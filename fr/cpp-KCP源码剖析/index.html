
<!doctype html>
<html lang="fr" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Ce texte analyse simplement le code source de KCP, discute de la mise en œuvre de l'ARQ sur KCP, ainsi que de quelques stratégies pour augmenter la vitesse de transmission de KCP.">
      
      
        <meta name="author" content="Disenone">
      
      
        <link rel="canonical" href="https://wiki.disenone.site/fr/cpp-KCP%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90/">
      
      
        <link rel="prev" href="../cpp-%E7%BC%96%E5%86%99Windows%E4%B8%8B%E7%9A%84MemoryLeakDetector/">
      
      
        <link rel="next" href="../py-%E4%BD%BF%E7%94%A8VisualStudio2015%E7%BC%96%E8%AF%91Python2.7.11/">
      
      
        <link rel="alternate" type="application/rss+xml" title="Flux RSS" href="../../feed_rss_created.xml">
        <link rel="alternate" type="application/rss+xml" title="Flux RSS du contenu mis à jour" href="../../feed_rss_updated.xml">
      
      <link rel="icon" href="../../assets/favicon/favicon.ico">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.5.50">
    
    
      
        <title>Analyse du code source KCP - Disenone's Wiki</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.a40c8224.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Noto+Sans+SC+-+local:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Noto Sans SC - local";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../assets/css/style.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    

   <link href="../../assets/stylesheets/glightbox.min.css" rel="stylesheet"/><style>
    html.glightbox-open { overflow: initial; height: 100%; }
    .gslide-title { margin-top: 0px; user-select: text; }
    .gslide-desc { color: #666; user-select: text; }
    .gslide-image img { background: white; }
    .gscrollbar-fixer { padding-right: 15px; }
    .gdesc-inner { font-size: 0.75rem; }
    body[data-md-color-scheme="slate"] .gdesc-inner { background: var(--md-default-bg-color);}
    body[data-md-color-scheme="slate"] .gslide-title { color: var(--md-default-fg-color);}
    body[data-md-color-scheme="slate"] .gslide-desc { color: var(--md-default-fg-color);}</style> <script src="../../assets/javascripts/glightbox.min.js"></script></head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="4051b5" data-md-color-accent="blue">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#quest-ce-que-le-kcp" class="md-skip">
          Aller au contenu
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="En-tête">
    <a href="../" title="Disenone&#39;s Wiki" class="md-header__button md-logo" aria-label="Disenone's Wiki" data-md-component="logo">
      
  <img src="../../assets/favicon/android-chrome-512x512.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Disenone's Wiki
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Analyse du code source KCP
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="4051b5" data-md-color-accent="blue"  aria-label="切换暗色模式"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="切换暗色模式" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3m0 8a5 5 0 0 1-5-5 5 5 0 0 1 5-5 5 5 0 0 1 5 5 5 5 0 0 1-5 5m0-12.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="black" data-md-color-accent="blue"  aria-label="切换亮色模式"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="切换亮色模式" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 9a3 3 0 0 1 3 3 3 3 0 0 1-3 3 3 3 0 0 1-3-3 3 3 0 0 1 3-3m0-4.5c5 0 9.27 3.11 11 7.5-1.73 4.39-6 7.5-11 7.5S2.73 16.39 1 12c1.73-4.39 6-7.5 11-7.5M3.18 12a9.821 9.821 0 0 0 17.64 0 9.821 9.821 0 0 0-17.64 0"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
      <div class="md-header__option">
  <div class="md-select">
    
    <button class="md-header__button md-icon" aria-label="Sélectionner la langue">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m12.87 15.07-2.54-2.51.03-.03A17.5 17.5 0 0 0 14.07 6H17V4h-7V2H8v2H1v2h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2zm-2.62 7 1.62-4.33L19.12 17z"/></svg>
    </button>
    <div class="md-select__inner">
      <ul class="md-select__list">
        
          <li class="md-select__item">
            <a href="../../cpp-KCP%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90/" hreflang="zh" class="md-select__link">
              简体中文
            </a>
          </li>
        
          <li class="md-select__item">
            <a href="../../zh-Hant/cpp-KCP%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90/" hreflang="zh-Hant" class="md-select__link">
              繁體中文
            </a>
          </li>
        
          <li class="md-select__item">
            <a href="../../en/cpp-KCP%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90/" hreflang="en" class="md-select__link">
              English
            </a>
          </li>
        
          <li class="md-select__item">
            <a href="../../es/cpp-KCP%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90/" hreflang="es" class="md-select__link">
              Español
            </a>
          </li>
        
          <li class="md-select__item">
            <a href="../../ja/cpp-KCP%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90/" hreflang="ja" class="md-select__link">
              日本語
            </a>
          </li>
        
          <li class="md-select__item">
            <a href="../../de/cpp-KCP%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90/" hreflang="de" class="md-select__link">
              Deutsch
            </a>
          </li>
        
          <li class="md-select__item">
            <a href="./" hreflang="fr" class="md-select__link">
              Français
            </a>
          </li>
        
          <li class="md-select__item">
            <a href="../../ar/cpp-KCP%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90/" hreflang="ar" class="md-select__link">
              العربية
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</div>
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Rechercher" placeholder="Rechercher" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Recherche">
        
        <button type="reset" class="md-search__icon md-icon" title="Effacer" aria-label="Effacer" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initialisation de la recherche
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/disenone/wiki_blog" title="Aller au dépôt" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2A10 10 0 0 0 2 12c0 4.42 2.87 8.17 6.84 9.5.5.08.66-.23.66-.5v-1.69c-2.77.6-3.36-1.34-3.36-1.34-.46-1.16-1.11-1.47-1.11-1.47-.91-.62.07-.6.07-.6 1 .07 1.53 1.03 1.53 1.03.87 1.52 2.34 1.07 2.91.83.09-.65.35-1.09.63-1.34-2.22-.25-4.55-1.11-4.55-4.92 0-1.11.38-2 1.03-2.71-.1-.25-.45-1.29.1-2.64 0 0 .84-.27 2.75 1.02.79-.22 1.65-.33 2.5-.33s1.71.11 2.5.33c1.91-1.29 2.75-1.02 2.75-1.02.55 1.35.2 2.39.1 2.64.65.71 1.03 1.6 1.03 2.71 0 3.82-2.34 4.66-4.57 4.91.36.31.69.92.69 1.85V21c0 .27.16.59.67.5C19.14 20.16 22 16.42 22 12A10 10 0 0 0 12 2"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Onglets" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../" class="md-tabs__link">
        
  
    
  
  Home

      </a>
    </li>
  

      
        
  
  
    
  
  
    
    
      
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../cpp-C%E5%92%8CCpp%E7%9A%84%E5%91%BD%E4%BB%A4%E8%A1%8C%E5%8F%82%E6%95%B0%E5%A4%84%E7%90%86%E6%80%BB%E7%BB%93/" class="md-tabs__link">
          
  
    
  
  Techniques de programmation

        </a>
      </li>
    
  

    
  

      
        
  
  
  
    
    
      
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../game-%E6%B8%B8%E6%88%8FAOI%E7%AE%97%E6%B3%95%E8%A7%A3%E6%9E%90%E5%92%8C%E6%80%A7%E8%83%BD%E5%AE%9E%E6%B5%8B/" class="md-tabs__link">
          
  
    
  
  Développement de jeux

        </a>
      </li>
    
  

    
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../" title="Disenone&#39;s Wiki" class="md-nav__button md-logo" aria-label="Disenone's Wiki" data-md-component="logo">
      
  <img src="../../assets/favicon/android-chrome-512x512.png" alt="logo">

    </a>
    Disenone's Wiki
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/disenone/wiki_blog" title="Aller au dépôt" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2A10 10 0 0 0 2 12c0 4.42 2.87 8.17 6.84 9.5.5.08.66-.23.66-.5v-1.69c-2.77.6-3.36-1.34-3.36-1.34-.46-1.16-1.11-1.47-1.11-1.47-.91-.62.07-.6.07-.6 1 .07 1.53 1.03 1.53 1.03.87 1.52 2.34 1.07 2.91.83.09-.65.35-1.09.63-1.34-2.22-.25-4.55-1.11-4.55-4.92 0-1.11.38-2 1.03-2.71-.1-.25-.45-1.29.1-2.64 0 0 .84-.27 2.75 1.02.79-.22 1.65-.33 2.5-.33s1.71.11 2.5.33c1.91-1.29 2.75-1.02 2.75-1.02.55 1.35.2 2.39.1 2.64.65.71 1.03 1.6 1.03 2.71 0 3.82-2.34 4.66-4.57 4.91.36.31.69.92.69 1.85V21c0 .27.16.59.67.5C19.14 20.16 22 16.42 22 12A10 10 0 0 0 12 2"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Home
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
      
        
      
        
      
    
    
      
        
        
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" checked>
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="">
            
  
  <span class="md-ellipsis">
    Techniques de programmation
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Techniques de programmation
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
    
  
  
  
    
    
      
        
      
        
      
        
      
        
      
    
    
      
      
        
          
          
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_1" checked>
        
          
          <label class="md-nav__link" for="__nav_2_1" id="__nav_2_1_label" tabindex="">
            
  
  <span class="md-ellipsis">
    C/C++
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_1_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_2_1">
            <span class="md-nav__icon md-icon"></span>
            C/C++
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../cpp-C%E5%92%8CCpp%E7%9A%84%E5%91%BD%E4%BB%A4%E8%A1%8C%E5%8F%82%E6%95%B0%E5%A4%84%E7%90%86%E6%80%BB%E7%BB%93/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    C/C++ : résumé de la gestion des paramètres de ligne de commande
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../cpp-C%E5%92%8CCpp%E5%AE%8F%E7%BC%96%E7%A8%8B%E8%A7%A3%E6%9E%90/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Analyse de la programmation des macros en C/C++
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../cpp-%E7%BC%96%E5%86%99Windows%E4%B8%8B%E7%9A%84MemoryLeakDetector/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Rédigez un détecteur de fuites de mémoire pour Windows.
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    Analyse du code source KCP
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    Analyse du code source KCP
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table des matières">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table des matières
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#quest-ce-que-le-kcp" class="md-nav__link">
    <span class="md-ellipsis">
      Qu'est-ce que le KCP ?
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#kcp-structure-de-donnees" class="md-nav__link">
    <span class="md-ellipsis">
      KCP structure de données
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#la-mise-en-uvre-de-larq-de-kcp" class="md-nav__link">
    <span class="md-ellipsis">
      La mise en œuvre de l'ARQ de KCP
    </span>
  </a>
  
    <nav class="md-nav" aria-label="La mise en œuvre de l'ARQ de KCP">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#envoyer" class="md-nav__link">
    <span class="md-ellipsis">
      Envoyer
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#reception" class="md-nav__link">
    <span class="md-ellipsis">
      Réception
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#re-transmission-en-cas-de-depassement-du-delai" class="md-nav__link">
    <span class="md-ellipsis">
      Re-transmission en cas de dépassement du délai
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#strategie-pour-augmenter-le-debit-kcp" class="md-nav__link">
    <span class="md-ellipsis">
      Stratégie pour augmenter le débit KCP
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Stratégie pour augmenter le débit KCP">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#retransmission-rapide" class="md-nav__link">
    <span class="md-ellipsis">
      Rétransmission rapide
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#reduire-le-temps-de-retransmission-des-delais-dattente" class="md-nav__link">
    <span class="md-ellipsis">
      Réduire le temps de retransmission des délais d'attente.
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#fenetre-denvoi-de-mise-a-jour" class="md-nav__link">
    <span class="md-ellipsis">
      Fenêtre d'envoi de mise à jour
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#resume" class="md-nav__link">
    <span class="md-ellipsis">
      Résumé
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
    
    
      
      
        
          
          
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_2" >
        
          
          <label class="md-nav__link" for="__nav_2_2" id="__nav_2_2_label" tabindex="">
            
  
  <span class="md-ellipsis">
    Python
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_2">
            <span class="md-nav__icon md-icon"></span>
            Python
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../py-%E4%BD%BF%E7%94%A8VisualStudio2015%E7%BC%96%E8%AF%91Python2.7.11/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Utiliser Visual Studio 2015 pour compiler Python 2.7.11
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../py-Python%E6%9D%82%E8%B0%881-%E6%8E%A2%E7%A9%B6__builtins__/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Python Discussions 1 - Exploration de __builtins__
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../py-Python%E6%9D%82%E8%B0%882-Python312-%E7%83%AD%E6%9B%B4%E6%96%B0/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Python Discussions 2 - Python3.12 Mise à jour à chaud
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Développement de jeux
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            Développement de jeux
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
      
        
      
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_1" >
        
          
          <label class="md-nav__link" for="__nav_3_1" id="__nav_3_1_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Fondamentaux
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_1">
            <span class="md-nav__icon md-icon"></span>
            Fondamentaux
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../game-%E6%B8%B8%E6%88%8FAOI%E7%AE%97%E6%B3%95%E8%A7%A3%E6%9E%90%E5%92%8C%E6%80%A7%E8%83%BD%E5%AE%9E%E6%B5%8B/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Analyse et test de performance de l'algorithme AOI de jeu.
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_2" >
        
          
          <label class="md-nav__link" for="__nav_3_2" id="__nav_3_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    UE
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_2">
            <span class="md-nav__icon md-icon"></span>
            UE
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ue-%E4%BD%BF%E7%94%A8FASTBuild%E7%BC%96%E8%AF%91UE4%E5%92%8CUE5/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Utiliser FASTBuild pour compiler UE4 et UE5
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ue-%E9%80%9A%E8%BF%87%E6%8F%92%E4%BB%B6%E6%BA%90%E7%A0%81%E6%B7%BB%E5%8A%A0%E6%8F%92%E4%BB%B6/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    UE ajoute des plugins via le code source du plugin.
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ue-%E6%89%A9%E5%B1%95%E7%BC%96%E8%BE%91%E5%99%A8%E8%8F%9C%E5%8D%95/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    UE Étendre le menu de l'éditeur
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ue-%E4%BD%BF%E7%94%A8%E8%B7%AF%E5%BE%84%E5%BD%A2%E5%BC%8F%E6%89%A9%E5%B1%95%E8%8F%9C%E5%8D%95/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    UE utilise le chemin d'accès pour étendre le menu
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ue-%E8%AE%BE%E7%BD%AE%E6%9C%AC%E5%9C%B0%E5%8C%96%E5%A4%9A%E8%AF%AD%E8%A8%80/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    UE configure la localisation multilingue
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ue-%E5%9B%BE%E7%89%87-%E5%90%84%E7%A7%8D%E5%9B%BE%E7%89%87%E6%93%8D%E4%BD%9C/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    UE réalise diverses opérations sur les images (UTexture2D) (lecture, sauvegarde, copie, presse-papiers...)
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ue-%E7%BC%96%E8%BE%91%E5%99%A8%E6%8F%92%E4%BB%B6-EditorPlus/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    UE éditeur plugin UE.EditorPlus documentation explicative
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ue-%E6%8F%92%E4%BB%B6-AIChatPlus/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Document d'instructions du plug-in UE AIChatPlus
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_3" >
        
          
          <label class="md-nav__link" for="__nav_3_3" id="__nav_3_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Unity
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_3">
            <span class="md-nav__icon md-icon"></span>
            Unity
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../unity-Unity%E7%AC%AC%E4%B8%89%E4%BA%BA%E7%A7%B0%E7%9B%B8%E6%9C%BA%E6%9E%84%E5%BB%BA%28%E4%B8%8A%29/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Construction du système de caméra à la troisième personne dans Unity (Partie 1)
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../unity-Unity%E7%AC%AC%E4%B8%89%E4%BA%BA%E7%A7%B0%E7%9B%B8%E6%9C%BA%E6%9E%84%E5%BB%BA%28%E4%B8%8B%29/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Construction d'un système de caméra à la troisième personne dans Unity (partie 2)
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../unity-Unity%E4%BA%BA%E7%89%A9%E6%8E%A7%E5%88%B6/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Contrôle des personnages Unity
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../unity-Unity%E7%94%BB%E6%B7%B1%E5%BA%A6%E5%9B%BE%E5%92%8C%E8%BE%B9%E7%BC%98%E6%A3%80%E6%B5%8B/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Unity crée une carte de profondeur (Depth Map) et une détection de contours (Edge Detection)
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../unity-Unity%E5%AE%9E%E7%8E%B0%E4%BD%93%E7%A7%AF%E5%85%89%E7%85%A7%E6%95%A3%E5%B0%84/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Unity implements volumetric light scattering (Volumetric Light Scattering, Cloud Gaps Light)
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table des matières">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table des matières
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#quest-ce-que-le-kcp" class="md-nav__link">
    <span class="md-ellipsis">
      Qu'est-ce que le KCP ?
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#kcp-structure-de-donnees" class="md-nav__link">
    <span class="md-ellipsis">
      KCP structure de données
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#la-mise-en-uvre-de-larq-de-kcp" class="md-nav__link">
    <span class="md-ellipsis">
      La mise en œuvre de l'ARQ de KCP
    </span>
  </a>
  
    <nav class="md-nav" aria-label="La mise en œuvre de l'ARQ de KCP">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#envoyer" class="md-nav__link">
    <span class="md-ellipsis">
      Envoyer
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#reception" class="md-nav__link">
    <span class="md-ellipsis">
      Réception
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#re-transmission-en-cas-de-depassement-du-delai" class="md-nav__link">
    <span class="md-ellipsis">
      Re-transmission en cas de dépassement du délai
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#strategie-pour-augmenter-le-debit-kcp" class="md-nav__link">
    <span class="md-ellipsis">
      Stratégie pour augmenter le débit KCP
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Stratégie pour augmenter le débit KCP">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#retransmission-rapide" class="md-nav__link">
    <span class="md-ellipsis">
      Rétransmission rapide
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#reduire-le-temps-de-retransmission-des-delais-dattente" class="md-nav__link">
    <span class="md-ellipsis">
      Réduire le temps de retransmission des délais d'attente.
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#fenetre-denvoi-de-mise-a-jour" class="md-nav__link">
    <span class="md-ellipsis">
      Fenêtre d'envoi de mise à jour
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#resume" class="md-nav__link">
    <span class="md-ellipsis">
      Résumé
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  
    <a href="https://github.com/disenone/wiki_blog/edit/main/docs/fr/cpp-KCP源码剖析.md" title="Editer cette page" class="md-content__button md-icon">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M10 20H6V4h7v5h5v3.1l2-2V8l-6-6H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h4zm10.2-7c.1 0 .3.1.4.2l1.3 1.3c.2.2.2.6 0 .8l-1 1-2.1-2.1 1-1c.1-.1.2-.2.4-.2m0 3.9L14.1 23H12v-2.1l6.1-6.1z"/></svg>
    </a>
  
  


  <h1>Analyse du code source KCP</h1>

<div><p><meta property="og:title" content="KCP 源码剖析"></p>
<p>Avant de lire cet article, si vous n'avez jamais entendu parler de KCP ou si vous ne connaissez pas du tout KCP, merci de prendre un peu de temps pour consulter le document explicatif du projet KCP : <a href="https://github.com/skywind3000/kcp">Portail</a>L'objectif de cet article est d'explorer en profondeur les détails de mise en œuvre de KCP afin de comprendre KCP.</p>
<h2 id="quest-ce-que-le-kcp">Qu'est-ce que le KCP ?</h2>
<p>KCP est un protocole rapide et fiable, capable de transmettre des données avec une latence inférieure à celle du TCP, permettant une retransmission des données plus rapide et des temps d'attente plus courts.</p>
<blockquote>
<p>TCP est conçu pour le trafic (combien de KB de données peuvent être transférées par seconde), mettant l'accent sur une utilisation optimale de la bande passante. KCP, en revanche, est conçu pour la vitesse de transmission (le temps qu'un paquet de données met pour aller d'une extrémité à l'autre), échangeant un gaspillage de bande passante de 10 à 20 % pour obtenir une vitesse de transmission 30 à 40 % plus rapide que celle de TCP. Le canal TCP est comme un grand canal à débit lent mais avec un volume de trafic très élevé, tandis que KCP se compare à un petit torrent à fort courant.</p>
</blockquote>
<p>Ce qui est écrit ci-dessus dans le document de KCP mentionne les mots-clés <strong>bande passante</strong> et <strong>débit</strong>. KCP consomme de la bande passante, ce qui entraîne des avantages comme des débits de transmission plus importants et plus équilibrés. Pour plus d'informations, veuillez vous référer à la documentation officielle de KCP.</p>
<h2 id="kcp-structure-de-donnees">KCP structure de données</h2>
<p>Le code source de KCP se trouve dans les fichiers <code>ikcp.h</code> et <code>ikcp.c</code>, où <code>ikcp.h</code> contient la déclaration des structures de données. La première est le paquet de données <code>SEGMENT</code>, qui représente l'unité minimale de traitement des données pour le protocole KCP :</p>
<details>
<summary>Structure SEGMENT (cliquez pour afficher le code)</summary>
<div class="language-cpp highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="c1">//=====================================================================</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a><span class="n">SEGMENT</span><span class="w"> </span><span class="n">est</span><span class="w"> </span><span class="n">un</span><span class="w"> </span><span class="n">paquet</span><span class="w"> </span><span class="n">de</span><span class="w"> </span><span class="n">données</span><span class="p">.</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a><span class="c1">//=====================================================================</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a><span class="k">struct</span><span class="w"> </span><span class="nc">IKCPSEG</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a><span class="p">{</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a><span class="n">Noeud</span><span class="w"> </span><span class="n">de</span><span class="w"> </span><span class="n">la</span><span class="w"> </span><span class="n">liste</span><span class="w"> </span><span class="n">chaînée</span><span class="p">,</span><span class="w"> </span><span class="n">à</span><span class="w"> </span><span class="n">la</span><span class="w"> </span><span class="n">fois</span><span class="w"> </span><span class="n">la</span><span class="w"> </span><span class="n">file</span><span class="w"> </span><span class="n">d</span><span class="err">'</span><span class="n">attente</span><span class="w"> </span><span class="n">de</span><span class="w"> </span><span class="n">l</span><span class="err">'</span><span class="n">émission</span><span class="w"> </span><span class="n">et</span><span class="w"> </span><span class="n">la</span><span class="w"> </span><span class="n">file</span><span class="w"> </span><span class="n">d</span><span class="err">'</span><span class="n">attente</span><span class="w"> </span><span class="n">de</span><span class="w"> </span><span class="n">réception</span><span class="w"> </span><span class="n">sont</span><span class="w"> </span><span class="n">des</span><span class="w"> </span><span class="n">structures</span><span class="w"> </span><span class="n">de</span><span class="w"> </span><span class="n">liste</span><span class="w"> </span><span class="n">ici</span><span class="p">.</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">IQUEUEHEAD</span><span class="w"> </span><span class="n">node</span><span class="p">;</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a><span class="n">Identifiant</span><span class="w"> </span><span class="n">de</span><span class="w"> </span><span class="n">session</span><span class="p">,</span><span class="w"> </span><span class="n">le</span><span class="w"> </span><span class="n">même</span><span class="w"> </span><span class="n">identifiant</span><span class="w"> </span><span class="n">de</span><span class="w"> </span><span class="n">session</span><span class="w"> </span><span class="n">est</span><span class="w"> </span><span class="n">identique</span><span class="p">.</span>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a><span class="w">    </span><span class="n">IUINT32</span><span class="w"> </span><span class="n">conv</span><span class="p">;</span>
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a>
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a><span class="n">Type</span><span class="w"> </span><span class="n">de</span><span class="w"> </span><span class="n">paquet</span><span class="p">,</span><span class="w"> </span><span class="n">par</span><span class="w"> </span><span class="n">exemple</span><span class="w"> </span><span class="n">DATA</span><span class="w"> </span><span class="n">ou</span><span class="w"> </span><span class="n">ACK</span><span class="p">.</span>
<a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a><span class="w">    </span><span class="n">IUINT32</span><span class="w"> </span><span class="n">cmd</span><span class="p">;</span>
<a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a>
<a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a><span class="c1">// En raison des limites de MTU, les gros paquets sont fragmentés en plusieurs petits paquets, voici le numéro de petit paquet.</span>
<a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a><span class="w">    </span><span class="n">IUINT32</span><span class="w"> </span><span class="n">frg</span>
<a id="__codelineno-0-17" name="__codelineno-0-17" href="#__codelineno-0-17"></a>
<a id="__codelineno-0-18" name="__codelineno-0-18" href="#__codelineno-0-18"></a><span class="n">Chaque</span><span class="w"> </span><span class="n">paquet</span><span class="w"> </span><span class="n">de</span><span class="w"> </span><span class="n">données</span><span class="w"> </span><span class="n">est</span><span class="w"> </span><span class="n">accompagné</span><span class="w"> </span><span class="n">de</span><span class="w"> </span><span class="n">la</span><span class="w"> </span><span class="n">taille</span><span class="w"> </span><span class="n">de</span><span class="w"> </span><span class="n">la</span><span class="w"> </span><span class="n">fenêtre</span><span class="w"> </span><span class="n">de</span><span class="w"> </span><span class="n">réception</span><span class="w"> </span><span class="n">de</span><span class="w"> </span><span class="n">l</span><span class="err">'</span><span class="n">émetteur</span><span class="p">.</span>
<a id="__codelineno-0-19" name="__codelineno-0-19" href="#__codelineno-0-19"></a><span class="w">    </span><span class="n">IUINT32</span><span class="w"> </span><span class="n">wnd</span><span class="p">;</span>
<a id="__codelineno-0-20" name="__codelineno-0-20" href="#__codelineno-0-20"></a>
<a id="__codelineno-0-21" name="__codelineno-0-21" href="#__codelineno-0-21"></a><span class="c1">// Le temps d'envoi, s'il s'agit d'un paquet ACK, sera défini sur le ts du paquet de données source</span>
<a id="__codelineno-0-22" name="__codelineno-0-22" href="#__codelineno-0-22"></a><span class="w">    </span><span class="n">IUINT32</span><span class="w"> </span><span class="n">ts</span><span class="p">;</span>
<a id="__codelineno-0-23" name="__codelineno-0-23" href="#__codelineno-0-23"></a>
<a id="__codelineno-0-24" name="__codelineno-0-24" href="#__codelineno-0-24"></a><span class="c1">// Numéro identifiant unique du paquet de données</span>
<a id="__codelineno-0-25" name="__codelineno-0-25" href="#__codelineno-0-25"></a><span class="w">    </span><span class="n">IUINT32</span><span class="w"> </span><span class="n">sn</span><span class="p">;</span>
<a id="__codelineno-0-26" name="__codelineno-0-26" href="#__codelineno-0-26"></a>
<a id="__codelineno-0-27" name="__codelineno-0-27" href="#__codelineno-0-27"></a><span class="c1">// Cela signifie que tous les paquets de données inférieurs à una ont été reçus avec succès, en accord avec le sens TCP : le plus ancien numéro de séquence non reconnu SND</span>
<a id="__codelineno-0-28" name="__codelineno-0-28" href="#__codelineno-0-28"></a><span class="w">    </span><span class="n">IUINT32</span><span class="w"> </span><span class="n">una</span><span class="p">;</span>
<a id="__codelineno-0-29" name="__codelineno-0-29" href="#__codelineno-0-29"></a>
<a id="__codelineno-0-30" name="__codelineno-0-30" href="#__codelineno-0-30"></a><span class="n">Longueur</span><span class="w"> </span><span class="n">des</span><span class="w"> </span><span class="n">données</span>
<a id="__codelineno-0-31" name="__codelineno-0-31" href="#__codelineno-0-31"></a><span class="w">    </span><span class="n">IUINT32</span><span class="w"> </span><span class="n">len</span><span class="p">;</span>
<a id="__codelineno-0-32" name="__codelineno-0-32" href="#__codelineno-0-32"></a>
<a id="__codelineno-0-33" name="__codelineno-0-33" href="#__codelineno-0-33"></a><span class="n">Temps</span><span class="w"> </span><span class="n">de</span><span class="w"> </span><span class="n">retransmission</span><span class="w"> </span><span class="n">timeout</span>
<a id="__codelineno-0-34" name="__codelineno-0-34" href="#__codelineno-0-34"></a><span class="w">    </span><span class="n">IUINT32</span><span class="w"> </span><span class="n">resendts</span><span class="p">;</span>
<a id="__codelineno-0-35" name="__codelineno-0-35" href="#__codelineno-0-35"></a>
<a id="__codelineno-0-36" name="__codelineno-0-36" href="#__codelineno-0-36"></a><span class="n">Prochain</span><span class="w"> </span><span class="n">délai</span><span class="w"> </span><span class="n">d</span><span class="err">'</span><span class="n">attente</span><span class="w"> </span><span class="n">dépassé</span>
<a id="__codelineno-0-37" name="__codelineno-0-37" href="#__codelineno-0-37"></a><span class="w">    </span><span class="n">IUINT32</span><span class="w"> </span><span class="n">rto</span><span class="p">;</span>
<a id="__codelineno-0-38" name="__codelineno-0-38" href="#__codelineno-0-38"></a>
<a id="__codelineno-0-39" name="__codelineno-0-39" href="#__codelineno-0-39"></a><span class="n">Réémission</span><span class="w"> </span><span class="n">rapide</span><span class="p">,</span><span class="w"> </span><span class="n">le</span><span class="w"> </span><span class="n">nombre</span><span class="w"> </span><span class="n">de</span><span class="w"> </span><span class="n">paquets</span><span class="w"> </span><span class="n">de</span><span class="w"> </span><span class="n">données</span><span class="w"> </span><span class="n">reçus</span><span class="w"> </span><span class="n">après</span><span class="w"> </span><span class="n">ce</span><span class="w"> </span><span class="n">paquet</span><span class="w"> </span><span class="n">dépasse</span><span class="w"> </span><span class="n">un</span><span class="w"> </span><span class="n">certain</span><span class="w"> </span><span class="n">seuil</span><span class="p">,</span><span class="w"> </span><span class="n">déclenchant</span><span class="w"> </span><span class="n">ainsi</span><span class="w"> </span><span class="n">la</span><span class="w"> </span><span class="n">réémission</span><span class="w"> </span><span class="n">rapide</span><span class="p">.</span>
<a id="__codelineno-0-40" name="__codelineno-0-40" href="#__codelineno-0-40"></a><span class="w">    </span><span class="n">IUINT32</span><span class="w"> </span><span class="n">fastack</span><span class="p">;</span>
<a id="__codelineno-0-41" name="__codelineno-0-41" href="#__codelineno-0-41"></a>
<a id="__codelineno-0-42" name="__codelineno-0-42" href="#__codelineno-0-42"></a><span class="n">Le</span><span class="w"> </span><span class="n">nombre</span><span class="w"> </span><span class="n">d</span><span class="err">'</span><span class="n">envois</span><span class="p">.</span>
<a id="__codelineno-0-43" name="__codelineno-0-43" href="#__codelineno-0-43"></a><span class="w">    </span><span class="n">IUINT32</span><span class="w"> </span><span class="n">xmit</span><span class="p">;</span>
<a id="__codelineno-0-44" name="__codelineno-0-44" href="#__codelineno-0-44"></a>
<a id="__codelineno-0-45" name="__codelineno-0-45" href="#__codelineno-0-45"></a><span class="c1">// Données</span>
<a id="__codelineno-0-46" name="__codelineno-0-46" href="#__codelineno-0-46"></a><span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
<a id="__codelineno-0-47" name="__codelineno-0-47" href="#__codelineno-0-47"></a><span class="p">};</span>
</code></pre></div>
</details>

<p>Après avoir regardé les commentaires sur <code>SEGMENT</code>, on peut voir que le cœur de KCP est également un protocole ARQ, garantissant la livraison des données par retransmission automatique en cas de dépassement de délai. Passons maintenant à la définition de la structure KCP <code>KCPCB</code> :</p>
<details>
<summary>Structure KCP (cliquez pour afficher le code)</summary>
<div class="language-cpp highlight"><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a><span class="c1">//---------------------------------------------------------------------</span>
<a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a><span class="c1">// IKCPCB</span>
<a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a><span class="c1">//---------------------------------------------------------------------</span>
<a id="__codelineno-1-4" name="__codelineno-1-4" href="#__codelineno-1-4"></a><span class="k">struct</span><span class="w"> </span><span class="nc">IKCPCB</span>
<a id="__codelineno-1-5" name="__codelineno-1-5" href="#__codelineno-1-5"></a><span class="p">{</span>
<a id="__codelineno-1-6" name="__codelineno-1-6" href="#__codelineno-1-6"></a><span class="c1">// conv : numéro de la conversation</span>
<a id="__codelineno-1-7" name="__codelineno-1-7" href="#__codelineno-1-7"></a><span class="n">mtu</span><span class="p">,</span><span class="w"> </span><span class="n">mss</span><span class="o">:</span><span class="w"> </span><span class="n">Unité</span><span class="w"> </span><span class="n">de</span><span class="w"> </span><span class="n">transfert</span><span class="w"> </span><span class="n">maximale</span><span class="p">,</span><span class="w"> </span><span class="n">taille</span><span class="w"> </span><span class="n">maximale</span><span class="w"> </span><span class="n">de</span><span class="w"> </span><span class="n">segment</span><span class="w"> </span><span class="n">de</span><span class="w"> </span><span class="n">message</span>
<a id="__codelineno-1-8" name="__codelineno-1-8" href="#__codelineno-1-8"></a><span class="c1">// état : état de la session, 0 valide, -1 déconnecté</span>
<a id="__codelineno-1-9" name="__codelineno-1-9" href="#__codelineno-1-9"></a><span class="w">    </span><span class="n">IUINT32</span><span class="w"> </span><span class="n">conv</span><span class="p">,</span><span class="w"> </span><span class="n">mtu</span><span class="p">,</span><span class="w"> </span><span class="n">mss</span><span class="p">,</span><span class="w"> </span><span class="n">state</span><span class="p">;</span>
<a id="__codelineno-1-10" name="__codelineno-1-10" href="#__codelineno-1-10"></a>
<a id="__codelineno-1-11" name="__codelineno-1-11" href="#__codelineno-1-11"></a><span class="c1">// snd_una: Numéro de paquet en attente d'ACK</span>
<a id="__codelineno-1-12" name="__codelineno-1-12" href="#__codelineno-1-12"></a><span class="c1">// snd_nxt: le numéro du paquet de données suivant à envoyer</span>
<a id="__codelineno-1-13" name="__codelineno-1-13" href="#__codelineno-1-13"></a><span class="c1">// rcv_nxt : numéro du prochain paquet de données à recevoir</span>
<a id="__codelineno-1-14" name="__codelineno-1-14" href="#__codelineno-1-14"></a><span class="w">    </span><span class="n">IUINT32</span><span class="w"> </span><span class="n">snd_una</span><span class="p">,</span><span class="w"> </span><span class="n">snd_nxt</span><span class="p">,</span><span class="w"> </span><span class="n">rcv_nxt</span><span class="p">;</span>
<a id="__codelineno-1-15" name="__codelineno-1-15" href="#__codelineno-1-15"></a>
<a id="__codelineno-1-16" name="__codelineno-1-16" href="#__codelineno-1-16"></a><span class="c1">// ts_recent, ts_lastack : non utilisé</span>
<a id="__codelineno-1-17" name="__codelineno-1-17" href="#__codelineno-1-17"></a><span class="c1">// ssthresh : seuil de contrôle de congestion pour le démarrage lent</span>
<a id="__codelineno-1-18" name="__codelineno-1-18" href="#__codelineno-1-18"></a><span class="w">    </span><span class="n">IUINT32</span><span class="w"> </span><span class="n">ts_recent</span><span class="p">,</span><span class="w"> </span><span class="n">ts_lastack</span><span class="p">,</span><span class="w"> </span><span class="n">ssthresh</span><span class="p">;</span>
<a id="__codelineno-1-19" name="__codelineno-1-19" href="#__codelineno-1-19"></a>
<a id="__codelineno-1-20" name="__codelineno-1-20" href="#__codelineno-1-20"></a><span class="c1">// rx_rto: rto (temps d'attente de retransmission) - temps de retransmission en cas de dépassement du délai</span>
<a id="__codelineno-1-21" name="__codelineno-1-21" href="#__codelineno-1-21"></a><span class="c1">// rx_rttval, rx_srtt, rx_minrto: Calcul des variables intermédiaires pour le calcul de RTO</span>
<a id="__codelineno-1-22" name="__codelineno-1-22" href="#__codelineno-1-22"></a><span class="w">    </span><span class="n">IINT32</span><span class="w"> </span><span class="n">rx_rttval</span><span class="p">,</span><span class="w"> </span><span class="n">rx_srtt</span><span class="p">,</span><span class="w"> </span><span class="n">rx_rto</span><span class="p">,</span><span class="w"> </span><span class="n">rx_minrto</span><span class="p">;</span>
<a id="__codelineno-1-23" name="__codelineno-1-23" href="#__codelineno-1-23"></a>
<a id="__codelineno-1-24" name="__codelineno-1-24" href="#__codelineno-1-24"></a><span class="c1">// snd_wnd, rcv_wnd : Taille maximale des fenêtres d'envoi et de réception</span>
<a id="__codelineno-1-25" name="__codelineno-1-25" href="#__codelineno-1-25"></a><span class="c1">// rmt_wnd : fenêtre distante, taille restante de la fenêtre d'acceptation de l'autre partie</span>
<a id="__codelineno-1-26" name="__codelineno-1-26" href="#__codelineno-1-26"></a><span class="c1">// cwnd : taille de la fenêtre d'envoi</span>
<a id="__codelineno-1-27" name="__codelineno-1-27" href="#__codelineno-1-27"></a><span class="c1">// probe: Indicateur sur l'envoi de messages de contrôle</span>
<a id="__codelineno-1-28" name="__codelineno-1-28" href="#__codelineno-1-28"></a><span class="w">    </span><span class="n">IUINT32</span><span class="w"> </span><span class="n">snd_wnd</span><span class="p">,</span><span class="w"> </span><span class="n">rcv_wnd</span><span class="p">,</span><span class="w"> </span><span class="n">rmt_wnd</span><span class="p">,</span><span class="w"> </span><span class="n">cwnd</span><span class="p">,</span><span class="w"> </span><span class="n">probe</span><span class="p">;</span>
<a id="__codelineno-1-29" name="__codelineno-1-29" href="#__codelineno-1-29"></a>
<a id="__codelineno-1-30" name="__codelineno-1-30" href="#__codelineno-1-30"></a><span class="c1">// current: Heure actuelle</span>
<a id="__codelineno-1-31" name="__codelineno-1-31" href="#__codelineno-1-31"></a><span class="c1">// interval: Intervalle de mise à jour</span>
<a id="__codelineno-1-32" name="__codelineno-1-32" href="#__codelineno-1-32"></a><span class="c1">// ts_flush : Temps de mise à jour suivant nécessaire</span>
<a id="__codelineno-1-33" name="__codelineno-1-33" href="#__codelineno-1-33"></a><span class="c1">// xmit : Nombre d'échecs d'envoi</span>
<a id="__codelineno-1-34" name="__codelineno-1-34" href="#__codelineno-1-34"></a><span class="w">    </span><span class="n">IUINT32</span><span class="w"> </span><span class="n">current</span><span class="p">,</span><span class="w"> </span><span class="n">interval</span><span class="p">,</span><span class="w"> </span><span class="n">ts_flush</span><span class="p">,</span><span class="w"> </span><span class="n">xmit</span><span class="p">;</span>
<a id="__codelineno-1-35" name="__codelineno-1-35" href="#__codelineno-1-35"></a>
<a id="__codelineno-1-36" name="__codelineno-1-36" href="#__codelineno-1-36"></a><span class="n">Longueur</span><span class="w"> </span><span class="n">de</span><span class="w"> </span><span class="n">la</span><span class="w"> </span><span class="n">liste</span><span class="w"> </span><span class="n">correspondante</span>
<a id="__codelineno-1-37" name="__codelineno-1-37" href="#__codelineno-1-37"></a><span class="w">    </span><span class="n">IUINT32</span><span class="w"> </span><span class="n">nrcv_buf</span><span class="p">,</span><span class="w"> </span><span class="n">nsnd_buf</span><span class="p">;</span>
<a id="__codelineno-1-38" name="__codelineno-1-38" href="#__codelineno-1-38"></a><span class="w">    </span><span class="n">IUINT32</span><span class="w"> </span><span class="n">nrcv_que</span><span class="p">,</span><span class="w"> </span><span class="n">nsnd_que</span><span class="p">;</span>
<a id="__codelineno-1-39" name="__codelineno-1-39" href="#__codelineno-1-39"></a>
<a id="__codelineno-1-40" name="__codelineno-1-40" href="#__codelineno-1-40"></a><span class="c1">// nodelay : Contrôle la vitesse d'augmentation du rto pour les retransmissions en cas de timeout</span>
<a id="__codelineno-1-41" name="__codelineno-1-41" href="#__codelineno-1-41"></a><span class="c1">// mis à jour: Est-ce que ikcp_update a été appelé</span>
<a id="__codelineno-1-42" name="__codelineno-1-42" href="#__codelineno-1-42"></a><span class="w">    </span><span class="n">IUINT32</span><span class="w"> </span><span class="n">nodelay</span><span class="p">,</span><span class="w"> </span><span class="n">updated</span><span class="p">;</span>
<a id="__codelineno-1-43" name="__codelineno-1-43" href="#__codelineno-1-43"></a>
<a id="__codelineno-1-44" name="__codelineno-1-44" href="#__codelineno-1-44"></a><span class="c1">// ts_probe, probe_wait : Lorsqu'il y a une fenêtre de réception à l'autre extrémité qui reste à 0 pendant une longue période, une interrogation est lancée activement et régulièrement.</span>
<a id="__codelineno-1-45" name="__codelineno-1-45" href="#__codelineno-1-45"></a><span class="w">    </span><span class="n">IUINT32</span><span class="w"> </span><span class="n">ts_probe</span><span class="p">,</span><span class="w"> </span><span class="n">probe_wait</span><span class="p">;</span>
<a id="__codelineno-1-46" name="__codelineno-1-46" href="#__codelineno-1-46"></a>
<a id="__codelineno-1-47" name="__codelineno-1-47" href="#__codelineno-1-47"></a><span class="c1">// deal_link: Pas de réponse de l'autre partie depuis longtemps</span>
<a id="__codelineno-1-48" name="__codelineno-1-48" href="#__codelineno-1-48"></a><span class="c1">// incr: Participation au calcul de la taille de la fenêtre d'envoi</span>
<a id="__codelineno-1-49" name="__codelineno-1-49" href="#__codelineno-1-49"></a><span class="w">    </span><span class="n">IUINT32</span><span class="w"> </span><span class="n">dead_link</span><span class="p">,</span><span class="w"> </span><span class="n">incr</span><span class="p">;</span>
<a id="__codelineno-1-50" name="__codelineno-1-50" href="#__codelineno-1-50"></a>
<a id="__codelineno-1-51" name="__codelineno-1-51" href="#__codelineno-1-51"></a><span class="c1">// queue: paquet de données en contact avec la couche utilisateur</span>
<a id="__codelineno-1-52" name="__codelineno-1-52" href="#__codelineno-1-52"></a><span class="c1">// buf: Paquet de données mis en cache par le protocole</span>
<a id="__codelineno-1-53" name="__codelineno-1-53" href="#__codelineno-1-53"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">IQUEUEHEAD</span><span class="w"> </span><span class="n">snd_queue</span><span class="p">;</span>
<a id="__codelineno-1-54" name="__codelineno-1-54" href="#__codelineno-1-54"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">IQUEUEHEAD</span><span class="w"> </span><span class="n">rcv_queue</span><span class="p">;</span>
<a id="__codelineno-1-55" name="__codelineno-1-55" href="#__codelineno-1-55"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">IQUEUEHEAD</span><span class="w"> </span><span class="n">snd_buf</span><span class="p">;</span>
<a id="__codelineno-1-56" name="__codelineno-1-56" href="#__codelineno-1-56"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">IQUEUEHEAD</span><span class="w"> </span><span class="n">rcv_buf</span><span class="p">;</span>
<a id="__codelineno-1-57" name="__codelineno-1-57" href="#__codelineno-1-57"></a>
<a id="__codelineno-1-58" name="__codelineno-1-58" href="#__codelineno-1-58"></a><span class="c1">// Informations sur les paquets de données nécessitant l'envoi d'un ack</span>
<a id="__codelineno-1-59" name="__codelineno-1-59" href="#__codelineno-1-59"></a><span class="w">    </span><span class="n">IUINT32</span><span class="w"> </span><span class="o">*</span><span class="n">acklist</span><span class="p">;</span>
<a id="__codelineno-1-60" name="__codelineno-1-60" href="#__codelineno-1-60"></a>
<a id="__codelineno-1-61" name="__codelineno-1-61" href="#__codelineno-1-61"></a><span class="n">Le</span><span class="w"> </span><span class="n">nombre</span><span class="w"> </span><span class="n">de</span><span class="w"> </span><span class="n">paquets</span><span class="w"> </span><span class="n">nécessitant</span><span class="w"> </span><span class="n">un</span><span class="w"> </span><span class="n">accusé</span><span class="w"> </span><span class="n">de</span><span class="w"> </span><span class="n">réception</span><span class="p">.</span>
<a id="__codelineno-1-62" name="__codelineno-1-62" href="#__codelineno-1-62"></a><span class="w">    </span><span class="n">IUINT32</span><span class="w"> </span><span class="n">ackcount</span><span class="p">;</span>
<a id="__codelineno-1-63" name="__codelineno-1-63" href="#__codelineno-1-63"></a>
<a id="__codelineno-1-64" name="__codelineno-1-64" href="#__codelineno-1-64"></a><span class="c1">// Taille de la mémoire de la liste des exceptions</span>
<a id="__codelineno-1-65" name="__codelineno-1-65" href="#__codelineno-1-65"></a><span class="w">    </span><span class="n">IUINT32</span><span class="w"> </span><span class="n">ackblock</span><span class="p">;</span>
<a id="__codelineno-1-66" name="__codelineno-1-66" href="#__codelineno-1-66"></a>
<a id="__codelineno-1-67" name="__codelineno-1-67" href="#__codelineno-1-67"></a><span class="n">Les</span><span class="w"> </span><span class="n">données</span><span class="w"> </span><span class="n">transmises</span><span class="w"> </span><span class="n">par</span><span class="w"> </span><span class="n">la</span><span class="w"> </span><span class="n">couche</span><span class="w"> </span><span class="n">utilisateur</span><span class="p">.</span>
<a id="__codelineno-1-68" name="__codelineno-1-68" href="#__codelineno-1-68"></a><span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">user</span><span class="p">;</span>
<a id="__codelineno-1-69" name="__codelineno-1-69" href="#__codelineno-1-69"></a>
<a id="__codelineno-1-70" name="__codelineno-1-70" href="#__codelineno-1-70"></a><span class="n">Stockage</span><span class="w"> </span><span class="n">de</span><span class="w"> </span><span class="n">l</span><span class="err">'</span><span class="n">espace</span><span class="w"> </span><span class="n">pour</span><span class="w"> </span><span class="n">un</span><span class="w"> </span><span class="n">paquet</span><span class="w"> </span><span class="n">KCP</span><span class="p">.</span>
<a id="__codelineno-1-71" name="__codelineno-1-71" href="#__codelineno-1-71"></a><span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">buffer</span><span class="p">;</span>
<a id="__codelineno-1-72" name="__codelineno-1-72" href="#__codelineno-1-72"></a>
<a id="__codelineno-1-73" name="__codelineno-1-73" href="#__codelineno-1-73"></a><span class="n">Le</span><span class="w"> </span><span class="n">nombre</span><span class="w"> </span><span class="n">de</span><span class="w"> </span><span class="n">déclenchements</span><span class="w"> </span><span class="n">du</span><span class="w"> </span><span class="n">retransmission</span><span class="w"> </span><span class="n">rapide</span><span class="w"> </span><span class="p">(</span><span class="n">fastack</span><span class="p">)</span>
<a id="__codelineno-1-74" name="__codelineno-1-74" href="#__codelineno-1-74"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">fastresend</span><span class="p">;</span>
<a id="__codelineno-1-75" name="__codelineno-1-75" href="#__codelineno-1-75"></a>
<a id="__codelineno-1-76" name="__codelineno-1-76" href="#__codelineno-1-76"></a><span class="c1">// Nombre maximal de retransmissions rapides</span>
<a id="__codelineno-1-77" name="__codelineno-1-77" href="#__codelineno-1-77"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">fastlimit</span><span class="p">;</span>
<a id="__codelineno-1-78" name="__codelineno-1-78" href="#__codelineno-1-78"></a>
<a id="__codelineno-1-79" name="__codelineno-1-79" href="#__codelineno-1-79"></a><span class="c1">// nocwnd: Ne tient pas compte de la taille de la fenêtre d'envoi lors du démarrage lent</span>
<a id="__codelineno-1-80" name="__codelineno-1-80" href="#__codelineno-1-80"></a><span class="nl">stream</span><span class="p">:</span><span class="w"> </span><span class="n">mode</span><span class="w"> </span><span class="n">flux</span>
<a id="__codelineno-1-81" name="__codelineno-1-81" href="#__codelineno-1-81"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">nocwnd</span><span class="p">,</span><span class="w"> </span><span class="n">stream</span><span class="p">;</span>
<a id="__codelineno-1-82" name="__codelineno-1-82" href="#__codelineno-1-82"></a>
<a id="__codelineno-1-83" name="__codelineno-1-83" href="#__codelineno-1-83"></a><span class="w">    </span><span class="c1">// debug log</span>
<a id="__codelineno-1-84" name="__codelineno-1-84" href="#__codelineno-1-84"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">logmask</span><span class="p">;</span>
<a id="__codelineno-1-85" name="__codelineno-1-85" href="#__codelineno-1-85"></a>
<a id="__codelineno-1-86" name="__codelineno-1-86" href="#__codelineno-1-86"></a><span class="n">Interface</span><span class="w"> </span><span class="n">d</span><span class="err">'</span><span class="n">envoi</span><span class="w"> </span><span class="n">de</span><span class="w"> </span><span class="n">données</span><span class="p">.</span>
<a id="__codelineno-1-87" name="__codelineno-1-87" href="#__codelineno-1-87"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">output</span><span class="p">)(</span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">buf</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">len</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">IKCPCB</span><span class="w"> </span><span class="o">*</span><span class="n">kcp</span><span class="p">,</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">user</span><span class="p">);</span>
<a id="__codelineno-1-88" name="__codelineno-1-88" href="#__codelineno-1-88"></a>
<a id="__codelineno-1-89" name="__codelineno-1-89" href="#__codelineno-1-89"></a><span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">writelog</span><span class="p">)(</span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">log</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">IKCPCB</span><span class="w"> </span><span class="o">*</span><span class="n">kcp</span><span class="p">,</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">user</span><span class="p">);</span>
<a id="__codelineno-1-90" name="__codelineno-1-90" href="#__codelineno-1-90"></a><span class="p">};</span>
</code></pre></div>
</details>

<p>En annotant un par un les champs dans la structure KCP, on peut avoir l'impression que l'ensemble du protocole KCP n'est pas très complexe. En analysant le code en détail, nous pouvons tous deux lire et comprendre le protocole KCP. <img alt="😄" class="twemoji" src="https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.1.0/assets/svg/1f604.svg" title=":smile:"></p>
<h2 id="la-mise-en-uvre-de-larq-de-kcp">La mise en œuvre de l'ARQ de KCP</h2>
<p>KCP intrinsèquement un protocole ARQ (Auto Repeat-reQuest, retransmission automatique) visant principalement à assurer une transmission fiable. Ainsi, nous allons d'abord nous concentrer sur la partie ARQ fondamentale de KCP et comment KCP réalise la transmission fiable.</p>
<p>ARQ, comme son nom l'indique, renvoie automatiquement les paquets de données correspondants lorsque nous pensons que la réception par l'autre extrémité a échoué. Cela garantit une transmission fiable grâce à la confirmation de réception et à la retransmission en cas de dépassement de délai. Dans l'implémentation du code spécifique, KCP attribue un identifiant unique "sn" à chaque paquet de données (également mentionné dans la section précédente comme étant un 'SEGMENT'). Une fois que l'autre extrémité reçoit le paquet de données, elle renvoie un paquet ACK (également un 'SEGMENT') avec le même "sn" que celui du paquet reçu, indiquant la réception réussie de ce paquet de données. Le 'SEGMENT' comporte également un champ "una" indiquant le numéro du prochain paquet de données attendu. En d'autres termes, tous les paquets de données avant ce numéro ont déjà été reçus, devenant ainsi un paquet ACK complet. Cela permet à l'émetteur de mettre à jour plus rapidement le tampon d'envoi et la fenêtre d'envoi.</p>
<p>Nous pouvons comprendre les bases de la mise en œuvre de l'ARQ en suivant le code d'envoi et de réception des paquets KCP.</p>
<h3 id="envoyer">Envoyer</h3>
<p>Le processus d'envoi se déroule comme suit : <code>ikcp_send</code> -&gt; <code>ikcp_update</code> -&gt; <code>ikcp_output</code>. L'appel supérieur à <code>ikcp_send</code> transmet les données à KCP, qui les traite pour l'envoi dans <code>ikcp_update</code>.</p>
<details>
<summary> ikcp_send（cliquez pour développer le code） </summary>
<div class="language-cpp highlight"><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a><span class="c1">//---------------------------------------------------------------------</span>
<a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a><span class="c1">// Interface d'envoi de données, l'utilisateur appelle ikcp_send pour permettre à kcp d'envoyer des données</span>
<a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a><span class="c1">// user/upper level send, returns below zero for error</span>
<a id="__codelineno-2-4" name="__codelineno-2-4" href="#__codelineno-2-4"></a><span class="c1">//---------------------------------------------------------------------</span>
<a id="__codelineno-2-5" name="__codelineno-2-5" href="#__codelineno-2-5"></a><span class="kt">int</span><span class="w"> </span><span class="nf">ikcp_send</span><span class="p">(</span><span class="n">ikcpcb</span><span class="w"> </span><span class="o">*</span><span class="n">kcp</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">buffer</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">len</span><span class="p">)</span>
<a id="__codelineno-2-6" name="__codelineno-2-6" href="#__codelineno-2-6"></a><span class="p">{</span>
<a id="__codelineno-2-7" name="__codelineno-2-7" href="#__codelineno-2-7"></a><span class="w">    </span><span class="n">IKCPSEG</span><span class="w"> </span><span class="o">*</span><span class="n">seg</span><span class="p">;</span>
<a id="__codelineno-2-8" name="__codelineno-2-8" href="#__codelineno-2-8"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">count</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">;</span>
<a id="__codelineno-2-9" name="__codelineno-2-9" href="#__codelineno-2-9"></a>
<a id="__codelineno-2-10" name="__codelineno-2-10" href="#__codelineno-2-10"></a><span class="c1">// mss ne peut pas être inférieur à 1</span>
<a id="__codelineno-2-11" name="__codelineno-2-11" href="#__codelineno-2-11"></a><span class="w">    </span><span class="n">assert</span><span class="p">(</span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">mss</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<a id="__codelineno-2-12" name="__codelineno-2-12" href="#__codelineno-2-12"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">len</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span>
<a id="__codelineno-2-13" name="__codelineno-2-13" href="#__codelineno-2-13"></a>
<a id="__codelineno-2-14" name="__codelineno-2-14" href="#__codelineno-2-14"></a><span class="w">    </span><span class="c1">// append to previous segment in streaming mode (if possible)</span>
<a id="__codelineno-2-15" name="__codelineno-2-15" href="#__codelineno-2-15"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">stream</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-2-16" name="__codelineno-2-16" href="#__codelineno-2-16"></a><span class="c1">// Traitement du mode flux</span>
<a id="__codelineno-2-17" name="__codelineno-2-17" href="#__codelineno-2-17"></a><span class="w">        </span><span class="c1">// ......</span>
<a id="__codelineno-2-18" name="__codelineno-2-18" href="#__codelineno-2-18"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-2-19" name="__codelineno-2-19" href="#__codelineno-2-19"></a>
<a id="__codelineno-2-20" name="__codelineno-2-20" href="#__codelineno-2-20"></a><span class="c1">// Calcul des sous-paquets, si la longueur des données len est supérieure à mss, elle doit être divisée en plusieurs paquets pour être envoyée, l'autre partie les assemblera une fois reçus.</span>
<a id="__codelineno-2-21" name="__codelineno-2-21" href="#__codelineno-2-21"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">len</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">mss</span><span class="p">)</span><span class="w"> </span><span class="n">count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<a id="__codelineno-2-22" name="__codelineno-2-22" href="#__codelineno-2-22"></a><span class="w">    </span><span class="k">else</span><span class="w"> </span><span class="n">count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">len</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">mss</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">mss</span><span class="p">;</span>
<a id="__codelineno-2-23" name="__codelineno-2-23" href="#__codelineno-2-23"></a>
<a id="__codelineno-2-24" name="__codelineno-2-24" href="#__codelineno-2-24"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">count</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">IKCP_WND_RCV</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="mi">-2</span><span class="p">;</span>
<a id="__codelineno-2-25" name="__codelineno-2-25" href="#__codelineno-2-25"></a>
<a id="__codelineno-2-26" name="__codelineno-2-26" href="#__codelineno-2-26"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">count</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="n">count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<a id="__codelineno-2-27" name="__codelineno-2-27" href="#__codelineno-2-27"></a>
<a id="__codelineno-2-28" name="__codelineno-2-28" href="#__codelineno-2-28"></a><span class="c1">// Sous-traitance</span>
<a id="__codelineno-2-29" name="__codelineno-2-29" href="#__codelineno-2-29"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">count</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-2-30" name="__codelineno-2-30" href="#__codelineno-2-30"></a><span class="n">Calculer</span><span class="w"> </span><span class="n">la</span><span class="w"> </span><span class="n">longueur</span><span class="w"> </span><span class="n">des</span><span class="w"> </span><span class="n">données</span><span class="w"> </span><span class="n">du</span><span class="w"> </span><span class="n">paquet</span><span class="w"> </span><span class="n">et</span><span class="w"> </span><span class="n">allouer</span><span class="w"> </span><span class="n">la</span><span class="w"> </span><span class="n">structure</span><span class="w"> </span><span class="n">seg</span><span class="w"> </span><span class="n">correspondante</span>
<a id="__codelineno-2-31" name="__codelineno-2-31" href="#__codelineno-2-31"></a><span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">len</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">mss</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">mss</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">len</span><span class="p">;</span>
<a id="__codelineno-2-32" name="__codelineno-2-32" href="#__codelineno-2-32"></a><span class="w">        </span><span class="n">seg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ikcp_segment_new</span><span class="p">(</span><span class="n">kcp</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="p">);</span>
<a id="__codelineno-2-33" name="__codelineno-2-33" href="#__codelineno-2-33"></a><span class="w">        </span><span class="n">assert</span><span class="p">(</span><span class="n">seg</span><span class="p">);</span>
<a id="__codelineno-2-34" name="__codelineno-2-34" href="#__codelineno-2-34"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">seg</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-2-35" name="__codelineno-2-35" href="#__codelineno-2-35"></a><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="mi">-2</span><span class="p">;</span>
<a id="__codelineno-2-36" name="__codelineno-2-36" href="#__codelineno-2-36"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-2-37" name="__codelineno-2-37" href="#__codelineno-2-37"></a>
<a id="__codelineno-2-38" name="__codelineno-2-38" href="#__codelineno-2-38"></a><span class="n">Définir</span><span class="w"> </span><span class="n">les</span><span class="w"> </span><span class="n">informations</span><span class="w"> </span><span class="n">de</span><span class="w"> </span><span class="n">données</span><span class="w"> </span><span class="n">de</span><span class="w"> </span><span class="n">seg</span><span class="p">,</span><span class="w"> </span><span class="n">frg</span><span class="w"> </span><span class="n">représente</span><span class="w"> </span><span class="n">le</span><span class="w"> </span><span class="n">numéro</span><span class="w"> </span><span class="n">de</span><span class="w"> </span><span class="n">fragmentation</span><span class="p">.</span>
<a id="__codelineno-2-39" name="__codelineno-2-39" href="#__codelineno-2-39"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">buffer</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">len</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-2-40" name="__codelineno-2-40" href="#__codelineno-2-40"></a><span class="w">            </span><span class="n">memcpy</span><span class="p">(</span><span class="n">seg</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="n">buffer</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="p">);</span>
<a id="__codelineno-2-41" name="__codelineno-2-41" href="#__codelineno-2-41"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-2-42" name="__codelineno-2-42" href="#__codelineno-2-42"></a><span class="w">        </span><span class="n">seg</span><span class="o">-&gt;</span><span class="n">len</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">size</span><span class="p">;</span>
<a id="__codelineno-2-43" name="__codelineno-2-43" href="#__codelineno-2-43"></a><span class="w">        </span><span class="n">seg</span><span class="o">-&gt;</span><span class="n">frg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">stream</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="o">?</span><span class="w"> </span><span class="p">(</span><span class="n">count</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="__codelineno-2-44" name="__codelineno-2-44" href="#__codelineno-2-44"></a>
<a id="__codelineno-2-45" name="__codelineno-2-45" href="#__codelineno-2-45"></a><span class="w">        </span><span class="c1">// Ajoutez à la fin de snd_queue, nsnd_qua augmente de un</span>
<a id="__codelineno-2-46" name="__codelineno-2-46" href="#__codelineno-2-46"></a><span class="w">        </span><span class="n">iqueue_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">seg</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">);</span>
<a id="__codelineno-2-47" name="__codelineno-2-47" href="#__codelineno-2-47"></a><span class="w">        </span><span class="n">iqueue_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">seg</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">snd_queue</span><span class="p">);</span>
<a id="__codelineno-2-48" name="__codelineno-2-48" href="#__codelineno-2-48"></a><span class="w">        </span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">nsnd_que</span><span class="o">++</span><span class="p">;</span>
<a id="__codelineno-2-49" name="__codelineno-2-49" href="#__codelineno-2-49"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">buffer</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-2-50" name="__codelineno-2-50" href="#__codelineno-2-50"></a><span class="w">            </span><span class="n">buffer</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">size</span><span class="p">;</span>
<a id="__codelineno-2-51" name="__codelineno-2-51" href="#__codelineno-2-51"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-2-52" name="__codelineno-2-52" href="#__codelineno-2-52"></a><span class="w">        </span><span class="n">len</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="n">size</span><span class="p">;</span>
<a id="__codelineno-2-53" name="__codelineno-2-53" href="#__codelineno-2-53"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-2-54" name="__codelineno-2-54" href="#__codelineno-2-54"></a>
<a id="__codelineno-2-55" name="__codelineno-2-55" href="#__codelineno-2-55"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="__codelineno-2-56" name="__codelineno-2-56" href="#__codelineno-2-56"></a><span class="p">}</span>
</code></pre></div>
</details>

<p><code>ikcp_send</code> est l'interface d'envoi de données appelée par le niveau supérieur de KCP. Toutes les données à envoyer via KCP doivent passer par cette interface. Ce que fait <code>ikcp_send</code> est assez simple : il divise les données en plusieurs paquets selon <code>kcp-&gt;mss</code> (longueur maximale des données par paquet), attribue un numéro de sous-paquet, puis place le tout à la fin de la liste d'envoi <code>snd_queue</code>. En mode flux, les données provenant de plusieurs appels à <code>ikcp_send</code> sont considérées comme un flux unique, remplissant d'abord automatiquement les <code>SEGMENT</code> inachevés avant de répartir les nouveaux. Les détails de cette mise en œuvre ne seront pas discutés ici, mais ceux qui sont intéressés peuvent, après avoir lu cet article, se référer au code correspondant pour mieux comprendre.</p>
<p>Après l'appel à <code>ikcp_send</code>, les données sont placées dans la <code>snd_queue</code> de KCP. Ensuite, KCP doit trouver un moment pour envoyer les données en attente d'envoi ; tout ce code se trouve dans <code>ikcp_update</code> et <code>ikcp_flush</code>.</p>
<details>
<summary> ikcp_mise_à_jour（Cliquez pour développer le code） </summary>
<div class="language-cpp highlight"><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a><span class="c1">//---------------------------------------------------------------------</span>
<a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a><span class="c1">// ikcp_update est une interface appelée périodiquement par le niveau supérieur, utilisée pour mettre à jour l'état de kcp et envoyer des données.</span>
<a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a><span class="c1">// update state (call it repeatedly, every 10ms-100ms), or you can ask </span>
<a id="__codelineno-3-4" name="__codelineno-3-4" href="#__codelineno-3-4"></a><span class="c1">// ikcp_check when to call it again (without ikcp_input/_send calling).</span>
<a id="__codelineno-3-5" name="__codelineno-3-5" href="#__codelineno-3-5"></a><span class="c1">// 'current' - current timestamp in millisec. </span>
<a id="__codelineno-3-6" name="__codelineno-3-6" href="#__codelineno-3-6"></a><span class="c1">//---------------------------------------------------------------------</span>
<a id="__codelineno-3-7" name="__codelineno-3-7" href="#__codelineno-3-7"></a><span class="kt">void</span><span class="w"> </span><span class="nf">ikcp_update</span><span class="p">(</span><span class="n">ikcpcb</span><span class="w"> </span><span class="o">*</span><span class="n">kcp</span><span class="p">,</span><span class="w"> </span><span class="n">IUINT32</span><span class="w"> </span><span class="n">current</span><span class="p">)</span>
<a id="__codelineno-3-8" name="__codelineno-3-8" href="#__codelineno-3-8"></a><span class="p">{</span>
<a id="__codelineno-3-9" name="__codelineno-3-9" href="#__codelineno-3-9"></a><span class="w">    </span><span class="n">IINT32</span><span class="w"> </span><span class="n">slap</span><span class="p">;</span>
<a id="__codelineno-3-10" name="__codelineno-3-10" href="#__codelineno-3-10"></a>
<a id="__codelineno-3-11" name="__codelineno-3-11" href="#__codelineno-3-11"></a><span class="w">    </span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">current</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">current</span><span class="p">;</span>
<a id="__codelineno-3-12" name="__codelineno-3-12" href="#__codelineno-3-12"></a>
<a id="__codelineno-3-13" name="__codelineno-3-13" href="#__codelineno-3-13"></a><span class="c1">// ikcp_flush vérifiera cela, la couche supérieure doit avoir appelé ikcp_update avant de pouvoir appeler ikcp_flush, il est conseillé d'utiliser uniquement ikcp_update.</span>
<a id="__codelineno-3-14" name="__codelineno-3-14" href="#__codelineno-3-14"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">updated</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-3-15" name="__codelineno-3-15" href="#__codelineno-3-15"></a><span class="w">        </span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">updated</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<a id="__codelineno-3-16" name="__codelineno-3-16" href="#__codelineno-3-16"></a><span class="w">        </span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">ts_flush</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">current</span><span class="p">;</span>
<a id="__codelineno-3-17" name="__codelineno-3-17" href="#__codelineno-3-17"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-3-18" name="__codelineno-3-18" href="#__codelineno-3-18"></a>
<a id="__codelineno-3-19" name="__codelineno-3-19" href="#__codelineno-3-19"></a><span class="w">    </span><span class="n">slap</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_itimediff</span><span class="p">(</span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">current</span><span class="p">,</span><span class="w"> </span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">ts_flush</span><span class="p">);</span>
<a id="__codelineno-3-20" name="__codelineno-3-20" href="#__codelineno-3-20"></a>
<a id="__codelineno-3-21" name="__codelineno-3-21" href="#__codelineno-3-21"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">slap</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">10000</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">slap</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">-10000</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-3-22" name="__codelineno-3-22" href="#__codelineno-3-22"></a><span class="w">        </span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">ts_flush</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">current</span><span class="p">;</span>
<a id="__codelineno-3-23" name="__codelineno-3-23" href="#__codelineno-3-23"></a><span class="w">        </span><span class="n">slap</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="__codelineno-3-24" name="__codelineno-3-24" href="#__codelineno-3-24"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-3-25" name="__codelineno-3-25" href="#__codelineno-3-25"></a>
<a id="__codelineno-3-26" name="__codelineno-3-26" href="#__codelineno-3-26"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">slap</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-3-27" name="__codelineno-3-27" href="#__codelineno-3-27"></a><span class="c1">// Le temps de la prochaine exécution flush</span>
<a id="__codelineno-3-28" name="__codelineno-3-28" href="#__codelineno-3-28"></a><span class="w">        </span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">ts_flush</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">interval</span><span class="p">;</span>
<a id="__codelineno-3-29" name="__codelineno-3-29" href="#__codelineno-3-29"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">_itimediff</span><span class="p">(</span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">current</span><span class="p">,</span><span class="w"> </span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">ts_flush</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-3-30" name="__codelineno-3-30" href="#__codelineno-3-30"></a><span class="w">            </span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">ts_flush</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">current</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">interval</span><span class="p">;</span>
<a id="__codelineno-3-31" name="__codelineno-3-31" href="#__codelineno-3-31"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-3-32" name="__codelineno-3-32" href="#__codelineno-3-32"></a><span class="w">        </span><span class="n">ikcp_flush</span><span class="p">(</span><span class="n">kcp</span><span class="p">);</span>
<a id="__codelineno-3-33" name="__codelineno-3-33" href="#__codelineno-3-33"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-3-34" name="__codelineno-3-34" href="#__codelineno-3-34"></a><span class="p">}</span>
</code></pre></div>
</details>

<p><code>ikcp_update</code> fait des choses très simples, il vérifie le temps de <code>ts_flush</code>, si les conditions sont remplies alors il appelle <code>ikcp_flush</code>. La principale logique de traitement se trouve dans <code>ikcp_flush</code>, car le contenu de <code>ikcp_flush</code> est un peu plus complexe, nous nous concentrons actuellement uniquement sur la partie liée à l'envoi ARQ :</p>
<details>
<summary> Envoyer des données (cliquez pour afficher le code) </summary>
<div class="language-cpp highlight"><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a><span class="c1">//---------------------------------------------------------------------</span>
<a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a><span class="c1">// ikcp_flush</span>
<a id="__codelineno-4-3" name="__codelineno-4-3" href="#__codelineno-4-3"></a><span class="c1">//---------------------------------------------------------------------</span>
<a id="__codelineno-4-4" name="__codelineno-4-4" href="#__codelineno-4-4"></a><span class="kt">void</span><span class="w"> </span><span class="nf">ikcp_flush</span><span class="p">(</span><span class="n">ikcpcb</span><span class="w"> </span><span class="o">*</span><span class="n">kcp</span><span class="p">)</span>
<a id="__codelineno-4-5" name="__codelineno-4-5" href="#__codelineno-4-5"></a><span class="p">{</span>
<a id="__codelineno-4-6" name="__codelineno-4-6" href="#__codelineno-4-6"></a><span class="w">    </span><span class="n">IUINT32</span><span class="w"> </span><span class="n">current</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">current</span><span class="p">;</span>
<a id="__codelineno-4-7" name="__codelineno-4-7" href="#__codelineno-4-7"></a>
<a id="__codelineno-4-8" name="__codelineno-4-8" href="#__codelineno-4-8"></a><span class="c1">// Le tampon est une donnée à transmettre à ikcp_output, initialisé à 3 fois la taille du paquet de données.</span>
<a id="__codelineno-4-9" name="__codelineno-4-9" href="#__codelineno-4-9"></a><span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">buffer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">;</span>
<a id="__codelineno-4-10" name="__codelineno-4-10" href="#__codelineno-4-10"></a><span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">ptr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">buffer</span><span class="p">;</span>
<a id="__codelineno-4-11" name="__codelineno-4-11" href="#__codelineno-4-11"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">count</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">;</span>
<a id="__codelineno-4-12" name="__codelineno-4-12" href="#__codelineno-4-12"></a><span class="w">    </span><span class="n">IUINT32</span><span class="w"> </span><span class="n">resent</span><span class="p">,</span><span class="w"> </span><span class="n">cwnd</span><span class="p">;</span>
<a id="__codelineno-4-13" name="__codelineno-4-13" href="#__codelineno-4-13"></a><span class="w">    </span><span class="n">IUINT32</span><span class="w"> </span><span class="n">rtomin</span><span class="p">;</span>
<a id="__codelineno-4-14" name="__codelineno-4-14" href="#__codelineno-4-14"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">IQUEUEHEAD</span><span class="w"> </span><span class="o">*</span><span class="n">p</span><span class="p">;</span>
<a id="__codelineno-4-15" name="__codelineno-4-15" href="#__codelineno-4-15"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">change</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="__codelineno-4-16" name="__codelineno-4-16" href="#__codelineno-4-16"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">lost</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="__codelineno-4-17" name="__codelineno-4-17" href="#__codelineno-4-17"></a><span class="w">    </span><span class="n">IKCPSEG</span><span class="w"> </span><span class="n">seg</span><span class="p">;</span>
<a id="__codelineno-4-18" name="__codelineno-4-18" href="#__codelineno-4-18"></a>
<a id="__codelineno-4-19" name="__codelineno-4-19" href="#__codelineno-4-19"></a><span class="w">    </span><span class="c1">// 'ikcp_update' haven't been called.</span>
<a id="__codelineno-4-20" name="__codelineno-4-20" href="#__codelineno-4-20"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">updated</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="p">;</span>
<a id="__codelineno-4-21" name="__codelineno-4-21" href="#__codelineno-4-21"></a>
<a id="__codelineno-4-22" name="__codelineno-4-22" href="#__codelineno-4-22"></a><span class="w">    </span><span class="n">seg</span><span class="p">.</span><span class="n">conv</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">conv</span><span class="p">;</span>
<a id="__codelineno-4-23" name="__codelineno-4-23" href="#__codelineno-4-23"></a><span class="w">    </span><span class="n">seg</span><span class="p">.</span><span class="n">cmd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">IKCP_CMD_ACK</span><span class="p">;</span>
<a id="__codelineno-4-24" name="__codelineno-4-24" href="#__codelineno-4-24"></a><span class="w">    </span><span class="n">seg</span><span class="p">.</span><span class="n">frg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="__codelineno-4-25" name="__codelineno-4-25" href="#__codelineno-4-25"></a>
<a id="__codelineno-4-26" name="__codelineno-4-26" href="#__codelineno-4-26"></a><span class="c1">// seg.wnd représente la taille actuelle de la fenêtre réceptrice.</span>
<a id="__codelineno-4-27" name="__codelineno-4-27" href="#__codelineno-4-27"></a><span class="w">    </span><span class="n">seg</span><span class="p">.</span><span class="n">wnd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ikcp_wnd_unused</span><span class="p">(</span><span class="n">kcp</span><span class="p">);</span>
<a id="__codelineno-4-28" name="__codelineno-4-28" href="#__codelineno-4-28"></a><span class="w">    </span><span class="n">seg</span><span class="p">.</span><span class="n">una</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">rcv_nxt</span><span class="p">;</span>
<a id="__codelineno-4-29" name="__codelineno-4-29" href="#__codelineno-4-29"></a><span class="w">    </span><span class="n">seg</span><span class="p">.</span><span class="n">len</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="__codelineno-4-30" name="__codelineno-4-30" href="#__codelineno-4-30"></a><span class="w">    </span><span class="n">seg</span><span class="p">.</span><span class="n">sn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="__codelineno-4-31" name="__codelineno-4-31" href="#__codelineno-4-31"></a><span class="w">    </span><span class="n">seg</span><span class="p">.</span><span class="n">ts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="__codelineno-4-32" name="__codelineno-4-32" href="#__codelineno-4-32"></a>
<a id="__codelineno-4-33" name="__codelineno-4-33" href="#__codelineno-4-33"></a><span class="c1">// Envoyer un accusé de réception</span>
<a id="__codelineno-4-34" name="__codelineno-4-34" href="#__codelineno-4-34"></a><span class="n">Calcul</span><span class="w"> </span><span class="n">de</span><span class="w"> </span><span class="n">la</span><span class="w"> </span><span class="n">fenêtre</span><span class="w"> </span><span class="n">d</span><span class="err">'</span><span class="n">envoi</span>
<a id="__codelineno-4-35" name="__codelineno-4-35" href="#__codelineno-4-35"></a><span class="w">    </span><span class="c1">//...</span>
<a id="__codelineno-4-36" name="__codelineno-4-36" href="#__codelineno-4-36"></a>
<a id="__codelineno-4-37" name="__codelineno-4-37" href="#__codelineno-4-37"></a><span class="c1">// Déplacer le paquet de données de snd_queue vers snd_buf</span>
<a id="__codelineno-4-38" name="__codelineno-4-38" href="#__codelineno-4-38"></a><span class="n">Le</span><span class="w"> </span><span class="n">déplacement</span><span class="w"> </span><span class="n">nécessite</span><span class="w"> </span><span class="n">de</span><span class="w"> </span><span class="n">respecter</span><span class="w"> </span><span class="n">la</span><span class="w"> </span><span class="n">taille</span><span class="w"> </span><span class="n">de</span><span class="w"> </span><span class="n">la</span><span class="w"> </span><span class="n">fenêtre</span><span class="w"> </span><span class="n">d</span><span class="err">'</span><span class="n">envoi</span><span class="p">.</span><span class="w"> </span><span class="n">Lorsque</span><span class="w"> </span><span class="n">la</span><span class="w"> </span><span class="n">fenêtre</span><span class="w"> </span><span class="n">d</span><span class="err">'</span><span class="n">envoi</span><span class="w"> </span><span class="n">est</span><span class="w"> </span><span class="n">pleine</span><span class="p">,</span><span class="w"> </span><span class="n">le</span><span class="w"> </span><span class="n">déplacement</span><span class="w"> </span><span class="n">s</span><span class="err">'</span><span class="n">arrête</span><span class="p">.</span>
<a id="__codelineno-4-39" name="__codelineno-4-39" href="#__codelineno-4-39"></a><span class="c1">// Les données placées à l'intérieur de snd_buf sont celles que vous pouvez directement envoyer à l'autre partie en appelant ikcp_output.</span>
<a id="__codelineno-4-40" name="__codelineno-4-40" href="#__codelineno-4-40"></a><span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">_itimediff</span><span class="p">(</span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">snd_nxt</span><span class="p">,</span><span class="w"> </span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">snd_una</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">cwnd</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-4-41" name="__codelineno-4-41" href="#__codelineno-4-41"></a><span class="w">        </span><span class="n">IKCPSEG</span><span class="w"> </span><span class="o">*</span><span class="n">newseg</span><span class="p">;</span>
<a id="__codelineno-4-42" name="__codelineno-4-42" href="#__codelineno-4-42"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">iqueue_is_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">snd_queue</span><span class="p">))</span><span class="w"> </span><span class="k">break</span><span class="p">;</span>
<a id="__codelineno-4-43" name="__codelineno-4-43" href="#__codelineno-4-43"></a>
<a id="__codelineno-4-44" name="__codelineno-4-44" href="#__codelineno-4-44"></a><span class="w">        </span><span class="n">newseg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iqueue_entry</span><span class="p">(</span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">snd_queue</span><span class="p">.</span><span class="n">next</span><span class="p">,</span><span class="w"> </span><span class="n">IKCPSEG</span><span class="p">,</span><span class="w"> </span><span class="n">node</span><span class="p">);</span>
<a id="__codelineno-4-45" name="__codelineno-4-45" href="#__codelineno-4-45"></a>
<a id="__codelineno-4-46" name="__codelineno-4-46" href="#__codelineno-4-46"></a><span class="w">        </span><span class="n">iqueue_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">newseg</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">);</span>
<a id="__codelineno-4-47" name="__codelineno-4-47" href="#__codelineno-4-47"></a><span class="w">        </span><span class="n">iqueue_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">newseg</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">snd_buf</span><span class="p">);</span>
<a id="__codelineno-4-48" name="__codelineno-4-48" href="#__codelineno-4-48"></a><span class="w">        </span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">nsnd_que</span><span class="o">--</span><span class="p">;</span>
<a id="__codelineno-4-49" name="__codelineno-4-49" href="#__codelineno-4-49"></a><span class="w">        </span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">nsnd_buf</span><span class="o">++</span><span class="p">;</span>
<a id="__codelineno-4-50" name="__codelineno-4-50" href="#__codelineno-4-50"></a>
<a id="__codelineno-4-51" name="__codelineno-4-51" href="#__codelineno-4-51"></a><span class="w">        </span><span class="n">newseg</span><span class="o">-&gt;</span><span class="n">conv</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">conv</span><span class="p">;</span>
<a id="__codelineno-4-52" name="__codelineno-4-52" href="#__codelineno-4-52"></a><span class="w">        </span><span class="n">newseg</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">IKCP_CMD_PUSH</span><span class="p">;</span>
<a id="__codelineno-4-53" name="__codelineno-4-53" href="#__codelineno-4-53"></a><span class="w">        </span><span class="n">newseg</span><span class="o">-&gt;</span><span class="n">wnd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">seg</span><span class="p">.</span><span class="n">wnd</span><span class="p">;</span>
<a id="__codelineno-4-54" name="__codelineno-4-54" href="#__codelineno-4-54"></a><span class="w">        </span><span class="n">newseg</span><span class="o">-&gt;</span><span class="n">ts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">current</span><span class="p">;</span>
<a id="__codelineno-4-55" name="__codelineno-4-55" href="#__codelineno-4-55"></a>
<a id="__codelineno-4-56" name="__codelineno-4-56" href="#__codelineno-4-56"></a><span class="c1">// seg is a unique identifier, essentially an increasing kcp-&gt;snd_nxt.</span>
<a id="__codelineno-4-57" name="__codelineno-4-57" href="#__codelineno-4-57"></a><span class="w">        </span><span class="n">newseg</span><span class="o">-&gt;</span><span class="n">sn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">snd_nxt</span><span class="o">++</span><span class="p">;</span>
<a id="__codelineno-4-58" name="__codelineno-4-58" href="#__codelineno-4-58"></a>
<a id="__codelineno-4-59" name="__codelineno-4-59" href="#__codelineno-4-59"></a><span class="c1">// La variable una est définie ici pour informer l'autre extrémité du prochain numéro de séquence du paquet à recevoir.</span>
<a id="__codelineno-4-60" name="__codelineno-4-60" href="#__codelineno-4-60"></a><span class="w">        </span><span class="n">newseg</span><span class="o">-&gt;</span><span class="n">una</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">rcv_nxt</span><span class="p">;</span>
<a id="__codelineno-4-61" name="__codelineno-4-61" href="#__codelineno-4-61"></a><span class="w">        </span><span class="n">newseg</span><span class="o">-&gt;</span><span class="n">resendts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">current</span><span class="p">;</span>
<a id="__codelineno-4-62" name="__codelineno-4-62" href="#__codelineno-4-62"></a><span class="w">        </span><span class="n">newseg</span><span class="o">-&gt;</span><span class="n">rto</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">rx_rto</span><span class="p">;</span>
<a id="__codelineno-4-63" name="__codelineno-4-63" href="#__codelineno-4-63"></a><span class="w">        </span><span class="n">newseg</span><span class="o">-&gt;</span><span class="n">fastack</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="__codelineno-4-64" name="__codelineno-4-64" href="#__codelineno-4-64"></a><span class="w">        </span><span class="n">newseg</span><span class="o">-&gt;</span><span class="n">xmit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="__codelineno-4-65" name="__codelineno-4-65" href="#__codelineno-4-65"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-4-66" name="__codelineno-4-66" href="#__codelineno-4-66"></a>
<a id="__codelineno-4-67" name="__codelineno-4-67" href="#__codelineno-4-67"></a><span class="c1">// Calcul de l'indicateur de retransmission rapide, temps d'attente d'expiration</span>
<a id="__codelineno-4-68" name="__codelineno-4-68" href="#__codelineno-4-68"></a><span class="w">    </span><span class="c1">// ...</span>
<a id="__codelineno-4-69" name="__codelineno-4-69" href="#__codelineno-4-69"></a>
<a id="__codelineno-4-70" name="__codelineno-4-70" href="#__codelineno-4-70"></a><span class="c1">// Envoyer snd_buf</span>
<a id="__codelineno-4-71" name="__codelineno-4-71" href="#__codelineno-4-71"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">snd_buf</span><span class="p">.</span><span class="n">next</span><span class="p">;</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">snd_buf</span><span class="p">;</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">p</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-4-72" name="__codelineno-4-72" href="#__codelineno-4-72"></a><span class="w">        </span><span class="n">IKCPSEG</span><span class="w"> </span><span class="o">*</span><span class="n">segment</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iqueue_entry</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="n">IKCPSEG</span><span class="p">,</span><span class="w"> </span><span class="n">node</span><span class="p">);</span>
<a id="__codelineno-4-73" name="__codelineno-4-73" href="#__codelineno-4-73"></a><span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">needsend</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="__codelineno-4-74" name="__codelineno-4-74" href="#__codelineno-4-74"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">segment</span><span class="o">-&gt;</span><span class="n">xmit</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-4-75" name="__codelineno-4-75" href="#__codelineno-4-75"></a><span class="c1">// Première envoi</span>
<a id="__codelineno-4-76" name="__codelineno-4-76" href="#__codelineno-4-76"></a><span class="c1">// set-&gt;xmit représente le nombre d'envois</span>
<a id="__codelineno-4-77" name="__codelineno-4-77" href="#__codelineno-4-77"></a><span class="c1">// Le temps d'attente pour la retransmission en cas de dépassement du délai</span>
<a id="__codelineno-4-78" name="__codelineno-4-78" href="#__codelineno-4-78"></a><span class="w">            </span><span class="n">needsend</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<a id="__codelineno-4-79" name="__codelineno-4-79" href="#__codelineno-4-79"></a><span class="w">            </span><span class="n">segment</span><span class="o">-&gt;</span><span class="n">xmit</span><span class="o">++</span><span class="p">;</span>
<a id="__codelineno-4-80" name="__codelineno-4-80" href="#__codelineno-4-80"></a><span class="w">            </span><span class="n">segment</span><span class="o">-&gt;</span><span class="n">rto</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">rx_rto</span><span class="p">;</span>
<a id="__codelineno-4-81" name="__codelineno-4-81" href="#__codelineno-4-81"></a><span class="w">            </span><span class="n">segment</span><span class="o">-&gt;</span><span class="n">resendts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">current</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">segment</span><span class="o">-&gt;</span><span class="n">rto</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">rtomin</span><span class="p">;</span>
<a id="__codelineno-4-82" name="__codelineno-4-82" href="#__codelineno-4-82"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-4-83" name="__codelineno-4-83" href="#__codelineno-4-83"></a><span class="w">        </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">_itimediff</span><span class="p">(</span><span class="n">current</span><span class="p">,</span><span class="w"> </span><span class="n">segment</span><span class="o">-&gt;</span><span class="n">resendts</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-4-84" name="__codelineno-4-84" href="#__codelineno-4-84"></a><span class="n">Re</span><span class="o">-</span><span class="n">transmission</span><span class="w"> </span><span class="n">en</span><span class="w"> </span><span class="n">cas</span><span class="w"> </span><span class="n">de</span><span class="w"> </span><span class="n">dépassement</span><span class="w"> </span><span class="n">du</span><span class="w"> </span><span class="n">délai</span>
<a id="__codelineno-4-85" name="__codelineno-4-85" href="#__codelineno-4-85"></a><span class="w">            </span><span class="c1">// ...</span>
<a id="__codelineno-4-86" name="__codelineno-4-86" href="#__codelineno-4-86"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-4-87" name="__codelineno-4-87" href="#__codelineno-4-87"></a><span class="w">        </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">segment</span><span class="o">-&gt;</span><span class="n">fastack</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">resent</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-4-88" name="__codelineno-4-88" href="#__codelineno-4-88"></a><span class="n">Requête</span><span class="w"> </span><span class="n">de</span><span class="w"> </span><span class="n">retransmission</span><span class="w"> </span><span class="n">rapide</span>
<a id="__codelineno-4-89" name="__codelineno-4-89" href="#__codelineno-4-89"></a><span class="w">            </span><span class="c1">// ...</span>
<a id="__codelineno-4-90" name="__codelineno-4-90" href="#__codelineno-4-90"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-4-91" name="__codelineno-4-91" href="#__codelineno-4-91"></a>
<a id="__codelineno-4-92" name="__codelineno-4-92" href="#__codelineno-4-92"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">needsend</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-4-93" name="__codelineno-4-93" href="#__codelineno-4-93"></a><span class="w">            </span><span class="kt">int</span><span class="w"> </span><span class="n">need</span><span class="p">;</span>
<a id="__codelineno-4-94" name="__codelineno-4-94" href="#__codelineno-4-94"></a><span class="w">            </span><span class="n">segment</span><span class="o">-&gt;</span><span class="n">ts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">current</span><span class="p">;</span>
<a id="__codelineno-4-95" name="__codelineno-4-95" href="#__codelineno-4-95"></a><span class="w">            </span><span class="n">segment</span><span class="o">-&gt;</span><span class="n">wnd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">seg</span><span class="p">.</span><span class="n">wnd</span><span class="p">;</span>
<a id="__codelineno-4-96" name="__codelineno-4-96" href="#__codelineno-4-96"></a><span class="w">            </span><span class="n">segment</span><span class="o">-&gt;</span><span class="n">una</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">rcv_nxt</span><span class="p">;</span>
<a id="__codelineno-4-97" name="__codelineno-4-97" href="#__codelineno-4-97"></a>
<a id="__codelineno-4-98" name="__codelineno-4-98" href="#__codelineno-4-98"></a><span class="w">            </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="n">ptr</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">buffer</span><span class="p">);</span>
<a id="__codelineno-4-99" name="__codelineno-4-99" href="#__codelineno-4-99"></a><span class="w">            </span><span class="n">need</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">IKCP_OVERHEAD</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">segment</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
<a id="__codelineno-4-100" name="__codelineno-4-100" href="#__codelineno-4-100"></a>
<a id="__codelineno-4-101" name="__codelineno-4-101" href="#__codelineno-4-101"></a><span class="c1">// Chaque fois que les données dans le buffer dépassent le mtu, il faut les envoyer tout de suite, en essayant d'éviter le découpage au niveau inférieur.</span>
<a id="__codelineno-4-102" name="__codelineno-4-102" href="#__codelineno-4-102"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">size</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">need</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">mtu</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-4-103" name="__codelineno-4-103" href="#__codelineno-4-103"></a><span class="w">                </span><span class="n">ikcp_output</span><span class="p">(</span><span class="n">kcp</span><span class="p">,</span><span class="w"> </span><span class="n">buffer</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="p">);</span>
<a id="__codelineno-4-104" name="__codelineno-4-104" href="#__codelineno-4-104"></a><span class="w">                </span><span class="n">ptr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">buffer</span><span class="p">;</span>
<a id="__codelineno-4-105" name="__codelineno-4-105" href="#__codelineno-4-105"></a><span class="w">            </span><span class="p">}</span>
<a id="__codelineno-4-106" name="__codelineno-4-106" href="#__codelineno-4-106"></a>
<a id="__codelineno-4-107" name="__codelineno-4-107" href="#__codelineno-4-107"></a><span class="c1">// Copiez les données de contrôle seg dans le tampon, kcp gère lui-même les problèmes de endianess.</span>
<a id="__codelineno-4-108" name="__codelineno-4-108" href="#__codelineno-4-108"></a><span class="w">            </span><span class="n">ptr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ikcp_encode_seg</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span><span class="w"> </span><span class="n">segment</span><span class="p">);</span>
<a id="__codelineno-4-109" name="__codelineno-4-109" href="#__codelineno-4-109"></a>
<a id="__codelineno-4-110" name="__codelineno-4-110" href="#__codelineno-4-110"></a><span class="c1">// Copie des données à nouveau</span>
<a id="__codelineno-4-111" name="__codelineno-4-111" href="#__codelineno-4-111"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">segment</span><span class="o">-&gt;</span><span class="n">len</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-4-112" name="__codelineno-4-112" href="#__codelineno-4-112"></a><span class="w">                </span><span class="n">memcpy</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span><span class="w"> </span><span class="n">segment</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="n">segment</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
<a id="__codelineno-4-113" name="__codelineno-4-113" href="#__codelineno-4-113"></a><span class="w">                </span><span class="n">ptr</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">segment</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
<a id="__codelineno-4-114" name="__codelineno-4-114" href="#__codelineno-4-114"></a><span class="w">            </span><span class="p">}</span>
<a id="__codelineno-4-115" name="__codelineno-4-115" href="#__codelineno-4-115"></a>
<a id="__codelineno-4-116" name="__codelineno-4-116" href="#__codelineno-4-116"></a>
<a id="__codelineno-4-117" name="__codelineno-4-117" href="#__codelineno-4-117"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">segment</span><span class="o">-&gt;</span><span class="n">xmit</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">dead_link</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-4-118" name="__codelineno-4-118" href="#__codelineno-4-118"></a><span class="w">                </span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">IUINT32</span><span class="p">)</span><span class="mi">-1</span><span class="p">;</span>
<a id="__codelineno-4-119" name="__codelineno-4-119" href="#__codelineno-4-119"></a><span class="w">            </span><span class="p">}</span>
<a id="__codelineno-4-120" name="__codelineno-4-120" href="#__codelineno-4-120"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-4-121" name="__codelineno-4-121" href="#__codelineno-4-121"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-4-122" name="__codelineno-4-122" href="#__codelineno-4-122"></a>
<a id="__codelineno-4-123" name="__codelineno-4-123" href="#__codelineno-4-123"></a><span class="w">    </span><span class="c1">// flash remain segments</span>
<a id="__codelineno-4-124" name="__codelineno-4-124" href="#__codelineno-4-124"></a><span class="w">    </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="n">ptr</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">buffer</span><span class="p">);</span>
<a id="__codelineno-4-125" name="__codelineno-4-125" href="#__codelineno-4-125"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">size</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-4-126" name="__codelineno-4-126" href="#__codelineno-4-126"></a><span class="w">        </span><span class="n">ikcp_output</span><span class="p">(</span><span class="n">kcp</span><span class="p">,</span><span class="w"> </span><span class="n">buffer</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="p">);</span>
<a id="__codelineno-4-127" name="__codelineno-4-127" href="#__codelineno-4-127"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-4-128" name="__codelineno-4-128" href="#__codelineno-4-128"></a>
<a id="__codelineno-4-129" name="__codelineno-4-129" href="#__codelineno-4-129"></a><span class="n">Calculer</span><span class="w"> </span><span class="n">le</span><span class="w"> </span><span class="n">seuil</span><span class="w"> </span><span class="n">ssthresh</span><span class="p">,</span><span class="w"> </span><span class="n">mettre</span><span class="w"> </span><span class="n">à</span><span class="w"> </span><span class="n">jour</span><span class="w"> </span><span class="n">la</span><span class="w"> </span><span class="n">taille</span><span class="w"> </span><span class="n">de</span><span class="w"> </span><span class="n">la</span><span class="w"> </span><span class="n">fenêtre</span><span class="w"> </span><span class="n">de</span><span class="w"> </span><span class="n">congestion</span><span class="w"> </span><span class="n">lente</span><span class="p">.</span>
<a id="__codelineno-4-130" name="__codelineno-4-130" href="#__codelineno-4-130"></a><span class="w">    </span><span class="c1">// ...</span>
<a id="__codelineno-4-131" name="__codelineno-4-131" href="#__codelineno-4-131"></a><span class="p">}</span>
</code></pre></div>
</details>

<p>Nous nous concentrons actuellement uniquement sur la logique d'envoi de données dans <code>ikcp_flush</code> :</p>
<p>Tout d'abord, KCP déplacera les données de <code>snd_queue</code> vers <code>snd_buf</code> en fonction de la taille de la fenêtre de réception de l'autre côté. La formule pour calculer le nombre de déplacements est <code>num = snd_nxt - (snd_una + cwnd)</code>, c'est-à-dire : si le numéro de séquence du maximum de paquets envoyés avec succès <code>snd_una</code> ajouté à la taille de la fenêtre glissante <code>cwnd</code> est supérieur au prochain numéro de paquet à envoyer <code>snd_nxt</code>, alors il est possible de continuer à envoyer de nouveaux paquets de données. En déplaçant le <code>SEG</code>, les champs de contrôle sont également définis.</p>
<ul>
<li>Parcourez <code>snd_buf</code>, si un paquet de données doit être envoyé, copiez les données dans <code>buffer</code>, tout en utilisant <code>ikcp_encode_seg</code> pour traiter les problèmes d'endianness des données de champ de contrôle.</li>
</ul>
<ul>
<li>Enfin, appelez <code>ikcp_output</code> pour envoyer les données du <code>buffer</code>.</li>
</ul>
<p>Jusqu'ici, KCP a terminé l'envoi des données.</p>
<h3 id="reception">Réception</h3>
<p>Le processus de réception est l'opposé de celui de l'envoi : <code>ikcp_input</code> -&gt; <code>ikcp_update</code> -&gt; <code>ikcp_recv</code>. Après que l'utilisateur ait reçu des données sur le réseau, il doit appeler <code>ikcp_input</code> pour les transmettre à KCP pour analyse. Lors de l'appel de <code>ikcp_update</code>, un paquet ACK est renvoyé à l'expéditeur. Le niveau supérieur reçoit les données après analyse par KCP en appelant <code>ikcp_recv</code>.</p>
<details>
<summary> Recevoir des données (cliquez pour développer le code) </summary>
<div class="language-cpp highlight"><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a><span class="c1">//---------------------------------------------------------------------</span>
<a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a><span class="c1">// input data</span>
<a id="__codelineno-5-3" name="__codelineno-5-3" href="#__codelineno-5-3"></a><span class="c1">//---------------------------------------------------------------------</span>
<a id="__codelineno-5-4" name="__codelineno-5-4" href="#__codelineno-5-4"></a><span class="kt">int</span><span class="w"> </span><span class="nf">ikcp_input</span><span class="p">(</span><span class="n">ikcpcb</span><span class="w"> </span><span class="o">*</span><span class="n">kcp</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">size</span><span class="p">)</span>
<a id="__codelineno-5-5" name="__codelineno-5-5" href="#__codelineno-5-5"></a><span class="p">{</span>
<a id="__codelineno-5-6" name="__codelineno-5-6" href="#__codelineno-5-6"></a><span class="w">    </span><span class="n">IUINT32</span><span class="w"> </span><span class="n">prev_una</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">snd_una</span><span class="p">;</span>
<a id="__codelineno-5-7" name="__codelineno-5-7" href="#__codelineno-5-7"></a><span class="w">    </span><span class="n">IUINT32</span><span class="w"> </span><span class="n">maxack</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">latest_ts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="__codelineno-5-8" name="__codelineno-5-8" href="#__codelineno-5-8"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">flag</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="__codelineno-5-9" name="__codelineno-5-9" href="#__codelineno-5-9"></a>
<a id="__codelineno-5-10" name="__codelineno-5-10" href="#__codelineno-5-10"></a><span class="c1">// Vérification de légalité</span>
<a id="__codelineno-5-11" name="__codelineno-5-11" href="#__codelineno-5-11"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">data</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">NULL</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">size</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">IKCP_OVERHEAD</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span>
<a id="__codelineno-5-12" name="__codelineno-5-12" href="#__codelineno-5-12"></a>
<a id="__codelineno-5-13" name="__codelineno-5-13" href="#__codelineno-5-13"></a><span class="c1">// data peut être plusieurs paquets KCP, traitement en boucle</span>
<a id="__codelineno-5-14" name="__codelineno-5-14" href="#__codelineno-5-14"></a><span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-5-15" name="__codelineno-5-15" href="#__codelineno-5-15"></a><span class="w">        </span><span class="n">IUINT32</span><span class="w"> </span><span class="n">ts</span><span class="p">,</span><span class="w"> </span><span class="n">sn</span><span class="p">,</span><span class="w"> </span><span class="n">len</span><span class="p">,</span><span class="w"> </span><span class="n">una</span><span class="p">,</span><span class="w"> </span><span class="n">conv</span><span class="p">;</span>
<a id="__codelineno-5-16" name="__codelineno-5-16" href="#__codelineno-5-16"></a><span class="w">        </span><span class="n">IUINT16</span><span class="w"> </span><span class="n">wnd</span><span class="p">;</span>
<a id="__codelineno-5-17" name="__codelineno-5-17" href="#__codelineno-5-17"></a><span class="w">        </span><span class="n">IUINT8</span><span class="w"> </span><span class="n">cmd</span><span class="p">,</span><span class="w"> </span><span class="n">frg</span><span class="p">;</span>
<a id="__codelineno-5-18" name="__codelineno-5-18" href="#__codelineno-5-18"></a><span class="w">        </span><span class="n">IKCPSEG</span><span class="w"> </span><span class="o">*</span><span class="n">seg</span><span class="p">;</span>
<a id="__codelineno-5-19" name="__codelineno-5-19" href="#__codelineno-5-19"></a>
<a id="__codelineno-5-20" name="__codelineno-5-20" href="#__codelineno-5-20"></a><span class="c1">// Pas assez d'un paquet KCP, sortie</span>
<a id="__codelineno-5-21" name="__codelineno-5-21" href="#__codelineno-5-21"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">size</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">IKCP_OVERHEAD</span><span class="p">)</span><span class="w"> </span><span class="k">break</span><span class="p">;</span>
<a id="__codelineno-5-22" name="__codelineno-5-22" href="#__codelineno-5-22"></a>
<a id="__codelineno-5-23" name="__codelineno-5-23" href="#__codelineno-5-23"></a><span class="n">D</span><span class="err">'</span><span class="n">abord</span><span class="p">,</span><span class="w"> </span><span class="n">analysez</span><span class="w"> </span><span class="n">les</span><span class="w"> </span><span class="n">champs</span><span class="w"> </span><span class="n">de</span><span class="w"> </span><span class="n">contrôle</span><span class="p">.</span>
<a id="__codelineno-5-24" name="__codelineno-5-24" href="#__codelineno-5-24"></a><span class="w">        </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ikcp_decode32u</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">conv</span><span class="p">);</span>
<a id="__codelineno-5-25" name="__codelineno-5-25" href="#__codelineno-5-25"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">conv</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">conv</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span>
<a id="__codelineno-5-26" name="__codelineno-5-26" href="#__codelineno-5-26"></a>
<a id="__codelineno-5-27" name="__codelineno-5-27" href="#__codelineno-5-27"></a><span class="w">        </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ikcp_decode8u</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>
<a id="__codelineno-5-28" name="__codelineno-5-28" href="#__codelineno-5-28"></a><span class="w">        </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ikcp_decode8u</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">frg</span><span class="p">);</span>
<a id="__codelineno-5-29" name="__codelineno-5-29" href="#__codelineno-5-29"></a><span class="w">        </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ikcp_decode16u</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">wnd</span><span class="p">);</span>
<a id="__codelineno-5-30" name="__codelineno-5-30" href="#__codelineno-5-30"></a><span class="w">        </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ikcp_decode32u</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">ts</span><span class="p">);</span>
<a id="__codelineno-5-31" name="__codelineno-5-31" href="#__codelineno-5-31"></a><span class="w">        </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ikcp_decode32u</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">sn</span><span class="p">);</span>
<a id="__codelineno-5-32" name="__codelineno-5-32" href="#__codelineno-5-32"></a><span class="w">        </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ikcp_decode32u</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">una</span><span class="p">);</span>
<a id="__codelineno-5-33" name="__codelineno-5-33" href="#__codelineno-5-33"></a><span class="w">        </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ikcp_decode32u</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">len</span><span class="p">);</span>
<a id="__codelineno-5-34" name="__codelineno-5-34" href="#__codelineno-5-34"></a>
<a id="__codelineno-5-35" name="__codelineno-5-35" href="#__codelineno-5-35"></a><span class="w">        </span><span class="n">size</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="n">IKCP_OVERHEAD</span><span class="p">;</span>
<a id="__codelineno-5-36" name="__codelineno-5-36" href="#__codelineno-5-36"></a>
<a id="__codelineno-5-37" name="__codelineno-5-37" href="#__codelineno-5-37"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="kt">long</span><span class="p">)</span><span class="n">size</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">len</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">len</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="mi">-2</span><span class="p">;</span>
<a id="__codelineno-5-38" name="__codelineno-5-38" href="#__codelineno-5-38"></a>
<a id="__codelineno-5-39" name="__codelineno-5-39" href="#__codelineno-5-39"></a><span class="n">Vérification</span><span class="w"> </span><span class="n">du</span><span class="w"> </span><span class="n">type</span><span class="w"> </span><span class="n">de</span><span class="w"> </span><span class="n">paquet</span><span class="w"> </span><span class="n">de</span><span class="w"> </span><span class="n">données</span>
<a id="__codelineno-5-40" name="__codelineno-5-40" href="#__codelineno-5-40"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">cmd</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">IKCP_CMD_PUSH</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">cmd</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">IKCP_CMD_ACK</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<a id="__codelineno-5-41" name="__codelineno-5-41" href="#__codelineno-5-41"></a><span class="w">            </span><span class="n">cmd</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">IKCP_CMD_WASK</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">cmd</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">IKCP_CMD_WINS</span><span class="p">)</span><span class="w"> </span>
<a id="__codelineno-5-42" name="__codelineno-5-42" href="#__codelineno-5-42"></a><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="mi">-3</span><span class="p">;</span>
<a id="__codelineno-5-43" name="__codelineno-5-43" href="#__codelineno-5-43"></a>
<a id="__codelineno-5-44" name="__codelineno-5-44" href="#__codelineno-5-44"></a><span class="w">        </span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">rmt_wnd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">wnd</span><span class="p">;</span>
<a id="__codelineno-5-45" name="__codelineno-5-45" href="#__codelineno-5-45"></a>
<a id="__codelineno-5-46" name="__codelineno-5-46" href="#__codelineno-5-46"></a><span class="c1">// Ici, "una" est le kcp-&gt;rcv_nxt de l'expéditeur. À partir de cette donnée, il est possible de supprimer les paquets de données qui ont été reçus et confirmés.</span>
<a id="__codelineno-5-47" name="__codelineno-5-47" href="#__codelineno-5-47"></a><span class="w">        </span><span class="n">ikcp_parse_una</span><span class="p">(</span><span class="n">kcp</span><span class="p">,</span><span class="w"> </span><span class="n">una</span><span class="p">);</span>
<a id="__codelineno-5-48" name="__codelineno-5-48" href="#__codelineno-5-48"></a><span class="c1">// Après avoir supprimé les paquets déjà confirmés comme reçus, mettre à jour le numéro de séquence snd_una du prochain paquet à envoyer.</span>
<a id="__codelineno-5-49" name="__codelineno-5-49" href="#__codelineno-5-49"></a><span class="w">        </span><span class="n">ikcp_shrink_buf</span><span class="p">(</span><span class="n">kcp</span><span class="p">);</span>
<a id="__codelineno-5-50" name="__codelineno-5-50" href="#__codelineno-5-50"></a>
<a id="__codelineno-5-51" name="__codelineno-5-51" href="#__codelineno-5-51"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">cmd</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">IKCP_CMD_ACK</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-5-52" name="__codelineno-5-52" href="#__codelineno-5-52"></a><span class="c1">// paquet ack</span>
<a id="__codelineno-5-53" name="__codelineno-5-53" href="#__codelineno-5-53"></a><span class="w">            </span><span class="c1">// ...</span>
<a id="__codelineno-5-54" name="__codelineno-5-54" href="#__codelineno-5-54"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-5-55" name="__codelineno-5-55" href="#__codelineno-5-55"></a><span class="w">        </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">cmd</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">IKCP_CMD_PUSH</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-5-56" name="__codelineno-5-56" href="#__codelineno-5-56"></a><span class="c1">// Paquet de données</span>
<a id="__codelineno-5-57" name="__codelineno-5-57" href="#__codelineno-5-57"></a><span class="n">Si</span><span class="w"> </span><span class="n">le</span><span class="w"> </span><span class="n">numéro</span><span class="w"> </span><span class="n">de</span><span class="w"> </span><span class="n">séquence</span><span class="w"> </span><span class="n">sn</span><span class="w"> </span><span class="n">des</span><span class="w"> </span><span class="n">paquets</span><span class="w"> </span><span class="n">reçus</span><span class="w"> </span><span class="n">se</span><span class="w"> </span><span class="n">trouve</span><span class="w"> </span><span class="n">dans</span><span class="w"> </span><span class="n">la</span><span class="w"> </span><span class="n">fenêtre</span><span class="w"> </span><span class="n">de</span><span class="w"> </span><span class="n">réception</span><span class="p">,</span><span class="w"> </span><span class="n">il</span><span class="w"> </span><span class="n">est</span><span class="w"> </span><span class="n">traité</span><span class="w"> </span><span class="n">normalement</span><span class="p">.</span><span class="w"> </span><span class="n">Sinon</span><span class="p">,</span><span class="w"> </span><span class="n">il</span><span class="w"> </span><span class="n">est</span><span class="w"> </span><span class="n">simplement</span><span class="w"> </span><span class="n">rejeté</span><span class="w"> </span><span class="n">en</span><span class="w"> </span><span class="n">attendant</span><span class="w"> </span><span class="n">d</span><span class="err">'</span><span class="n">être</span><span class="w"> </span><span class="n">renvoyé</span><span class="p">.</span>
<a id="__codelineno-5-58" name="__codelineno-5-58" href="#__codelineno-5-58"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">_itimediff</span><span class="p">(</span><span class="n">sn</span><span class="p">,</span><span class="w"> </span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">rcv_nxt</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">rcv_wnd</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-5-59" name="__codelineno-5-59" href="#__codelineno-5-59"></a>
<a id="__codelineno-5-60" name="__codelineno-5-60" href="#__codelineno-5-60"></a><span class="n">Chaque</span><span class="w"> </span><span class="n">paquet</span><span class="w"> </span><span class="n">de</span><span class="w"> </span><span class="n">données</span><span class="w"> </span><span class="n">reçu</span><span class="w"> </span><span class="n">doit</span><span class="w"> </span><span class="n">être</span><span class="w"> </span><span class="n">suivi</span><span class="w"> </span><span class="n">d</span><span class="err">'</span><span class="n">un</span><span class="w"> </span><span class="n">paquet</span><span class="w"> </span><span class="n">d</span><span class="err">'</span><span class="n">accusé</span><span class="w"> </span><span class="n">de</span><span class="w"> </span><span class="n">réception</span><span class="w"> </span><span class="n">pour</span><span class="w"> </span><span class="n">enregistrer</span><span class="w"> </span><span class="n">l</span><span class="err">'</span><span class="n">information</span><span class="p">.</span>
<a id="__codelineno-5-61" name="__codelineno-5-61" href="#__codelineno-5-61"></a><span class="w">                </span><span class="n">ikcp_ack_push</span><span class="p">(</span><span class="n">kcp</span><span class="p">,</span><span class="w"> </span><span class="n">sn</span><span class="p">,</span><span class="w"> </span><span class="n">ts</span><span class="p">);</span>
<a id="__codelineno-5-62" name="__codelineno-5-62" href="#__codelineno-5-62"></a>
<a id="__codelineno-5-63" name="__codelineno-5-63" href="#__codelineno-5-63"></a><span class="c1">// Les données reçues sont traitées par ikcp_parse_data</span>
<a id="__codelineno-5-64" name="__codelineno-5-64" href="#__codelineno-5-64"></a><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">_itimediff</span><span class="p">(</span><span class="n">sn</span><span class="p">,</span><span class="w"> </span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">rcv_nxt</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-5-65" name="__codelineno-5-65" href="#__codelineno-5-65"></a><span class="w">                    </span><span class="n">seg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ikcp_segment_new</span><span class="p">(</span><span class="n">kcp</span><span class="p">,</span><span class="w"> </span><span class="n">len</span><span class="p">);</span>
<a id="__codelineno-5-66" name="__codelineno-5-66" href="#__codelineno-5-66"></a><span class="w">                    </span><span class="n">seg</span><span class="o">-&gt;</span><span class="n">conv</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">conv</span><span class="p">;</span>
<a id="__codelineno-5-67" name="__codelineno-5-67" href="#__codelineno-5-67"></a><span class="w">                    </span><span class="n">seg</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cmd</span><span class="p">;</span>
<a id="__codelineno-5-68" name="__codelineno-5-68" href="#__codelineno-5-68"></a><span class="w">                    </span><span class="n">seg</span><span class="o">-&gt;</span><span class="n">frg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">frg</span><span class="p">;</span>
<a id="__codelineno-5-69" name="__codelineno-5-69" href="#__codelineno-5-69"></a><span class="w">                    </span><span class="n">seg</span><span class="o">-&gt;</span><span class="n">wnd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">wnd</span><span class="p">;</span>
<a id="__codelineno-5-70" name="__codelineno-5-70" href="#__codelineno-5-70"></a><span class="w">                    </span><span class="n">seg</span><span class="o">-&gt;</span><span class="n">ts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ts</span><span class="p">;</span>
<a id="__codelineno-5-71" name="__codelineno-5-71" href="#__codelineno-5-71"></a><span class="w">                    </span><span class="n">seg</span><span class="o">-&gt;</span><span class="n">sn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sn</span><span class="p">;</span>
<a id="__codelineno-5-72" name="__codelineno-5-72" href="#__codelineno-5-72"></a><span class="w">                    </span><span class="n">seg</span><span class="o">-&gt;</span><span class="n">una</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">una</span><span class="p">;</span>
<a id="__codelineno-5-73" name="__codelineno-5-73" href="#__codelineno-5-73"></a><span class="w">                    </span><span class="n">seg</span><span class="o">-&gt;</span><span class="n">len</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">len</span><span class="p">;</span>
<a id="__codelineno-5-74" name="__codelineno-5-74" href="#__codelineno-5-74"></a>
<a id="__codelineno-5-75" name="__codelineno-5-75" href="#__codelineno-5-75"></a><span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">len</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-5-76" name="__codelineno-5-76" href="#__codelineno-5-76"></a><span class="w">                        </span><span class="n">memcpy</span><span class="p">(</span><span class="n">seg</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="n">len</span><span class="p">);</span>
<a id="__codelineno-5-77" name="__codelineno-5-77" href="#__codelineno-5-77"></a><span class="w">                    </span><span class="p">}</span>
<a id="__codelineno-5-78" name="__codelineno-5-78" href="#__codelineno-5-78"></a>
<a id="__codelineno-5-79" name="__codelineno-5-79" href="#__codelineno-5-79"></a><span class="w">                    </span><span class="n">ikcp_parse_data</span><span class="p">(</span><span class="n">kcp</span><span class="p">,</span><span class="w"> </span><span class="n">seg</span><span class="p">);</span>
<a id="__codelineno-5-80" name="__codelineno-5-80" href="#__codelineno-5-80"></a><span class="w">                </span><span class="p">}</span>
<a id="__codelineno-5-81" name="__codelineno-5-81" href="#__codelineno-5-81"></a><span class="w">            </span><span class="p">}</span>
<a id="__codelineno-5-82" name="__codelineno-5-82" href="#__codelineno-5-82"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-5-83" name="__codelineno-5-83" href="#__codelineno-5-83"></a><span class="w">        </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">cmd</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">IKCP_CMD_WASK</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-5-84" name="__codelineno-5-84" href="#__codelineno-5-84"></a><span class="n">Veuillez</span><span class="w"> </span><span class="n">traduire</span><span class="w"> </span><span class="n">ce</span><span class="w"> </span><span class="n">texte</span><span class="w"> </span><span class="n">en</span><span class="w"> </span><span class="n">français</span><span class="w"> </span><span class="o">:</span>
<a id="__codelineno-5-85" name="__codelineno-5-85" href="#__codelineno-5-85"></a>
<a id="__codelineno-5-86" name="__codelineno-5-86" href="#__codelineno-5-86"></a><span class="w">            </span><span class="c1">// Package de fenêtre de requête</span>
<a id="__codelineno-5-87" name="__codelineno-5-87" href="#__codelineno-5-87"></a><span class="w">            </span><span class="c1">// ...</span>
<a id="__codelineno-5-88" name="__codelineno-5-88" href="#__codelineno-5-88"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-5-89" name="__codelineno-5-89" href="#__codelineno-5-89"></a><span class="w">        </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">cmd</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">IKCP_CMD_WINS</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-5-90" name="__codelineno-5-90" href="#__codelineno-5-90"></a><span class="c1">// Paquet de réponse de la fenêtre de requête</span>
<a id="__codelineno-5-91" name="__codelineno-5-91" href="#__codelineno-5-91"></a><span class="w">            </span><span class="c1">// ...</span>
<a id="__codelineno-5-92" name="__codelineno-5-92" href="#__codelineno-5-92"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-5-93" name="__codelineno-5-93" href="#__codelineno-5-93"></a><span class="w">        </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-5-94" name="__codelineno-5-94" href="#__codelineno-5-94"></a><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="mi">-3</span><span class="p">;</span>
<a id="__codelineno-5-95" name="__codelineno-5-95" href="#__codelineno-5-95"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-5-96" name="__codelineno-5-96" href="#__codelineno-5-96"></a>
<a id="__codelineno-5-97" name="__codelineno-5-97" href="#__codelineno-5-97"></a><span class="w">        </span><span class="n">data</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">len</span><span class="p">;</span>
<a id="__codelineno-5-98" name="__codelineno-5-98" href="#__codelineno-5-98"></a><span class="w">        </span><span class="n">size</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="n">len</span><span class="p">;</span>
<a id="__codelineno-5-99" name="__codelineno-5-99" href="#__codelineno-5-99"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-5-100" name="__codelineno-5-100" href="#__codelineno-5-100"></a>
<a id="__codelineno-5-101" name="__codelineno-5-101" href="#__codelineno-5-101"></a><span class="c1">// Gérer la logique de retransmission rapide</span>
<a id="__codelineno-5-102" name="__codelineno-5-102" href="#__codelineno-5-102"></a><span class="w">    </span><span class="c1">// ...</span>
<a id="__codelineno-5-103" name="__codelineno-5-103" href="#__codelineno-5-103"></a>
<a id="__codelineno-5-104" name="__codelineno-5-104" href="#__codelineno-5-104"></a><span class="n">Mettre</span><span class="w"> </span><span class="n">à</span><span class="w"> </span><span class="n">jour</span><span class="w"> </span><span class="n">la</span><span class="w"> </span><span class="n">fenêtre</span><span class="w"> </span><span class="n">d</span><span class="err">'</span><span class="n">envoi</span><span class="p">.</span>
<a id="__codelineno-5-105" name="__codelineno-5-105" href="#__codelineno-5-105"></a><span class="w">    </span><span class="c1">// ...</span>
<a id="__codelineno-5-106" name="__codelineno-5-106" href="#__codelineno-5-106"></a>
<a id="__codelineno-5-107" name="__codelineno-5-107" href="#__codelineno-5-107"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="__codelineno-5-108" name="__codelineno-5-108" href="#__codelineno-5-108"></a><span class="p">}</span>
</code></pre></div>
</details>

<p><code>ikcp_input</code> traite chaque paquet <code>SEG</code> en vérifiant d'abord la légalité et le type du paquet, car chaque paquet contient <code>una</code>, qui stocke le numéro de séquence du paquet en attente de réception par l'expéditeur. Les paquets dont le numéro est inférieur à <code>una</code> ont déjà été acceptés par l'autre partie, il est donc possible de supprimer de <code>snd_buff</code> tous ceux qui doivent être inférieurs à <code>una</code> et de mettre à jour <code>snd_nxt</code>. Cette partie est gérée par <code>ikcp_parse_una</code> et <code>ikcp_shrink_buf</code>. Chaque paquet de données reçu nécessite de renvoyer un paquet ACK, qui est enregistré par <code>ikcp_ack_push</code>, et ensuite <code>ikcp_parse_data</code> est appelé pour traiter les données.</p>
<details>
<summary> Analyser les données (cliquez pour développer le code) </summary>
<div class="language-cpp highlight"><pre><span></span><code><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a><span class="kt">void</span><span class="w"> </span><span class="nf">ikcp_parse_data</span><span class="p">(</span><span class="n">ikcpcb</span><span class="w"> </span><span class="o">*</span><span class="n">kcp</span><span class="p">,</span><span class="w"> </span><span class="n">IKCPSEG</span><span class="w"> </span><span class="o">*</span><span class="n">newseg</span><span class="p">)</span>
<a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a><span class="p">{</span>
<a id="__codelineno-6-3" name="__codelineno-6-3" href="#__codelineno-6-3"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">IQUEUEHEAD</span><span class="w"> </span><span class="o">*</span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">prev</span><span class="p">;</span>
<a id="__codelineno-6-4" name="__codelineno-6-4" href="#__codelineno-6-4"></a><span class="w">    </span><span class="n">IUINT32</span><span class="w"> </span><span class="n">sn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">newseg</span><span class="o">-&gt;</span><span class="n">sn</span><span class="p">;</span>
<a id="__codelineno-6-5" name="__codelineno-6-5" href="#__codelineno-6-5"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">repeat</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="__codelineno-6-6" name="__codelineno-6-6" href="#__codelineno-6-6"></a>
<a id="__codelineno-6-7" name="__codelineno-6-7" href="#__codelineno-6-7"></a><span class="n">Vérification</span><span class="w"> </span><span class="n">du</span><span class="w"> </span><span class="n">numéro</span><span class="w"> </span><span class="n">de</span><span class="w"> </span><span class="n">séquence</span>
<a id="__codelineno-6-8" name="__codelineno-6-8" href="#__codelineno-6-8"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">_itimediff</span><span class="p">(</span><span class="n">sn</span><span class="p">,</span><span class="w"> </span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">rcv_nxt</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">rcv_wnd</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">||</span>
<a id="__codelineno-6-9" name="__codelineno-6-9" href="#__codelineno-6-9"></a><span class="w">        </span><span class="n">_itimediff</span><span class="p">(</span><span class="n">sn</span><span class="p">,</span><span class="w"> </span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">rcv_nxt</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-6-10" name="__codelineno-6-10" href="#__codelineno-6-10"></a><span class="w">        </span><span class="n">ikcp_segment_delete</span><span class="p">(</span><span class="n">kcp</span><span class="p">,</span><span class="w"> </span><span class="n">newseg</span><span class="p">);</span>
<a id="__codelineno-6-11" name="__codelineno-6-11" href="#__codelineno-6-11"></a><span class="w">        </span><span class="k">return</span><span class="p">;</span>
<a id="__codelineno-6-12" name="__codelineno-6-12" href="#__codelineno-6-12"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-6-13" name="__codelineno-6-13" href="#__codelineno-6-13"></a>
<a id="__codelineno-6-14" name="__codelineno-6-14" href="#__codelineno-6-14"></a><span class="c1">// Trouver l'emplacement où newseg devrait être placé, car le seg reçu peut être désordonné.</span>
<a id="__codelineno-6-15" name="__codelineno-6-15" href="#__codelineno-6-15"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">rcv_buf</span><span class="p">.</span><span class="n">prev</span><span class="p">;</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">rcv_buf</span><span class="p">;</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">prev</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-6-16" name="__codelineno-6-16" href="#__codelineno-6-16"></a><span class="w">        </span><span class="n">IKCPSEG</span><span class="w"> </span><span class="o">*</span><span class="n">seg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iqueue_entry</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="n">IKCPSEG</span><span class="p">,</span><span class="w"> </span><span class="n">node</span><span class="p">);</span>
<a id="__codelineno-6-17" name="__codelineno-6-17" href="#__codelineno-6-17"></a><span class="w">        </span><span class="n">prev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">p</span><span class="o">-&gt;</span><span class="n">prev</span><span class="p">;</span>
<a id="__codelineno-6-18" name="__codelineno-6-18" href="#__codelineno-6-18"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">seg</span><span class="o">-&gt;</span><span class="n">sn</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">sn</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-6-19" name="__codelineno-6-19" href="#__codelineno-6-19"></a><span class="c1">// Reçu en double</span>
<a id="__codelineno-6-20" name="__codelineno-6-20" href="#__codelineno-6-20"></a><span class="w">            </span><span class="n">repeat</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<a id="__codelineno-6-21" name="__codelineno-6-21" href="#__codelineno-6-21"></a><span class="w">            </span><span class="k">break</span><span class="p">;</span>
<a id="__codelineno-6-22" name="__codelineno-6-22" href="#__codelineno-6-22"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-6-23" name="__codelineno-6-23" href="#__codelineno-6-23"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">_itimediff</span><span class="p">(</span><span class="n">sn</span><span class="p">,</span><span class="w"> </span><span class="n">seg</span><span class="o">-&gt;</span><span class="n">sn</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-6-24" name="__codelineno-6-24" href="#__codelineno-6-24"></a><span class="w">            </span><span class="k">break</span><span class="p">;</span>
<a id="__codelineno-6-25" name="__codelineno-6-25" href="#__codelineno-6-25"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-6-26" name="__codelineno-6-26" href="#__codelineno-6-26"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-6-27" name="__codelineno-6-27" href="#__codelineno-6-27"></a>
<a id="__codelineno-6-28" name="__codelineno-6-28" href="#__codelineno-6-28"></a><span class="n">Placer</span><span class="w"> </span><span class="n">le</span><span class="w"> </span><span class="n">newseg</span><span class="w"> </span><span class="n">à</span><span class="w"> </span><span class="n">la</span><span class="w"> </span><span class="n">bonne</span><span class="w"> </span><span class="n">position</span><span class="w"> </span><span class="n">dans</span><span class="w"> </span><span class="n">rcv_buf</span><span class="p">.</span>
<a id="__codelineno-6-29" name="__codelineno-6-29" href="#__codelineno-6-29"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">repeat</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-6-30" name="__codelineno-6-30" href="#__codelineno-6-30"></a><span class="w">        </span><span class="n">iqueue_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">newseg</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">);</span>
<a id="__codelineno-6-31" name="__codelineno-6-31" href="#__codelineno-6-31"></a><span class="w">        </span><span class="n">iqueue_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">newseg</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="p">);</span>
<a id="__codelineno-6-32" name="__codelineno-6-32" href="#__codelineno-6-32"></a><span class="w">        </span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">nrcv_buf</span><span class="o">++</span><span class="p">;</span>
<a id="__codelineno-6-33" name="__codelineno-6-33" href="#__codelineno-6-33"></a><span class="w">    </span><span class="p">}</span><span class="w">    </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-6-34" name="__codelineno-6-34" href="#__codelineno-6-34"></a><span class="w">        </span><span class="n">ikcp_segment_delete</span><span class="p">(</span><span class="n">kcp</span><span class="p">,</span><span class="w"> </span><span class="n">newseg</span><span class="p">);</span>
<a id="__codelineno-6-35" name="__codelineno-6-35" href="#__codelineno-6-35"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-6-36" name="__codelineno-6-36" href="#__codelineno-6-36"></a>
<a id="__codelineno-6-37" name="__codelineno-6-37" href="#__codelineno-6-37"></a><span class="n">Déplacez</span><span class="w"> </span><span class="n">les</span><span class="w"> </span><span class="n">données</span><span class="w"> </span><span class="n">de</span><span class="w"> </span><span class="n">rcv_buf</span><span class="w"> </span><span class="n">vers</span><span class="w"> </span><span class="n">rcv_queue</span><span class="p">.</span>
<a id="__codelineno-6-38" name="__codelineno-6-38" href="#__codelineno-6-38"></a><span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="w"> </span><span class="n">iqueue_is_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">rcv_buf</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-6-39" name="__codelineno-6-39" href="#__codelineno-6-39"></a><span class="w">        </span><span class="n">IKCPSEG</span><span class="w"> </span><span class="o">*</span><span class="n">seg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iqueue_entry</span><span class="p">(</span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">rcv_buf</span><span class="p">.</span><span class="n">next</span><span class="p">,</span><span class="w"> </span><span class="n">IKCPSEG</span><span class="p">,</span><span class="w"> </span><span class="n">node</span><span class="p">);</span>
<a id="__codelineno-6-40" name="__codelineno-6-40" href="#__codelineno-6-40"></a><span class="c1">// Si le numéro de séquence seg est le numéro d'attente de réception, déplacez-le vers rcv_queue</span>
<a id="__codelineno-6-41" name="__codelineno-6-41" href="#__codelineno-6-41"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">seg</span><span class="o">-&gt;</span><span class="n">sn</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">rcv_nxt</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">nrcv_que</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">rcv_wnd</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-6-42" name="__codelineno-6-42" href="#__codelineno-6-42"></a><span class="w">            </span><span class="n">iqueue_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">seg</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">);</span>
<a id="__codelineno-6-43" name="__codelineno-6-43" href="#__codelineno-6-43"></a><span class="w">            </span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">nrcv_buf</span><span class="o">--</span><span class="p">;</span>
<a id="__codelineno-6-44" name="__codelineno-6-44" href="#__codelineno-6-44"></a><span class="w">            </span><span class="n">iqueue_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">seg</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">rcv_queue</span><span class="p">);</span>
<a id="__codelineno-6-45" name="__codelineno-6-45" href="#__codelineno-6-45"></a><span class="w">            </span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">nrcv_que</span><span class="o">++</span><span class="p">;</span>
<a id="__codelineno-6-46" name="__codelineno-6-46" href="#__codelineno-6-46"></a><span class="w">            </span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">rcv_nxt</span><span class="o">++</span><span class="p">;</span>
<a id="__codelineno-6-47" name="__codelineno-6-47" href="#__codelineno-6-47"></a><span class="w">        </span><span class="p">}</span><span class="w">    </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-6-48" name="__codelineno-6-48" href="#__codelineno-6-48"></a><span class="w">            </span><span class="k">break</span><span class="p">;</span>
<a id="__codelineno-6-49" name="__codelineno-6-49" href="#__codelineno-6-49"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-6-50" name="__codelineno-6-50" href="#__codelineno-6-50"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-6-51" name="__codelineno-6-51" href="#__codelineno-6-51"></a><span class="p">}</span>
</code></pre></div>
</details>

<p>La fonction <code>ikcp_parse_data</code> a pour principal objectif de placer le segment <code>newseg</code> au bon endroit dans <code>kcp-&gt;rcv_buf</code> et de déplacer les données de <code>rcv_buf</code> vers <code>rcv_queue</code>. Le bon emplacement dans <code>rcv_buf</code> signifie que <code>rcv_buf</code> est trié par ordre croissant de <code>sn</code> et que <code>newseg</code> doit trouver sa place en fonction de sa propre valeur <code>sn</code>. Les données sur <code>rcv_buf</code> doivent être déplacées vers <code>rcv_queue</code> lorsque le numéro de séquence du paquet de données sur <code>rcv_buf</code> est égal au prochain numéro de séquence attendu par KCP, <code>kcp-&gt;rcv_nxt</code>. Après le déplacement d'un paquet de données, il est nécessaire de mettre à jour <code>kcp-&gt;rcv_nxt</code> avant de traiter le paquet de données suivant.</p>
<p>Après <code>ikcp_input</code>, lorsque la couche supérieure appelle <code>ikcp_update</code>, un paquet ACK sera envoyé, et l'appel à <code>ikcp_recv</code> renverra des données valides à la couche supérieure. <code>ikcp_update</code> et <code>ikcp_recv</code> sont indépendants l'un de l'autre et n'ont pas d'exigence de séquence d'appel, cela dépend du moment des appels de la couche supérieure. Examinons d'abord la partie concernant l'envoi d'ACK dans <code>ikcp_update</code> :</p>
<details>
<r> Répondre ACK (cliquez pour afficher le code) </r>
<div class="language-cpp highlight"><pre><span></span><code><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a><span class="c1">// Comme mentionné précédemment, ikcp_update appelle finalement ikcp_flush</span>
<a id="__codelineno-7-2" name="__codelineno-7-2" href="#__codelineno-7-2"></a><span class="kt">void</span><span class="w"> </span><span class="nf">ikcp_flush</span><span class="p">(</span><span class="n">ikcpcb</span><span class="w"> </span><span class="o">*</span><span class="n">kcp</span><span class="p">,</span><span class="w"> </span><span class="n">IUINT32</span><span class="w"> </span><span class="n">current</span><span class="p">)</span>
<a id="__codelineno-7-3" name="__codelineno-7-3" href="#__codelineno-7-3"></a><span class="p">{</span>
<a id="__codelineno-7-4" name="__codelineno-7-4" href="#__codelineno-7-4"></a><span class="w">    </span><span class="c1">// ...</span>
<a id="__codelineno-7-5" name="__codelineno-7-5" href="#__codelineno-7-5"></a>
<a id="__codelineno-7-6" name="__codelineno-7-6" href="#__codelineno-7-6"></a><span class="n">Répondre</span><span class="w"> </span><span class="n">au</span><span class="w"> </span><span class="n">paquet</span><span class="w"> </span><span class="n">ACK</span>
<a id="__codelineno-7-7" name="__codelineno-7-7" href="#__codelineno-7-7"></a><span class="w">    </span><span class="n">count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">ackcount</span><span class="p">;</span>
<a id="__codelineno-7-8" name="__codelineno-7-8" href="#__codelineno-7-8"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">count</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-7-9" name="__codelineno-7-9" href="#__codelineno-7-9"></a><span class="w">        </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="n">ptr</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">buffer</span><span class="p">);</span>
<a id="__codelineno-7-10" name="__codelineno-7-10" href="#__codelineno-7-10"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">size</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">IKCP_OVERHEAD</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">mtu</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-7-11" name="__codelineno-7-11" href="#__codelineno-7-11"></a><span class="w">            </span><span class="n">ikcp_output</span><span class="p">(</span><span class="n">kcp</span><span class="p">,</span><span class="w"> </span><span class="n">buffer</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="p">);</span>
<a id="__codelineno-7-12" name="__codelineno-7-12" href="#__codelineno-7-12"></a><span class="w">            </span><span class="n">ptr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">buffer</span><span class="p">;</span>
<a id="__codelineno-7-13" name="__codelineno-7-13" href="#__codelineno-7-13"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-7-14" name="__codelineno-7-14" href="#__codelineno-7-14"></a><span class="w">        </span><span class="n">ikcp_ack_get</span><span class="p">(</span><span class="n">kcp</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">seg</span><span class="p">.</span><span class="n">sn</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">seg</span><span class="p">.</span><span class="n">ts</span><span class="p">);</span>
<a id="__codelineno-7-15" name="__codelineno-7-15" href="#__codelineno-7-15"></a><span class="w">        </span><span class="n">ptr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ikcp_encode_seg</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">seg</span><span class="p">);</span>
<a id="__codelineno-7-16" name="__codelineno-7-16" href="#__codelineno-7-16"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-7-17" name="__codelineno-7-17" href="#__codelineno-7-17"></a>
<a id="__codelineno-7-18" name="__codelineno-7-18" href="#__codelineno-7-18"></a><span class="w">    </span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">ackcount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="__codelineno-7-19" name="__codelineno-7-19" href="#__codelineno-7-19"></a>
<a id="__codelineno-7-20" name="__codelineno-7-20" href="#__codelineno-7-20"></a><span class="w">    </span><span class="c1">// ...</span>
<a id="__codelineno-7-21" name="__codelineno-7-21" href="#__codelineno-7-21"></a><span class="p">}</span>
</code></pre></div>
</details>

<p>Le paquet ACK a déjà été sauvegardé par <code>ikcp_ack_push</code>, donc ici il suffit d'utiliser <code>ikcp_ack_get</code> pour obtenir les informations de chaque paquet ACK et les envoyer à l'autre partie. La couche supérieure peut utiliser <code>ikcp_recv</code> pour recevoir des données de KCP :</p>
<details>
ikcp_recv（cliquer pour afficher le code）
<div class="language-cpp highlight"><pre><span></span><code><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a><span class="c1">//---------------------------------------------------------------------</span>
<a id="__codelineno-8-2" name="__codelineno-8-2" href="#__codelineno-8-2"></a><span class="c1">// user/upper level recv: returns size, returns below zero for EAGAIN</span>
<a id="__codelineno-8-3" name="__codelineno-8-3" href="#__codelineno-8-3"></a><span class="c1">//---------------------------------------------------------------------</span>
<a id="__codelineno-8-4" name="__codelineno-8-4" href="#__codelineno-8-4"></a><span class="kt">int</span><span class="w"> </span><span class="nf">ikcp_recv</span><span class="p">(</span><span class="n">ikcpcb</span><span class="w"> </span><span class="o">*</span><span class="n">kcp</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">buffer</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">len</span><span class="p">)</span>
<a id="__codelineno-8-5" name="__codelineno-8-5" href="#__codelineno-8-5"></a><span class="p">{</span>
<a id="__codelineno-8-6" name="__codelineno-8-6" href="#__codelineno-8-6"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">IQUEUEHEAD</span><span class="w"> </span><span class="o">*</span><span class="n">p</span><span class="p">;</span>
<a id="__codelineno-8-7" name="__codelineno-8-7" href="#__codelineno-8-7"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">ispeek</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">len</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="o">?</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="__codelineno-8-8" name="__codelineno-8-8" href="#__codelineno-8-8"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">peeksize</span><span class="p">;</span>
<a id="__codelineno-8-9" name="__codelineno-8-9" href="#__codelineno-8-9"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">recover</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="__codelineno-8-10" name="__codelineno-8-10" href="#__codelineno-8-10"></a><span class="w">    </span><span class="n">IKCPSEG</span><span class="w"> </span><span class="o">*</span><span class="n">seg</span><span class="p">;</span>
<a id="__codelineno-8-11" name="__codelineno-8-11" href="#__codelineno-8-11"></a><span class="w">    </span><span class="n">assert</span><span class="p">(</span><span class="n">kcp</span><span class="p">);</span>
<a id="__codelineno-8-12" name="__codelineno-8-12" href="#__codelineno-8-12"></a>
<a id="__codelineno-8-13" name="__codelineno-8-13" href="#__codelineno-8-13"></a><span class="c1">// Certaines vérifications de validité</span>
<a id="__codelineno-8-14" name="__codelineno-8-14" href="#__codelineno-8-14"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">iqueue_is_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">rcv_queue</span><span class="p">))</span>
<a id="__codelineno-8-15" name="__codelineno-8-15" href="#__codelineno-8-15"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span>
<a id="__codelineno-8-16" name="__codelineno-8-16" href="#__codelineno-8-16"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">len</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="n">len</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="n">len</span><span class="p">;</span>
<a id="__codelineno-8-17" name="__codelineno-8-17" href="#__codelineno-8-17"></a>
<a id="__codelineno-8-18" name="__codelineno-8-18" href="#__codelineno-8-18"></a><span class="n">Calculer</span><span class="w"> </span><span class="n">la</span><span class="w"> </span><span class="n">longueur</span><span class="w"> </span><span class="n">des</span><span class="w"> </span><span class="n">données</span><span class="w"> </span><span class="n">pouvant</span><span class="w"> </span><span class="n">être</span><span class="w"> </span><span class="n">renvoyées</span>
<a id="__codelineno-8-19" name="__codelineno-8-19" href="#__codelineno-8-19"></a><span class="w">    </span><span class="n">peeksize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ikcp_peeksize</span><span class="p">(</span><span class="n">kcp</span><span class="p">);</span>
<a id="__codelineno-8-20" name="__codelineno-8-20" href="#__codelineno-8-20"></a>
<a id="__codelineno-8-21" name="__codelineno-8-21" href="#__codelineno-8-21"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">peeksize</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-8-22" name="__codelineno-8-22" href="#__codelineno-8-22"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">-2</span><span class="p">;</span>
<a id="__codelineno-8-23" name="__codelineno-8-23" href="#__codelineno-8-23"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">peeksize</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">len</span><span class="p">)</span>
<a id="__codelineno-8-24" name="__codelineno-8-24" href="#__codelineno-8-24"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">-3</span><span class="p">;</span>
<a id="__codelineno-8-25" name="__codelineno-8-25" href="#__codelineno-8-25"></a>
<a id="__codelineno-8-26" name="__codelineno-8-26" href="#__codelineno-8-26"></a><span class="n">Vérifiez</span><span class="w"> </span><span class="n">la</span><span class="w"> </span><span class="n">taille</span><span class="w"> </span><span class="n">de</span><span class="w"> </span><span class="n">la</span><span class="w"> </span><span class="n">fenêtre</span><span class="w"> </span><span class="n">de</span><span class="w"> </span><span class="n">réception</span><span class="p">.</span>
<a id="__codelineno-8-27" name="__codelineno-8-27" href="#__codelineno-8-27"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">nrcv_que</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">rcv_wnd</span><span class="p">)</span>
<a id="__codelineno-8-28" name="__codelineno-8-28" href="#__codelineno-8-28"></a><span class="w">        </span><span class="n">recover</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<a id="__codelineno-8-29" name="__codelineno-8-29" href="#__codelineno-8-29"></a>
<a id="__codelineno-8-30" name="__codelineno-8-30" href="#__codelineno-8-30"></a><span class="c1">// Parcourir rcv_queue et copier les données dans le buffer.</span>
<a id="__codelineno-8-31" name="__codelineno-8-31" href="#__codelineno-8-31"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">len</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">rcv_queue</span><span class="p">.</span><span class="n">next</span><span class="p">;</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">rcv_queue</span><span class="p">;</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-8-32" name="__codelineno-8-32" href="#__codelineno-8-32"></a><span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">fragment</span><span class="p">;</span>
<a id="__codelineno-8-33" name="__codelineno-8-33" href="#__codelineno-8-33"></a><span class="w">        </span><span class="n">seg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iqueue_entry</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="n">IKCPSEG</span><span class="p">,</span><span class="w"> </span><span class="n">node</span><span class="p">);</span>
<a id="__codelineno-8-34" name="__codelineno-8-34" href="#__codelineno-8-34"></a><span class="w">        </span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">p</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
<a id="__codelineno-8-35" name="__codelineno-8-35" href="#__codelineno-8-35"></a>
<a id="__codelineno-8-36" name="__codelineno-8-36" href="#__codelineno-8-36"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">buffer</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-8-37" name="__codelineno-8-37" href="#__codelineno-8-37"></a><span class="w">            </span><span class="n">memcpy</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span><span class="w"> </span><span class="n">seg</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="n">seg</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
<a id="__codelineno-8-38" name="__codelineno-8-38" href="#__codelineno-8-38"></a><span class="w">            </span><span class="n">buffer</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">seg</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
<a id="__codelineno-8-39" name="__codelineno-8-39" href="#__codelineno-8-39"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-8-40" name="__codelineno-8-40" href="#__codelineno-8-40"></a>
<a id="__codelineno-8-41" name="__codelineno-8-41" href="#__codelineno-8-41"></a><span class="w">        </span><span class="n">len</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">seg</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
<a id="__codelineno-8-42" name="__codelineno-8-42" href="#__codelineno-8-42"></a>
<a id="__codelineno-8-43" name="__codelineno-8-43" href="#__codelineno-8-43"></a><span class="c1">// Déterminer le sous-ensemble</span>
<a id="__codelineno-8-44" name="__codelineno-8-44" href="#__codelineno-8-44"></a><span class="w">        </span><span class="n">fragment</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">seg</span><span class="o">-&gt;</span><span class="n">frg</span><span class="p">;</span>
<a id="__codelineno-8-45" name="__codelineno-8-45" href="#__codelineno-8-45"></a>
<a id="__codelineno-8-46" name="__codelineno-8-46" href="#__codelineno-8-46"></a><span class="n">Supprimer</span><span class="w"> </span><span class="n">le</span><span class="w"> </span><span class="n">paquet</span><span class="w"> </span><span class="n">de</span><span class="w"> </span><span class="n">données</span>
<a id="__codelineno-8-47" name="__codelineno-8-47" href="#__codelineno-8-47"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ispeek</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-8-48" name="__codelineno-8-48" href="#__codelineno-8-48"></a><span class="w">            </span><span class="n">iqueue_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">seg</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">);</span>
<a id="__codelineno-8-49" name="__codelineno-8-49" href="#__codelineno-8-49"></a><span class="w">            </span><span class="n">ikcp_segment_delete</span><span class="p">(</span><span class="n">kcp</span><span class="p">,</span><span class="w"> </span><span class="n">seg</span><span class="p">);</span>
<a id="__codelineno-8-50" name="__codelineno-8-50" href="#__codelineno-8-50"></a><span class="w">            </span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">nrcv_que</span><span class="o">--</span><span class="p">;</span>
<a id="__codelineno-8-51" name="__codelineno-8-51" href="#__codelineno-8-51"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-8-52" name="__codelineno-8-52" href="#__codelineno-8-52"></a>
<a id="__codelineno-8-53" name="__codelineno-8-53" href="#__codelineno-8-53"></a><span class="c1">// Tous les sous-embouts sont copiés, quitter la boucle.</span>
<a id="__codelineno-8-54" name="__codelineno-8-54" href="#__codelineno-8-54"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">fragment</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-8-55" name="__codelineno-8-55" href="#__codelineno-8-55"></a><span class="w">            </span><span class="k">break</span><span class="p">;</span>
<a id="__codelineno-8-56" name="__codelineno-8-56" href="#__codelineno-8-56"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-8-57" name="__codelineno-8-57" href="#__codelineno-8-57"></a>
<a id="__codelineno-8-58" name="__codelineno-8-58" href="#__codelineno-8-58"></a><span class="w">    </span><span class="n">assert</span><span class="p">(</span><span class="n">len</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">peeksize</span><span class="p">);</span>
<a id="__codelineno-8-59" name="__codelineno-8-59" href="#__codelineno-8-59"></a>
<a id="__codelineno-8-60" name="__codelineno-8-60" href="#__codelineno-8-60"></a><span class="c1">// rcv_queue s'est encore un peu vidé, essayons de continuer à déplacer de rcv_buf vers rcv_queue.</span>
<a id="__codelineno-8-61" name="__codelineno-8-61" href="#__codelineno-8-61"></a><span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="w"> </span><span class="n">iqueue_is_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">rcv_buf</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-8-62" name="__codelineno-8-62" href="#__codelineno-8-62"></a><span class="w">        </span><span class="n">seg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iqueue_entry</span><span class="p">(</span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">rcv_buf</span><span class="p">.</span><span class="n">next</span><span class="p">,</span><span class="w"> </span><span class="n">IKCPSEG</span><span class="p">,</span><span class="w"> </span><span class="n">node</span><span class="p">);</span>
<a id="__codelineno-8-63" name="__codelineno-8-63" href="#__codelineno-8-63"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">seg</span><span class="o">-&gt;</span><span class="n">sn</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">rcv_nxt</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">nrcv_que</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">rcv_wnd</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-8-64" name="__codelineno-8-64" href="#__codelineno-8-64"></a><span class="w">            </span><span class="n">iqueue_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">seg</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">);</span>
<a id="__codelineno-8-65" name="__codelineno-8-65" href="#__codelineno-8-65"></a><span class="w">            </span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">nrcv_buf</span><span class="o">--</span><span class="p">;</span>
<a id="__codelineno-8-66" name="__codelineno-8-66" href="#__codelineno-8-66"></a><span class="w">            </span><span class="n">iqueue_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">seg</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">rcv_queue</span><span class="p">);</span>
<a id="__codelineno-8-67" name="__codelineno-8-67" href="#__codelineno-8-67"></a><span class="w">            </span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">nrcv_que</span><span class="o">++</span><span class="p">;</span>
<a id="__codelineno-8-68" name="__codelineno-8-68" href="#__codelineno-8-68"></a><span class="w">            </span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">rcv_nxt</span><span class="o">++</span><span class="p">;</span>
<a id="__codelineno-8-69" name="__codelineno-8-69" href="#__codelineno-8-69"></a><span class="w">        </span><span class="p">}</span><span class="w">    </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-8-70" name="__codelineno-8-70" href="#__codelineno-8-70"></a><span class="w">            </span><span class="k">break</span><span class="p">;</span>
<a id="__codelineno-8-71" name="__codelineno-8-71" href="#__codelineno-8-71"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-8-72" name="__codelineno-8-72" href="#__codelineno-8-72"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-8-73" name="__codelineno-8-73" href="#__codelineno-8-73"></a>
<a id="__codelineno-8-74" name="__codelineno-8-74" href="#__codelineno-8-74"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">len</span><span class="p">;</span>
<a id="__codelineno-8-75" name="__codelineno-8-75" href="#__codelineno-8-75"></a><span class="p">}</span>
</code></pre></div>
</details>

<p><code>ikcp_recv</code> est une fonction qui ne renvoie qu'un seul paquet de données complet à chaque appel. La couche supérieure peut l'appeler en boucle jusqu'à ce qu'il n'y ait plus de données à renvoyer. La logique de la fonction est assez simple, elle consiste à copier les données de <code>rcv_queue</code> dans le <code>buffer</code> fourni par la couche supérieure. À ce stade, le récepteur a déjà traité le paquet de données reçu.</p>
<p>Lorsque le destinataire traite le paquet de données, il envoie un paquet ACK à l'expéditeur. Voyons maintenant comment l'expéditeur gère la réception du paquet ACK :</p>
<details>
<summary> Traitement des paquets ACK (cliquez pour développer le code) </summary>
<div class="language-cpp highlight"><pre><span></span><code><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a><span class="kt">int</span><span class="w"> </span><span class="nf">ikcp_input</span><span class="p">(</span><span class="n">ikcpcb</span><span class="w"> </span><span class="o">*</span><span class="n">kcp</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">size</span><span class="p">)</span>
<a id="__codelineno-9-2" name="__codelineno-9-2" href="#__codelineno-9-2"></a><span class="p">{</span>
<a id="__codelineno-9-3" name="__codelineno-9-3" href="#__codelineno-9-3"></a><span class="w">    </span><span class="c1">// ...</span>
<a id="__codelineno-9-4" name="__codelineno-9-4" href="#__codelineno-9-4"></a><span class="w">    </span><span class="n">IUINT32</span><span class="w"> </span><span class="n">maxack</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">latest_ts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="__codelineno-9-5" name="__codelineno-9-5" href="#__codelineno-9-5"></a><span class="w">    </span><span class="c1">// ...</span>
<a id="__codelineno-9-6" name="__codelineno-9-6" href="#__codelineno-9-6"></a><span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-9-7" name="__codelineno-9-7" href="#__codelineno-9-7"></a><span class="w">        </span><span class="c1">// ...</span>
<a id="__codelineno-9-8" name="__codelineno-9-8" href="#__codelineno-9-8"></a><span class="c1">// ts est le kcp-&gt; current de l'autre côté</span>
<a id="__codelineno-9-9" name="__codelineno-9-9" href="#__codelineno-9-9"></a><span class="w">        </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ikcp_decode32u</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">ts</span><span class="p">);</span>
<a id="__codelineno-9-10" name="__codelineno-9-10" href="#__codelineno-9-10"></a><span class="w">        </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ikcp_decode32u</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">sn</span><span class="p">);</span>
<a id="__codelineno-9-11" name="__codelineno-9-11" href="#__codelineno-9-11"></a>
<a id="__codelineno-9-12" name="__codelineno-9-12" href="#__codelineno-9-12"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">cmd</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">IKCP_CMD_ACK</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-9-13" name="__codelineno-9-13" href="#__codelineno-9-13"></a><span class="n">Mettre</span><span class="w"> </span><span class="n">à</span><span class="w"> </span><span class="n">jour</span><span class="w"> </span><span class="n">rot</span>
<a id="__codelineno-9-14" name="__codelineno-9-14" href="#__codelineno-9-14"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">_itimediff</span><span class="p">(</span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">current</span><span class="p">,</span><span class="w"> </span><span class="n">ts</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-9-15" name="__codelineno-9-15" href="#__codelineno-9-15"></a><span class="w">                </span><span class="n">ikcp_update_ack</span><span class="p">(</span><span class="n">kcp</span><span class="p">,</span><span class="w"> </span><span class="n">_itimediff</span><span class="p">(</span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">current</span><span class="p">,</span><span class="w"> </span><span class="n">ts</span><span class="p">));</span>
<a id="__codelineno-9-16" name="__codelineno-9-16" href="#__codelineno-9-16"></a><span class="w">            </span><span class="p">}</span>
<a id="__codelineno-9-17" name="__codelineno-9-17" href="#__codelineno-9-17"></a><span class="n">Mettre</span><span class="w"> </span><span class="n">à</span><span class="w"> </span><span class="n">jour</span><span class="w"> </span><span class="n">snd_buf</span>
<a id="__codelineno-9-18" name="__codelineno-9-18" href="#__codelineno-9-18"></a><span class="w">            </span><span class="n">ikcp_parse_ack</span><span class="p">(</span><span class="n">kcp</span><span class="p">,</span><span class="w"> </span><span class="n">sn</span><span class="p">);</span>
<a id="__codelineno-9-19" name="__codelineno-9-19" href="#__codelineno-9-19"></a><span class="w">            </span><span class="n">ikcp_shrink_buf</span><span class="p">(</span><span class="n">kcp</span><span class="p">);</span>
<a id="__codelineno-9-20" name="__codelineno-9-20" href="#__codelineno-9-20"></a>
<a id="__codelineno-9-21" name="__codelineno-9-21" href="#__codelineno-9-21"></a><span class="n">maxack</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">le</span><span class="w"> </span><span class="n">plus</span><span class="w"> </span><span class="n">grand</span><span class="w"> </span><span class="n">numéro</span><span class="w"> </span><span class="n">de</span><span class="w"> </span><span class="n">séquence</span><span class="w"> </span><span class="n">parmi</span><span class="w"> </span><span class="n">tous</span><span class="w"> </span><span class="n">les</span><span class="w"> </span><span class="n">paquets</span><span class="w"> </span><span class="n">ACK</span><span class="w"> </span><span class="n">de</span><span class="w"> </span><span class="n">cette</span><span class="w"> </span><span class="n">entrée</span>
<a id="__codelineno-9-22" name="__codelineno-9-22" href="#__codelineno-9-22"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">flag</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-9-23" name="__codelineno-9-23" href="#__codelineno-9-23"></a><span class="w">                </span><span class="n">flag</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<a id="__codelineno-9-24" name="__codelineno-9-24" href="#__codelineno-9-24"></a><span class="w">                </span><span class="n">maxack</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sn</span><span class="p">;</span>
<a id="__codelineno-9-25" name="__codelineno-9-25" href="#__codelineno-9-25"></a><span class="w">                </span><span class="n">latest_ts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ts</span><span class="p">;</span>
<a id="__codelineno-9-26" name="__codelineno-9-26" href="#__codelineno-9-26"></a><span class="w">            </span><span class="p">}</span><span class="w">    </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-9-27" name="__codelineno-9-27" href="#__codelineno-9-27"></a><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">_itimediff</span><span class="p">(</span><span class="n">sn</span><span class="p">,</span><span class="w"> </span><span class="n">maxack</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-9-28" name="__codelineno-9-28" href="#__codelineno-9-28"></a><span class="w">                </span><span class="cp">#ifndef IKCP_FASTACK_CONSERVE</span>
<a id="__codelineno-9-29" name="__codelineno-9-29" href="#__codelineno-9-29"></a><span class="w">                    </span><span class="n">maxack</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sn</span><span class="p">;</span>
<a id="__codelineno-9-30" name="__codelineno-9-30" href="#__codelineno-9-30"></a><span class="w">                    </span><span class="n">latest_ts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ts</span><span class="p">;</span>
<a id="__codelineno-9-31" name="__codelineno-9-31" href="#__codelineno-9-31"></a><span class="w">                </span><span class="cp">#else</span>
<a id="__codelineno-9-32" name="__codelineno-9-32" href="#__codelineno-9-32"></a><span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">_itimediff</span><span class="p">(</span><span class="n">ts</span><span class="p">,</span><span class="w"> </span><span class="n">latest_ts</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-9-33" name="__codelineno-9-33" href="#__codelineno-9-33"></a><span class="w">                        </span><span class="n">maxack</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sn</span><span class="p">;</span>
<a id="__codelineno-9-34" name="__codelineno-9-34" href="#__codelineno-9-34"></a><span class="w">                        </span><span class="n">latest_ts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ts</span><span class="p">;</span>
<a id="__codelineno-9-35" name="__codelineno-9-35" href="#__codelineno-9-35"></a><span class="w">                    </span><span class="p">}</span>
<a id="__codelineno-9-36" name="__codelineno-9-36" href="#__codelineno-9-36"></a><span class="w">                </span><span class="cp">#endif</span>
<a id="__codelineno-9-37" name="__codelineno-9-37" href="#__codelineno-9-37"></a><span class="w">                </span><span class="p">}</span>
<a id="__codelineno-9-38" name="__codelineno-9-38" href="#__codelineno-9-38"></a><span class="w">            </span><span class="p">}</span>
<a id="__codelineno-9-39" name="__codelineno-9-39" href="#__codelineno-9-39"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-9-40" name="__codelineno-9-40" href="#__codelineno-9-40"></a><span class="w">        </span><span class="c1">// ...</span>
<a id="__codelineno-9-41" name="__codelineno-9-41" href="#__codelineno-9-41"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-9-42" name="__codelineno-9-42" href="#__codelineno-9-42"></a>
<a id="__codelineno-9-43" name="__codelineno-9-43" href="#__codelineno-9-43"></a><span class="n">Si</span><span class="w"> </span><span class="n">un</span><span class="w"> </span><span class="n">paquet</span><span class="w"> </span><span class="n">ACK</span><span class="w"> </span><span class="n">est</span><span class="w"> </span><span class="n">reçu</span><span class="p">,</span><span class="w"> </span><span class="n">enregistrez</span><span class="o">-</span><span class="n">le</span><span class="w"> </span><span class="n">pour</span><span class="w"> </span><span class="n">effectuer</span><span class="w"> </span><span class="n">une</span><span class="w"> </span><span class="n">retransmission</span><span class="w"> </span><span class="n">rapide</span><span class="p">.</span>
<a id="__codelineno-9-44" name="__codelineno-9-44" href="#__codelineno-9-44"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">flag</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-9-45" name="__codelineno-9-45" href="#__codelineno-9-45"></a><span class="w">        </span><span class="n">ikcp_parse_fastack</span><span class="p">(</span><span class="n">kcp</span><span class="p">,</span><span class="w"> </span><span class="n">maxack</span><span class="p">,</span><span class="w"> </span><span class="n">latest_ts</span><span class="p">);</span>
<a id="__codelineno-9-46" name="__codelineno-9-46" href="#__codelineno-9-46"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-9-47" name="__codelineno-9-47" href="#__codelineno-9-47"></a><span class="p">}</span>
</code></pre></div>
</details>

<p>On peut voir qu'après avoir reçu le paquet ACK, il est nécessaire d'utiliser <code>ikcp_parse_ack</code> et <code>ikcp_shrink_buf</code> pour mettre à jour <code>snd_buf</code>, en plus d'appeler <code>ikcp_update_ack</code> pour calculer le nouveau RTT (retransmission timeout, délai de retransmission). <code>ikcp_input</code> détermine le numéro de séquence le plus élevé dans le paquet ACK reçu, ce qui est enregistré pour un éventuel renvoi rapide. Ainsi, une fois que l'émetteur reçoit le paquet ACK, les données envoyées sont retirées de <code>snd_buf</code>, assurant ainsi que le paquet est bien reçu par le destinataire et que le cycle de confirmation de réception ARQ est achevé.</p>
<h3 id="re-transmission-en-cas-de-depassement-du-delai">Re-transmission en cas de dépassement du délai</h3>
<p>Ce qui précède est le mécanisme de confirmation de réception dans l'ARQ mis en œuvre par KCP. L'ARQ nécessite également une retransmission en cas de dépassement de délai pour garantir la fiabilité. Voyons ci-dessous comment KCP gère la retransmission en cas de dépassement de délai.</p>
<p>Revenons à la fonction <code>ikcp_flush</code> :</p>
<details>
<summary> Réexpédition en cas de délai d'attente (cliquez pour développer le code) </summary>
<div class="language-cpp highlight"><pre><span></span><code><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a><span class="kt">void</span><span class="w"> </span><span class="nf">ikcp_flush</span><span class="p">(</span><span class="n">ikcpcb</span><span class="w"> </span><span class="o">*</span><span class="n">kcp</span><span class="p">)</span>
<a id="__codelineno-10-2" name="__codelineno-10-2" href="#__codelineno-10-2"></a><span class="p">{</span>
<a id="__codelineno-10-3" name="__codelineno-10-3" href="#__codelineno-10-3"></a><span class="w">    </span><span class="c1">// ...</span>
<a id="__codelineno-10-4" name="__codelineno-10-4" href="#__codelineno-10-4"></a><span class="c1">// Envoyer snd_buf</span>
<a id="__codelineno-10-5" name="__codelineno-10-5" href="#__codelineno-10-5"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">snd_buf</span><span class="p">.</span><span class="n">next</span><span class="p">;</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">snd_buf</span><span class="p">;</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">p</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-10-6" name="__codelineno-10-6" href="#__codelineno-10-6"></a><span class="w">        </span><span class="n">IKCPSEG</span><span class="w"> </span><span class="o">*</span><span class="n">segment</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iqueue_entry</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="n">IKCPSEG</span><span class="p">,</span><span class="w"> </span><span class="n">node</span><span class="p">);</span>
<a id="__codelineno-10-7" name="__codelineno-10-7" href="#__codelineno-10-7"></a><span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">needsend</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="__codelineno-10-8" name="__codelineno-10-8" href="#__codelineno-10-8"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">segment</span><span class="o">-&gt;</span><span class="n">xmit</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-10-9" name="__codelineno-10-9" href="#__codelineno-10-9"></a><span class="c1">// Première envoi</span>
<a id="__codelineno-10-10" name="__codelineno-10-10" href="#__codelineno-10-10"></a><span class="w">            </span><span class="n">needsend</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<a id="__codelineno-10-11" name="__codelineno-10-11" href="#__codelineno-10-11"></a><span class="w">            </span><span class="n">segment</span><span class="o">-&gt;</span><span class="n">xmit</span><span class="o">++</span><span class="p">;</span>
<a id="__codelineno-10-12" name="__codelineno-10-12" href="#__codelineno-10-12"></a><span class="w">            </span><span class="c1">// Définir segment-&gt;rto</span>
<a id="__codelineno-10-13" name="__codelineno-10-13" href="#__codelineno-10-13"></a><span class="n">Calculez</span><span class="w"> </span><span class="n">le</span><span class="w"> </span><span class="n">temps</span><span class="w"> </span><span class="n">de</span><span class="w"> </span><span class="n">retransmission</span><span class="w"> </span><span class="n">du</span><span class="w"> </span><span class="n">segment</span><span class="o">-&gt;</span><span class="n">resendts</span><span class="w"> </span><span class="n">en</span><span class="w"> </span><span class="n">fonction</span><span class="w"> </span><span class="n">de</span><span class="w"> </span><span class="n">segment</span><span class="o">-&gt;</span><span class="n">rto</span><span class="p">.</span>
<a id="__codelineno-10-14" name="__codelineno-10-14" href="#__codelineno-10-14"></a><span class="w">            </span><span class="n">segment</span><span class="o">-&gt;</span><span class="n">rto</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">rx_rto</span><span class="p">;</span>
<a id="__codelineno-10-15" name="__codelineno-10-15" href="#__codelineno-10-15"></a><span class="w">            </span><span class="n">segment</span><span class="o">-&gt;</span><span class="n">resendts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">current</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">segment</span><span class="o">-&gt;</span><span class="n">rto</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">rtomin</span><span class="p">;</span>
<a id="__codelineno-10-16" name="__codelineno-10-16" href="#__codelineno-10-16"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-10-17" name="__codelineno-10-17" href="#__codelineno-10-17"></a><span class="w">        </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">_itimediff</span><span class="p">(</span><span class="n">current</span><span class="p">,</span><span class="w"> </span><span class="n">segment</span><span class="o">-&gt;</span><span class="n">resendts</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-10-18" name="__codelineno-10-18" href="#__codelineno-10-18"></a><span class="c1">// Rétransmission après délai d'attente</span>
<a id="__codelineno-10-19" name="__codelineno-10-19" href="#__codelineno-10-19"></a><span class="w">            </span><span class="n">needsend</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<a id="__codelineno-10-20" name="__codelineno-10-20" href="#__codelineno-10-20"></a><span class="w">            </span><span class="n">segment</span><span class="o">-&gt;</span><span class="n">xmit</span><span class="o">++</span><span class="p">;</span>
<a id="__codelineno-10-21" name="__codelineno-10-21" href="#__codelineno-10-21"></a><span class="w">            </span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">xmit</span><span class="o">++</span><span class="p">;</span>
<a id="__codelineno-10-22" name="__codelineno-10-22" href="#__codelineno-10-22"></a><span class="n">Contrôle</span><span class="w"> </span><span class="n">du</span><span class="w"> </span><span class="n">calcul</span><span class="w"> </span><span class="n">du</span><span class="w"> </span><span class="n">temps</span><span class="w"> </span><span class="n">de</span><span class="w"> </span><span class="n">retransmission</span><span class="w"> </span><span class="n">en</span><span class="w"> </span><span class="n">cas</span><span class="w"> </span><span class="n">de</span><span class="w"> </span><span class="n">délai</span><span class="w"> </span><span class="n">nul</span><span class="p">.</span>
<a id="__codelineno-10-23" name="__codelineno-10-23" href="#__codelineno-10-23"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">nodelay</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-10-24" name="__codelineno-10-24" href="#__codelineno-10-24"></a><span class="w">                </span><span class="n">segment</span><span class="o">-&gt;</span><span class="n">rto</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">rx_rto</span><span class="p">;</span>
<a id="__codelineno-10-25" name="__codelineno-10-25" href="#__codelineno-10-25"></a><span class="w">            </span><span class="p">}</span><span class="w">    </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-10-26" name="__codelineno-10-26" href="#__codelineno-10-26"></a><span class="w">                </span><span class="n">segment</span><span class="o">-&gt;</span><span class="n">rto</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">rx_rto</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span>
<a id="__codelineno-10-27" name="__codelineno-10-27" href="#__codelineno-10-27"></a><span class="w">            </span><span class="p">}</span>
<a id="__codelineno-10-28" name="__codelineno-10-28" href="#__codelineno-10-28"></a><span class="w">            </span><span class="n">segment</span><span class="o">-&gt;</span><span class="n">resendts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">current</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">segment</span><span class="o">-&gt;</span><span class="n">rto</span><span class="p">;</span>
<a id="__codelineno-10-29" name="__codelineno-10-29" href="#__codelineno-10-29"></a><span class="w">            </span><span class="n">lost</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<a id="__codelineno-10-30" name="__codelineno-10-30" href="#__codelineno-10-30"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-10-31" name="__codelineno-10-31" href="#__codelineno-10-31"></a><span class="w">        </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">segment</span><span class="o">-&gt;</span><span class="n">fastack</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">resent</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-10-32" name="__codelineno-10-32" href="#__codelineno-10-32"></a><span class="c1">// Répétition rapide</span>
<a id="__codelineno-10-33" name="__codelineno-10-33" href="#__codelineno-10-33"></a><span class="w">            </span><span class="c1">// ...</span>
<a id="__codelineno-10-34" name="__codelineno-10-34" href="#__codelineno-10-34"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-10-35" name="__codelineno-10-35" href="#__codelineno-10-35"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">needsend</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-10-36" name="__codelineno-10-36" href="#__codelineno-10-36"></a><span class="w">            </span><span class="c1">// Envoyer des données</span>
<a id="__codelineno-10-37" name="__codelineno-10-37" href="#__codelineno-10-37"></a><span class="w">            </span><span class="c1">// ...</span>
<a id="__codelineno-10-38" name="__codelineno-10-38" href="#__codelineno-10-38"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-10-39" name="__codelineno-10-39" href="#__codelineno-10-39"></a><span class="w">    </span><span class="c1">// ...</span>
<a id="__codelineno-10-40" name="__codelineno-10-40" href="#__codelineno-10-40"></a><span class="p">}</span>
</code></pre></div>
</details>

<p>Une fois que le temps actuel <code>current</code> dépasse le temps de retransmission de <code>segment-&gt;resendts</code>, cela signifie qu'aucun paquet ACK de la part du destinataire n'a été reçu pendant cette période, déclenchant le mécanisme de retransmission par timeout, <code>needsend = 1</code>, et les données doivent être renvoyées.</p>
<p>Avec les mécanismes de réception confirmée et de retransmission en cas de dépassement du délai, KCP peut garantir une transmission de données fiable de base. Cependant, pour maintenir un débit de données plus stable, KCP a effectué davantage d'optimisations. Jetons un œil aux autres améliorations apportées par KCP.</p>
<h2 id="strategie-pour-augmenter-le-debit-kcp">Stratégie pour augmenter le débit KCP</h2>
<h3 id="retransmission-rapide">Rétransmission rapide</h3>
<p>L'expéditeur a envoyé deux paquets de données, numérotés <code>sn</code> et <code>sn + 1</code>. Si seul l'ACK pour <code>sn + 1</code> a été reçu, cela pourrait être dû au fait que l'ACK pour <code>sn</code> n'est pas encore arrivé dans le réseau, ou que l'ACK a été perdu, ou que le paquet de données <code>sn</code> a été perdu. Si le délai de retransmission n'est pas encore atteint et que le réseau n'est pas encore trop encombré, mais que des pertes de paquets se produisent pour une raison quelconque, l'expéditeur peut choisir d'envoyer à nouveau le paquet de données <code>sn</code> de manière proactive, afin d'aider le récepteur à recevoir les données plus rapidement et d'augmenter le débit.</p>
<p>KCP met également en œuvre un mécanisme de retransmission rapide à l'intérieur de la fonction <code>ikcp_flush</code>.</p>
<details>
<summary> Fast retransmission (click to expand code) </summary>
<div class="language-cpp highlight"><pre><span></span><code><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a><span class="kt">void</span><span class="w"> </span><span class="nf">ikcp_flush</span><span class="p">(</span><span class="n">ikcpcb</span><span class="w"> </span><span class="o">*</span><span class="n">kcp</span><span class="p">)</span>
<a id="__codelineno-11-2" name="__codelineno-11-2" href="#__codelineno-11-2"></a><span class="p">{</span>
<a id="__codelineno-11-3" name="__codelineno-11-3" href="#__codelineno-11-3"></a><span class="w">    </span><span class="c1">// ...</span>
<a id="__codelineno-11-4" name="__codelineno-11-4" href="#__codelineno-11-4"></a><span class="w">    </span><span class="n">resent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">fastresend</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="o">?</span><span class="w"> </span><span class="p">(</span><span class="n">IUINT32</span><span class="p">)</span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">fastresend</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="mh">0xffffffff</span><span class="p">;</span>
<a id="__codelineno-11-5" name="__codelineno-11-5" href="#__codelineno-11-5"></a>
<a id="__codelineno-11-6" name="__codelineno-11-6" href="#__codelineno-11-6"></a><span class="c1">// Envoyer snd_buf</span>
<a id="__codelineno-11-7" name="__codelineno-11-7" href="#__codelineno-11-7"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">snd_buf</span><span class="p">.</span><span class="n">next</span><span class="p">;</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">snd_buf</span><span class="p">;</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">p</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-11-8" name="__codelineno-11-8" href="#__codelineno-11-8"></a><span class="w">        </span><span class="n">IKCPSEG</span><span class="w"> </span><span class="o">*</span><span class="n">segment</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iqueue_entry</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="n">IKCPSEG</span><span class="p">,</span><span class="w"> </span><span class="n">node</span><span class="p">);</span>
<a id="__codelineno-11-9" name="__codelineno-11-9" href="#__codelineno-11-9"></a><span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">needsend</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="__codelineno-11-10" name="__codelineno-11-10" href="#__codelineno-11-10"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">segment</span><span class="o">-&gt;</span><span class="n">xmit</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-11-11" name="__codelineno-11-11" href="#__codelineno-11-11"></a><span class="w">            </span><span class="c1">// ...</span>
<a id="__codelineno-11-12" name="__codelineno-11-12" href="#__codelineno-11-12"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-11-13" name="__codelineno-11-13" href="#__codelineno-11-13"></a><span class="w">        </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">_itimediff</span><span class="p">(</span><span class="n">current</span><span class="p">,</span><span class="w"> </span><span class="n">segment</span><span class="o">-&gt;</span><span class="n">resendts</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-11-14" name="__codelineno-11-14" href="#__codelineno-11-14"></a><span class="w">            </span><span class="c1">// ...</span>
<a id="__codelineno-11-15" name="__codelineno-11-15" href="#__codelineno-11-15"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-11-16" name="__codelineno-11-16" href="#__codelineno-11-16"></a><span class="w">        </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">segment</span><span class="o">-&gt;</span><span class="n">fastack</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">resent</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-11-17" name="__codelineno-11-17" href="#__codelineno-11-17"></a><span class="c1">// Transmission rapide</span>
<a id="__codelineno-11-18" name="__codelineno-11-18" href="#__codelineno-11-18"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="kt">int</span><span class="p">)</span><span class="n">segment</span><span class="o">-&gt;</span><span class="n">xmit</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">fastlimit</span><span class="w"> </span><span class="o">||</span>
<a id="__codelineno-11-19" name="__codelineno-11-19" href="#__codelineno-11-19"></a><span class="w">                </span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">fastlimit</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-11-20" name="__codelineno-11-20" href="#__codelineno-11-20"></a><span class="w">                </span><span class="n">needsend</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<a id="__codelineno-11-21" name="__codelineno-11-21" href="#__codelineno-11-21"></a><span class="w">                </span><span class="n">segment</span><span class="o">-&gt;</span><span class="n">xmit</span><span class="o">++</span><span class="p">;</span>
<a id="__codelineno-11-22" name="__codelineno-11-22" href="#__codelineno-11-22"></a><span class="w">                </span><span class="n">segment</span><span class="o">-&gt;</span><span class="n">fastack</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="__codelineno-11-23" name="__codelineno-11-23" href="#__codelineno-11-23"></a><span class="w">                </span><span class="n">segment</span><span class="o">-&gt;</span><span class="n">resendts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">current</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">segment</span><span class="o">-&gt;</span><span class="n">rto</span><span class="p">;</span>
<a id="__codelineno-11-24" name="__codelineno-11-24" href="#__codelineno-11-24"></a><span class="w">                </span><span class="n">change</span><span class="o">++</span><span class="p">;</span>
<a id="__codelineno-11-25" name="__codelineno-11-25" href="#__codelineno-11-25"></a><span class="w">            </span><span class="p">}</span>
<a id="__codelineno-11-26" name="__codelineno-11-26" href="#__codelineno-11-26"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-11-27" name="__codelineno-11-27" href="#__codelineno-11-27"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">needsend</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-11-28" name="__codelineno-11-28" href="#__codelineno-11-28"></a><span class="w">            </span><span class="c1">// Envoyer des données</span>
<a id="__codelineno-11-29" name="__codelineno-11-29" href="#__codelineno-11-29"></a><span class="w">            </span><span class="c1">// ...</span>
<a id="__codelineno-11-30" name="__codelineno-11-30" href="#__codelineno-11-30"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-11-31" name="__codelineno-11-31" href="#__codelineno-11-31"></a><span class="w">    </span><span class="c1">// ...</span>
<a id="__codelineno-11-32" name="__codelineno-11-32" href="#__codelineno-11-32"></a><span class="p">}</span>
</code></pre></div>
</details>

<p>Pour une retransmission rapide au départ, deux conditions doivent être remplies :
* <code>segment-&gt;fastack &gt;= resent</code>, resent est un paramètre configurable <code>kcp-&gt;fastresend</code>, configuré sur 0 désactive la retransmission rapide. <code>segment-&gt;fastack</code> est défini dans la fonction <code>ikcp_parse_fastack</code>, qui est appelée dans <code>ikcp_input</code>, et augmente <code>segment-&gt;fastack</code> de un pour tous les <code>sn</code> inférieurs à <code>maxack</code> calculé dans <code>ikcp_input</code>. Ainsi, <code>segment-&gt;fastack</code> représente le nombre de paquets reçus dont le numéro de séquence (sn) est supérieur.
Le texte à traduire en français est le suivant :</p>
<ul>
<li><code>segment-&gt;xmit &lt;= kcp-&gt;fastlimit || kcp-&gt;fastlimit &lt;= 0</code>，<code>setgment-&gt;xmit</code> est le nombre d'envois, <code>kcp-&gt;fastlimit</code> est le nombre maximum configurable de retransmissions rapides, le nombre d'envois doit être inférieur au nombre maximum de retransmissions rapides.</li>
</ul>
<p>Une fois que les conditions requises pour un accusé de réception rapide sont remplies, KCP procédera à l'accusé de réception rapide. Attention, l'accusé de réception rapide ne réinitialisera pas le délai de retransmission, le délai de retransmission d'origine restera en vigueur.</p>
<h3 id="reduire-le-temps-de-retransmission-des-delais-dattente">Réduire le temps de retransmission des délais d'attente.</h3>
<p>Le mécanisme de retransmission après expiration du délai est très utile, mais prend beaucoup de temps. Selon la stratégie TCP, le temps de retransmission après expiration du délai double à chaque fois, ce qui entraîne une augmentation rapide du temps d'attente. Pendant ce temps d'attente, il est probable que le récepteur ait épuisé sa fenêtre de réception, l'empêchant de recevoir de nouvelles données. De plus, le paquet à retransmettre se trouve en tête de file, ce qui signifie que le destinataire doit recevoir ce paquet avant de renvoyer toutes les données à la couche supérieure. Dans une telle situation, la vitesse du réseau est quasiment nulle. KCP propose une option de configuration pour ralentir la croissance du temps d'attente sans la doubler à chaque fois. En configurant <code>kcp-&gt;nodelay</code>, vous pouvez contrôler la croissance du temps d'attente pour qu'elle n'augmente que de 1 fois le RTO ou de 0,5 fois le RTO, ce qui permet de ralentir efficacement l'augmentation du temps d'attente et d'aider le réseau à retrouver rapidement sa vitesse.</p>
<h3 id="fenetre-denvoi-de-mise-a-jour">Fenêtre d'envoi de mise à jour</h3>
<p>La fenêtre d'envoi représente le nombre de paquets de données transférés simultanément. Plus la fenêtre est grande, plus il y a de données transférées simultanément, une vitesse de transmission plus rapide. Cependant, une fenêtre trop grande peut entraîner une congestion du réseau, une augmentation du taux de perte de paquets, une augmentation des retransmissions de données et une diminution de la vitesse de transmission. Par conséquent, la fenêtre d'envoi doit être constamment mise à jour en fonction de la situation du réseau, progressivement approcher de l'optimum. Le code sur la fenêtre d'envoi dans KCP :</p>
<details>
<summary>Envoyer la fenêtre (cliquez pour afficher le code)</summary>
<div class="language-cpp highlight"><pre><span></span><code><a id="__codelineno-12-1" name="__codelineno-12-1" href="#__codelineno-12-1"></a><span class="n">ikcpcb</span><span class="o">*</span><span class="w"> </span><span class="nf">ikcp_create</span><span class="p">(</span><span class="n">IUINT32</span><span class="w"> </span><span class="n">conv</span><span class="p">,</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">user</span><span class="p">)</span>
<a id="__codelineno-12-2" name="__codelineno-12-2" href="#__codelineno-12-2"></a><span class="p">{</span>
<a id="__codelineno-12-3" name="__codelineno-12-3" href="#__codelineno-12-3"></a><span class="w">    </span><span class="c1">// ...</span>
<a id="__codelineno-12-4" name="__codelineno-12-4" href="#__codelineno-12-4"></a><span class="c1">// snd_wnd, rcv_wnd taille des buffer d'envoi et de réception</span>
<a id="__codelineno-12-5" name="__codelineno-12-5" href="#__codelineno-12-5"></a><span class="w">    </span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">snd_wnd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">IKCP_WND_SND</span><span class="p">;</span><span class="w">    </span><span class="c1">// 32</span>
<a id="__codelineno-12-6" name="__codelineno-12-6" href="#__codelineno-12-6"></a><span class="w">    </span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">rcv_wnd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">IKCP_WND_RCV</span><span class="p">;</span><span class="w">    </span><span class="c1">// 128</span>
<a id="__codelineno-12-7" name="__codelineno-12-7" href="#__codelineno-12-7"></a><span class="c1">// Taille de la fenêtre de réception de l'autre extrémité              // 128</span>
<a id="__codelineno-12-8" name="__codelineno-12-8" href="#__codelineno-12-8"></a><span class="w">    </span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">rmt_wnd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">IKCP_WND_RCV</span>
<a id="__codelineno-12-9" name="__codelineno-12-9" href="#__codelineno-12-9"></a><span class="n">Initialiser</span><span class="w"> </span><span class="n">la</span><span class="w"> </span><span class="n">fenêtre</span><span class="w"> </span><span class="n">d</span><span class="err">'</span><span class="n">envoi</span><span class="w"> </span><span class="n">cwnd</span><span class="w"> </span><span class="n">à</span><span class="w"> </span><span class="mf">0.</span>
<a id="__codelineno-12-10" name="__codelineno-12-10" href="#__codelineno-12-10"></a><span class="w">    </span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">cwnd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="__codelineno-12-11" name="__codelineno-12-11" href="#__codelineno-12-11"></a><span class="n">Transmettre</span><span class="w"> </span><span class="n">la</span><span class="w"> </span><span class="n">taille</span><span class="w"> </span><span class="n">en</span><span class="w"> </span><span class="n">octets</span><span class="w"> </span><span class="n">de</span><span class="w"> </span><span class="n">la</span><span class="w"> </span><span class="n">fenêtre</span><span class="w"> </span><span class="n">d</span><span class="err">'</span><span class="n">envoi</span><span class="p">,</span><span class="w"> </span><span class="n">participant</span><span class="w"> </span><span class="n">au</span><span class="w"> </span><span class="n">calcul</span><span class="w"> </span><span class="n">de</span><span class="w"> </span><span class="n">la</span><span class="w"> </span><span class="n">cwnd</span>
<a id="__codelineno-12-12" name="__codelineno-12-12" href="#__codelineno-12-12"></a><span class="w">    </span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">incr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>
<a id="__codelineno-12-13" name="__codelineno-12-13" href="#__codelineno-12-13"></a><span class="n">Seuil</span><span class="w"> </span><span class="n">de</span><span class="w"> </span><span class="n">démarrage</span><span class="w"> </span><span class="n">lent</span>
<a id="__codelineno-12-14" name="__codelineno-12-14" href="#__codelineno-12-14"></a><span class="w">    </span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">ssthresh</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">IKCP_THRESH_INIT</span><span class="p">;</span>
<a id="__codelineno-12-15" name="__codelineno-12-15" href="#__codelineno-12-15"></a><span class="n">Le</span><span class="w"> </span><span class="s">"nocwnd"</span><span class="w"> </span><span class="n">est</span><span class="w"> </span><span class="n">un</span><span class="w"> </span><span class="n">paramètre</span><span class="w"> </span><span class="n">configurable</span><span class="p">,</span><span class="w"> </span><span class="n">avec</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="n">qui</span><span class="w"> </span><span class="n">ne</span><span class="w"> </span><span class="n">prend</span><span class="w"> </span><span class="n">pas</span><span class="w"> </span><span class="n">en</span><span class="w"> </span><span class="n">compte</span><span class="w"> </span><span class="n">le</span><span class="w"> </span><span class="n">cwnd</span><span class="p">.</span>
<a id="__codelineno-12-16" name="__codelineno-12-16" href="#__codelineno-12-16"></a><span class="w">    </span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">nocwnd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="__codelineno-12-17" name="__codelineno-12-17" href="#__codelineno-12-17"></a><span class="w">    </span><span class="c1">// ...</span>
<a id="__codelineno-12-18" name="__codelineno-12-18" href="#__codelineno-12-18"></a><span class="p">}</span>
<a id="__codelineno-12-19" name="__codelineno-12-19" href="#__codelineno-12-19"></a>
<a id="__codelineno-12-20" name="__codelineno-12-20" href="#__codelineno-12-20"></a><span class="kt">void</span><span class="w"> </span><span class="nf">ikcp_flush</span><span class="p">(</span><span class="n">ikcpcb</span><span class="w"> </span><span class="o">*</span><span class="n">kcp</span><span class="p">)</span>
<a id="__codelineno-12-21" name="__codelineno-12-21" href="#__codelineno-12-21"></a><span class="p">{</span>
<a id="__codelineno-12-22" name="__codelineno-12-22" href="#__codelineno-12-22"></a><span class="w">    </span><span class="c1">// ...</span>
<a id="__codelineno-12-23" name="__codelineno-12-23" href="#__codelineno-12-23"></a><span class="n">Lors</span><span class="w"> </span><span class="n">de</span><span class="w"> </span><span class="n">l</span><span class="err">'</span><span class="n">envoi</span><span class="w"> </span><span class="n">de</span><span class="w"> </span><span class="n">données</span><span class="p">,</span><span class="w"> </span><span class="n">commencez</span><span class="w"> </span><span class="n">par</span><span class="w"> </span><span class="n">calculer</span><span class="w"> </span><span class="n">la</span><span class="w"> </span><span class="n">taille</span><span class="w"> </span><span class="n">de</span><span class="w"> </span><span class="n">la</span><span class="w"> </span><span class="n">fenêtre</span><span class="w"> </span><span class="n">d</span><span class="err">'</span><span class="n">envoi</span><span class="p">,</span><span class="w"> </span><span class="n">qui</span><span class="w"> </span><span class="n">est</span><span class="w"> </span><span class="n">le</span><span class="w"> </span><span class="n">minimum</span><span class="w"> </span><span class="n">entre</span><span class="w"> </span><span class="n">la</span><span class="w"> </span><span class="n">taille</span><span class="w"> </span><span class="n">du</span><span class="w"> </span><span class="n">tampon</span><span class="w"> </span><span class="n">d</span><span class="err">'</span><span class="n">envoi</span><span class="w"> </span><span class="n">et</span><span class="w"> </span><span class="n">la</span><span class="w"> </span><span class="n">taille</span><span class="w"> </span><span class="n">de</span><span class="w"> </span><span class="n">la</span><span class="w"> </span><span class="n">fenêtre</span><span class="w"> </span><span class="n">de</span><span class="w"> </span><span class="n">réception</span><span class="w"> </span><span class="n">de</span><span class="w"> </span><span class="n">l</span><span class="err">'</span><span class="n">autre</span><span class="w"> </span><span class="n">partie</span><span class="p">.</span>
<a id="__codelineno-12-24" name="__codelineno-12-24" href="#__codelineno-12-24"></a><span class="w">    </span><span class="n">cwnd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_imin_</span><span class="p">(</span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">snd_wnd</span><span class="p">,</span><span class="w"> </span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">rmt_wnd</span><span class="p">);</span>
<a id="__codelineno-12-25" name="__codelineno-12-25" href="#__codelineno-12-25"></a><span class="n">Il</span><span class="w"> </span><span class="n">est</span><span class="w"> </span><span class="n">également</span><span class="w"> </span><span class="n">nécessaire</span><span class="w"> </span><span class="n">de</span><span class="w"> </span><span class="n">prendre</span><span class="w"> </span><span class="n">en</span><span class="w"> </span><span class="n">compte</span><span class="w"> </span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">cwnd</span><span class="p">,</span><span class="w"> </span><span class="n">qui</span><span class="w"> </span><span class="n">est</span><span class="w"> </span><span class="n">la</span><span class="w"> </span><span class="n">fenêtre</span><span class="w"> </span><span class="n">d</span><span class="err">'</span><span class="n">envoi</span><span class="w"> </span><span class="n">en</span><span class="w"> </span><span class="n">constante</span><span class="w"> </span><span class="n">évolution</span><span class="p">.</span>
<a id="__codelineno-12-26" name="__codelineno-12-26" href="#__codelineno-12-26"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">nocwnd</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="n">cwnd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_imin_</span><span class="p">(</span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">cwnd</span><span class="p">,</span><span class="w"> </span><span class="n">cwnd</span><span class="p">);</span>
<a id="__codelineno-12-27" name="__codelineno-12-27" href="#__codelineno-12-27"></a>
<a id="__codelineno-12-28" name="__codelineno-12-28" href="#__codelineno-12-28"></a><span class="c1">// Déplacer snd_queue vers snd_buf en fonction de la taille de cwnd</span>
<a id="__codelineno-12-29" name="__codelineno-12-29" href="#__codelineno-12-29"></a><span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">_itimediff</span><span class="p">(</span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">snd_nxt</span><span class="p">,</span><span class="w"> </span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">snd_una</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">cwnd</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-12-30" name="__codelineno-12-30" href="#__codelineno-12-30"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-12-31" name="__codelineno-12-31" href="#__codelineno-12-31"></a><span class="n">Envoyez</span><span class="w"> </span><span class="n">les</span><span class="w"> </span><span class="n">données</span>
<a id="__codelineno-12-32" name="__codelineno-12-32" href="#__codelineno-12-32"></a><span class="w">    </span><span class="n">resent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">fastresend</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="o">?</span><span class="w"> </span><span class="p">(</span><span class="n">IUINT32</span><span class="p">)</span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">fastresend</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="mh">0xffffffff</span><span class="p">;</span>
<a id="__codelineno-12-33" name="__codelineno-12-33" href="#__codelineno-12-33"></a><span class="c1">// Déclencher la retransmission de temporisation lost = 1</span>
<a id="__codelineno-12-34" name="__codelineno-12-34" href="#__codelineno-12-34"></a><span class="n">Déclencher</span><span class="w"> </span><span class="n">la</span><span class="w"> </span><span class="n">répétition</span><span class="w"> </span><span class="n">rapide</span><span class="w"> </span><span class="n">après</span><span class="w"> </span><span class="n">un</span><span class="w"> </span><span class="n">changement</span><span class="o">++</span>
<a id="__codelineno-12-35" name="__codelineno-12-35" href="#__codelineno-12-35"></a>
<a id="__codelineno-12-36" name="__codelineno-12-36" href="#__codelineno-12-36"></a><span class="c1">// Mettre à jour le seuil de démarrage lent et la fenêtre d'envoi</span>
<a id="__codelineno-12-37" name="__codelineno-12-37" href="#__codelineno-12-37"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">change</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-12-38" name="__codelineno-12-38" href="#__codelineno-12-38"></a><span class="n">Si</span><span class="w"> </span><span class="n">un</span><span class="w"> </span><span class="n">déclenchement</span><span class="w"> </span><span class="n">de</span><span class="w"> </span><span class="n">retransmission</span><span class="w"> </span><span class="n">rapide</span><span class="w"> </span><span class="n">se</span><span class="w"> </span><span class="n">produit</span><span class="p">,</span><span class="w"> </span><span class="n">la</span><span class="w"> </span><span class="n">valeur</span><span class="w"> </span><span class="n">de</span><span class="w"> </span><span class="n">ssthresh</span><span class="w"> </span><span class="n">est</span><span class="w"> </span><span class="n">établie</span><span class="w"> </span><span class="n">à</span><span class="w"> </span><span class="n">la</span><span class="w"> </span><span class="n">moitié</span><span class="w"> </span><span class="n">du</span><span class="w"> </span><span class="n">nombre</span><span class="w"> </span><span class="n">de</span><span class="w"> </span><span class="n">paquets</span><span class="w"> </span><span class="n">en</span><span class="w"> </span><span class="n">transit</span><span class="w"> </span><span class="n">sur</span><span class="w"> </span><span class="n">le</span><span class="w"> </span><span class="n">réseau</span><span class="p">.</span>
<a id="__codelineno-12-39" name="__codelineno-12-39" href="#__codelineno-12-39"></a><span class="w">        </span><span class="n">IUINT32</span><span class="w"> </span><span class="n">inflight</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">snd_nxt</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">snd_una</span><span class="p">;</span>
<a id="__codelineno-12-40" name="__codelineno-12-40" href="#__codelineno-12-40"></a><span class="w">        </span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">ssthresh</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inflight</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span>
<a id="__codelineno-12-41" name="__codelineno-12-41" href="#__codelineno-12-41"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">ssthresh</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">IKCP_THRESH_MIN</span><span class="p">)</span>
<a id="__codelineno-12-42" name="__codelineno-12-42" href="#__codelineno-12-42"></a><span class="w">            </span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">ssthresh</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">IKCP_THRESH_MIN</span><span class="p">;</span>
<a id="__codelineno-12-43" name="__codelineno-12-43" href="#__codelineno-12-43"></a>
<a id="__codelineno-12-44" name="__codelineno-12-44" href="#__codelineno-12-44"></a><span class="c1">// La fenêtre d'envoi est égale à la valeur du seuil plus les renvois liés à la retransmission rapide.</span>
<a id="__codelineno-12-45" name="__codelineno-12-45" href="#__codelineno-12-45"></a><span class="w">        </span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">cwnd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">ssthresh</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">resent</span><span class="p">;</span>
<a id="__codelineno-12-46" name="__codelineno-12-46" href="#__codelineno-12-46"></a><span class="w">        </span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">incr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">cwnd</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">mss</span><span class="p">;</span>
<a id="__codelineno-12-47" name="__codelineno-12-47" href="#__codelineno-12-47"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-12-48" name="__codelineno-12-48" href="#__codelineno-12-48"></a>
<a id="__codelineno-12-49" name="__codelineno-12-49" href="#__codelineno-12-49"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">lost</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-12-50" name="__codelineno-12-50" href="#__codelineno-12-50"></a><span class="n">Si</span><span class="w"> </span><span class="n">des</span><span class="w"> </span><span class="n">retransmissions</span><span class="w"> </span><span class="n">sont</span><span class="w"> </span><span class="n">déclenchées</span><span class="w"> </span><span class="n">en</span><span class="w"> </span><span class="n">cas</span><span class="w"> </span><span class="n">de</span><span class="w"> </span><span class="n">dépassement</span><span class="w"> </span><span class="n">de</span><span class="w"> </span><span class="n">délai</span><span class="p">,</span><span class="w"> </span><span class="n">cela</span><span class="w"> </span><span class="n">déclenche</span><span class="w"> </span><span class="n">un</span><span class="w"> </span><span class="n">démarrage</span><span class="w"> </span><span class="n">lent</span><span class="p">,</span><span class="w"> </span><span class="n">avec</span><span class="w"> </span><span class="n">le</span><span class="w"> </span><span class="n">seuil</span><span class="w"> </span><span class="n">ssthresh</span><span class="w"> </span><span class="n">défini</span><span class="w"> </span><span class="n">comme</span><span class="w"> </span><span class="n">la</span><span class="w"> </span><span class="n">moitié</span><span class="w"> </span><span class="n">de</span><span class="w"> </span><span class="n">la</span><span class="w"> </span><span class="n">fenêtre</span><span class="w"> </span><span class="n">d</span><span class="err">'</span><span class="n">envoi</span><span class="p">.</span>
<a id="__codelineno-12-51" name="__codelineno-12-51" href="#__codelineno-12-51"></a><span class="w">        </span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">ssthresh</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cwnd</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span>
<a id="__codelineno-12-52" name="__codelineno-12-52" href="#__codelineno-12-52"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">ssthresh</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">IKCP_THRESH_MIN</span><span class="p">)</span>
<a id="__codelineno-12-53" name="__codelineno-12-53" href="#__codelineno-12-53"></a><span class="w">            </span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">ssthresh</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">IKCP_THRESH_MIN</span><span class="p">;</span>
<a id="__codelineno-12-54" name="__codelineno-12-54" href="#__codelineno-12-54"></a><span class="c1">// Envoyer la fenêtre de retour à 1, redémarrer la croissance à un rythme lent</span>
<a id="__codelineno-12-55" name="__codelineno-12-55" href="#__codelineno-12-55"></a><span class="w">        </span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">cwnd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<a id="__codelineno-12-56" name="__codelineno-12-56" href="#__codelineno-12-56"></a><span class="w">        </span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">incr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">mss</span><span class="p">;</span>
<a id="__codelineno-12-57" name="__codelineno-12-57" href="#__codelineno-12-57"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-12-58" name="__codelineno-12-58" href="#__codelineno-12-58"></a>
<a id="__codelineno-12-59" name="__codelineno-12-59" href="#__codelineno-12-59"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">cwnd</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-12-60" name="__codelineno-12-60" href="#__codelineno-12-60"></a><span class="c1">// Parce qu'il est initialisé à 0, il sera de nouveau réglé à 1 ici.</span>
<a id="__codelineno-12-61" name="__codelineno-12-61" href="#__codelineno-12-61"></a><span class="w">        </span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">cwnd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<a id="__codelineno-12-62" name="__codelineno-12-62" href="#__codelineno-12-62"></a><span class="w">        </span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">incr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">mss</span><span class="p">;</span>
<a id="__codelineno-12-63" name="__codelineno-12-63" href="#__codelineno-12-63"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-12-64" name="__codelineno-12-64" href="#__codelineno-12-64"></a><span class="p">}</span>
<a id="__codelineno-12-65" name="__codelineno-12-65" href="#__codelineno-12-65"></a>
<a id="__codelineno-12-66" name="__codelineno-12-66" href="#__codelineno-12-66"></a><span class="kt">int</span><span class="w"> </span><span class="nf">ikcp_input</span><span class="p">(</span><span class="n">ikcpcb</span><span class="w"> </span><span class="o">*</span><span class="n">kcp</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">size</span><span class="p">)</span>
<a id="__codelineno-12-67" name="__codelineno-12-67" href="#__codelineno-12-67"></a><span class="p">{</span>
<a id="__codelineno-12-68" name="__codelineno-12-68" href="#__codelineno-12-68"></a><span class="w">    </span><span class="n">IUINT32</span><span class="w"> </span><span class="n">prev_una</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">snd_una</span><span class="p">;</span>
<a id="__codelineno-12-69" name="__codelineno-12-69" href="#__codelineno-12-69"></a><span class="c1">// Traiter les données reçues</span>
<a id="__codelineno-12-70" name="__codelineno-12-70" href="#__codelineno-12-70"></a>
<a id="__codelineno-12-71" name="__codelineno-12-71" href="#__codelineno-12-71"></a><span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-12-72" name="__codelineno-12-72" href="#__codelineno-12-72"></a><span class="w">        </span><span class="c1">// ...</span>
<a id="__codelineno-12-73" name="__codelineno-12-73" href="#__codelineno-12-73"></a><span class="w">        </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ikcp_decode16u</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">wnd</span><span class="p">)</span>
<a id="__codelineno-12-74" name="__codelineno-12-74" href="#__codelineno-12-74"></a><span class="c1">// rmt_wnd est la taille de la fenêtre de réception de l'autre partie.</span>
<a id="__codelineno-12-75" name="__codelineno-12-75" href="#__codelineno-12-75"></a><span class="w">        </span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">rmt_wnd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">wnd</span>
<a id="__codelineno-12-76" name="__codelineno-12-76" href="#__codelineno-12-76"></a><span class="w">        </span><span class="c1">// ...</span>
<a id="__codelineno-12-77" name="__codelineno-12-77" href="#__codelineno-12-77"></a><span class="c1">// Traitement des données</span>
<a id="__codelineno-12-78" name="__codelineno-12-78" href="#__codelineno-12-78"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-12-79" name="__codelineno-12-79" href="#__codelineno-12-79"></a>
<a id="__codelineno-12-80" name="__codelineno-12-80" href="#__codelineno-12-80"></a><span class="c1">// Dernière mise à jour de la fenêtre d'envoi</span>
<a id="__codelineno-12-81" name="__codelineno-12-81" href="#__codelineno-12-81"></a><span class="c1">// kcp-&gt;snd_una - prev_una &gt; 0, cela indique que cette fois l'input a reçu un ACK et que le tampon d'envoi snd_buf a changé.</span>
<a id="__codelineno-12-82" name="__codelineno-12-82" href="#__codelineno-12-82"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">_itimediff</span><span class="p">(</span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">snd_una</span><span class="p">,</span><span class="w"> </span><span class="n">prev_una</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-12-83" name="__codelineno-12-83" href="#__codelineno-12-83"></a><span class="n">Vérifie</span><span class="w"> </span><span class="n">à</span><span class="w"> </span><span class="n">nouveau</span><span class="w"> </span><span class="n">la</span><span class="w"> </span><span class="n">fenêtre</span><span class="w"> </span><span class="n">de</span><span class="w"> </span><span class="n">réception</span><span class="w"> </span><span class="n">de</span><span class="w"> </span><span class="n">la</span><span class="w"> </span><span class="n">partie</span><span class="w"> </span><span class="n">opposée</span><span class="p">.</span>
<a id="__codelineno-12-84" name="__codelineno-12-84" href="#__codelineno-12-84"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">cwnd</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">rmt_wnd</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-12-85" name="__codelineno-12-85" href="#__codelineno-12-85"></a><span class="w">            </span><span class="n">IUINT32</span><span class="w"> </span><span class="n">mss</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">mss</span><span class="p">;</span>
<a id="__codelineno-12-86" name="__codelineno-12-86" href="#__codelineno-12-86"></a>
<a id="__codelineno-12-87" name="__codelineno-12-87" href="#__codelineno-12-87"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">cwnd</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">ssthresh</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-12-88" name="__codelineno-12-88" href="#__codelineno-12-88"></a><span class="n">Lorsque</span><span class="w"> </span><span class="n">la</span><span class="w"> </span><span class="n">quantité</span><span class="w"> </span><span class="n">de</span><span class="w"> </span><span class="n">données</span><span class="w"> </span><span class="n">est</span><span class="w"> </span><span class="n">inférieure</span><span class="w"> </span><span class="n">au</span><span class="w"> </span><span class="n">seuil</span><span class="w"> </span><span class="n">de</span><span class="w"> </span><span class="n">démarrage</span><span class="w"> </span><span class="n">lent</span><span class="p">,</span><span class="w"> </span><span class="n">la</span><span class="w"> </span><span class="n">croissance</span><span class="w"> </span><span class="n">est</span><span class="w"> </span><span class="n">doublée</span><span class="p">.</span>
<a id="__codelineno-12-89" name="__codelineno-12-89" href="#__codelineno-12-89"></a><span class="w">                </span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">cwnd</span><span class="o">++</span><span class="p">;</span>
<a id="__codelineno-12-90" name="__codelineno-12-90" href="#__codelineno-12-90"></a><span class="w">                </span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">incr</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">mss</span><span class="p">;</span>
<a id="__codelineno-12-91" name="__codelineno-12-91" href="#__codelineno-12-91"></a>
<a id="__codelineno-12-92" name="__codelineno-12-92" href="#__codelineno-12-92"></a><span class="w">            </span><span class="p">}</span><span class="w">    </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-12-93" name="__codelineno-12-93" href="#__codelineno-12-93"></a><span class="n">Lorsque</span><span class="w"> </span><span class="n">le</span><span class="w"> </span><span class="n">seuil</span><span class="w"> </span><span class="n">de</span><span class="w"> </span><span class="n">démarrage</span><span class="w"> </span><span class="n">lent</span><span class="w"> </span><span class="n">est</span><span class="w"> </span><span class="n">dépassé</span><span class="p">,</span><span class="w"> </span><span class="n">incr</span><span class="w"> </span><span class="n">est</span><span class="w"> </span><span class="n">mis</span><span class="w"> </span><span class="n">à</span><span class="w"> </span><span class="n">jour</span><span class="w"> </span><span class="n">en</span><span class="w"> </span><span class="n">utilisant</span><span class="w"> </span><span class="n">la</span><span class="w"> </span><span class="n">formule</span><span class="p">,</span><span class="w"> </span><span class="n">puis</span><span class="w"> </span><span class="n">cwnd</span><span class="w"> </span><span class="n">est</span><span class="w"> </span><span class="n">calculé</span><span class="p">.</span>
<a id="__codelineno-12-94" name="__codelineno-12-94" href="#__codelineno-12-94"></a><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">incr</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">mss</span><span class="p">)</span><span class="w"> </span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">incr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mss</span><span class="p">;</span>
<a id="__codelineno-12-95" name="__codelineno-12-95" href="#__codelineno-12-95"></a><span class="w">                </span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">incr</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="p">(</span><span class="n">mss</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">mss</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">incr</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">mss</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">16</span><span class="p">);</span>
<a id="__codelineno-12-96" name="__codelineno-12-96" href="#__codelineno-12-96"></a><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">cwnd</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">mss</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">incr</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-12-97" name="__codelineno-12-97" href="#__codelineno-12-97"></a><span class="w">                    </span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">cwnd</span><span class="o">++</span><span class="p">;</span>
<a id="__codelineno-12-98" name="__codelineno-12-98" href="#__codelineno-12-98"></a><span class="w">                </span><span class="p">}</span>
<a id="__codelineno-12-99" name="__codelineno-12-99" href="#__codelineno-12-99"></a><span class="w">            </span><span class="p">}</span>
<a id="__codelineno-12-100" name="__codelineno-12-100" href="#__codelineno-12-100"></a><span class="c1">// Les valeurs mises à jour doivent encore être comparées à rmt_wnd</span>
<a id="__codelineno-12-101" name="__codelineno-12-101" href="#__codelineno-12-101"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">cwnd</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">rmt_wnd</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-12-102" name="__codelineno-12-102" href="#__codelineno-12-102"></a><span class="w">                </span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">cwnd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">rmt_wnd</span><span class="p">;</span>
<a id="__codelineno-12-103" name="__codelineno-12-103" href="#__codelineno-12-103"></a><span class="w">                </span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">incr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">rmt_wnd</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">mss</span><span class="p">;</span>
<a id="__codelineno-12-104" name="__codelineno-12-104" href="#__codelineno-12-104"></a><span class="w">            </span><span class="p">}</span>
<a id="__codelineno-12-105" name="__codelineno-12-105" href="#__codelineno-12-105"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-12-106" name="__codelineno-12-106" href="#__codelineno-12-106"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-12-107" name="__codelineno-12-107" href="#__codelineno-12-107"></a><span class="p">}</span>
</code></pre></div>
</details>

<p>La traduction en français du texte est la suivante :</p>
<p>La taille du fenêtre d'envoi <code>kcp-&gt;cwnd</code> nécessite un peu plus de code, car elle doit être mise à jour à la fois lors de l'envoi et de la réception de données. <code>kcp-&gt;cwnd</code> est initialisé à 0.
Ensuite, lors de la première invocation de <code>ikcp_flush</code>, si la valeur est inférieure à 1, elle sera modifiée à 1. Par la suite, l'expéditeur enverra un nombre correspondant de paquets de données en fonction de la taille de la fenêtre d'envoi, en attendant les ACK.
Traitez les paquets de réponse. Les paquets ACK sont traités dans <code>kcp-&gt;input</code>, si un paquet ACK est détecté dans <code>kcp-&gt;input</code> et qu'il y a une suppression des paquets de données envoyés dans le tampon d'envoi, cela signifie que les paquets de données ont été livrés avec succès, alors <code>kcp-&gt;cwnd++</code>. En réalité, il est très probable qu'un seul paquet ACK soit traité à chaque fois dans <code>kcp-&gt;input</code>. On peut dire que pour chaque ACK reçu, il y a <code>kcp-&gt;cwnd++</code>. Cette incrémentation implique un effet de doublement, par exemple si <code>kcp-&gt;cwnd = 2</code>, en envoyant deux paquets de données et en recevant deux ACK, cela déclenche deux incréments, aboutissant finalement à <code>kcp-&gt;cwnd = 4</code>, un doublement.</p>
<p><code>cwnd</code> peut continuer à croître de manière exponentielle jusqu'à dépasser le seuil de démarrage lent, ou en cas de retransmission par timeout ou de retransmission rapide. Après une retransmission par timeout, le démarrage lent est déclenché, le seuil de démarrage lent <code>ssthresh = kcp-&gt;cwnd / 2</code>, la fenêtre d'envoi <code>kcp-&gt;cwnd = 1</code>, et on revient au début pour une nouvelle croissance exponentielle. En cas de retransmission rapide, KCP réduit d'abord <code>ssthresh</code>, c'est-à-dire qu'il réduit l'espace de croissance exponentielle de <code>cwnd</code>, ralentissant ainsi la vitesse de croissance et atténuant les problèmes de congestion.</p>
<p>KCP a également ajouté une configuration "nocwnd". Lorsque "nocwnd = 1", l'envoi de données ne tient plus compte de la taille de la fenêtre d'envoi. Il envoie directement le maximum de paquets de données qui peuvent être envoyés, répondant ainsi aux exigences du mode haute vitesse.</p>
<h2 id="resume">Résumé</h2>
<p>Cet article analyse simplement le code source de KCP et discute de l'implémentation de l'ARQ sur KCP, ainsi que de certaines stratégies pour améliorer le débit de KCP. Il reste de nombreux détails non abordés, ceux qui sont intéressés peuvent consulter le code source de KCP par eux-mêmes et s'attendre à en tirer également de nombreux apprentissages.</p>
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

<!-- 转载声明 && visit -->
<blockquote>
<p>Original: <a href="https://wiki.disenone.site/fr">https://wiki.disenone.site/fr</a></p>
<p>This post is protected by <a href="https://creativecommons.org/licenses/by/4.0/deed.en">CC BY-NC-SA 4.0</a> agreement, should be reproduced with attribution.</p>
</blockquote>
<!-- 转载 -->
<div class="a2a_kit a2a_kit_size_32 a2a_default_style" data-a2a-icon-color="#4051b5">
    <a class="a2a_dd" href="https://www.addtoany.com/share"></a>
    <a class="a2a_button_copy_link"></a>
    <a class="a2a_button_wechat"></a>
    <a class="a2a_button_reddit"></a>
    <a class="a2a_button_google_gmail"></a>
    <a class="a2a_button_pocket"></a>
</div>
<script async src="https://static.addtoany.com/menu/page.js"></script>

<!-- 评论 -->
<script src="https://giscus.app/client.js" data-repo="disenone/wiki" data-repo-id="R_kgDOKz9PQg" data-category="Announcements" data-category-id="DIC_kwDOKz9PQs4Cbbvv" data-mapping="og:title" data-strict="1" data-reactions-enabled="1" data-emit-metadata="0" data-input-position="top" data-theme="preferred_color_scheme" data-lang="fr" data-loading="lazy" crossorigin="anonymous" async>
</script>

<!-- visit -->
<blockquote>
<p></p><p class="copyright text-muted"><span id="busuanzi_container_site_uv"> <span id="busuanzi_value_site_uv"></span> Visitors. </span> <span id="busuanzi_container_site_pv"> <span id="busuanzi_value_site_pv"></span> Total Visits. </span> <span id="busuanzi_container_page_pv"> <span id="busuanzi_value_page_pv"></span> Page Visits. </span></p>
<p>Ce message a été traduit en utilisant ChatGPT, veuillez laisser vos commentaires dans <a href="https://github.com/disenone/wiki_blog/issues/new"><strong>Feedback</strong></a>Veuillez signaler toute omission. </p>
</blockquote></div>







  
    
  
  
    
  


  <aside class="md-source-file">
    
      
  <span class="md-source-file__fact">
    <span class="md-icon" title="Dernière mise à jour">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M21 13.1c-.1 0-.3.1-.4.2l-1 1 2.1 2.1 1-1c.2-.2.2-.6 0-.8l-1.3-1.3c-.1-.1-.2-.2-.4-.2m-1.9 1.8-6.1 6V23h2.1l6.1-6.1zM12.5 7v5.2l4 2.4-1 1L11 13V7zM11 21.9c-5.1-.5-9-4.8-9-9.9C2 6.5 6.5 2 12 2c5.3 0 9.6 4.1 10 9.3-.3-.1-.6-.2-1-.2s-.7.1-1 .2C19.6 7.2 16.2 4 12 4c-4.4 0-8 3.6-8 8 0 4.1 3.1 7.5 7.1 7.9l-.1.2z"/></svg>
    </span>
    <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-custom">2025-01-31</span>
  </span>

    
    
      
  <span class="md-source-file__fact">
    <span class="md-icon" title="Créé">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M14.47 15.08 11 13V7h1.5v5.25l3.08 1.83c-.41.28-.79.62-1.11 1m-1.39 4.84c-.36.05-.71.08-1.08.08-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8c0 .37-.03.72-.08 1.08.69.1 1.33.32 1.92.64.1-.56.16-1.13.16-1.72 0-5.5-4.5-10-10-10S2 6.5 2 12s4.47 10 10 10c.59 0 1.16-.06 1.72-.16-.32-.59-.54-1.23-.64-1.92M18 15v3h-3v2h3v3h2v-3h3v-2h-3v-3z"/></svg>
    </span>
    <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-custom">2025-01-04</span>
  </span>

    
    
    
  </aside>





                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Retour en haut de la page
</button>
        
      </main>
      
        <footer class="md-footer">
  
    
      
      <nav class="md-footer__inner md-grid" aria-label="Pied de page" >
        
          
          <a href="../cpp-%E7%BC%96%E5%86%99Windows%E4%B8%8B%E7%9A%84MemoryLeakDetector/" class="md-footer__link md-footer__link--prev" aria-label="Précédent: Rédigez un détecteur de fuites de mémoire pour Windows.">
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
            </div>
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Précédent
              </span>
              <div class="md-ellipsis">
                Rédigez un détecteur de fuites de mémoire pour Windows.
              </div>
            </div>
          </a>
        
        
          
          <a href="../py-%E4%BD%BF%E7%94%A8VisualStudio2015%E7%BC%96%E8%AF%91Python2.7.11/" class="md-footer__link md-footer__link--next" aria-label="Suivant: Utiliser Visual Studio 2015 pour compiler Python 2.7.11">
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Suivant
              </span>
              <div class="md-ellipsis">
                Utiliser Visual Studio 2015 pour compiler Python 2.7.11
              </div>
            </div>
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11z"/></svg>
            </div>
          </a>
        
      </nav>
    
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright &copy; 2014 - 2024 by <a href="https://github.com/disenone"> Disenone </a>
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "../..", "features": ["content.code.copy", "content.code.annotate", "content.code.select", "content.action.edit", "content.tooltips", "navigation.tracking", "navigation.tabs", "navigation.footer", "navigation.sections", "navigation.indexes", "toc.follow", "navigation.top", "search.suggest"], "search": "../../assets/javascripts/workers/search.f8cc74c7.min.js", "translations": {"clipboard.copied": "Copi\u00e9 dans le presse-papier", "clipboard.copy": "Copier dans le presse-papier", "search.result.more.one": "1 de plus sur cette page", "search.result.more.other": "# de plus sur cette page", "search.result.none": "Aucun document trouv\u00e9", "search.result.one": "1 document trouv\u00e9", "search.result.other": "# documents trouv\u00e9s", "search.result.placeholder": "Taper pour d\u00e9marrer la recherche", "search.result.term.missing": "Non trouv\u00e9", "select.version": "S\u00e9lectionner la version"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.60a45f97.min.js"></script>
      
    
  <script id="init-glightbox">const lightbox = GLightbox({"touchNavigation": true, "loop": false, "zoomable": true, "draggable": true, "openEffect": "zoom", "closeEffect": "zoom", "slideEffect": "slide"});
document$.subscribe(() => { lightbox.reload() });
</script></body>
</html>