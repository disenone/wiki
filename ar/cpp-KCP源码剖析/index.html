
<!doctype html>
<html lang="ar" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="هذا المقال يحلل ببساطة شيفرة KCP ويناقش تنفيذ نقارة التكرار التلقائي على KCP، بالإضافة إلى بعض استراتيجيات تعزيز سرعة تدفق KCP.">
      
      
        <meta name="author" content="Disenone">
      
      
        <link rel="canonical" href="https://wiki.disenone.site/ar/cpp-KCP%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90/">
      
      
        <link rel="prev" href="../cpp-%E7%BC%96%E5%86%99Windows%E4%B8%8B%E7%9A%84MemoryLeakDetector/">
      
      
        <link rel="next" href="../py-%E4%BD%BF%E7%94%A8VisualStudio2015%E7%BC%96%E8%AF%91Python2.7.11/">
      
      
        <link rel="alternate" type="application/rss+xml" title="ملقم بالخلاصات" href="../../feed_rss_created.xml">
        <link rel="alternate" type="application/rss+xml" title="ملقم بالخلاصات المحدثة" href="../../feed_rss_updated.xml">
      
      <link rel="icon" href="../../assets/favicon/favicon.ico">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.5.50">
    
    
      
        <title>KCP كود المصدر التحليل - Disenone's Wiki</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.a40c8224.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Noto+Sans+SC+-+local:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Noto Sans SC - local";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../assets/css/style.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    

   <link href="../../assets/stylesheets/glightbox.min.css" rel="stylesheet"/><style>
    html.glightbox-open { overflow: initial; height: 100%; }
    .gslide-title { margin-top: 0px; user-select: text; }
    .gslide-desc { color: #666; user-select: text; }
    .gslide-image img { background: white; }
    .gscrollbar-fixer { padding-right: 15px; }
    .gdesc-inner { font-size: 0.75rem; }
    body[data-md-color-scheme="slate"] .gdesc-inner { background: var(--md-default-bg-color);}
    body[data-md-color-scheme="slate"] .gslide-title { color: var(--md-default-fg-color);}
    body[data-md-color-scheme="slate"] .gslide-desc { color: var(--md-default-fg-color);}</style> <script src="../../assets/javascripts/glightbox.min.js"></script></head>
  
  
    
    
      
    
    
    
    
    <body dir="rtl" data-md-color-scheme="default" data-md-color-primary="4051b5" data-md-color-accent="blue">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#kcp" class="md-skip">
          انتقل إلى المحتوى
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="عنوان العارضة">
    <a href="../" title="Disenone&#39;s Wiki" class="md-header__button md-logo" aria-label="Disenone's Wiki" data-md-component="logo">
      
  <img src="../../assets/favicon/android-chrome-512x512.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Disenone's Wiki
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              KCP كود المصدر التحليل
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="4051b5" data-md-color-accent="blue"  aria-label="切换暗色模式"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="切换暗色模式" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3m0 8a5 5 0 0 1-5-5 5 5 0 0 1 5-5 5 5 0 0 1 5 5 5 5 0 0 1-5 5m0-12.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="black" data-md-color-accent="blue"  aria-label="切换亮色模式"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="切换亮色模式" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 9a3 3 0 0 1 3 3 3 3 0 0 1-3 3 3 3 0 0 1-3-3 3 3 0 0 1 3-3m0-4.5c5 0 9.27 3.11 11 7.5-1.73 4.39-6 7.5-11 7.5S2.73 16.39 1 12c1.73-4.39 6-7.5 11-7.5M3.18 12a9.821 9.821 0 0 0 17.64 0 9.821 9.821 0 0 0-17.64 0"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
      <div class="md-header__option">
  <div class="md-select">
    
    <button class="md-header__button md-icon" aria-label="إختر اللغة">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m12.87 15.07-2.54-2.51.03-.03A17.5 17.5 0 0 0 14.07 6H17V4h-7V2H8v2H1v2h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2zm-2.62 7 1.62-4.33L19.12 17z"/></svg>
    </button>
    <div class="md-select__inner">
      <ul class="md-select__list">
        
          <li class="md-select__item">
            <a href="../../cpp-KCP%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90/" hreflang="zh" class="md-select__link">
              简体中文
            </a>
          </li>
        
          <li class="md-select__item">
            <a href="../../zh-Hant/cpp-KCP%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90/" hreflang="zh-Hant" class="md-select__link">
              繁體中文
            </a>
          </li>
        
          <li class="md-select__item">
            <a href="../../en/cpp-KCP%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90/" hreflang="en" class="md-select__link">
              English
            </a>
          </li>
        
          <li class="md-select__item">
            <a href="../../es/cpp-KCP%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90/" hreflang="es" class="md-select__link">
              Español
            </a>
          </li>
        
          <li class="md-select__item">
            <a href="../../ja/cpp-KCP%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90/" hreflang="ja" class="md-select__link">
              日本語
            </a>
          </li>
        
          <li class="md-select__item">
            <a href="../../de/cpp-KCP%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90/" hreflang="de" class="md-select__link">
              Deutsch
            </a>
          </li>
        
          <li class="md-select__item">
            <a href="../../fr/cpp-KCP%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90/" hreflang="fr" class="md-select__link">
              Français
            </a>
          </li>
        
          <li class="md-select__item">
            <a href="./" hreflang="ar" class="md-select__link">
              العربية
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</div>
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="بحث" placeholder="بحث" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="إبحث">
        
        <button type="reset" class="md-search__icon md-icon" title="مسح كلي" aria-label="مسح كلي" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            بدء البحث
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/disenone/wiki_blog" title="اذهب إلى المصدر" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2A10 10 0 0 0 2 12c0 4.42 2.87 8.17 6.84 9.5.5.08.66-.23.66-.5v-1.69c-2.77.6-3.36-1.34-3.36-1.34-.46-1.16-1.11-1.47-1.11-1.47-.91-.62.07-.6.07-.6 1 .07 1.53 1.03 1.53 1.03.87 1.52 2.34 1.07 2.91.83.09-.65.35-1.09.63-1.34-2.22-.25-4.55-1.11-4.55-4.92 0-1.11.38-2 1.03-2.71-.1-.25-.45-1.29.1-2.64 0 0 .84-.27 2.75 1.02.79-.22 1.65-.33 2.5-.33s1.71.11 2.5.33c1.91-1.29 2.75-1.02 2.75-1.02.55 1.35.2 2.39.1 2.64.65.71 1.03 1.6 1.03 2.71 0 3.82-2.34 4.66-4.57 4.91.36.31.69.92.69 1.85V21c0 .27.16.59.67.5C19.14 20.16 22 16.42 22 12A10 10 0 0 0 12 2"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="نوافذ" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../" class="md-tabs__link">
        
  
    
  
  Home

      </a>
    </li>
  

      
        
  
  
    
  
  
    
    
      
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../cpp-C%E5%92%8CCpp%E7%9A%84%E5%91%BD%E4%BB%A4%E8%A1%8C%E5%8F%82%E6%95%B0%E5%A4%84%E7%90%86%E6%80%BB%E7%BB%93/" class="md-tabs__link">
          
  
    
  
  تقنيات البرمجة

        </a>
      </li>
    
  

    
  

      
        
  
  
  
    
    
      
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../game-%E6%B8%B8%E6%88%8FAOI%E7%AE%97%E6%B3%95%E8%A7%A3%E6%9E%90%E5%92%8C%E6%80%A7%E8%83%BD%E5%AE%9E%E6%B5%8B/" class="md-tabs__link">
          
  
    
  
  تطوير الألعاب

        </a>
      </li>
    
  

    
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="تصفح" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../" title="Disenone&#39;s Wiki" class="md-nav__button md-logo" aria-label="Disenone's Wiki" data-md-component="logo">
      
  <img src="../../assets/favicon/android-chrome-512x512.png" alt="logo">

    </a>
    Disenone's Wiki
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/disenone/wiki_blog" title="اذهب إلى المصدر" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2A10 10 0 0 0 2 12c0 4.42 2.87 8.17 6.84 9.5.5.08.66-.23.66-.5v-1.69c-2.77.6-3.36-1.34-3.36-1.34-.46-1.16-1.11-1.47-1.11-1.47-.91-.62.07-.6.07-.6 1 .07 1.53 1.03 1.53 1.03.87 1.52 2.34 1.07 2.91.83.09-.65.35-1.09.63-1.34-2.22-.25-4.55-1.11-4.55-4.92 0-1.11.38-2 1.03-2.71-.1-.25-.45-1.29.1-2.64 0 0 .84-.27 2.75 1.02.79-.22 1.65-.33 2.5-.33s1.71.11 2.5.33c1.91-1.29 2.75-1.02 2.75-1.02.55 1.35.2 2.39.1 2.64.65.71 1.03 1.6 1.03 2.71 0 3.82-2.34 4.66-4.57 4.91.36.31.69.92.69 1.85V21c0 .27.16.59.67.5C19.14 20.16 22 16.42 22 12A10 10 0 0 0 12 2"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Home
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
      
        
      
        
      
    
    
      
        
        
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" checked>
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="">
            
  
  <span class="md-ellipsis">
    تقنيات البرمجة
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            تقنيات البرمجة
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
    
  
  
  
    
    
      
        
      
        
      
        
      
        
      
    
    
      
      
        
          
          
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_1" checked>
        
          
          <label class="md-nav__link" for="__nav_2_1" id="__nav_2_1_label" tabindex="">
            
  
  <span class="md-ellipsis">
    C/C++
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_1_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_2_1">
            <span class="md-nav__icon md-icon"></span>
            C/C++
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../cpp-C%E5%92%8CCpp%E7%9A%84%E5%91%BD%E4%BB%A4%E8%A1%8C%E5%8F%82%E6%95%B0%E5%A4%84%E7%90%86%E6%80%BB%E7%BB%93/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ملخص معالجة معلمات سطر الأوامر في C/C++
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../cpp-C%E5%92%8CCpp%E5%AE%8F%E7%BC%96%E7%A8%8B%E8%A7%A3%E6%9E%90/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    C/C++ تحليل برمجة الماكرو
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../cpp-%E7%BC%96%E5%86%99Windows%E4%B8%8B%E7%9A%84MemoryLeakDetector/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    كتابة كاشف تسرب الذاكرة في نظام Windows
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    KCP كود المصدر التحليل
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    KCP كود المصدر التحليل
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="جدول المحتويات">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      جدول المحتويات
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#kcp" class="md-nav__link">
    <span class="md-ellipsis">
      ما هو KCP
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#kcp_1" class="md-nav__link">
    <span class="md-ellipsis">
      KCP هيكل البيانات
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#arq-kcp" class="md-nav__link">
    <span class="md-ellipsis">
      تنفيذ ARQ لدى KCP
    </span>
  </a>
  
    <nav class="md-nav" aria-label="تنفيذ ARQ لدى KCP">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    <span class="md-ellipsis">
      إرسال
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    <span class="md-ellipsis">
      استقبال
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_3" class="md-nav__link">
    <span class="md-ellipsis">
      إعادة الإرسال بعد تجاوز المهلة
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#kcp_2" class="md-nav__link">
    <span class="md-ellipsis">
      إستراتيجية زيادة سرعة التدفق لـ KCP
    </span>
  </a>
  
    <nav class="md-nav" aria-label="إستراتيجية زيادة سرعة التدفق لـ KCP">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_4" class="md-nav__link">
    <span class="md-ellipsis">
      إعادة النقل السريع
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_5" class="md-nav__link">
    <span class="md-ellipsis">
      تقليل وقت إعادة الإرسال في حالة تجاوز الوقت القصوى
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_6" class="md-nav__link">
    <span class="md-ellipsis">
      تحديث نافذة الإرسال
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_7" class="md-nav__link">
    <span class="md-ellipsis">
      تلخيص
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
    
    
      
      
        
          
          
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_2" >
        
          
          <label class="md-nav__link" for="__nav_2_2" id="__nav_2_2_label" tabindex="">
            
  
  <span class="md-ellipsis">
    Python
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_2">
            <span class="md-nav__icon md-icon"></span>
            Python
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../py-%E4%BD%BF%E7%94%A8VisualStudio2015%E7%BC%96%E8%AF%91Python2.7.11/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    استخدام Visual Studio 2015 لتجميع Python 2.7.11
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../py-Python%E6%9D%82%E8%B0%881-%E6%8E%A2%E7%A9%B6__builtins__/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Python 杂谈 1 - استكشاف __builtins__
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../py-Python%E6%9D%82%E8%B0%882-Python312-%E7%83%AD%E6%9B%B4%E6%96%B0/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    نقاشات متنوعة حول Python 2 - تحديث ساخن لـ Python 3.12
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    تطوير الألعاب
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            تطوير الألعاب
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
      
        
      
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_1" >
        
          
          <label class="md-nav__link" for="__nav_3_1" id="__nav_3_1_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    الأساسيات
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_1">
            <span class="md-nav__icon md-icon"></span>
            الأساسيات
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../game-%E6%B8%B8%E6%88%8FAOI%E7%AE%97%E6%B3%95%E8%A7%A3%E6%9E%90%E5%92%8C%E6%80%A7%E8%83%BD%E5%AE%9E%E6%B5%8B/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    تحليل واختبار أداء خوارزمية AOI للألعاب
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_2" >
        
          
          <label class="md-nav__link" for="__nav_3_2" id="__nav_3_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    UE
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_2">
            <span class="md-nav__icon md-icon"></span>
            UE
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ue-%E4%BD%BF%E7%94%A8FASTBuild%E7%BC%96%E8%AF%91UE4%E5%92%8CUE5/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    استخدام FASTBuild لتجميع UE4 و UE5
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ue-%E9%80%9A%E8%BF%87%E6%8F%92%E4%BB%B6%E6%BA%90%E7%A0%81%E6%B7%BB%E5%8A%A0%E6%8F%92%E4%BB%B6/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    يرجى إضافة البرنامج التابع لـ UE عن طريق إضافة مصدر البرنامج إلى المكون الإضافي
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ue-%E6%89%A9%E5%B1%95%E7%BC%96%E8%BE%91%E5%99%A8%E8%8F%9C%E5%8D%95/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    توسيع قائمة محرر UE
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ue-%E4%BD%BF%E7%94%A8%E8%B7%AF%E5%BE%84%E5%BD%A2%E5%BC%8F%E6%89%A9%E5%B1%95%E8%8F%9C%E5%8D%95/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    استخدام المسار لتوسيع القائمة UE
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ue-%E8%AE%BE%E7%BD%AE%E6%9C%AC%E5%9C%B0%E5%8C%96%E5%A4%9A%E8%AF%AD%E8%A8%80/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ضبط الـUE للغات المتعددة المحلية
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ue-%E5%9B%BE%E7%89%87-%E5%90%84%E7%A7%8D%E5%9B%BE%E7%89%87%E6%93%8D%E4%BD%9C/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    تحقيق مجموعة متنوعة من عمليات الصور (UTexture2D) (قراءة، حفظ، نسخ، الحافظة...)
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ue-%E7%BC%96%E8%BE%91%E5%99%A8%E6%8F%92%E4%BB%B6-EditorPlus/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ملحقات محرر UE.EditorPlus لبرنامج UE - وثائق الشرح
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ue-%E6%8F%92%E4%BB%B6-AIChatPlus/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    UE ملحق AIChatPlus وثيقة الشرح
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_3" >
        
          
          <label class="md-nav__link" for="__nav_3_3" id="__nav_3_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Unity
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_3">
            <span class="md-nav__icon md-icon"></span>
            Unity
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../unity-Unity%E7%AC%AC%E4%B8%89%E4%BA%BA%E7%A7%B0%E7%9B%B8%E6%9C%BA%E6%9E%84%E5%BB%BA%28%E4%B8%8A%29/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ترجمة هذه النصوص إلى اللغة العربية:

بناء كاميرا Unity الشخصية الثالثة (الجزء الأول)
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../unity-Unity%E7%AC%AC%E4%B8%89%E4%BA%BA%E7%A7%B0%E7%9B%B8%E6%9C%BA%E6%9E%84%E5%BB%BA%28%E4%B8%8B%29/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Unity تخطيط الكاميرا من شخصية الجهة الثالثة (الجزء الثاني)
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../unity-Unity%E4%BA%BA%E7%89%A9%E6%8E%A7%E5%88%B6/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Unity تحكم الشخصيات
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../unity-Unity%E7%94%BB%E6%B7%B1%E5%BA%A6%E5%9B%BE%E5%92%8C%E8%BE%B9%E7%BC%98%E6%A3%80%E6%B5%8B/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    قم بتوليف صورة العمق(depth map) وكشف الحواف (edge detection)
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../unity-Unity%E5%AE%9E%E7%8E%B0%E4%BD%93%E7%A7%AF%E5%85%89%E7%85%A7%E6%95%A3%E5%B0%84/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    تنفيذ Unity لتشتت الضوء الحجمي (Volumetric Light Scattering، الضوء المتناثر في السحب)
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="جدول المحتويات">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      جدول المحتويات
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#kcp" class="md-nav__link">
    <span class="md-ellipsis">
      ما هو KCP
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#kcp_1" class="md-nav__link">
    <span class="md-ellipsis">
      KCP هيكل البيانات
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#arq-kcp" class="md-nav__link">
    <span class="md-ellipsis">
      تنفيذ ARQ لدى KCP
    </span>
  </a>
  
    <nav class="md-nav" aria-label="تنفيذ ARQ لدى KCP">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    <span class="md-ellipsis">
      إرسال
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    <span class="md-ellipsis">
      استقبال
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_3" class="md-nav__link">
    <span class="md-ellipsis">
      إعادة الإرسال بعد تجاوز المهلة
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#kcp_2" class="md-nav__link">
    <span class="md-ellipsis">
      إستراتيجية زيادة سرعة التدفق لـ KCP
    </span>
  </a>
  
    <nav class="md-nav" aria-label="إستراتيجية زيادة سرعة التدفق لـ KCP">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_4" class="md-nav__link">
    <span class="md-ellipsis">
      إعادة النقل السريع
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_5" class="md-nav__link">
    <span class="md-ellipsis">
      تقليل وقت إعادة الإرسال في حالة تجاوز الوقت القصوى
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_6" class="md-nav__link">
    <span class="md-ellipsis">
      تحديث نافذة الإرسال
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_7" class="md-nav__link">
    <span class="md-ellipsis">
      تلخيص
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  
    <a href="https://github.com/disenone/wiki_blog/edit/main/docs/ar/cpp-KCP源码剖析.md" title="عدل الصفحة" class="md-content__button md-icon">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M10 20H6V4h7v5h5v3.1l2-2V8l-6-6H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h4zm10.2-7c.1 0 .3.1.4.2l1.3 1.3c.2.2.2.6 0 .8l-1 1-2.1-2.1 1-1c.1-.1.2-.2.4-.2m0 3.9L14.1 23H12v-2.1l6.1-6.1z"/></svg>
    </a>
  
  


  <h1>KCP كود المصدر التحليل</h1>

<div><p><meta property="og:title" content="KCP 源码剖析"></p>
<p>قبل قراءة هذا المقال، إذا لم تسمع عن KCP من قبل، أو إذا كنت لا تعرف شيئًا عن KCP، يرجى قضاء بعض الوقت في الاطلاع على وثائق شرح مشروع KCP: <a href="https://github.com/skywind3000/kcp">رابط</a>الهدف من هذا النص هو فهم تفاصيل تنفيذ KCP بشكل متعمق.</p>
<h2 id="kcp">ما هو KCP</h2>
<p>KCP هو بروتوكول سريع وموثوق، يمكنه نقل البيانات بتأخير أقل بالمقارنة مع TCP، كما أن إعادة نقل البيانات أسرع والوقت المستغرق في الانتظار أقصر.</p>
<blockquote>
<p>TCP مصمم لحركة المرور (كم من البيانات بالكيلوبايت يمكن نقلها في الثانية)، حيث يهتم باستخدام النطاق الترددي بشكل كامل. بينما KCP مصمم لسرعة تدفق البيانات (كم من الوقت يحتاج الحزمة الواحدة للانتقال من طرف إلى طرف)، مقابل تضييع ما يصل إلى 10%-20% من النطاق الترددي للحصول على سرعة نقل تصل إلى 30%-40% أسرع من TCP. قناة TCP هي قناة برقم تدفق بطيء جدًا ولكن بشحنة بيانات ضخمة في الثانية، بينما KCP هو تيار سريع للمياه.</p>
</blockquote>
<p>هذا ما ورد في وثائق KCP، الكلمات الرئيسية هي <strong>عرض النطاق الترددي</strong> و<strong>سرعة التدفق</strong>، يمكن أن يؤدي KCP إلى فقدان عرض النطاق الترددي، مما يتيح فوائد كبيرة من ناحية معدلات النقل الأكبر والأكثر توازنًا. لمزيد من التفاصيل، يُرجى الرجوع إلى وثائق KCP ذاته.</p>
<h2 id="kcp_1">KCP هيكل البيانات</h2>
<p>مصدر رمز KCP موجود في <code>ikcp.h</code> و <code>ikcp.c</code>، حيث يحتوي <code>ikcp.h</code> على تعريفات البنية الأساسية، أولها هو حزمة البيانات <code>SEGMENT</code>، وهي الوحدة الأصغر لمعالجة بيانات بروتوكول KCP:</p>
<details>
&lt;ملخص&gt; تركيب القطعة (انقر لعرض الكود) ملخص&gt;
<div class="language-cpp highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="c1">//=====================================================================</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a><span class="c1">// التقسيم هو مجموعة بيانات واحدة</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a><span class="c1">//=====================================================================</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a><span class="k">struct</span><span class="w"> </span><span class="nc">IKCPSEG</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a><span class="p">{</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a><span class="c1">// تعتبر العقدة في القائمة المرتبطة، حيث كل من قائمة الإرسال والاستقبال هما هياكل القوائم هنا</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">IQUEUEHEAD</span><span class="w"> </span><span class="n">node</span><span class="p">;</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a><span class="c1">// رقم المحادثة، نفس رقم المحادثة متطابق</span>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a><span class="w">    </span><span class="n">IUINT32</span><span class="w"> </span><span class="n">conv</span><span class="p">;</span>
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a>
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a><span class="c1">// نوع حزمة البيانات، مثل DATA أو ACK</span>
<a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a><span class="w">    </span><span class="n">IUINT32</span><span class="w"> </span><span class="n">cmd</span><span class="p">;</span>
<a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a>
<a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a><span class="n">بسبب</span><span class="w"> </span><span class="n">الحد</span><span class="w"> </span><span class="n">الأقصى</span><span class="w"> </span><span class="n">لوحدة</span><span class="w"> </span><span class="n">النقل</span><span class="w"> </span><span class="p">(</span><span class="n">MTU</span><span class="p">)</span><span class="err">،</span><span class="w"> </span><span class="n">قد</span><span class="w"> </span><span class="n">يتم</span><span class="w"> </span><span class="n">تقسيم</span><span class="w"> </span><span class="n">حزم</span><span class="w"> </span><span class="n">البيانات</span><span class="w"> </span><span class="n">الكبيرة</span><span class="w"> </span><span class="n">إلى</span><span class="w"> </span><span class="n">عدة</span><span class="w"> </span><span class="n">حزم</span><span class="w"> </span><span class="n">بيانات</span><span class="w"> </span><span class="n">صغيرة</span><span class="err">،</span><span class="w"> </span><span class="n">وهذا</span><span class="w"> </span><span class="n">هو</span><span class="w"> </span><span class="n">رقم</span><span class="w"> </span><span class="n">حزمة</span><span class="w"> </span><span class="n">البيانات</span><span class="w"> </span><span class="n">الصغيرة</span><span class="p">.</span>
<a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a><span class="w">    </span><span class="n">IUINT32</span><span class="w"> </span><span class="n">frg</span>
<a id="__codelineno-0-17" name="__codelineno-0-17" href="#__codelineno-0-17"></a>
<a id="__codelineno-0-18" name="__codelineno-0-18" href="#__codelineno-0-18"></a><span class="n">كل</span><span class="w"> </span><span class="n">حزمة</span><span class="w"> </span><span class="n">بيانات</span><span class="w"> </span><span class="n">ستحتوي</span><span class="w"> </span><span class="n">على</span><span class="w"> </span><span class="n">حجم</span><span class="w"> </span><span class="n">نافذة</span><span class="w"> </span><span class="n">الاستقبال</span><span class="w"> </span><span class="n">للمرسل</span><span class="p">.</span>
<a id="__codelineno-0-19" name="__codelineno-0-19" href="#__codelineno-0-19"></a><span class="w">    </span><span class="n">IUINT32</span><span class="w"> </span><span class="n">wnd</span><span class="p">;</span>
<a id="__codelineno-0-20" name="__codelineno-0-20" href="#__codelineno-0-20"></a>
<a id="__codelineno-0-21" name="__codelineno-0-21" href="#__codelineno-0-21"></a><span class="c1">// وقت الإرسال، إذا كان الحزمة هي حزمة ACK، سيتم ضبطها على الوقت الزمني الخاص بحزمة البيانات الأصلية</span>
<a id="__codelineno-0-22" name="__codelineno-0-22" href="#__codelineno-0-22"></a><span class="w">    </span><span class="n">IUINT32</span><span class="w"> </span><span class="n">ts</span><span class="p">;</span>
<a id="__codelineno-0-23" name="__codelineno-0-23" href="#__codelineno-0-23"></a>
<a id="__codelineno-0-24" name="__codelineno-0-24" href="#__codelineno-0-24"></a><span class="c1">// رقم يعرف حزمة البيانات بشكل فريد</span>
<a id="__codelineno-0-25" name="__codelineno-0-25" href="#__codelineno-0-25"></a><span class="w">    </span><span class="n">IUINT32</span><span class="w"> </span><span class="n">sn</span><span class="p">;</span>
<a id="__codelineno-0-26" name="__codelineno-0-26" href="#__codelineno-0-26"></a>
<a id="__codelineno-0-27" name="__codelineno-0-27" href="#__codelineno-0-27"></a><span class="n">تمثل</span><span class="w"> </span><span class="n">جميع</span><span class="w"> </span><span class="n">حزم</span><span class="w"> </span><span class="n">البيانات</span><span class="w"> </span><span class="n">التي</span><span class="w"> </span><span class="n">تكون</span><span class="w"> </span><span class="n">أقل</span><span class="w"> </span><span class="n">من</span><span class="w"> </span><span class="n">una</span><span class="w"> </span><span class="n">تلقت</span><span class="w"> </span><span class="n">بنجاح</span><span class="err">،</span><span class="w"> </span><span class="n">وهذا</span><span class="w"> </span><span class="n">يتماشى</span><span class="w"> </span><span class="n">مع</span><span class="w"> </span><span class="n">معنى</span><span class="w"> </span><span class="n">TCP</span><span class="o">:</span><span class="w"> </span><span class="n">أقدم</span><span class="w"> </span><span class="n">رقم</span><span class="w"> </span><span class="n">تسلسل</span><span class="w"> </span><span class="n">غير</span><span class="w"> </span><span class="n">معترف</span><span class="w"> </span><span class="n">به</span><span class="w"> </span><span class="n">SND</span>
<a id="__codelineno-0-28" name="__codelineno-0-28" href="#__codelineno-0-28"></a><span class="w">    </span><span class="n">IUINT32</span><span class="w"> </span><span class="n">una</span><span class="p">;</span>
<a id="__codelineno-0-29" name="__codelineno-0-29" href="#__codelineno-0-29"></a>
<a id="__codelineno-0-30" name="__codelineno-0-30" href="#__codelineno-0-30"></a><span class="n">طول</span><span class="w"> </span><span class="n">البيانات</span>
<a id="__codelineno-0-31" name="__codelineno-0-31" href="#__codelineno-0-31"></a><span class="w">    </span><span class="n">IUINT32</span><span class="w"> </span><span class="n">len</span><span class="p">;</span>
<a id="__codelineno-0-32" name="__codelineno-0-32" href="#__codelineno-0-32"></a>
<a id="__codelineno-0-33" name="__codelineno-0-33" href="#__codelineno-0-33"></a><span class="c1">// وقت إعادة الإرسال في حالة تجاوز الوقت</span>
<a id="__codelineno-0-34" name="__codelineno-0-34" href="#__codelineno-0-34"></a><span class="w">    </span><span class="n">IUINT32</span><span class="w"> </span><span class="n">resendts</span><span class="p">;</span>
<a id="__codelineno-0-35" name="__codelineno-0-35" href="#__codelineno-0-35"></a>
<a id="__codelineno-0-36" name="__codelineno-0-36" href="#__codelineno-0-36"></a><span class="c1">// وقت الانتظار الزائد في المرة القادمة</span>
<a id="__codelineno-0-37" name="__codelineno-0-37" href="#__codelineno-0-37"></a><span class="w">    </span><span class="n">IUINT32</span><span class="w"> </span><span class="n">rto</span><span class="p">;</span>
<a id="__codelineno-0-38" name="__codelineno-0-38" href="#__codelineno-0-38"></a>
<a id="__codelineno-0-39" name="__codelineno-0-39" href="#__codelineno-0-39"></a><span class="n">سريع</span><span class="w"> </span><span class="n">إعادة</span><span class="w"> </span><span class="n">البث</span><span class="err">،</span><span class="w"> </span><span class="n">يتم</span><span class="w"> </span><span class="n">تفعيله</span><span class="w"> </span><span class="n">عندما</span><span class="w"> </span><span class="n">يتلقى</span><span class="w"> </span><span class="n">عدد</span><span class="w"> </span><span class="n">معين</span><span class="w"> </span><span class="n">من</span><span class="w"> </span><span class="n">الحزم</span><span class="w"> </span><span class="n">البيانات</span><span class="w"> </span><span class="n">بعد</span><span class="w"> </span><span class="n">استلام</span><span class="w"> </span><span class="n">هذه</span><span class="w"> </span><span class="n">الحزمة</span><span class="p">.</span>
<a id="__codelineno-0-40" name="__codelineno-0-40" href="#__codelineno-0-40"></a><span class="w">    </span><span class="n">IUINT32</span><span class="w"> </span><span class="n">fastack</span><span class="p">;</span>
<a id="__codelineno-0-41" name="__codelineno-0-41" href="#__codelineno-0-41"></a>
<a id="__codelineno-0-42" name="__codelineno-0-42" href="#__codelineno-0-42"></a><span class="n">عدد</span><span class="w"> </span><span class="n">المرات</span><span class="w"> </span><span class="n">المرسلة</span>
<a id="__codelineno-0-43" name="__codelineno-0-43" href="#__codelineno-0-43"></a><span class="w">    </span><span class="n">IUINT32</span><span class="w"> </span><span class="n">xmit</span><span class="p">;</span>
<a id="__codelineno-0-44" name="__codelineno-0-44" href="#__codelineno-0-44"></a>
<a id="__codelineno-0-45" name="__codelineno-0-45" href="#__codelineno-0-45"></a><span class="c1">// البيانات</span>
<a id="__codelineno-0-46" name="__codelineno-0-46" href="#__codelineno-0-46"></a><span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
<a id="__codelineno-0-47" name="__codelineno-0-47" href="#__codelineno-0-47"></a><span class="p">};</span>
</code></pre></div>
</details>

<p>بعد قراءة تعليقات <code>SEGMENT</code>، يمكن بشكل عام أن نرى أن جوهر KCP هو بروتوكول ARQ أيضًا، حيث يضمن وصول البيانات من خلال إعادة الإرسال التلقائي بالتوقيت المناسب. لنلق نظرة على تعريف هيكل KCP <code>KCPCB</code> بعد ذلك:</p>
<details>
&lt;ملخص&gt; هيكل KCP (انقر لعرض الكود) ملخص&gt;
<div class="language-cpp highlight"><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a><span class="c1">//---------------------------------------------------------------------</span>
<a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a><span class="c1">// IKCPCB</span>
<a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a><span class="c1">//---------------------------------------------------------------------</span>
<a id="__codelineno-1-4" name="__codelineno-1-4" href="#__codelineno-1-4"></a><span class="k">struct</span><span class="w"> </span><span class="nc">IKCPCB</span>
<a id="__codelineno-1-5" name="__codelineno-1-5" href="#__codelineno-1-5"></a><span class="p">{</span>
<a id="__codelineno-1-6" name="__codelineno-1-6" href="#__codelineno-1-6"></a><span class="c1">// conv: رقم المحادثة</span>
<a id="__codelineno-1-7" name="__codelineno-1-7" href="#__codelineno-1-7"></a><span class="c1">// mtu, mss: أقصى وحدة نقل، أقصى حجم لقطع البيانات</span>
<a id="__codelineno-1-8" name="__codelineno-1-8" href="#__codelineno-1-8"></a><span class="nl">state</span><span class="p">:</span><span class="w"> </span><span class="n">حالة</span><span class="w"> </span><span class="n">الجلسة</span><span class="w"> </span><span class="err">،</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="n">فعال</span><span class="w"> </span><span class="err">،</span><span class="w"> </span><span class="mi">-1</span><span class="w"> </span><span class="n">فصل</span>
<a id="__codelineno-1-9" name="__codelineno-1-9" href="#__codelineno-1-9"></a><span class="w">    </span><span class="n">IUINT32</span><span class="w"> </span><span class="n">conv</span><span class="p">,</span><span class="w"> </span><span class="n">mtu</span><span class="p">,</span><span class="w"> </span><span class="n">mss</span><span class="p">,</span><span class="w"> </span><span class="n">state</span><span class="p">;</span>
<a id="__codelineno-1-10" name="__codelineno-1-10" href="#__codelineno-1-10"></a>
<a id="__codelineno-1-11" name="__codelineno-1-11" href="#__codelineno-1-11"></a><span class="c1">// snd_una: انتظار رقم حزمة ACK</span>
<a id="__codelineno-1-12" name="__codelineno-1-12" href="#__codelineno-1-12"></a><span class="c1">// snd_nxt: رقم الحزمة القادمة المنتظرة للإرسال</span>
<a id="__codelineno-1-13" name="__codelineno-1-13" href="#__codelineno-1-13"></a><span class="c1">// rcv_nxt: الرقم التسلسلي للبيانات التالية المنتظر استقبالها</span>
<a id="__codelineno-1-14" name="__codelineno-1-14" href="#__codelineno-1-14"></a><span class="w">    </span><span class="n">IUINT32</span><span class="w"> </span><span class="n">snd_una</span><span class="p">,</span><span class="w"> </span><span class="n">snd_nxt</span><span class="p">,</span><span class="w"> </span><span class="n">rcv_nxt</span><span class="p">;</span>
<a id="__codelineno-1-15" name="__codelineno-1-15" href="#__codelineno-1-15"></a>
<a id="__codelineno-1-16" name="__codelineno-1-16" href="#__codelineno-1-16"></a><span class="c1">// ts_recent، ts_lastack: غير مستخدمة</span>
<a id="__codelineno-1-17" name="__codelineno-1-17" href="#__codelineno-1-17"></a><span class="c1">// ssthresh: عتبة بدء التباطؤ لتحكم الازدحام</span>
<a id="__codelineno-1-18" name="__codelineno-1-18" href="#__codelineno-1-18"></a><span class="w">    </span><span class="n">IUINT32</span><span class="w"> </span><span class="n">ts_recent</span><span class="p">,</span><span class="w"> </span><span class="n">ts_lastack</span><span class="p">,</span><span class="w"> </span><span class="n">ssthresh</span><span class="p">;</span>
<a id="__codelineno-1-19" name="__codelineno-1-19" href="#__codelineno-1-19"></a>
<a id="__codelineno-1-20" name="__codelineno-1-20" href="#__codelineno-1-20"></a><span class="c1">// rx_rto: rto (retransmission timeout)，وقت انتهاء العرض (إعادة الإرسال)، وقت إعادة البث</span>
<a id="__codelineno-1-21" name="__codelineno-1-21" href="#__codelineno-1-21"></a><span class="c1">// rx_rttval، rx_srtt، rx_minrto: حساب المتغيرات الوسيطة لـ rto</span>
<a id="__codelineno-1-22" name="__codelineno-1-22" href="#__codelineno-1-22"></a><span class="w">    </span><span class="n">IINT32</span><span class="w"> </span><span class="n">rx_rttval</span><span class="p">,</span><span class="w"> </span><span class="n">rx_srtt</span><span class="p">,</span><span class="w"> </span><span class="n">rx_rto</span><span class="p">,</span><span class="w"> </span><span class="n">rx_minrto</span><span class="p">;</span>
<a id="__codelineno-1-23" name="__codelineno-1-23" href="#__codelineno-1-23"></a>
<a id="__codelineno-1-24" name="__codelineno-1-24" href="#__codelineno-1-24"></a><span class="c1">// حجم النافذة الخاصة بالإرسال والاستقبال: أقصى حجم للنافذة المستخدمة لعمليات الإرسال والاستقبال</span>
<a id="__codelineno-1-25" name="__codelineno-1-25" href="#__codelineno-1-25"></a><span class="c1">// rmt_wnd: نافذة بعيدة ، حجم نافذة الاستقبال المتبقي للطرف الآخر</span>
<a id="__codelineno-1-26" name="__codelineno-1-26" href="#__codelineno-1-26"></a><span class="c1">// cwnd: حجم نافذة الإرسال القابلة</span>
<a id="__codelineno-1-27" name="__codelineno-1-27" href="#__codelineno-1-27"></a><span class="c1">// الاستعلام: هل تريد إرسال علامة رسالة التحكم؟</span>
<a id="__codelineno-1-28" name="__codelineno-1-28" href="#__codelineno-1-28"></a><span class="w">    </span><span class="n">IUINT32</span><span class="w"> </span><span class="n">snd_wnd</span><span class="p">,</span><span class="w"> </span><span class="n">rcv_wnd</span><span class="p">,</span><span class="w"> </span><span class="n">rmt_wnd</span><span class="p">,</span><span class="w"> </span><span class="n">cwnd</span><span class="p">,</span><span class="w"> </span><span class="n">probe</span><span class="p">;</span>
<a id="__codelineno-1-29" name="__codelineno-1-29" href="#__codelineno-1-29"></a>
<a id="__codelineno-1-30" name="__codelineno-1-30" href="#__codelineno-1-30"></a><span class="c1">// الحالي: الوقت الحالي</span>
<a id="__codelineno-1-31" name="__codelineno-1-31" href="#__codelineno-1-31"></a><span class="c1">// interval: تحديث الفاصل</span>
<a id="__codelineno-1-32" name="__codelineno-1-32" href="#__codelineno-1-32"></a><span class="c1">// ts_flush: الوقت الذي يجب أن يتم فيه التحديث في المرة القادمة</span>
<a id="__codelineno-1-33" name="__codelineno-1-33" href="#__codelineno-1-33"></a><span class="c1">// xmit: عدد مرات فشل الإرسال</span>
<a id="__codelineno-1-34" name="__codelineno-1-34" href="#__codelineno-1-34"></a><span class="w">    </span><span class="n">IUINT32</span><span class="w"> </span><span class="n">current</span><span class="p">,</span><span class="w"> </span><span class="n">interval</span><span class="p">,</span><span class="w"> </span><span class="n">ts_flush</span><span class="p">,</span><span class="w"> </span><span class="n">xmit</span><span class="p">;</span>
<a id="__codelineno-1-35" name="__codelineno-1-35" href="#__codelineno-1-35"></a>
<a id="__codelineno-1-36" name="__codelineno-1-36" href="#__codelineno-1-36"></a><span class="n">طول</span><span class="w"> </span><span class="n">القائمة</span><span class="w"> </span><span class="n">المرتبطة</span>
<a id="__codelineno-1-37" name="__codelineno-1-37" href="#__codelineno-1-37"></a><span class="w">    </span><span class="n">IUINT32</span><span class="w"> </span><span class="n">nrcv_buf</span><span class="p">,</span><span class="w"> </span><span class="n">nsnd_buf</span><span class="p">;</span>
<a id="__codelineno-1-38" name="__codelineno-1-38" href="#__codelineno-1-38"></a><span class="w">    </span><span class="n">IUINT32</span><span class="w"> </span><span class="n">nrcv_que</span><span class="p">,</span><span class="w"> </span><span class="n">nsnd_que</span><span class="p">;</span>
<a id="__codelineno-1-39" name="__codelineno-1-39" href="#__codelineno-1-39"></a>
<a id="__codelineno-1-40" name="__codelineno-1-40" href="#__codelineno-1-40"></a><span class="c1">// nodelay: تحكم في سرعة زيادة rto لإعادة الإرسال المتأخر</span>
<a id="__codelineno-1-41" name="__codelineno-1-41" href="#__codelineno-1-41"></a><span class="n">هل</span><span class="w"> </span><span class="n">تم</span><span class="w"> </span><span class="n">استدعاء</span><span class="w"> </span><span class="n">ikcp_update</span><span class="err">؟</span>
<a id="__codelineno-1-42" name="__codelineno-1-42" href="#__codelineno-1-42"></a><span class="w">    </span><span class="n">IUINT32</span><span class="w"> </span><span class="n">nodelay</span><span class="p">,</span><span class="w"> </span><span class="n">updated</span><span class="p">;</span>
<a id="__codelineno-1-43" name="__codelineno-1-43" href="#__codelineno-1-43"></a>
<a id="__codelineno-1-44" name="__codelineno-1-44" href="#__codelineno-1-44"></a><span class="c1">// عملية ts_probe، probe_wait: عندما تصبح نوافذ استقبال الجهة المقابلة صفر لفترة طويلة، يتم إطلاق الاستفسارات بانتظام بشكل نشط</span>
<a id="__codelineno-1-45" name="__codelineno-1-45" href="#__codelineno-1-45"></a><span class="w">    </span><span class="n">IUINT32</span><span class="w"> </span><span class="n">ts_probe</span><span class="p">,</span><span class="w"> </span><span class="n">probe_wait</span><span class="p">;</span>
<a id="__codelineno-1-46" name="__codelineno-1-46" href="#__codelineno-1-46"></a>
<a id="__codelineno-1-47" name="__codelineno-1-47" href="#__codelineno-1-47"></a><span class="c1">// deal_link: الجانب الآخر غير مستجيب لفترة طويلة</span>
<a id="__codelineno-1-48" name="__codelineno-1-48" href="#__codelineno-1-48"></a><span class="c1">// incr: Calculate the transmission window size.</span>
<a id="__codelineno-1-49" name="__codelineno-1-49" href="#__codelineno-1-49"></a><span class="w">    </span><span class="n">IUINT32</span><span class="w"> </span><span class="n">dead_link</span><span class="p">,</span><span class="w"> </span><span class="n">incr</span><span class="p">;</span>
<a id="__codelineno-1-50" name="__codelineno-1-50" href="#__codelineno-1-50"></a>
<a id="__codelineno-1-51" name="__codelineno-1-51" href="#__codelineno-1-51"></a><span class="c1">// قائمة الانتظار: حزمة البيانات التي تتفاعل مع طبقة المستخدم</span>
<a id="__codelineno-1-52" name="__codelineno-1-52" href="#__codelineno-1-52"></a><span class="c1">// buf: حزم البيانات المخزنة مؤقتًا</span>
<a id="__codelineno-1-53" name="__codelineno-1-53" href="#__codelineno-1-53"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">IQUEUEHEAD</span><span class="w"> </span><span class="n">snd_queue</span><span class="p">;</span>
<a id="__codelineno-1-54" name="__codelineno-1-54" href="#__codelineno-1-54"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">IQUEUEHEAD</span><span class="w"> </span><span class="n">rcv_queue</span><span class="p">;</span>
<a id="__codelineno-1-55" name="__codelineno-1-55" href="#__codelineno-1-55"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">IQUEUEHEAD</span><span class="w"> </span><span class="n">snd_buf</span><span class="p">;</span>
<a id="__codelineno-1-56" name="__codelineno-1-56" href="#__codelineno-1-56"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">IQUEUEHEAD</span><span class="w"> </span><span class="n">rcv_buf</span><span class="p">;</span>
<a id="__codelineno-1-57" name="__codelineno-1-57" href="#__codelineno-1-57"></a>
<a id="__codelineno-1-58" name="__codelineno-1-58" href="#__codelineno-1-58"></a><span class="n">بيانات</span><span class="w"> </span><span class="n">الحزمة</span><span class="w"> </span><span class="n">التي</span><span class="w"> </span><span class="n">تحتاج</span><span class="w"> </span><span class="n">إلى</span><span class="w"> </span><span class="n">إرسال</span><span class="w"> </span><span class="n">تأكيد</span><span class="w"> </span><span class="n">ACK</span>
<a id="__codelineno-1-59" name="__codelineno-1-59" href="#__codelineno-1-59"></a><span class="w">    </span><span class="n">IUINT32</span><span class="w"> </span><span class="o">*</span><span class="n">acklist</span><span class="p">;</span>
<a id="__codelineno-1-60" name="__codelineno-1-60" href="#__codelineno-1-60"></a>
<a id="__codelineno-1-61" name="__codelineno-1-61" href="#__codelineno-1-61"></a><span class="c1">// تحتاج إلى عدد الحزم ack</span>
<a id="__codelineno-1-62" name="__codelineno-1-62" href="#__codelineno-1-62"></a><span class="w">    </span><span class="n">IUINT32</span><span class="w"> </span><span class="n">ackcount</span><span class="p">;</span>
<a id="__codelineno-1-63" name="__codelineno-1-63" href="#__codelineno-1-63"></a>
<a id="__codelineno-1-64" name="__codelineno-1-64" href="#__codelineno-1-64"></a><span class="c1">// حجم الذاكرة الداخلية</span>
<a id="__codelineno-1-65" name="__codelineno-1-65" href="#__codelineno-1-65"></a><span class="w">    </span><span class="n">IUINT32</span><span class="w"> </span><span class="n">ackblock</span><span class="p">;</span>
<a id="__codelineno-1-66" name="__codelineno-1-66" href="#__codelineno-1-66"></a>
<a id="__codelineno-1-67" name="__codelineno-1-67" href="#__codelineno-1-67"></a><span class="c1">// البيانات التي تم تمريرها من طبقة المستخدم</span>
<a id="__codelineno-1-68" name="__codelineno-1-68" href="#__codelineno-1-68"></a><span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">user</span><span class="p">;</span>
<a id="__codelineno-1-69" name="__codelineno-1-69" href="#__codelineno-1-69"></a>
<a id="__codelineno-1-70" name="__codelineno-1-70" href="#__codelineno-1-70"></a><span class="c1">// مساحة تخزين حزمة kcp</span>
<a id="__codelineno-1-71" name="__codelineno-1-71" href="#__codelineno-1-71"></a><span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">buffer</span><span class="p">;</span>
<a id="__codelineno-1-72" name="__codelineno-1-72" href="#__codelineno-1-72"></a>
<a id="__codelineno-1-73" name="__codelineno-1-73" href="#__codelineno-1-73"></a><span class="n">عدد</span><span class="w"> </span><span class="n">مرات</span><span class="w"> </span><span class="n">تنفيذ</span><span class="w"> </span><span class="n">fastack</span><span class="w"> </span><span class="n">لتشغيل</span><span class="w"> </span><span class="n">إعادة</span><span class="w"> </span><span class="n">الإرسال</span><span class="w"> </span><span class="n">السريع</span>
<a id="__codelineno-1-74" name="__codelineno-1-74" href="#__codelineno-1-74"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">fastresend</span><span class="p">;</span>
<a id="__codelineno-1-75" name="__codelineno-1-75" href="#__codelineno-1-75"></a>
<a id="__codelineno-1-76" name="__codelineno-1-76" href="#__codelineno-1-76"></a><span class="c1">// عدد مرات إعادة النقل السريع القصوى</span>
<a id="__codelineno-1-77" name="__codelineno-1-77" href="#__codelineno-1-77"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">fastlimit</span><span class="p">;</span>
<a id="__codelineno-1-78" name="__codelineno-1-78" href="#__codelineno-1-78"></a>
<a id="__codelineno-1-79" name="__codelineno-1-79" href="#__codelineno-1-79"></a><span class="c1">//nocwnd: لا يُنظر إلى حجم نافذة الإرسال في التشغيل البطيء</span>
<a id="__codelineno-1-80" name="__codelineno-1-80" href="#__codelineno-1-80"></a><span class="c1">// تيار: وضع التدفق</span>
<a id="__codelineno-1-81" name="__codelineno-1-81" href="#__codelineno-1-81"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">nocwnd</span><span class="p">,</span><span class="w"> </span><span class="n">stream</span><span class="p">;</span>
<a id="__codelineno-1-82" name="__codelineno-1-82" href="#__codelineno-1-82"></a>
<a id="__codelineno-1-83" name="__codelineno-1-83" href="#__codelineno-1-83"></a><span class="w">    </span><span class="c1">// debug log</span>
<a id="__codelineno-1-84" name="__codelineno-1-84" href="#__codelineno-1-84"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">logmask</span><span class="p">;</span>
<a id="__codelineno-1-85" name="__codelineno-1-85" href="#__codelineno-1-85"></a>
<a id="__codelineno-1-86" name="__codelineno-1-86" href="#__codelineno-1-86"></a><span class="c1">// واجهة إرسال البيانات</span>
<a id="__codelineno-1-87" name="__codelineno-1-87" href="#__codelineno-1-87"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">output</span><span class="p">)(</span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">buf</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">len</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">IKCPCB</span><span class="w"> </span><span class="o">*</span><span class="n">kcp</span><span class="p">,</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">user</span><span class="p">);</span>
<a id="__codelineno-1-88" name="__codelineno-1-88" href="#__codelineno-1-88"></a>
<a id="__codelineno-1-89" name="__codelineno-1-89" href="#__codelineno-1-89"></a><span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">writelog</span><span class="p">)(</span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">log</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">IKCPCB</span><span class="w"> </span><span class="o">*</span><span class="n">kcp</span><span class="p">,</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">user</span><span class="p">);</span>
<a id="__codelineno-1-90" name="__codelineno-1-90" href="#__codelineno-1-90"></a><span class="p">};</span>
</code></pre></div>
</details>

<p>قم بتعليق حقول هيكل KCP بشكل متسلسل، يمكننا أن نشعر بأن بروتوكول KCP ليس معقدًا جدًا. عند تحليل الشفرة بدقة، يمكن لكل منا فهم وفهم بروتوكول KCP <img alt="😄" class="twemoji" src="https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.1.0/assets/svg/1f604.svg" title=":smile:"></p>
<h2 id="arq-kcp">تنفيذ ARQ لدى KCP</h2>
<p>KCP هو بروتوكول ARQ (Auto Repeat-reQuest، طلب الإعادة التلقائي) في الجوهر، الهدف الأساسي هو ضمان نقل المعلومات بشكل موثوق. لذا، يمكننا أن نركز أولاً على الجزء الأساسي ARQ من KCP وكيف يضمن نقل المعلومات بشكل موثوق.</p>
<p>ARQ، هو اختصار تعني Automatic Repeat reQuest، عندما نعتقد أن الطرف الآخر فشل في استقبال حزمة بيانات، يتم إعادة إرسال الحزمة المقابلة تلقائيًا، يتم تحقيق النقل الآمن من خلال آليتي التأكيد على الاستلام وإعادة الإرسال بعد الانتهاء من المدة الزمنية المحددة. من الناحية العملية لتنفيذ الشيفرة، يخصص KCP معرفًا فريدًا "sn" لكل حزمة بيانات (التي تمت ذكرها في الجزء السابق باسم "SEGMENT")، وبمجرد أن يستلم الطرف الآخر الحزمة بيانات، سيقوم بإرسال حزمة استلام ACK (وهي نفس النوع "SEGMENT")، والـ "sn" لحزمة ACK يتطابق مع "sn" للحزمة البيانات التي تمت استلامها، ويُعلم بأن الحزمة تم استلامها بنجاح. على الـ "SEGMENT" يوجد حقل آخر يسمى "una" يُمثل رقم الحزمة القادمة المتوقع استلامها، بمعنى آخر، أي أن جميع الحزم التي سبقت هذا الرقم قد تم استلامها بالفعل، ويعتبر ذلك بمثابة حزمة ACK شاملة، مما يتيح للطرف المُرسل تحديث الذاكرة المؤقتة للإرسال والنافذة للإرسال بشكل أسرع.</p>
<p>يمكننا فهم تنفيذ ARQ الأساسي عن طريق تتبع رموز إرسال واستقبال حزم الـ KCP.</p>
<h3 id="_1">إرسال</h3>
<p>عملية الإرسال تتضمن <code>ikcp_send</code> -&gt; <code>ikcp_update</code> -&gt; <code>ikcp_output</code>، حيث يُستدعى <code>ikcp_send</code> من الطبقة العلوية ليمرر البيانات إلى KCP، ويتم معالجة إرسال البيانات في KCP خلال <code>ikcp_update</code>.</p>
<details>
&lt;ملخص&gt; ikcp_send（انقر لعرض الشيفرة）ملخص&gt;
<div class="language-cpp highlight"><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a><span class="c1">//---------------------------------------------------------------------</span>
<a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a><span class="c1">// واجهة إرسال البيانات، حيث يُستدعى العميل ikcp_send لإرسال بيانات kcp</span>
<a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a><span class="c1">// user/upper level send, returns below zero for error</span>
<a id="__codelineno-2-4" name="__codelineno-2-4" href="#__codelineno-2-4"></a><span class="c1">//---------------------------------------------------------------------</span>
<a id="__codelineno-2-5" name="__codelineno-2-5" href="#__codelineno-2-5"></a><span class="kt">int</span><span class="w"> </span><span class="nf">ikcp_send</span><span class="p">(</span><span class="n">ikcpcb</span><span class="w"> </span><span class="o">*</span><span class="n">kcp</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">buffer</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">len</span><span class="p">)</span>
<a id="__codelineno-2-6" name="__codelineno-2-6" href="#__codelineno-2-6"></a><span class="p">{</span>
<a id="__codelineno-2-7" name="__codelineno-2-7" href="#__codelineno-2-7"></a><span class="w">    </span><span class="n">IKCPSEG</span><span class="w"> </span><span class="o">*</span><span class="n">seg</span><span class="p">;</span>
<a id="__codelineno-2-8" name="__codelineno-2-8" href="#__codelineno-2-8"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">count</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">;</span>
<a id="__codelineno-2-9" name="__codelineno-2-9" href="#__codelineno-2-9"></a>
<a id="__codelineno-2-10" name="__codelineno-2-10" href="#__codelineno-2-10"></a><span class="c1">// يجب أن لا تكون قيمة mss أقل من 1</span>
<a id="__codelineno-2-11" name="__codelineno-2-11" href="#__codelineno-2-11"></a><span class="w">    </span><span class="n">assert</span><span class="p">(</span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">mss</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<a id="__codelineno-2-12" name="__codelineno-2-12" href="#__codelineno-2-12"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">len</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span>
<a id="__codelineno-2-13" name="__codelineno-2-13" href="#__codelineno-2-13"></a>
<a id="__codelineno-2-14" name="__codelineno-2-14" href="#__codelineno-2-14"></a><span class="w">    </span><span class="c1">// append to previous segment in streaming mode (if possible)</span>
<a id="__codelineno-2-15" name="__codelineno-2-15" href="#__codelineno-2-15"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">stream</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-2-16" name="__codelineno-2-16" href="#__codelineno-2-16"></a><span class="n">نمط</span><span class="w"> </span><span class="n">تدفق</span><span class="w"> </span><span class="n">المعالجة</span>
<a id="__codelineno-2-17" name="__codelineno-2-17" href="#__codelineno-2-17"></a><span class="w">        </span><span class="c1">// ......</span>
<a id="__codelineno-2-18" name="__codelineno-2-18" href="#__codelineno-2-18"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-2-19" name="__codelineno-2-19" href="#__codelineno-2-19"></a>
<a id="__codelineno-2-20" name="__codelineno-2-20" href="#__codelineno-2-20"></a><span class="n">قم</span><span class="w"> </span><span class="n">بتقسيم</span><span class="w"> </span><span class="n">البيانات</span><span class="w"> </span><span class="n">إلى</span><span class="w"> </span><span class="n">حزم</span><span class="w"> </span><span class="n">إذا</span><span class="w"> </span><span class="n">كان</span><span class="w"> </span><span class="n">طول</span><span class="w"> </span><span class="n">البيانات</span><span class="w"> </span><span class="n">len</span><span class="w"> </span><span class="n">أكبر</span><span class="w"> </span><span class="n">من</span><span class="w"> </span><span class="n">mss</span><span class="err">،</span><span class="w"> </span><span class="n">ويجب</span><span class="w"> </span><span class="n">إرسالها</span><span class="w"> </span><span class="n">في</span><span class="w"> </span><span class="n">حزم</span><span class="w"> </span><span class="n">متعددة</span><span class="w"> </span><span class="n">لتجميعها</span><span class="w"> </span><span class="n">من</span><span class="w"> </span><span class="n">قبل</span><span class="w"> </span><span class="n">الطرف</span><span class="w"> </span><span class="n">الآخر</span><span class="p">.</span>
<a id="__codelineno-2-21" name="__codelineno-2-21" href="#__codelineno-2-21"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">len</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">mss</span><span class="p">)</span><span class="w"> </span><span class="n">count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<a id="__codelineno-2-22" name="__codelineno-2-22" href="#__codelineno-2-22"></a><span class="w">    </span><span class="k">else</span><span class="w"> </span><span class="n">count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">len</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">mss</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">mss</span><span class="p">;</span>
<a id="__codelineno-2-23" name="__codelineno-2-23" href="#__codelineno-2-23"></a>
<a id="__codelineno-2-24" name="__codelineno-2-24" href="#__codelineno-2-24"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">count</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">IKCP_WND_RCV</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="mi">-2</span><span class="p">;</span>
<a id="__codelineno-2-25" name="__codelineno-2-25" href="#__codelineno-2-25"></a>
<a id="__codelineno-2-26" name="__codelineno-2-26" href="#__codelineno-2-26"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">count</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="n">count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<a id="__codelineno-2-27" name="__codelineno-2-27" href="#__codelineno-2-27"></a>
<a id="__codelineno-2-28" name="__codelineno-2-28" href="#__codelineno-2-28"></a><span class="c1">// تقسيم الحزم</span>
<a id="__codelineno-2-29" name="__codelineno-2-29" href="#__codelineno-2-29"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">count</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-2-30" name="__codelineno-2-30" href="#__codelineno-2-30"></a><span class="n">حساب</span><span class="w"> </span><span class="n">طول</span><span class="w"> </span><span class="n">بيانات</span><span class="w"> </span><span class="n">الحزمة</span><span class="w"> </span><span class="n">وتخصيص</span><span class="w"> </span><span class="n">هيكل</span><span class="w"> </span><span class="n">seg</span><span class="w"> </span><span class="n">المقابل</span>
<a id="__codelineno-2-31" name="__codelineno-2-31" href="#__codelineno-2-31"></a><span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">len</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">mss</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">mss</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">len</span><span class="p">;</span>
<a id="__codelineno-2-32" name="__codelineno-2-32" href="#__codelineno-2-32"></a><span class="w">        </span><span class="n">seg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ikcp_segment_new</span><span class="p">(</span><span class="n">kcp</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="p">);</span>
<a id="__codelineno-2-33" name="__codelineno-2-33" href="#__codelineno-2-33"></a><span class="w">        </span><span class="n">assert</span><span class="p">(</span><span class="n">seg</span><span class="p">);</span>
<a id="__codelineno-2-34" name="__codelineno-2-34" href="#__codelineno-2-34"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">seg</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-2-35" name="__codelineno-2-35" href="#__codelineno-2-35"></a><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="mi">-2</span><span class="p">;</span>
<a id="__codelineno-2-36" name="__codelineno-2-36" href="#__codelineno-2-36"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-2-37" name="__codelineno-2-37" href="#__codelineno-2-37"></a>
<a id="__codelineno-2-38" name="__codelineno-2-38" href="#__codelineno-2-38"></a><span class="n">قم</span><span class="w"> </span><span class="n">بتعيين</span><span class="w"> </span><span class="n">معلومات</span><span class="w"> </span><span class="n">بيانات</span><span class="w"> </span><span class="n">seg</span><span class="err">،</span><span class="w"> </span><span class="n">حيث</span><span class="w"> </span><span class="n">تعبر</span><span class="w"> </span><span class="n">frg</span><span class="w"> </span><span class="n">عن</span><span class="w"> </span><span class="n">رقم</span><span class="w"> </span><span class="n">الحزمة</span><span class="p">.</span>
<a id="__codelineno-2-39" name="__codelineno-2-39" href="#__codelineno-2-39"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">buffer</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">len</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-2-40" name="__codelineno-2-40" href="#__codelineno-2-40"></a><span class="w">            </span><span class="n">memcpy</span><span class="p">(</span><span class="n">seg</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="n">buffer</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="p">);</span>
<a id="__codelineno-2-41" name="__codelineno-2-41" href="#__codelineno-2-41"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-2-42" name="__codelineno-2-42" href="#__codelineno-2-42"></a><span class="w">        </span><span class="n">seg</span><span class="o">-&gt;</span><span class="n">len</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">size</span><span class="p">;</span>
<a id="__codelineno-2-43" name="__codelineno-2-43" href="#__codelineno-2-43"></a><span class="w">        </span><span class="n">seg</span><span class="o">-&gt;</span><span class="n">frg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">stream</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="o">?</span><span class="w"> </span><span class="p">(</span><span class="n">count</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="__codelineno-2-44" name="__codelineno-2-44" href="#__codelineno-2-44"></a>
<a id="__codelineno-2-45" name="__codelineno-2-45" href="#__codelineno-2-45"></a><span class="c1">// إضافة إلى نهاية snd_queue، ثم زيادة nsnd_qua بمقدار واحد</span>
<a id="__codelineno-2-46" name="__codelineno-2-46" href="#__codelineno-2-46"></a><span class="w">        </span><span class="n">iqueue_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">seg</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">);</span>
<a id="__codelineno-2-47" name="__codelineno-2-47" href="#__codelineno-2-47"></a><span class="w">        </span><span class="n">iqueue_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">seg</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">snd_queue</span><span class="p">);</span>
<a id="__codelineno-2-48" name="__codelineno-2-48" href="#__codelineno-2-48"></a><span class="w">        </span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">nsnd_que</span><span class="o">++</span><span class="p">;</span>
<a id="__codelineno-2-49" name="__codelineno-2-49" href="#__codelineno-2-49"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">buffer</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-2-50" name="__codelineno-2-50" href="#__codelineno-2-50"></a><span class="w">            </span><span class="n">buffer</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">size</span><span class="p">;</span>
<a id="__codelineno-2-51" name="__codelineno-2-51" href="#__codelineno-2-51"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-2-52" name="__codelineno-2-52" href="#__codelineno-2-52"></a><span class="w">        </span><span class="n">len</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="n">size</span><span class="p">;</span>
<a id="__codelineno-2-53" name="__codelineno-2-53" href="#__codelineno-2-53"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-2-54" name="__codelineno-2-54" href="#__codelineno-2-54"></a>
<a id="__codelineno-2-55" name="__codelineno-2-55" href="#__codelineno-2-55"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="__codelineno-2-56" name="__codelineno-2-56" href="#__codelineno-2-56"></a><span class="p">}</span>
</code></pre></div>
</details>

<p><code>ikcp_send</code> هي واجهة إرسال البيانات التي يجب استدعاؤها من طبقة KCP العليا ، حيث يجب على جميع البيانات التي يتعين إرسالها عبر KCP تمريرها من خلال هذه الواجهة. الأمر الذي تقوم به <code>ikcp_send</code> بسيط جدًا ، حيث يقوم أساسًا بتقسيم البيانات إلى عدة حزم وتعيين رقم تسلسلي لكل حزمة ووضعها في نهاية قائمة الإرسال <code>snd_queue</code> استنادًا إلى <code>kcp-&gt;mss</code> (طول البيانات القصوى للحزمة). يتيح الوضع التسلسلي تحويل البيانات التي تم إرسالها بواسطة <code>ikcp_send</code> مرارًا وتكرارًا إلى تدفق واحد ، حيث يتم ملء <code>SEGMENT</code>غير المكتمل تلقائيًا أولاً ثم تخصيص جديد ، لا تدرس هذه المقالة التفاصيل التنفيذية بشكل مفصل ، إذا كنت مهتمًا ، فأعتقد أن بعد قراءة هذه المقالة ، من الممكن فهم الشفرة بعد رؤيتها.</p>
<p>بمجرد استكمال استدعاء <code>ikcp_send</code> ، يتم وضع البيانات في <code>snd_queue</code> في KCP. فيما بعد ، يجب على KCP أن يجد فرصة لإرسال البيانات المعلقة، وتوضع هذه الشفرة البرمجية في <code>ikcp_update</code> و <code>ikcp_flush</code>.</p>
<details>
ikcp_update（انقر لعرض الكود）
<div class="language-cpp highlight"><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a><span class="c1">//---------------------------------------------------------------------</span>
<a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a><span class="n">ikcp_update</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">an</span><span class="w"> </span><span class="n">interface</span><span class="w"> </span><span class="n">that</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">periodically</span><span class="w"> </span><span class="n">called</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">upper</span><span class="w"> </span><span class="n">layer</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">update</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">state</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">kcp</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="n">send</span><span class="w"> </span><span class="n">data</span><span class="p">.</span>
<a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a><span class="c1">// update state (call it repeatedly, every 10ms-100ms), or you can ask </span>
<a id="__codelineno-3-4" name="__codelineno-3-4" href="#__codelineno-3-4"></a><span class="c1">// ikcp_check when to call it again (without ikcp_input/_send calling).</span>
<a id="__codelineno-3-5" name="__codelineno-3-5" href="#__codelineno-3-5"></a><span class="c1">// 'current' - current timestamp in millisec. </span>
<a id="__codelineno-3-6" name="__codelineno-3-6" href="#__codelineno-3-6"></a><span class="c1">//---------------------------------------------------------------------</span>
<a id="__codelineno-3-7" name="__codelineno-3-7" href="#__codelineno-3-7"></a><span class="kt">void</span><span class="w"> </span><span class="n">ikcp_update</span><span class="p">(</span><span class="n">ikcpcb</span><span class="w"> </span><span class="o">*</span><span class="n">kcp</span><span class="p">,</span><span class="w"> </span><span class="n">IUINT32</span><span class="w"> </span><span class="n">current</span><span class="p">)</span>
<a id="__codelineno-3-8" name="__codelineno-3-8" href="#__codelineno-3-8"></a><span class="p">{</span>
<a id="__codelineno-3-9" name="__codelineno-3-9" href="#__codelineno-3-9"></a><span class="w">    </span><span class="n">IINT32</span><span class="w"> </span><span class="n">slap</span><span class="p">;</span>
<a id="__codelineno-3-10" name="__codelineno-3-10" href="#__codelineno-3-10"></a>
<a id="__codelineno-3-11" name="__codelineno-3-11" href="#__codelineno-3-11"></a><span class="w">    </span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">current</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">current</span><span class="p">;</span>
<a id="__codelineno-3-12" name="__codelineno-3-12" href="#__codelineno-3-12"></a>
<a id="__codelineno-3-13" name="__codelineno-3-13" href="#__codelineno-3-13"></a><span class="n">ikcp_flush</span><span class="w"> </span><span class="n">سوف</span><span class="w"> </span><span class="n">يتحقق</span><span class="w"> </span><span class="n">من</span><span class="w"> </span><span class="n">ذلك</span><span class="err">،</span><span class="w"> </span><span class="n">يجب</span><span class="w"> </span><span class="n">على</span><span class="w"> </span><span class="n">الطبقة</span><span class="w"> </span><span class="n">العليا</span><span class="w"> </span><span class="n">استدعاء</span><span class="w"> </span><span class="n">ikcp_update</span><span class="w"> </span><span class="n">قبل</span><span class="w"> </span><span class="n">استدعاء</span><span class="w"> </span><span class="n">ikcp_flush</span><span class="err">،</span><span class="w"> </span><span class="n">نوصي</span><span class="w"> </span><span class="n">باستخدام</span><span class="w"> </span><span class="n">ikcp_update</span><span class="w"> </span><span class="n">فقط</span><span class="p">.</span>
<a id="__codelineno-3-14" name="__codelineno-3-14" href="#__codelineno-3-14"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">updated</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-3-15" name="__codelineno-3-15" href="#__codelineno-3-15"></a><span class="w">        </span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">updated</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<a id="__codelineno-3-16" name="__codelineno-3-16" href="#__codelineno-3-16"></a><span class="w">        </span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">ts_flush</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">current</span><span class="p">;</span>
<a id="__codelineno-3-17" name="__codelineno-3-17" href="#__codelineno-3-17"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-3-18" name="__codelineno-3-18" href="#__codelineno-3-18"></a>
<a id="__codelineno-3-19" name="__codelineno-3-19" href="#__codelineno-3-19"></a><span class="w">    </span><span class="n">slap</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_itimediff</span><span class="p">(</span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">current</span><span class="p">,</span><span class="w"> </span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">ts_flush</span><span class="p">);</span>
<a id="__codelineno-3-20" name="__codelineno-3-20" href="#__codelineno-3-20"></a>
<a id="__codelineno-3-21" name="__codelineno-3-21" href="#__codelineno-3-21"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">slap</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">10000</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">slap</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">-10000</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-3-22" name="__codelineno-3-22" href="#__codelineno-3-22"></a><span class="w">        </span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">ts_flush</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">current</span><span class="p">;</span>
<a id="__codelineno-3-23" name="__codelineno-3-23" href="#__codelineno-3-23"></a><span class="w">        </span><span class="n">slap</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="__codelineno-3-24" name="__codelineno-3-24" href="#__codelineno-3-24"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-3-25" name="__codelineno-3-25" href="#__codelineno-3-25"></a>
<a id="__codelineno-3-26" name="__codelineno-3-26" href="#__codelineno-3-26"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">slap</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-3-27" name="__codelineno-3-27" href="#__codelineno-3-27"></a><span class="c1">// الوقت التالي للتفريغ</span>
<a id="__codelineno-3-28" name="__codelineno-3-28" href="#__codelineno-3-28"></a><span class="w">        </span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">ts_flush</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">interval</span><span class="p">;</span>
<a id="__codelineno-3-29" name="__codelineno-3-29" href="#__codelineno-3-29"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">_itimediff</span><span class="p">(</span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">current</span><span class="p">,</span><span class="w"> </span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">ts_flush</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-3-30" name="__codelineno-3-30" href="#__codelineno-3-30"></a><span class="w">            </span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">ts_flush</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">current</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">interval</span><span class="p">;</span>
<a id="__codelineno-3-31" name="__codelineno-3-31" href="#__codelineno-3-31"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-3-32" name="__codelineno-3-32" href="#__codelineno-3-32"></a><span class="w">        </span><span class="n">ikcp_flush</span><span class="p">(</span><span class="n">kcp</span><span class="p">);</span>
<a id="__codelineno-3-33" name="__codelineno-3-33" href="#__codelineno-3-33"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-3-34" name="__codelineno-3-34" href="#__codelineno-3-34"></a><span class="p">}</span>
</code></pre></div>
</details>

<p>تقوم وظيفة <code>ikcp_update</code> بفعل بسيط جدًا، تقوم بتقييم الوقت الخاص بـ <code>ts_flush</code>، وإذا تم اجتياز الشرط، سيتم استدعاء <code>ikcp_flush</code>. ويتم التعامل الرئيسي في داخل <code>ikcp_flush</code>، لأن محتوى <code>ikcp_flush</code> أكثر تعقيدًا قليلاً، حاليًا نحن مهتمون فقط بالجزء المتعلق بإرسال الطلبات التكرارية التلقائية ARQ.</p>
<details>
&lt;ملخص&gt; إرسال البيانات (انقر لعرض الشفرة) ملخص&gt;
<div class="language-cpp highlight"><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a><span class="c1">//---------------------------------------------------------------------</span>
<a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a><span class="c1">// ikcp_flush</span>
<a id="__codelineno-4-3" name="__codelineno-4-3" href="#__codelineno-4-3"></a><span class="c1">//---------------------------------------------------------------------</span>
<a id="__codelineno-4-4" name="__codelineno-4-4" href="#__codelineno-4-4"></a><span class="kt">void</span><span class="w"> </span><span class="nf">ikcp_flush</span><span class="p">(</span><span class="n">ikcpcb</span><span class="w"> </span><span class="o">*</span><span class="n">kcp</span><span class="p">)</span>
<a id="__codelineno-4-5" name="__codelineno-4-5" href="#__codelineno-4-5"></a><span class="p">{</span>
<a id="__codelineno-4-6" name="__codelineno-4-6" href="#__codelineno-4-6"></a><span class="w">    </span><span class="n">IUINT32</span><span class="w"> </span><span class="n">current</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">current</span><span class="p">;</span>
<a id="__codelineno-4-7" name="__codelineno-4-7" href="#__codelineno-4-7"></a>
<a id="__codelineno-4-8" name="__codelineno-4-8" href="#__codelineno-4-8"></a><span class="c1">// buffer يجب أن تمرر البيانات إلى ikcp_output ، يتم تهيئتها بحجم حزم البيانات ثلاث مرات.</span>
<a id="__codelineno-4-9" name="__codelineno-4-9" href="#__codelineno-4-9"></a><span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">buffer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">;</span>
<a id="__codelineno-4-10" name="__codelineno-4-10" href="#__codelineno-4-10"></a><span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">ptr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">buffer</span><span class="p">;</span>
<a id="__codelineno-4-11" name="__codelineno-4-11" href="#__codelineno-4-11"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">count</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">;</span>
<a id="__codelineno-4-12" name="__codelineno-4-12" href="#__codelineno-4-12"></a><span class="w">    </span><span class="n">IUINT32</span><span class="w"> </span><span class="n">resent</span><span class="p">,</span><span class="w"> </span><span class="n">cwnd</span><span class="p">;</span>
<a id="__codelineno-4-13" name="__codelineno-4-13" href="#__codelineno-4-13"></a><span class="w">    </span><span class="n">IUINT32</span><span class="w"> </span><span class="n">rtomin</span><span class="p">;</span>
<a id="__codelineno-4-14" name="__codelineno-4-14" href="#__codelineno-4-14"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">IQUEUEHEAD</span><span class="w"> </span><span class="o">*</span><span class="n">p</span><span class="p">;</span>
<a id="__codelineno-4-15" name="__codelineno-4-15" href="#__codelineno-4-15"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">change</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="__codelineno-4-16" name="__codelineno-4-16" href="#__codelineno-4-16"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">lost</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="__codelineno-4-17" name="__codelineno-4-17" href="#__codelineno-4-17"></a><span class="w">    </span><span class="n">IKCPSEG</span><span class="w"> </span><span class="n">seg</span><span class="p">;</span>
<a id="__codelineno-4-18" name="__codelineno-4-18" href="#__codelineno-4-18"></a>
<a id="__codelineno-4-19" name="__codelineno-4-19" href="#__codelineno-4-19"></a><span class="w">    </span><span class="c1">// 'ikcp_update' haven't been called.</span>
<a id="__codelineno-4-20" name="__codelineno-4-20" href="#__codelineno-4-20"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">updated</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="p">;</span>
<a id="__codelineno-4-21" name="__codelineno-4-21" href="#__codelineno-4-21"></a>
<a id="__codelineno-4-22" name="__codelineno-4-22" href="#__codelineno-4-22"></a><span class="w">    </span><span class="n">seg</span><span class="p">.</span><span class="n">conv</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">conv</span><span class="p">;</span>
<a id="__codelineno-4-23" name="__codelineno-4-23" href="#__codelineno-4-23"></a><span class="w">    </span><span class="n">seg</span><span class="p">.</span><span class="n">cmd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">IKCP_CMD_ACK</span><span class="p">;</span>
<a id="__codelineno-4-24" name="__codelineno-4-24" href="#__codelineno-4-24"></a><span class="w">    </span><span class="n">seg</span><span class="p">.</span><span class="n">frg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="__codelineno-4-25" name="__codelineno-4-25" href="#__codelineno-4-25"></a>
<a id="__codelineno-4-26" name="__codelineno-4-26" href="#__codelineno-4-26"></a><span class="c1">// seg.wnd هو تعبير يمثل حجم النافذة الحالية المتاحة للاستقبال</span>
<a id="__codelineno-4-27" name="__codelineno-4-27" href="#__codelineno-4-27"></a><span class="w">    </span><span class="n">seg</span><span class="p">.</span><span class="n">wnd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ikcp_wnd_unused</span><span class="p">(</span><span class="n">kcp</span><span class="p">);</span>
<a id="__codelineno-4-28" name="__codelineno-4-28" href="#__codelineno-4-28"></a><span class="w">    </span><span class="n">seg</span><span class="p">.</span><span class="n">una</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">rcv_nxt</span><span class="p">;</span>
<a id="__codelineno-4-29" name="__codelineno-4-29" href="#__codelineno-4-29"></a><span class="w">    </span><span class="n">seg</span><span class="p">.</span><span class="n">len</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="__codelineno-4-30" name="__codelineno-4-30" href="#__codelineno-4-30"></a><span class="w">    </span><span class="n">seg</span><span class="p">.</span><span class="n">sn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="__codelineno-4-31" name="__codelineno-4-31" href="#__codelineno-4-31"></a><span class="w">    </span><span class="n">seg</span><span class="p">.</span><span class="n">ts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="__codelineno-4-32" name="__codelineno-4-32" href="#__codelineno-4-32"></a>
<a id="__codelineno-4-33" name="__codelineno-4-33" href="#__codelineno-4-33"></a><span class="c1">// إرسال تأكيد</span>
<a id="__codelineno-4-34" name="__codelineno-4-34" href="#__codelineno-4-34"></a><span class="n">حساب</span><span class="w"> </span><span class="n">نافذة</span><span class="w"> </span><span class="n">الإرسال</span>
<a id="__codelineno-4-35" name="__codelineno-4-35" href="#__codelineno-4-35"></a><span class="w">    </span><span class="c1">//...</span>
<a id="__codelineno-4-36" name="__codelineno-4-36" href="#__codelineno-4-36"></a>
<a id="__codelineno-4-37" name="__codelineno-4-37" href="#__codelineno-4-37"></a><span class="n">نقل</span><span class="w"> </span><span class="n">حزمة</span><span class="w"> </span><span class="n">البيانات</span><span class="w"> </span><span class="n">من</span><span class="w"> </span><span class="n">قائمة</span><span class="w"> </span><span class="n">الإرسال</span><span class="w"> </span><span class="n">إلى</span><span class="w"> </span><span class="n">الذاكرة</span><span class="w"> </span><span class="n">النصية</span><span class="w"> </span><span class="n">للإرسال</span>
<a id="__codelineno-4-38" name="__codelineno-4-38" href="#__codelineno-4-38"></a><span class="n">التحرك</span><span class="w"> </span><span class="n">يتطلب</span><span class="w"> </span><span class="n">تلبية</span><span class="w"> </span><span class="n">حجم</span><span class="w"> </span><span class="n">النافذة</span><span class="w"> </span><span class="n">المرسلة</span><span class="err">،</span><span class="w"> </span><span class="n">عندما</span><span class="w"> </span><span class="n">تمتلئ</span><span class="w"> </span><span class="n">النافذة</span><span class="w"> </span><span class="n">المرسلة</span><span class="err">،</span><span class="w"> </span><span class="n">يتوقف</span><span class="w"> </span><span class="n">التحرك</span><span class="p">.</span>
<a id="__codelineno-4-39" name="__codelineno-4-39" href="#__codelineno-4-39"></a><span class="n">البيانات</span><span class="w"> </span><span class="n">الموجودة</span><span class="w"> </span><span class="n">داخل</span><span class="w"> </span><span class="n">snd_buf</span><span class="w"> </span><span class="n">هي</span><span class="w"> </span><span class="n">البيانات</span><span class="w"> </span><span class="n">التي</span><span class="w"> </span><span class="n">يمكن</span><span class="w"> </span><span class="n">إرسالها</span><span class="w"> </span><span class="n">مباشرة</span><span class="w"> </span><span class="n">إلى</span><span class="w"> </span><span class="n">الطرف</span><span class="w"> </span><span class="n">الآخر</span><span class="w"> </span><span class="n">عن</span><span class="w"> </span><span class="n">طريق</span><span class="w"> </span><span class="n">استدعاء</span><span class="w"> </span><span class="n">ikcp_output</span><span class="p">.</span>
<a id="__codelineno-4-40" name="__codelineno-4-40" href="#__codelineno-4-40"></a><span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">_itimediff</span><span class="p">(</span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">snd_nxt</span><span class="p">,</span><span class="w"> </span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">snd_una</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">cwnd</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-4-41" name="__codelineno-4-41" href="#__codelineno-4-41"></a><span class="w">        </span><span class="n">IKCPSEG</span><span class="w"> </span><span class="o">*</span><span class="n">newseg</span><span class="p">;</span>
<a id="__codelineno-4-42" name="__codelineno-4-42" href="#__codelineno-4-42"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">iqueue_is_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">snd_queue</span><span class="p">))</span><span class="w"> </span><span class="k">break</span><span class="p">;</span>
<a id="__codelineno-4-43" name="__codelineno-4-43" href="#__codelineno-4-43"></a>
<a id="__codelineno-4-44" name="__codelineno-4-44" href="#__codelineno-4-44"></a><span class="w">        </span><span class="n">newseg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iqueue_entry</span><span class="p">(</span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">snd_queue</span><span class="p">.</span><span class="n">next</span><span class="p">,</span><span class="w"> </span><span class="n">IKCPSEG</span><span class="p">,</span><span class="w"> </span><span class="n">node</span><span class="p">);</span>
<a id="__codelineno-4-45" name="__codelineno-4-45" href="#__codelineno-4-45"></a>
<a id="__codelineno-4-46" name="__codelineno-4-46" href="#__codelineno-4-46"></a><span class="w">        </span><span class="n">iqueue_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">newseg</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">);</span>
<a id="__codelineno-4-47" name="__codelineno-4-47" href="#__codelineno-4-47"></a><span class="w">        </span><span class="n">iqueue_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">newseg</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">snd_buf</span><span class="p">);</span>
<a id="__codelineno-4-48" name="__codelineno-4-48" href="#__codelineno-4-48"></a><span class="w">        </span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">nsnd_que</span><span class="o">--</span><span class="p">;</span>
<a id="__codelineno-4-49" name="__codelineno-4-49" href="#__codelineno-4-49"></a><span class="w">        </span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">nsnd_buf</span><span class="o">++</span><span class="p">;</span>
<a id="__codelineno-4-50" name="__codelineno-4-50" href="#__codelineno-4-50"></a>
<a id="__codelineno-4-51" name="__codelineno-4-51" href="#__codelineno-4-51"></a><span class="w">        </span><span class="n">newseg</span><span class="o">-&gt;</span><span class="n">conv</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">conv</span><span class="p">;</span>
<a id="__codelineno-4-52" name="__codelineno-4-52" href="#__codelineno-4-52"></a><span class="w">        </span><span class="n">newseg</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">IKCP_CMD_PUSH</span><span class="p">;</span>
<a id="__codelineno-4-53" name="__codelineno-4-53" href="#__codelineno-4-53"></a><span class="w">        </span><span class="n">newseg</span><span class="o">-&gt;</span><span class="n">wnd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">seg</span><span class="p">.</span><span class="n">wnd</span><span class="p">;</span>
<a id="__codelineno-4-54" name="__codelineno-4-54" href="#__codelineno-4-54"></a><span class="w">        </span><span class="n">newseg</span><span class="o">-&gt;</span><span class="n">ts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">current</span><span class="p">;</span>
<a id="__codelineno-4-55" name="__codelineno-4-55" href="#__codelineno-4-55"></a>
<a id="__codelineno-4-56" name="__codelineno-4-56" href="#__codelineno-4-56"></a><span class="c1">// "seg" is a unique serial number, actually it is an increasing kcp-&gt;snd_nxt</span>
<a id="__codelineno-4-57" name="__codelineno-4-57" href="#__codelineno-4-57"></a><span class="w">        </span><span class="n">newseg</span><span class="o">-&gt;</span><span class="n">sn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">snd_nxt</span><span class="o">++</span><span class="p">;</span>
<a id="__codelineno-4-58" name="__codelineno-4-58" href="#__codelineno-4-58"></a>
<a id="__codelineno-4-59" name="__codelineno-4-59" href="#__codelineno-4-59"></a><span class="n">تم</span><span class="w"> </span><span class="n">تعيين</span><span class="w"> </span><span class="n">una</span><span class="w"> </span><span class="n">هنا</span><span class="w"> </span><span class="n">لإشعار</span><span class="w"> </span><span class="n">جهة</span><span class="w"> </span><span class="n">الاستقبال</span><span class="w"> </span><span class="n">برقم</span><span class="w"> </span><span class="n">تسلسل</span><span class="w"> </span><span class="n">الحزمة</span><span class="w"> </span><span class="n">التالية</span><span class="w"> </span><span class="n">التي</span><span class="w"> </span><span class="n">يجب</span><span class="w"> </span><span class="n">استقبالها</span><span class="p">.</span>
<a id="__codelineno-4-60" name="__codelineno-4-60" href="#__codelineno-4-60"></a><span class="w">        </span><span class="n">newseg</span><span class="o">-&gt;</span><span class="n">una</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">rcv_nxt</span><span class="p">;</span>
<a id="__codelineno-4-61" name="__codelineno-4-61" href="#__codelineno-4-61"></a><span class="w">        </span><span class="n">newseg</span><span class="o">-&gt;</span><span class="n">resendts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">current</span><span class="p">;</span>
<a id="__codelineno-4-62" name="__codelineno-4-62" href="#__codelineno-4-62"></a><span class="w">        </span><span class="n">newseg</span><span class="o">-&gt;</span><span class="n">rto</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">rx_rto</span><span class="p">;</span>
<a id="__codelineno-4-63" name="__codelineno-4-63" href="#__codelineno-4-63"></a><span class="w">        </span><span class="n">newseg</span><span class="o">-&gt;</span><span class="n">fastack</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="__codelineno-4-64" name="__codelineno-4-64" href="#__codelineno-4-64"></a><span class="w">        </span><span class="n">newseg</span><span class="o">-&gt;</span><span class="n">xmit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="__codelineno-4-65" name="__codelineno-4-65" href="#__codelineno-4-65"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-4-66" name="__codelineno-4-66" href="#__codelineno-4-66"></a>
<a id="__codelineno-4-67" name="__codelineno-4-67" href="#__codelineno-4-67"></a><span class="c1">// حساب علامة إعادة النقل السريع، ووقت الانتظار الزائد</span>
<a id="__codelineno-4-68" name="__codelineno-4-68" href="#__codelineno-4-68"></a><span class="w">    </span><span class="c1">// ...</span>
<a id="__codelineno-4-69" name="__codelineno-4-69" href="#__codelineno-4-69"></a>
<a id="__codelineno-4-70" name="__codelineno-4-70" href="#__codelineno-4-70"></a><span class="c1">// إرسال snd_buf</span>
<a id="__codelineno-4-71" name="__codelineno-4-71" href="#__codelineno-4-71"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">snd_buf</span><span class="p">.</span><span class="n">next</span><span class="p">;</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">snd_buf</span><span class="p">;</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">p</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-4-72" name="__codelineno-4-72" href="#__codelineno-4-72"></a><span class="w">        </span><span class="n">IKCPSEG</span><span class="w"> </span><span class="o">*</span><span class="n">segment</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iqueue_entry</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="n">IKCPSEG</span><span class="p">,</span><span class="w"> </span><span class="n">node</span><span class="p">);</span>
<a id="__codelineno-4-73" name="__codelineno-4-73" href="#__codelineno-4-73"></a><span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">needsend</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="__codelineno-4-74" name="__codelineno-4-74" href="#__codelineno-4-74"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">segment</span><span class="o">-&gt;</span><span class="n">xmit</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-4-75" name="__codelineno-4-75" href="#__codelineno-4-75"></a><span class="c1">// الإرسال الأول</span>
<a id="__codelineno-4-76" name="__codelineno-4-76" href="#__codelineno-4-76"></a><span class="n">set</span><span class="o">-&gt;</span><span class="n">xmit</span><span class="w"> </span><span class="n">تعني</span><span class="w"> </span><span class="n">عدد</span><span class="w"> </span><span class="n">مرات</span><span class="w"> </span><span class="n">الإرسال</span>
<a id="__codelineno-4-77" name="__codelineno-4-77" href="#__codelineno-4-77"></a><span class="c1">// وقت الانتظار لإعادة إرسال resendts بعد انتهاء المهلة</span>
<a id="__codelineno-4-78" name="__codelineno-4-78" href="#__codelineno-4-78"></a><span class="w">            </span><span class="n">needsend</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<a id="__codelineno-4-79" name="__codelineno-4-79" href="#__codelineno-4-79"></a><span class="w">            </span><span class="n">segment</span><span class="o">-&gt;</span><span class="n">xmit</span><span class="o">++</span><span class="p">;</span>
<a id="__codelineno-4-80" name="__codelineno-4-80" href="#__codelineno-4-80"></a><span class="w">            </span><span class="n">segment</span><span class="o">-&gt;</span><span class="n">rto</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">rx_rto</span><span class="p">;</span>
<a id="__codelineno-4-81" name="__codelineno-4-81" href="#__codelineno-4-81"></a><span class="w">            </span><span class="n">segment</span><span class="o">-&gt;</span><span class="n">resendts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">current</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">segment</span><span class="o">-&gt;</span><span class="n">rto</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">rtomin</span><span class="p">;</span>
<a id="__codelineno-4-82" name="__codelineno-4-82" href="#__codelineno-4-82"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-4-83" name="__codelineno-4-83" href="#__codelineno-4-83"></a><span class="w">        </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">_itimediff</span><span class="p">(</span><span class="n">current</span><span class="p">,</span><span class="w"> </span><span class="n">segment</span><span class="o">-&gt;</span><span class="n">resendts</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-4-84" name="__codelineno-4-84" href="#__codelineno-4-84"></a><span class="n">إعادة</span><span class="w"> </span><span class="n">الإرسال</span><span class="w"> </span><span class="n">بسبب</span><span class="w"> </span><span class="n">تجاوز</span><span class="w"> </span><span class="n">الوقت</span>
<a id="__codelineno-4-85" name="__codelineno-4-85" href="#__codelineno-4-85"></a><span class="w">            </span><span class="c1">// ...</span>
<a id="__codelineno-4-86" name="__codelineno-4-86" href="#__codelineno-4-86"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-4-87" name="__codelineno-4-87" href="#__codelineno-4-87"></a><span class="w">        </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">segment</span><span class="o">-&gt;</span><span class="n">fastack</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">resent</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-4-88" name="__codelineno-4-88" href="#__codelineno-4-88"></a><span class="c1">// إعادة النقل السريع</span>
<a id="__codelineno-4-89" name="__codelineno-4-89" href="#__codelineno-4-89"></a><span class="w">            </span><span class="c1">// ...</span>
<a id="__codelineno-4-90" name="__codelineno-4-90" href="#__codelineno-4-90"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-4-91" name="__codelineno-4-91" href="#__codelineno-4-91"></a>
<a id="__codelineno-4-92" name="__codelineno-4-92" href="#__codelineno-4-92"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">needsend</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-4-93" name="__codelineno-4-93" href="#__codelineno-4-93"></a><span class="w">            </span><span class="kt">int</span><span class="w"> </span><span class="n">need</span><span class="p">;</span>
<a id="__codelineno-4-94" name="__codelineno-4-94" href="#__codelineno-4-94"></a><span class="w">            </span><span class="n">segment</span><span class="o">-&gt;</span><span class="n">ts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">current</span><span class="p">;</span>
<a id="__codelineno-4-95" name="__codelineno-4-95" href="#__codelineno-4-95"></a><span class="w">            </span><span class="n">segment</span><span class="o">-&gt;</span><span class="n">wnd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">seg</span><span class="p">.</span><span class="n">wnd</span><span class="p">;</span>
<a id="__codelineno-4-96" name="__codelineno-4-96" href="#__codelineno-4-96"></a><span class="w">            </span><span class="n">segment</span><span class="o">-&gt;</span><span class="n">una</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">rcv_nxt</span><span class="p">;</span>
<a id="__codelineno-4-97" name="__codelineno-4-97" href="#__codelineno-4-97"></a>
<a id="__codelineno-4-98" name="__codelineno-4-98" href="#__codelineno-4-98"></a><span class="w">            </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="n">ptr</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">buffer</span><span class="p">);</span>
<a id="__codelineno-4-99" name="__codelineno-4-99" href="#__codelineno-4-99"></a><span class="w">            </span><span class="n">need</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">IKCP_OVERHEAD</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">segment</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
<a id="__codelineno-4-100" name="__codelineno-4-100" href="#__codelineno-4-100"></a>
<a id="__codelineno-4-101" name="__codelineno-4-101" href="#__codelineno-4-101"></a><span class="n">عندما</span><span class="w"> </span><span class="n">تتجاوز</span><span class="w"> </span><span class="n">بيانات</span><span class="w"> </span><span class="n">الحافظة</span><span class="w"> </span><span class="n">mtu</span><span class="w"> </span><span class="err">،</span><span class="w"> </span><span class="n">قم</span><span class="w"> </span><span class="n">بإرسالها</span><span class="w"> </span><span class="n">أولا</span><span class="err">ً</span><span class="w"> </span><span class="n">لتجنب</span><span class="w"> </span><span class="n">تجزئة</span><span class="w"> </span><span class="n">الطبقة</span><span class="w"> </span><span class="n">السفلية</span><span class="p">.</span>
<a id="__codelineno-4-102" name="__codelineno-4-102" href="#__codelineno-4-102"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">size</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">need</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">mtu</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-4-103" name="__codelineno-4-103" href="#__codelineno-4-103"></a><span class="w">                </span><span class="n">ikcp_output</span><span class="p">(</span><span class="n">kcp</span><span class="p">,</span><span class="w"> </span><span class="n">buffer</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="p">);</span>
<a id="__codelineno-4-104" name="__codelineno-4-104" href="#__codelineno-4-104"></a><span class="w">                </span><span class="n">ptr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">buffer</span><span class="p">;</span>
<a id="__codelineno-4-105" name="__codelineno-4-105" href="#__codelineno-4-105"></a><span class="w">            </span><span class="p">}</span>
<a id="__codelineno-4-106" name="__codelineno-4-106" href="#__codelineno-4-106"></a>
<a id="__codelineno-4-107" name="__codelineno-4-107" href="#__codelineno-4-107"></a><span class="n">نسخ</span><span class="w"> </span><span class="n">بيانات</span><span class="w"> </span><span class="n">تحكم</span><span class="w"> </span><span class="n">seg</span><span class="w"> </span><span class="n">إلى</span><span class="w"> </span><span class="n">buffer</span><span class="w"> </span><span class="err">،</span><span class="w">  </span><span class="n">kcp</span><span class="w"> </span><span class="n">سيتولى</span><span class="w"> </span><span class="n">التعامل</span><span class="w"> </span><span class="n">مع</span><span class="w"> </span><span class="n">مشكلة</span><span class="w"> </span><span class="n">نهاية</span><span class="w"> </span><span class="n">البايت</span><span class="w"> </span><span class="n">لوحده</span><span class="p">.</span>
<a id="__codelineno-4-108" name="__codelineno-4-108" href="#__codelineno-4-108"></a><span class="w">            </span><span class="n">ptr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ikcp_encode_seg</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span><span class="w"> </span><span class="n">segment</span><span class="p">);</span>
<a id="__codelineno-4-109" name="__codelineno-4-109" href="#__codelineno-4-109"></a>
<a id="__codelineno-4-110" name="__codelineno-4-110" href="#__codelineno-4-110"></a><span class="c1">// يتم نسخ البيانات مرة أخرى.</span>
<a id="__codelineno-4-111" name="__codelineno-4-111" href="#__codelineno-4-111"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">segment</span><span class="o">-&gt;</span><span class="n">len</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-4-112" name="__codelineno-4-112" href="#__codelineno-4-112"></a><span class="w">                </span><span class="n">memcpy</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span><span class="w"> </span><span class="n">segment</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="n">segment</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
<a id="__codelineno-4-113" name="__codelineno-4-113" href="#__codelineno-4-113"></a><span class="w">                </span><span class="n">ptr</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">segment</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
<a id="__codelineno-4-114" name="__codelineno-4-114" href="#__codelineno-4-114"></a><span class="w">            </span><span class="p">}</span>
<a id="__codelineno-4-115" name="__codelineno-4-115" href="#__codelineno-4-115"></a>
<a id="__codelineno-4-116" name="__codelineno-4-116" href="#__codelineno-4-116"></a>
<a id="__codelineno-4-117" name="__codelineno-4-117" href="#__codelineno-4-117"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">segment</span><span class="o">-&gt;</span><span class="n">xmit</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">dead_link</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-4-118" name="__codelineno-4-118" href="#__codelineno-4-118"></a><span class="w">                </span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">IUINT32</span><span class="p">)</span><span class="mi">-1</span><span class="p">;</span>
<a id="__codelineno-4-119" name="__codelineno-4-119" href="#__codelineno-4-119"></a><span class="w">            </span><span class="p">}</span>
<a id="__codelineno-4-120" name="__codelineno-4-120" href="#__codelineno-4-120"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-4-121" name="__codelineno-4-121" href="#__codelineno-4-121"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-4-122" name="__codelineno-4-122" href="#__codelineno-4-122"></a>
<a id="__codelineno-4-123" name="__codelineno-4-123" href="#__codelineno-4-123"></a><span class="w">    </span><span class="c1">// flash remain segments</span>
<a id="__codelineno-4-124" name="__codelineno-4-124" href="#__codelineno-4-124"></a><span class="w">    </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="n">ptr</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">buffer</span><span class="p">);</span>
<a id="__codelineno-4-125" name="__codelineno-4-125" href="#__codelineno-4-125"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">size</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-4-126" name="__codelineno-4-126" href="#__codelineno-4-126"></a><span class="w">        </span><span class="n">ikcp_output</span><span class="p">(</span><span class="n">kcp</span><span class="p">,</span><span class="w"> </span><span class="n">buffer</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="p">);</span>
<a id="__codelineno-4-127" name="__codelineno-4-127" href="#__codelineno-4-127"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-4-128" name="__codelineno-4-128" href="#__codelineno-4-128"></a>
<a id="__codelineno-4-129" name="__codelineno-4-129" href="#__codelineno-4-129"></a><span class="c1">// حساب قيمة ssthresh وتحديث نافذة البدء البطيء</span>
<a id="__codelineno-4-130" name="__codelineno-4-130" href="#__codelineno-4-130"></a><span class="w">    </span><span class="c1">// ...</span>
<a id="__codelineno-4-131" name="__codelineno-4-131" href="#__codelineno-4-131"></a><span class="p">}</span>
</code></pre></div>
</details>

<p>نحن حالياً مركزون على المنطق المتعلق بإرسال البيانات داخل <code>ikcp_flush</code>:</p>
<p>أولاً، ستقوم KCP بنقل البيانات من <code>snd_queue</code> إلى <code>snd_buf</code> استنادًا إلى حجم نافذة الاستقبال للطرف الآخر. يُحسب عدد النقل بالمعادلة التالية: <code>num = snd_nxt - (snd_una + cwnd)</code>، أي: إذا كانت أقصى رقم تسلسل للحزمة المرسلة بنجاح <code>snd_una</code> بزيادة حجم نافذة الانزلاق <code>cwnd</code> أكبر من رقم تسلسل الحزمة التالية المقرر إرسالها <code>snd_nxt</code>، يمكن مواصلة إرسال بيانات جديدة. خلال نقل <code>SEG</code>، سيتم ضبط حقول التحكم.</p>
<p>قم بتمرير <code>snd_buf</code>، وفي حال الحاجة إلى إرسال حزمة بيانات، قم بنسخ البيانات إلى الـ <code>buffer</code>، مع معالجة مشكلة تناوب البيانات في الحقل التحكم باستخدام <code>ikcp_encode_seg</code>.</p>
<p>قم بتنفيذ <code>ikcp_output</code> في النهاية لإرسال البيانات على <code>buffer</code></p>
<p>حتى الآن ، أكمل KCP إرسال البيانات.</p>
<h3 id="_2">استقبال</h3>
<p>عملية الاستقبال معاكسة لعملية الإرسال: <code>ikcp_input</code> -&gt; <code>ikcp_update</code> -&gt; <code>ikcp_recv</code>، بعد استلام المستخدم للبيانات عبر الشبكة، يتعين عليه استدعاء <code>ikcp_input</code> لتحليلها بواسطة KCP، وأثناء استدعاء <code>ikcp_update</code> سيتم إرسال باك ACK إلى الجهة المرسلة، ويمكن للطبقة العليا استقبال البيانات المحللة بعد ذلك عن طريق استدعاء <code>ikcp_recv</code>.</p>
<details>
&lt;الملخص&gt; استقبال البيانات (انقر لعرض الشيفرة) الملخص&gt;
<div class="language-cpp highlight"><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a><span class="c1">//---------------------------------------------------------------------</span>
<a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a><span class="c1">// input data</span>
<a id="__codelineno-5-3" name="__codelineno-5-3" href="#__codelineno-5-3"></a><span class="c1">//---------------------------------------------------------------------</span>
<a id="__codelineno-5-4" name="__codelineno-5-4" href="#__codelineno-5-4"></a><span class="kt">int</span><span class="w"> </span><span class="nf">ikcp_input</span><span class="p">(</span><span class="n">ikcpcb</span><span class="w"> </span><span class="o">*</span><span class="n">kcp</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">size</span><span class="p">)</span>
<a id="__codelineno-5-5" name="__codelineno-5-5" href="#__codelineno-5-5"></a><span class="p">{</span>
<a id="__codelineno-5-6" name="__codelineno-5-6" href="#__codelineno-5-6"></a><span class="w">    </span><span class="n">IUINT32</span><span class="w"> </span><span class="n">prev_una</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">snd_una</span><span class="p">;</span>
<a id="__codelineno-5-7" name="__codelineno-5-7" href="#__codelineno-5-7"></a><span class="w">    </span><span class="n">IUINT32</span><span class="w"> </span><span class="n">maxack</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">latest_ts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="__codelineno-5-8" name="__codelineno-5-8" href="#__codelineno-5-8"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">flag</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="__codelineno-5-9" name="__codelineno-5-9" href="#__codelineno-5-9"></a>
<a id="__codelineno-5-10" name="__codelineno-5-10" href="#__codelineno-5-10"></a><span class="c1">// فحص الشرعية</span>
<a id="__codelineno-5-11" name="__codelineno-5-11" href="#__codelineno-5-11"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">data</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">NULL</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">size</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">IKCP_OVERHEAD</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span>
<a id="__codelineno-5-12" name="__codelineno-5-12" href="#__codelineno-5-12"></a>
<a id="__codelineno-5-13" name="__codelineno-5-13" href="#__codelineno-5-13"></a><span class="c1">// البيانات قد تكون مجموعة من طرود KCP، يتم التعامل معها بشكل دوري</span>
<a id="__codelineno-5-14" name="__codelineno-5-14" href="#__codelineno-5-14"></a><span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-5-15" name="__codelineno-5-15" href="#__codelineno-5-15"></a><span class="w">        </span><span class="n">IUINT32</span><span class="w"> </span><span class="n">ts</span><span class="p">,</span><span class="w"> </span><span class="n">sn</span><span class="p">,</span><span class="w"> </span><span class="n">len</span><span class="p">,</span><span class="w"> </span><span class="n">una</span><span class="p">,</span><span class="w"> </span><span class="n">conv</span><span class="p">;</span>
<a id="__codelineno-5-16" name="__codelineno-5-16" href="#__codelineno-5-16"></a><span class="w">        </span><span class="n">IUINT16</span><span class="w"> </span><span class="n">wnd</span><span class="p">;</span>
<a id="__codelineno-5-17" name="__codelineno-5-17" href="#__codelineno-5-17"></a><span class="w">        </span><span class="n">IUINT8</span><span class="w"> </span><span class="n">cmd</span><span class="p">,</span><span class="w"> </span><span class="n">frg</span><span class="p">;</span>
<a id="__codelineno-5-18" name="__codelineno-5-18" href="#__codelineno-5-18"></a><span class="w">        </span><span class="n">IKCPSEG</span><span class="w"> </span><span class="o">*</span><span class="n">seg</span><span class="p">;</span>
<a id="__codelineno-5-19" name="__codelineno-5-19" href="#__codelineno-5-19"></a>
<a id="__codelineno-5-20" name="__codelineno-5-20" href="#__codelineno-5-20"></a><span class="n">لا</span><span class="w"> </span><span class="n">يكفي</span><span class="w"> </span><span class="n">وجود</span><span class="w"> </span><span class="n">حزمة</span><span class="w"> </span><span class="n">KCP</span><span class="w"> </span><span class="n">واحدة</span><span class="err">،</span><span class="w"> </span><span class="n">تم</span><span class="w"> </span><span class="n">الخروج</span>
<a id="__codelineno-5-21" name="__codelineno-5-21" href="#__codelineno-5-21"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">size</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">IKCP_OVERHEAD</span><span class="p">)</span><span class="w"> </span><span class="k">break</span><span class="p">;</span>
<a id="__codelineno-5-22" name="__codelineno-5-22" href="#__codelineno-5-22"></a>
<a id="__codelineno-5-23" name="__codelineno-5-23" href="#__codelineno-5-23"></a><span class="c1">// دعونا نبدأ بتحليل الحقول التحكمية</span>
<a id="__codelineno-5-24" name="__codelineno-5-24" href="#__codelineno-5-24"></a><span class="w">        </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ikcp_decode32u</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">conv</span><span class="p">);</span>
<a id="__codelineno-5-25" name="__codelineno-5-25" href="#__codelineno-5-25"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">conv</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">conv</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span>
<a id="__codelineno-5-26" name="__codelineno-5-26" href="#__codelineno-5-26"></a>
<a id="__codelineno-5-27" name="__codelineno-5-27" href="#__codelineno-5-27"></a><span class="w">        </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ikcp_decode8u</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>
<a id="__codelineno-5-28" name="__codelineno-5-28" href="#__codelineno-5-28"></a><span class="w">        </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ikcp_decode8u</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">frg</span><span class="p">);</span>
<a id="__codelineno-5-29" name="__codelineno-5-29" href="#__codelineno-5-29"></a><span class="w">        </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ikcp_decode16u</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">wnd</span><span class="p">);</span>
<a id="__codelineno-5-30" name="__codelineno-5-30" href="#__codelineno-5-30"></a><span class="w">        </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ikcp_decode32u</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">ts</span><span class="p">);</span>
<a id="__codelineno-5-31" name="__codelineno-5-31" href="#__codelineno-5-31"></a><span class="w">        </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ikcp_decode32u</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">sn</span><span class="p">);</span>
<a id="__codelineno-5-32" name="__codelineno-5-32" href="#__codelineno-5-32"></a><span class="w">        </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ikcp_decode32u</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">una</span><span class="p">);</span>
<a id="__codelineno-5-33" name="__codelineno-5-33" href="#__codelineno-5-33"></a><span class="w">        </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ikcp_decode32u</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">len</span><span class="p">);</span>
<a id="__codelineno-5-34" name="__codelineno-5-34" href="#__codelineno-5-34"></a>
<a id="__codelineno-5-35" name="__codelineno-5-35" href="#__codelineno-5-35"></a><span class="w">        </span><span class="n">size</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="n">IKCP_OVERHEAD</span><span class="p">;</span>
<a id="__codelineno-5-36" name="__codelineno-5-36" href="#__codelineno-5-36"></a>
<a id="__codelineno-5-37" name="__codelineno-5-37" href="#__codelineno-5-37"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="kt">long</span><span class="p">)</span><span class="n">size</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">len</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">len</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="mi">-2</span><span class="p">;</span>
<a id="__codelineno-5-38" name="__codelineno-5-38" href="#__codelineno-5-38"></a>
<a id="__codelineno-5-39" name="__codelineno-5-39" href="#__codelineno-5-39"></a><span class="n">التحقق</span><span class="w"> </span><span class="n">من</span><span class="w"> </span><span class="n">نوع</span><span class="w"> </span><span class="n">الحزمة</span><span class="w"> </span><span class="n">البيانية</span>
<a id="__codelineno-5-40" name="__codelineno-5-40" href="#__codelineno-5-40"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">cmd</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">IKCP_CMD_PUSH</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">cmd</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">IKCP_CMD_ACK</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<a id="__codelineno-5-41" name="__codelineno-5-41" href="#__codelineno-5-41"></a><span class="w">            </span><span class="n">cmd</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">IKCP_CMD_WASK</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">cmd</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">IKCP_CMD_WINS</span><span class="p">)</span><span class="w"> </span>
<a id="__codelineno-5-42" name="__codelineno-5-42" href="#__codelineno-5-42"></a><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="mi">-3</span><span class="p">;</span>
<a id="__codelineno-5-43" name="__codelineno-5-43" href="#__codelineno-5-43"></a>
<a id="__codelineno-5-44" name="__codelineno-5-44" href="#__codelineno-5-44"></a><span class="w">        </span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">rmt_wnd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">wnd</span><span class="p">;</span>
<a id="__codelineno-5-45" name="__codelineno-5-45" href="#__codelineno-5-45"></a>
<a id="__codelineno-5-46" name="__codelineno-5-46" href="#__codelineno-5-46"></a><span class="n">هنا</span><span class="err">،</span><span class="w"> </span><span class="err">'</span><span class="n">una</span><span class="err">'</span><span class="w"> </span><span class="n">تمثل</span><span class="w"> </span><span class="err">'</span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">rcv_nxt</span><span class="err">'</span><span class="w"> </span><span class="n">للجهة</span><span class="w"> </span><span class="n">المرسلة</span><span class="p">.</span><span class="w"> </span><span class="n">باستناد</span><span class="w"> </span><span class="n">إلى</span><span class="w"> </span><span class="n">هذه</span><span class="w"> </span><span class="n">البيانات</span><span class="err">،</span><span class="w"> </span><span class="n">يمكن</span><span class="w"> </span><span class="n">إزالة</span><span class="w"> </span><span class="n">الحزم</span><span class="w"> </span><span class="n">التي</span><span class="w"> </span><span class="n">تم</span><span class="w"> </span><span class="n">تأكيد</span><span class="w"> </span><span class="n">استلامها</span><span class="w"> </span><span class="n">بالفعل</span><span class="p">.</span>
<a id="__codelineno-5-47" name="__codelineno-5-47" href="#__codelineno-5-47"></a><span class="w">        </span><span class="n">ikcp_parse_una</span><span class="p">(</span><span class="n">kcp</span><span class="p">,</span><span class="w"> </span><span class="n">una</span><span class="p">);</span>
<a id="__codelineno-5-48" name="__codelineno-5-48" href="#__codelineno-5-48"></a><span class="n">بعد</span><span class="w"> </span><span class="n">إزالة</span><span class="w"> </span><span class="n">الحزم</span><span class="w"> </span><span class="n">التي</span><span class="w"> </span><span class="n">تم</span><span class="w"> </span><span class="n">تأكيد</span><span class="w"> </span><span class="n">استلامها</span><span class="w"> </span><span class="err">،</span><span class="w"> </span><span class="n">قم</span><span class="w"> </span><span class="n">بتحديث</span><span class="w"> </span><span class="n">snd_una</span><span class="w"> </span><span class="n">بالرقم</span><span class="w"> </span><span class="n">التسلسلي</span><span class="w"> </span><span class="n">الذي</span><span class="w"> </span><span class="n">سيتم</span><span class="w"> </span><span class="n">إرساله</span><span class="w"> </span><span class="n">التالي</span><span class="p">.</span>
<a id="__codelineno-5-49" name="__codelineno-5-49" href="#__codelineno-5-49"></a><span class="w">        </span><span class="n">ikcp_shrink_buf</span><span class="p">(</span><span class="n">kcp</span><span class="p">);</span>
<a id="__codelineno-5-50" name="__codelineno-5-50" href="#__codelineno-5-50"></a>
<a id="__codelineno-5-51" name="__codelineno-5-51" href="#__codelineno-5-51"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">cmd</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">IKCP_CMD_ACK</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-5-52" name="__codelineno-5-52" href="#__codelineno-5-52"></a><span class="err">ٍ</span><span class="n">صادق</span><span class="err">،</span><span class="w"> </span><span class="n">حزمة</span><span class="w"> </span><span class="c1">//</span>
<a id="__codelineno-5-53" name="__codelineno-5-53" href="#__codelineno-5-53"></a><span class="w">            </span><span class="c1">// ...</span>
<a id="__codelineno-5-54" name="__codelineno-5-54" href="#__codelineno-5-54"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-5-55" name="__codelineno-5-55" href="#__codelineno-5-55"></a><span class="w">        </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">cmd</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">IKCP_CMD_PUSH</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-5-56" name="__codelineno-5-56" href="#__codelineno-5-56"></a><span class="c1">// حُزمة بيانات</span>
<a id="__codelineno-5-57" name="__codelineno-5-57" href="#__codelineno-5-57"></a><span class="n">إذا</span><span class="w"> </span><span class="n">كان</span><span class="w"> </span><span class="n">رقم</span><span class="w"> </span><span class="n">تسلسل</span><span class="w"> </span><span class="n">حزمة</span><span class="w"> </span><span class="n">البيانات</span><span class="w"> </span><span class="n">المستلمة</span><span class="w"> </span><span class="n">يقع</span><span class="w"> </span><span class="n">ضمن</span><span class="w"> </span><span class="n">نافذة</span><span class="w"> </span><span class="n">الاستقبال</span><span class="err">،</span><span class="w"> </span><span class="n">يتم</span><span class="w"> </span><span class="n">التعامل</span><span class="w"> </span><span class="n">معها</span><span class="w"> </span><span class="n">بشكل</span><span class="w"> </span><span class="n">طبيعي</span><span class="err">،</span><span class="w"> </span><span class="n">في</span><span class="w"> </span><span class="n">حالة</span><span class="w"> </span><span class="n">عدم</span><span class="w"> </span><span class="n">وجوده</span><span class="w"> </span><span class="n">ضمنها</span><span class="err">،</span><span class="w"> </span><span class="n">يتم</span><span class="w"> </span><span class="n">تجاهلها</span><span class="w"> </span><span class="n">مباشرة</span><span class="w"> </span><span class="n">وفي</span><span class="w"> </span><span class="n">انتظار</span><span class="w"> </span><span class="n">إعادة</span><span class="w"> </span><span class="n">الإرسال</span><span class="p">.</span>
<a id="__codelineno-5-58" name="__codelineno-5-58" href="#__codelineno-5-58"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">_itimediff</span><span class="p">(</span><span class="n">sn</span><span class="p">,</span><span class="w"> </span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">rcv_nxt</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">rcv_wnd</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-5-59" name="__codelineno-5-59" href="#__codelineno-5-59"></a>
<a id="__codelineno-5-60" name="__codelineno-5-60" href="#__codelineno-5-60"></a><span class="n">كل</span><span class="w"> </span><span class="n">حزمة</span><span class="w"> </span><span class="n">بيانات</span><span class="w"> </span><span class="n">تستلم</span><span class="w"> </span><span class="n">يجب</span><span class="w"> </span><span class="n">أن</span><span class="w"> </span><span class="n">ت</span><span class="err">ُ</span><span class="n">رس</span><span class="err">َ</span><span class="n">ل</span><span class="w"> </span><span class="n">حزمة</span><span class="w"> </span><span class="n">تأكيد</span><span class="w"> </span><span class="p">(</span><span class="n">ack</span><span class="p">)</span><span class="w"> </span><span class="n">معها</span><span class="w"> </span><span class="n">وت</span><span class="err">ُ</span><span class="n">سج</span><span class="err">َّ</span><span class="n">ل</span>
<a id="__codelineno-5-61" name="__codelineno-5-61" href="#__codelineno-5-61"></a><span class="w">                </span><span class="n">ikcp_ack_push</span><span class="p">(</span><span class="n">kcp</span><span class="p">,</span><span class="w"> </span><span class="n">sn</span><span class="p">,</span><span class="w"> </span><span class="n">ts</span><span class="p">);</span>
<a id="__codelineno-5-62" name="__codelineno-5-62" href="#__codelineno-5-62"></a>
<a id="__codelineno-5-63" name="__codelineno-5-63" href="#__codelineno-5-63"></a><span class="c1">// يتم معالجة البيانات المستلمة باستخدام ikcp_parse_data</span>
<a id="__codelineno-5-64" name="__codelineno-5-64" href="#__codelineno-5-64"></a><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">_itimediff</span><span class="p">(</span><span class="n">sn</span><span class="p">,</span><span class="w"> </span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">rcv_nxt</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-5-65" name="__codelineno-5-65" href="#__codelineno-5-65"></a><span class="w">                    </span><span class="n">seg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ikcp_segment_new</span><span class="p">(</span><span class="n">kcp</span><span class="p">,</span><span class="w"> </span><span class="n">len</span><span class="p">);</span>
<a id="__codelineno-5-66" name="__codelineno-5-66" href="#__codelineno-5-66"></a><span class="w">                    </span><span class="n">seg</span><span class="o">-&gt;</span><span class="n">conv</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">conv</span><span class="p">;</span>
<a id="__codelineno-5-67" name="__codelineno-5-67" href="#__codelineno-5-67"></a><span class="w">                    </span><span class="n">seg</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cmd</span><span class="p">;</span>
<a id="__codelineno-5-68" name="__codelineno-5-68" href="#__codelineno-5-68"></a><span class="w">                    </span><span class="n">seg</span><span class="o">-&gt;</span><span class="n">frg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">frg</span><span class="p">;</span>
<a id="__codelineno-5-69" name="__codelineno-5-69" href="#__codelineno-5-69"></a><span class="w">                    </span><span class="n">seg</span><span class="o">-&gt;</span><span class="n">wnd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">wnd</span><span class="p">;</span>
<a id="__codelineno-5-70" name="__codelineno-5-70" href="#__codelineno-5-70"></a><span class="w">                    </span><span class="n">seg</span><span class="o">-&gt;</span><span class="n">ts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ts</span><span class="p">;</span>
<a id="__codelineno-5-71" name="__codelineno-5-71" href="#__codelineno-5-71"></a><span class="w">                    </span><span class="n">seg</span><span class="o">-&gt;</span><span class="n">sn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sn</span><span class="p">;</span>
<a id="__codelineno-5-72" name="__codelineno-5-72" href="#__codelineno-5-72"></a><span class="w">                    </span><span class="n">seg</span><span class="o">-&gt;</span><span class="n">una</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">una</span><span class="p">;</span>
<a id="__codelineno-5-73" name="__codelineno-5-73" href="#__codelineno-5-73"></a><span class="w">                    </span><span class="n">seg</span><span class="o">-&gt;</span><span class="n">len</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">len</span><span class="p">;</span>
<a id="__codelineno-5-74" name="__codelineno-5-74" href="#__codelineno-5-74"></a>
<a id="__codelineno-5-75" name="__codelineno-5-75" href="#__codelineno-5-75"></a><span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">len</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-5-76" name="__codelineno-5-76" href="#__codelineno-5-76"></a><span class="w">                        </span><span class="n">memcpy</span><span class="p">(</span><span class="n">seg</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="n">len</span><span class="p">);</span>
<a id="__codelineno-5-77" name="__codelineno-5-77" href="#__codelineno-5-77"></a><span class="w">                    </span><span class="p">}</span>
<a id="__codelineno-5-78" name="__codelineno-5-78" href="#__codelineno-5-78"></a>
<a id="__codelineno-5-79" name="__codelineno-5-79" href="#__codelineno-5-79"></a><span class="w">                    </span><span class="n">ikcp_parse_data</span><span class="p">(</span><span class="n">kcp</span><span class="p">,</span><span class="w"> </span><span class="n">seg</span><span class="p">);</span>
<a id="__codelineno-5-80" name="__codelineno-5-80" href="#__codelineno-5-80"></a><span class="w">                </span><span class="p">}</span>
<a id="__codelineno-5-81" name="__codelineno-5-81" href="#__codelineno-5-81"></a><span class="w">            </span><span class="p">}</span>
<a id="__codelineno-5-82" name="__codelineno-5-82" href="#__codelineno-5-82"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-5-83" name="__codelineno-5-83" href="#__codelineno-5-83"></a><span class="w">        </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">cmd</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">IKCP_CMD_WASK</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-5-84" name="__codelineno-5-84" href="#__codelineno-5-84"></a><span class="c1">// التحقق من نافذة الحزم</span>
<a id="__codelineno-5-85" name="__codelineno-5-85" href="#__codelineno-5-85"></a><span class="w">            </span><span class="c1">// ...</span>
<a id="__codelineno-5-86" name="__codelineno-5-86" href="#__codelineno-5-86"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-5-87" name="__codelineno-5-87" href="#__codelineno-5-87"></a><span class="w">        </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">cmd</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">IKCP_CMD_WINS</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-5-88" name="__codelineno-5-88" href="#__codelineno-5-88"></a><span class="c1">// رد نافذة الاستعلام</span>
<a id="__codelineno-5-89" name="__codelineno-5-89" href="#__codelineno-5-89"></a><span class="w">            </span><span class="c1">// ...</span>
<a id="__codelineno-5-90" name="__codelineno-5-90" href="#__codelineno-5-90"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-5-91" name="__codelineno-5-91" href="#__codelineno-5-91"></a><span class="w">        </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-5-92" name="__codelineno-5-92" href="#__codelineno-5-92"></a><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="mi">-3</span><span class="p">;</span>
<a id="__codelineno-5-93" name="__codelineno-5-93" href="#__codelineno-5-93"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-5-94" name="__codelineno-5-94" href="#__codelineno-5-94"></a>
<a id="__codelineno-5-95" name="__codelineno-5-95" href="#__codelineno-5-95"></a><span class="w">        </span><span class="n">data</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">len</span><span class="p">;</span>
<a id="__codelineno-5-96" name="__codelineno-5-96" href="#__codelineno-5-96"></a><span class="w">        </span><span class="n">size</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="n">len</span><span class="p">;</span>
<a id="__codelineno-5-97" name="__codelineno-5-97" href="#__codelineno-5-97"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-5-98" name="__codelineno-5-98" href="#__codelineno-5-98"></a>
<a id="__codelineno-5-99" name="__codelineno-5-99" href="#__codelineno-5-99"></a><span class="n">معالجة</span><span class="w"> </span><span class="n">منطقية</span><span class="w"> </span><span class="n">إعادة</span><span class="w"> </span><span class="n">الإرسال</span><span class="w"> </span><span class="n">السريع</span>
<a id="__codelineno-5-100" name="__codelineno-5-100" href="#__codelineno-5-100"></a><span class="w">    </span><span class="c1">// ...</span>
<a id="__codelineno-5-101" name="__codelineno-5-101" href="#__codelineno-5-101"></a>
<a id="__codelineno-5-102" name="__codelineno-5-102" href="#__codelineno-5-102"></a><span class="n">تحديث</span><span class="w"> </span><span class="n">نافذة</span><span class="w"> </span><span class="n">الإرسال</span>
<a id="__codelineno-5-103" name="__codelineno-5-103" href="#__codelineno-5-103"></a><span class="w">    </span><span class="c1">// ...</span>
<a id="__codelineno-5-104" name="__codelineno-5-104" href="#__codelineno-5-104"></a>
<a id="__codelineno-5-105" name="__codelineno-5-105" href="#__codelineno-5-105"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="__codelineno-5-106" name="__codelineno-5-106" href="#__codelineno-5-106"></a><span class="p">}</span>
</code></pre></div>
</details>

<p><code>ikcp_input</code> یعالج كل حزمة <code>SEG</code> بشكل دوري، يتحقق أولاً من صحة البيانات ونوع الحزمة، لأن كل حزمة بيانات تحمل <code>una</code>، التي تحتوي على رقم تسلسلي للحزمة التي ينبغي على المرسل انتظار استلامها، عليه أن تكون الحزم التي يحتاج الطرف الآخر استلامها قبل <code>una</code> قد تم استقبالها بنجاح، لذا يمكن حذف الحزم التي تحتاج إلى أن تكون قبل <code>una</code> من <code>snd_buff</code> وتحديث <code>snd_nxt</code>، وتتم هذه العملية بواسطة <code>ikcp_parse_una</code> و <code>ikcp_shrink_buf</code>. كل حزمة بيانات تصل يجب الرد عليها بحزمة ACK، وتُسجّل بواسطة <code>ikcp_ack_push</code>، وأخيرًا يتم استدعاء <code>ikcp_parse_data</code> لمعالجة البيانات.</p>
<details>
<summary> تحليل البيانات (انقر لعرض الشيفرة) </summary>
<div class="language-cpp highlight"><pre><span></span><code><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a><span class="kt">void</span><span class="w"> </span><span class="nf">ikcp_parse_data</span><span class="p">(</span><span class="n">ikcpcb</span><span class="w"> </span><span class="o">*</span><span class="n">kcp</span><span class="p">,</span><span class="w"> </span><span class="n">IKCPSEG</span><span class="w"> </span><span class="o">*</span><span class="n">newseg</span><span class="p">)</span>
<a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a><span class="p">{</span>
<a id="__codelineno-6-3" name="__codelineno-6-3" href="#__codelineno-6-3"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">IQUEUEHEAD</span><span class="w"> </span><span class="o">*</span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">prev</span><span class="p">;</span>
<a id="__codelineno-6-4" name="__codelineno-6-4" href="#__codelineno-6-4"></a><span class="w">    </span><span class="n">IUINT32</span><span class="w"> </span><span class="n">sn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">newseg</span><span class="o">-&gt;</span><span class="n">sn</span><span class="p">;</span>
<a id="__codelineno-6-5" name="__codelineno-6-5" href="#__codelineno-6-5"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">repeat</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="__codelineno-6-6" name="__codelineno-6-6" href="#__codelineno-6-6"></a>
<a id="__codelineno-6-7" name="__codelineno-6-7" href="#__codelineno-6-7"></a><span class="c1">// التحقق من الرقم التسلسلي</span>
<a id="__codelineno-6-8" name="__codelineno-6-8" href="#__codelineno-6-8"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">_itimediff</span><span class="p">(</span><span class="n">sn</span><span class="p">,</span><span class="w"> </span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">rcv_nxt</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">rcv_wnd</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">||</span>
<a id="__codelineno-6-9" name="__codelineno-6-9" href="#__codelineno-6-9"></a><span class="w">        </span><span class="n">_itimediff</span><span class="p">(</span><span class="n">sn</span><span class="p">,</span><span class="w"> </span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">rcv_nxt</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-6-10" name="__codelineno-6-10" href="#__codelineno-6-10"></a><span class="w">        </span><span class="n">ikcp_segment_delete</span><span class="p">(</span><span class="n">kcp</span><span class="p">,</span><span class="w"> </span><span class="n">newseg</span><span class="p">);</span>
<a id="__codelineno-6-11" name="__codelineno-6-11" href="#__codelineno-6-11"></a><span class="w">        </span><span class="k">return</span><span class="p">;</span>
<a id="__codelineno-6-12" name="__codelineno-6-12" href="#__codelineno-6-12"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-6-13" name="__codelineno-6-13" href="#__codelineno-6-13"></a>
<a id="__codelineno-6-14" name="__codelineno-6-14" href="#__codelineno-6-14"></a><span class="n">العثور</span><span class="w"> </span><span class="n">على</span><span class="w"> </span><span class="n">الموقع</span><span class="w"> </span><span class="n">الصحيح</span><span class="w"> </span><span class="n">لـ</span><span class="w"> </span><span class="n">newseg</span><span class="err">،</span><span class="w"> </span><span class="n">لأن</span><span class="w"> </span><span class="n">seg</span><span class="w"> </span><span class="n">الوارد</span><span class="w"> </span><span class="n">قد</span><span class="w"> </span><span class="n">يكون</span><span class="w"> </span><span class="n">غير</span><span class="w"> </span><span class="n">مرتب</span><span class="w"> </span><span class="n">بالتسلسل</span><span class="w"> </span><span class="n">الصحيح</span><span class="p">.</span>
<a id="__codelineno-6-15" name="__codelineno-6-15" href="#__codelineno-6-15"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">rcv_buf</span><span class="p">.</span><span class="n">prev</span><span class="p">;</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">rcv_buf</span><span class="p">;</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">prev</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-6-16" name="__codelineno-6-16" href="#__codelineno-6-16"></a><span class="w">        </span><span class="n">IKCPSEG</span><span class="w"> </span><span class="o">*</span><span class="n">seg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iqueue_entry</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="n">IKCPSEG</span><span class="p">,</span><span class="w"> </span><span class="n">node</span><span class="p">);</span>
<a id="__codelineno-6-17" name="__codelineno-6-17" href="#__codelineno-6-17"></a><span class="w">        </span><span class="n">prev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">p</span><span class="o">-&gt;</span><span class="n">prev</span><span class="p">;</span>
<a id="__codelineno-6-18" name="__codelineno-6-18" href="#__codelineno-6-18"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">seg</span><span class="o">-&gt;</span><span class="n">sn</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">sn</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-6-19" name="__codelineno-6-19" href="#__codelineno-6-19"></a><span class="n">من</span><span class="w"> </span><span class="n">فضلك</span><span class="err">،</span><span class="w"> </span><span class="n">قد</span><span class="w"> </span><span class="n">يكون</span><span class="w"> </span><span class="n">التصريح</span><span class="w"> </span><span class="n">غير</span><span class="w"> </span><span class="n">واضح</span><span class="err">،</span><span class="w"> </span><span class="n">ي</span><span class="err">ُ</span><span class="n">رجى</span><span class="w"> </span><span class="n">تقديم</span><span class="w"> </span><span class="n">سياق</span><span class="w"> </span><span class="n">إضافي</span><span class="p">.</span>
<a id="__codelineno-6-20" name="__codelineno-6-20" href="#__codelineno-6-20"></a><span class="w">            </span><span class="n">repeat</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<a id="__codelineno-6-21" name="__codelineno-6-21" href="#__codelineno-6-21"></a><span class="w">            </span><span class="k">break</span><span class="p">;</span>
<a id="__codelineno-6-22" name="__codelineno-6-22" href="#__codelineno-6-22"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-6-23" name="__codelineno-6-23" href="#__codelineno-6-23"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">_itimediff</span><span class="p">(</span><span class="n">sn</span><span class="p">,</span><span class="w"> </span><span class="n">seg</span><span class="o">-&gt;</span><span class="n">sn</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-6-24" name="__codelineno-6-24" href="#__codelineno-6-24"></a><span class="w">            </span><span class="k">break</span><span class="p">;</span>
<a id="__codelineno-6-25" name="__codelineno-6-25" href="#__codelineno-6-25"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-6-26" name="__codelineno-6-26" href="#__codelineno-6-26"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-6-27" name="__codelineno-6-27" href="#__codelineno-6-27"></a>
<a id="__codelineno-6-28" name="__codelineno-6-28" href="#__codelineno-6-28"></a><span class="n">وضع</span><span class="w"> </span><span class="n">newseg</span><span class="w"> </span><span class="n">في</span><span class="w"> </span><span class="n">مكانه</span><span class="w"> </span><span class="n">الصحيح</span><span class="w"> </span><span class="n">داخل</span><span class="w"> </span><span class="n">rcv_buf</span>
<a id="__codelineno-6-29" name="__codelineno-6-29" href="#__codelineno-6-29"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">repeat</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-6-30" name="__codelineno-6-30" href="#__codelineno-6-30"></a><span class="w">        </span><span class="n">iqueue_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">newseg</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">);</span>
<a id="__codelineno-6-31" name="__codelineno-6-31" href="#__codelineno-6-31"></a><span class="w">        </span><span class="n">iqueue_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">newseg</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="p">);</span>
<a id="__codelineno-6-32" name="__codelineno-6-32" href="#__codelineno-6-32"></a><span class="w">        </span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">nrcv_buf</span><span class="o">++</span><span class="p">;</span>
<a id="__codelineno-6-33" name="__codelineno-6-33" href="#__codelineno-6-33"></a><span class="w">    </span><span class="p">}</span><span class="w">    </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-6-34" name="__codelineno-6-34" href="#__codelineno-6-34"></a><span class="w">        </span><span class="n">ikcp_segment_delete</span><span class="p">(</span><span class="n">kcp</span><span class="p">,</span><span class="w"> </span><span class="n">newseg</span><span class="p">);</span>
<a id="__codelineno-6-35" name="__codelineno-6-35" href="#__codelineno-6-35"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-6-36" name="__codelineno-6-36" href="#__codelineno-6-36"></a>
<a id="__codelineno-6-37" name="__codelineno-6-37" href="#__codelineno-6-37"></a><span class="n">نقل</span><span class="w"> </span><span class="n">البيانات</span><span class="w"> </span><span class="n">من</span><span class="w"> </span><span class="n">rcv_buf</span><span class="w"> </span><span class="n">إلى</span><span class="w"> </span><span class="n">rcv_queue</span>
<a id="__codelineno-6-38" name="__codelineno-6-38" href="#__codelineno-6-38"></a><span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="w"> </span><span class="n">iqueue_is_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">rcv_buf</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-6-39" name="__codelineno-6-39" href="#__codelineno-6-39"></a><span class="w">        </span><span class="n">IKCPSEG</span><span class="w"> </span><span class="o">*</span><span class="n">seg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iqueue_entry</span><span class="p">(</span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">rcv_buf</span><span class="p">.</span><span class="n">next</span><span class="p">,</span><span class="w"> </span><span class="n">IKCPSEG</span><span class="p">,</span><span class="w"> </span><span class="n">node</span><span class="p">);</span>
<a id="__codelineno-6-40" name="__codelineno-6-40" href="#__codelineno-6-40"></a><span class="n">إذا</span><span class="w"> </span><span class="n">كان</span><span class="w"> </span><span class="n">رقم</span><span class="w"> </span><span class="n">seg</span><span class="w"> </span><span class="n">هو</span><span class="w"> </span><span class="n">رقم</span><span class="w"> </span><span class="n">الانتظار</span><span class="w"> </span><span class="n">للتلقي</span><span class="err">،</span><span class="w"> </span><span class="n">قم</span><span class="w"> </span><span class="n">بنقله</span><span class="w"> </span><span class="n">إلى</span><span class="w"> </span><span class="n">قائمة</span><span class="w"> </span><span class="n">الاستقبال</span><span class="p">.</span>
<a id="__codelineno-6-41" name="__codelineno-6-41" href="#__codelineno-6-41"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">seg</span><span class="o">-&gt;</span><span class="n">sn</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">rcv_nxt</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">nrcv_que</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">rcv_wnd</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-6-42" name="__codelineno-6-42" href="#__codelineno-6-42"></a><span class="w">            </span><span class="n">iqueue_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">seg</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">);</span>
<a id="__codelineno-6-43" name="__codelineno-6-43" href="#__codelineno-6-43"></a><span class="w">            </span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">nrcv_buf</span><span class="o">--</span><span class="p">;</span>
<a id="__codelineno-6-44" name="__codelineno-6-44" href="#__codelineno-6-44"></a><span class="w">            </span><span class="n">iqueue_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">seg</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">rcv_queue</span><span class="p">);</span>
<a id="__codelineno-6-45" name="__codelineno-6-45" href="#__codelineno-6-45"></a><span class="w">            </span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">nrcv_que</span><span class="o">++</span><span class="p">;</span>
<a id="__codelineno-6-46" name="__codelineno-6-46" href="#__codelineno-6-46"></a><span class="w">            </span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">rcv_nxt</span><span class="o">++</span><span class="p">;</span>
<a id="__codelineno-6-47" name="__codelineno-6-47" href="#__codelineno-6-47"></a><span class="w">        </span><span class="p">}</span><span class="w">    </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-6-48" name="__codelineno-6-48" href="#__codelineno-6-48"></a><span class="w">            </span><span class="k">break</span><span class="p">;</span>
<a id="__codelineno-6-49" name="__codelineno-6-49" href="#__codelineno-6-49"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-6-50" name="__codelineno-6-50" href="#__codelineno-6-50"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-6-51" name="__codelineno-6-51" href="#__codelineno-6-51"></a><span class="p">}</span>
</code></pre></div>
</details>

<p>وظيفة <code>ikcp_parse_data</code> الرئيسية هي وضع <code>newseg</code> في موضع مناسب في <code>kcp-&gt;rcv_buf</code> ونقل البيانات من <code>rcv_buf</code> إلى <code>rcv_queue</code>. الموضع المناسب في <code>rcv_buf</code> يعني أن <code>rcv_buf</code> مرتب بترتيب تصاعدي حسب <code>sn</code> ويحتاج <code>newseg</code> إلى البحث عن موضع مناسب بناءً على حجم <code>sn</code> الخاص به. يجب نقل البيانات الموجودة على <code>rcv_buf</code> إلى <code>rcv_queue</code> شريطة أن يكون رقم حزمة البيانات على <code>rcv_buf</code> مساويًا لرقم حزمة البيانات التي ينتظر KCP تلقيها <code>kcp-&gt;rcv_nxt</code>، بعد نقل حزمة بيانات، يجب تحديث <code>kcp-&gt;rcv_nxt</code> ومن ثم معالجة الحزمة البيانات التالية.</p>
<p>بعد <code>ikcp_input</code>، عند استدعاء الطبقة العلوية لـ <code>ikcp_update</code> سيتم إرسال حزمة ACK، وعند استدعاء <code>ikcp_recv</code> ستُعاد البيانات الصحيحة للطبقة العلوية. <code>ikcp_update</code> و<code>ikcp_recv</code> مستقلّتان تماما، لا توجد متطلبات لترتيب الاستدعاء، بل تعتمد على توقيت الاستدعاء من الطبقة العلوية. دعنا ننظر أولاً إلى الجزء المتعلق بإرسال ACK داخل <code>ikcp_update</code>:</p>
<details>
&lt;ملخص&gt; الرد على ACK (انقر لعرض الكود) ملخص&gt;
<div class="language-cpp highlight"><pre><span></span><code><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a><span class="n">تم</span><span class="w"> </span><span class="n">ذكره</span><span class="w"> </span><span class="n">سابق</span><span class="err">ً</span><span class="n">ا</span><span class="w"> </span><span class="n">أن</span><span class="w"> </span><span class="n">ikcp_update</span><span class="w"> </span><span class="n">يقوم</span><span class="w"> </span><span class="n">في</span><span class="w"> </span><span class="n">النهاية</span><span class="w"> </span><span class="n">باستدعاء</span><span class="w"> </span><span class="n">ikcp_flush</span><span class="p">.</span>
<a id="__codelineno-7-2" name="__codelineno-7-2" href="#__codelineno-7-2"></a><span class="kt">void</span><span class="w"> </span><span class="n">ikcp_flush</span><span class="p">(</span><span class="n">ikcpcb</span><span class="w"> </span><span class="o">*</span><span class="n">kcp</span><span class="p">,</span><span class="w"> </span><span class="n">IUINT32</span><span class="w"> </span><span class="n">current</span><span class="p">)</span>
<a id="__codelineno-7-3" name="__codelineno-7-3" href="#__codelineno-7-3"></a><span class="p">{</span>
<a id="__codelineno-7-4" name="__codelineno-7-4" href="#__codelineno-7-4"></a><span class="w">    </span><span class="c1">// ...</span>
<a id="__codelineno-7-5" name="__codelineno-7-5" href="#__codelineno-7-5"></a>
<a id="__codelineno-7-6" name="__codelineno-7-6" href="#__codelineno-7-6"></a><span class="c1">// الرد على حزمة ACK</span>
<a id="__codelineno-7-7" name="__codelineno-7-7" href="#__codelineno-7-7"></a><span class="w">    </span><span class="n">count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">ackcount</span><span class="p">;</span>
<a id="__codelineno-7-8" name="__codelineno-7-8" href="#__codelineno-7-8"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">count</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-7-9" name="__codelineno-7-9" href="#__codelineno-7-9"></a><span class="w">        </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="n">ptr</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">buffer</span><span class="p">);</span>
<a id="__codelineno-7-10" name="__codelineno-7-10" href="#__codelineno-7-10"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">size</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">IKCP_OVERHEAD</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">mtu</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-7-11" name="__codelineno-7-11" href="#__codelineno-7-11"></a><span class="w">            </span><span class="n">ikcp_output</span><span class="p">(</span><span class="n">kcp</span><span class="p">,</span><span class="w"> </span><span class="n">buffer</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="p">);</span>
<a id="__codelineno-7-12" name="__codelineno-7-12" href="#__codelineno-7-12"></a><span class="w">            </span><span class="n">ptr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">buffer</span><span class="p">;</span>
<a id="__codelineno-7-13" name="__codelineno-7-13" href="#__codelineno-7-13"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-7-14" name="__codelineno-7-14" href="#__codelineno-7-14"></a><span class="w">        </span><span class="n">ikcp_ack_get</span><span class="p">(</span><span class="n">kcp</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">seg</span><span class="p">.</span><span class="n">sn</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">seg</span><span class="p">.</span><span class="n">ts</span><span class="p">);</span>
<a id="__codelineno-7-15" name="__codelineno-7-15" href="#__codelineno-7-15"></a><span class="w">        </span><span class="n">ptr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ikcp_encode_seg</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">seg</span><span class="p">);</span>
<a id="__codelineno-7-16" name="__codelineno-7-16" href="#__codelineno-7-16"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-7-17" name="__codelineno-7-17" href="#__codelineno-7-17"></a>
<a id="__codelineno-7-18" name="__codelineno-7-18" href="#__codelineno-7-18"></a><span class="w">    </span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">ackcount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="__codelineno-7-19" name="__codelineno-7-19" href="#__codelineno-7-19"></a>
<a id="__codelineno-7-20" name="__codelineno-7-20" href="#__codelineno-7-20"></a><span class="w">    </span><span class="c1">// ...</span>
<a id="__codelineno-7-21" name="__codelineno-7-21" href="#__codelineno-7-21"></a><span class="p">}</span>
</code></pre></div>
</details>

<p>تم حفظ حزم ACK مسبقًا بواسطة <code>ikcp_ack_push</code> ، لذا هنا يكفي استخدام <code>ikcp_ack_get</code> للحصول على معلومات كل حزمة ACK وإرسالها إلى الطرف الآخر. يمكن للطبقة العلوية استخدام <code>ikcp_recv</code> للحصول على البيانات من KCP:</p>
<details>
ikcp_recv（انقر لعرض الكود）
<div class="language-cpp highlight"><pre><span></span><code><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a><span class="c1">//---------------------------------------------------------------------</span>
<a id="__codelineno-8-2" name="__codelineno-8-2" href="#__codelineno-8-2"></a><span class="c1">// user/upper level recv: returns size, returns below zero for EAGAIN</span>
<a id="__codelineno-8-3" name="__codelineno-8-3" href="#__codelineno-8-3"></a><span class="c1">//---------------------------------------------------------------------</span>
<a id="__codelineno-8-4" name="__codelineno-8-4" href="#__codelineno-8-4"></a><span class="kt">int</span><span class="w"> </span><span class="nf">ikcp_recv</span><span class="p">(</span><span class="n">ikcpcb</span><span class="w"> </span><span class="o">*</span><span class="n">kcp</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">buffer</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">len</span><span class="p">)</span>
<a id="__codelineno-8-5" name="__codelineno-8-5" href="#__codelineno-8-5"></a><span class="p">{</span>
<a id="__codelineno-8-6" name="__codelineno-8-6" href="#__codelineno-8-6"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">IQUEUEHEAD</span><span class="w"> </span><span class="o">*</span><span class="n">p</span><span class="p">;</span>
<a id="__codelineno-8-7" name="__codelineno-8-7" href="#__codelineno-8-7"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">ispeek</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">len</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="o">?</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="__codelineno-8-8" name="__codelineno-8-8" href="#__codelineno-8-8"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">peeksize</span><span class="p">;</span>
<a id="__codelineno-8-9" name="__codelineno-8-9" href="#__codelineno-8-9"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">recover</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="__codelineno-8-10" name="__codelineno-8-10" href="#__codelineno-8-10"></a><span class="w">    </span><span class="n">IKCPSEG</span><span class="w"> </span><span class="o">*</span><span class="n">seg</span><span class="p">;</span>
<a id="__codelineno-8-11" name="__codelineno-8-11" href="#__codelineno-8-11"></a><span class="w">    </span><span class="n">assert</span><span class="p">(</span><span class="n">kcp</span><span class="p">);</span>
<a id="__codelineno-8-12" name="__codelineno-8-12" href="#__codelineno-8-12"></a>
<a id="__codelineno-8-13" name="__codelineno-8-13" href="#__codelineno-8-13"></a><span class="c1">// بعض الفحوصات الصحيحة</span>
<a id="__codelineno-8-14" name="__codelineno-8-14" href="#__codelineno-8-14"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">iqueue_is_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">rcv_queue</span><span class="p">))</span>
<a id="__codelineno-8-15" name="__codelineno-8-15" href="#__codelineno-8-15"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span>
<a id="__codelineno-8-16" name="__codelineno-8-16" href="#__codelineno-8-16"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">len</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="n">len</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="n">len</span><span class="p">;</span>
<a id="__codelineno-8-17" name="__codelineno-8-17" href="#__codelineno-8-17"></a>
<a id="__codelineno-8-18" name="__codelineno-8-18" href="#__codelineno-8-18"></a><span class="n">حساب</span><span class="w"> </span><span class="n">طول</span><span class="w"> </span><span class="n">البيانات</span><span class="w"> </span><span class="n">التي</span><span class="w"> </span><span class="n">يمكن</span><span class="w"> </span><span class="n">إرجاعها</span>
<a id="__codelineno-8-19" name="__codelineno-8-19" href="#__codelineno-8-19"></a><span class="w">    </span><span class="n">peeksize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ikcp_peeksize</span><span class="p">(</span><span class="n">kcp</span><span class="p">);</span>
<a id="__codelineno-8-20" name="__codelineno-8-20" href="#__codelineno-8-20"></a>
<a id="__codelineno-8-21" name="__codelineno-8-21" href="#__codelineno-8-21"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">peeksize</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-8-22" name="__codelineno-8-22" href="#__codelineno-8-22"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">-2</span><span class="p">;</span>
<a id="__codelineno-8-23" name="__codelineno-8-23" href="#__codelineno-8-23"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">peeksize</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">len</span><span class="p">)</span>
<a id="__codelineno-8-24" name="__codelineno-8-24" href="#__codelineno-8-24"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">-3</span><span class="p">;</span>
<a id="__codelineno-8-25" name="__codelineno-8-25" href="#__codelineno-8-25"></a>
<a id="__codelineno-8-26" name="__codelineno-8-26" href="#__codelineno-8-26"></a><span class="c1">// تحقق من نافذة الاستلام</span>
<a id="__codelineno-8-27" name="__codelineno-8-27" href="#__codelineno-8-27"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">nrcv_que</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">rcv_wnd</span><span class="p">)</span>
<a id="__codelineno-8-28" name="__codelineno-8-28" href="#__codelineno-8-28"></a><span class="w">        </span><span class="n">recover</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<a id="__codelineno-8-29" name="__codelineno-8-29" href="#__codelineno-8-29"></a>
<a id="__codelineno-8-30" name="__codelineno-8-30" href="#__codelineno-8-30"></a><span class="n">تجول</span><span class="w"> </span><span class="n">في</span><span class="w"> </span><span class="n">قائمة</span><span class="w"> </span><span class="n">rcv_queue</span><span class="w"> </span><span class="n">وانسخ</span><span class="w"> </span><span class="n">البيانات</span><span class="w"> </span><span class="n">إلى</span><span class="w"> </span><span class="n">الbuffer</span><span class="p">.</span>
<a id="__codelineno-8-31" name="__codelineno-8-31" href="#__codelineno-8-31"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">len</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">rcv_queue</span><span class="p">.</span><span class="n">next</span><span class="p">;</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">rcv_queue</span><span class="p">;</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-8-32" name="__codelineno-8-32" href="#__codelineno-8-32"></a><span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">fragment</span><span class="p">;</span>
<a id="__codelineno-8-33" name="__codelineno-8-33" href="#__codelineno-8-33"></a><span class="w">        </span><span class="n">seg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iqueue_entry</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="n">IKCPSEG</span><span class="p">,</span><span class="w"> </span><span class="n">node</span><span class="p">);</span>
<a id="__codelineno-8-34" name="__codelineno-8-34" href="#__codelineno-8-34"></a><span class="w">        </span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">p</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
<a id="__codelineno-8-35" name="__codelineno-8-35" href="#__codelineno-8-35"></a>
<a id="__codelineno-8-36" name="__codelineno-8-36" href="#__codelineno-8-36"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">buffer</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-8-37" name="__codelineno-8-37" href="#__codelineno-8-37"></a><span class="w">            </span><span class="n">memcpy</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span><span class="w"> </span><span class="n">seg</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="n">seg</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
<a id="__codelineno-8-38" name="__codelineno-8-38" href="#__codelineno-8-38"></a><span class="w">            </span><span class="n">buffer</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">seg</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
<a id="__codelineno-8-39" name="__codelineno-8-39" href="#__codelineno-8-39"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-8-40" name="__codelineno-8-40" href="#__codelineno-8-40"></a>
<a id="__codelineno-8-41" name="__codelineno-8-41" href="#__codelineno-8-41"></a><span class="w">        </span><span class="n">len</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">seg</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
<a id="__codelineno-8-42" name="__codelineno-8-42" href="#__codelineno-8-42"></a>
<a id="__codelineno-8-43" name="__codelineno-8-43" href="#__codelineno-8-43"></a><span class="c1">// التحقق من التقسيم</span>
<a id="__codelineno-8-44" name="__codelineno-8-44" href="#__codelineno-8-44"></a><span class="w">        </span><span class="n">fragment</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">seg</span><span class="o">-&gt;</span><span class="n">frg</span><span class="p">;</span>
<a id="__codelineno-8-45" name="__codelineno-8-45" href="#__codelineno-8-45"></a>
<a id="__codelineno-8-46" name="__codelineno-8-46" href="#__codelineno-8-46"></a><span class="n">قم</span><span class="w"> </span><span class="n">بإزالة</span><span class="w"> </span><span class="n">الحزمة</span><span class="w"> </span><span class="n">البيانية</span>
<a id="__codelineno-8-47" name="__codelineno-8-47" href="#__codelineno-8-47"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ispeek</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-8-48" name="__codelineno-8-48" href="#__codelineno-8-48"></a><span class="w">            </span><span class="n">iqueue_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">seg</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">);</span>
<a id="__codelineno-8-49" name="__codelineno-8-49" href="#__codelineno-8-49"></a><span class="w">            </span><span class="n">ikcp_segment_delete</span><span class="p">(</span><span class="n">kcp</span><span class="p">,</span><span class="w"> </span><span class="n">seg</span><span class="p">);</span>
<a id="__codelineno-8-50" name="__codelineno-8-50" href="#__codelineno-8-50"></a><span class="w">            </span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">nrcv_que</span><span class="o">--</span><span class="p">;</span>
<a id="__codelineno-8-51" name="__codelineno-8-51" href="#__codelineno-8-51"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-8-52" name="__codelineno-8-52" href="#__codelineno-8-52"></a>
<a id="__codelineno-8-53" name="__codelineno-8-53" href="#__codelineno-8-53"></a><span class="n">تم</span><span class="w"> </span><span class="n">نسخ</span><span class="w"> </span><span class="n">جميع</span><span class="w"> </span><span class="n">الحزم</span><span class="w"> </span><span class="n">الفرعية</span><span class="err">،</span><span class="w"> </span><span class="n">انسحب</span><span class="w"> </span><span class="n">من</span><span class="w"> </span><span class="n">الحلقة</span>
<a id="__codelineno-8-54" name="__codelineno-8-54" href="#__codelineno-8-54"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">fragment</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-8-55" name="__codelineno-8-55" href="#__codelineno-8-55"></a><span class="w">            </span><span class="k">break</span><span class="p">;</span>
<a id="__codelineno-8-56" name="__codelineno-8-56" href="#__codelineno-8-56"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-8-57" name="__codelineno-8-57" href="#__codelineno-8-57"></a>
<a id="__codelineno-8-58" name="__codelineno-8-58" href="#__codelineno-8-58"></a><span class="w">    </span><span class="n">assert</span><span class="p">(</span><span class="n">len</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">peeksize</span><span class="p">);</span>
<a id="__codelineno-8-59" name="__codelineno-8-59" href="#__codelineno-8-59"></a>
<a id="__codelineno-8-60" name="__codelineno-8-60" href="#__codelineno-8-60"></a><span class="c1">// تم تفريغ rcv_queue قليلاً مرة أخرى، يتم محاولة الاستمرار في نقل البيانات من rcv_buf إلى rcv_queue</span>
<a id="__codelineno-8-61" name="__codelineno-8-61" href="#__codelineno-8-61"></a><span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="w"> </span><span class="n">iqueue_is_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">rcv_buf</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-8-62" name="__codelineno-8-62" href="#__codelineno-8-62"></a><span class="w">        </span><span class="n">seg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iqueue_entry</span><span class="p">(</span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">rcv_buf</span><span class="p">.</span><span class="n">next</span><span class="p">,</span><span class="w"> </span><span class="n">IKCPSEG</span><span class="p">,</span><span class="w"> </span><span class="n">node</span><span class="p">);</span>
<a id="__codelineno-8-63" name="__codelineno-8-63" href="#__codelineno-8-63"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">seg</span><span class="o">-&gt;</span><span class="n">sn</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">rcv_nxt</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">nrcv_que</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">rcv_wnd</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-8-64" name="__codelineno-8-64" href="#__codelineno-8-64"></a><span class="w">            </span><span class="n">iqueue_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">seg</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">);</span>
<a id="__codelineno-8-65" name="__codelineno-8-65" href="#__codelineno-8-65"></a><span class="w">            </span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">nrcv_buf</span><span class="o">--</span><span class="p">;</span>
<a id="__codelineno-8-66" name="__codelineno-8-66" href="#__codelineno-8-66"></a><span class="w">            </span><span class="n">iqueue_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">seg</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">rcv_queue</span><span class="p">);</span>
<a id="__codelineno-8-67" name="__codelineno-8-67" href="#__codelineno-8-67"></a><span class="w">            </span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">nrcv_que</span><span class="o">++</span><span class="p">;</span>
<a id="__codelineno-8-68" name="__codelineno-8-68" href="#__codelineno-8-68"></a><span class="w">            </span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">rcv_nxt</span><span class="o">++</span><span class="p">;</span>
<a id="__codelineno-8-69" name="__codelineno-8-69" href="#__codelineno-8-69"></a><span class="w">        </span><span class="p">}</span><span class="w">    </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-8-70" name="__codelineno-8-70" href="#__codelineno-8-70"></a><span class="w">            </span><span class="k">break</span><span class="p">;</span>
<a id="__codelineno-8-71" name="__codelineno-8-71" href="#__codelineno-8-71"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-8-72" name="__codelineno-8-72" href="#__codelineno-8-72"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-8-73" name="__codelineno-8-73" href="#__codelineno-8-73"></a>
<a id="__codelineno-8-74" name="__codelineno-8-74" href="#__codelineno-8-74"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">len</span><span class="p">;</span>
<a id="__codelineno-8-75" name="__codelineno-8-75" href="#__codelineno-8-75"></a><span class="p">}</span>
</code></pre></div>
</details>

<p><code>ikcp_recv</code> ستُعيد مرة واحدة فقط حزمة بيانات كاملة ، يمكن للطبقة العلوية استدعاء دالة حلقياً حتى لا توجد بيانات تعود ، المنطقية للدالة بسيطة نوعًا ما ، حيث تقوم بنسخ البيانات من <code>rcv_queue</code> إلى <code>buffer</code> الذي تم تمريره من قبل الطبقة العلوية ، وبهذا تكون الجهة العايدة قد أنهت معالجة البيانات التي تلقتها.</p>
<p>عندما يقوم جهة الاستقبال بمعالجة حزمة البيانات، يُرسل إلى الجهة المرسلة حزمة تأكيد (ACK)، لنلق نظرة أخرى على كيفية استقبال الجهة المرسلة حزمة الـACK.</p>
<details>
&lt;ملخص&gt; معالجة حزمة ACK (انقر لعرض الرمز) ملخص&gt;
<div class="language-cpp highlight"><pre><span></span><code><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a><span class="kt">int</span><span class="w"> </span><span class="nf">ikcp_input</span><span class="p">(</span><span class="n">ikcpcb</span><span class="w"> </span><span class="o">*</span><span class="n">kcp</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">size</span><span class="p">)</span>
<a id="__codelineno-9-2" name="__codelineno-9-2" href="#__codelineno-9-2"></a><span class="p">{</span>
<a id="__codelineno-9-3" name="__codelineno-9-3" href="#__codelineno-9-3"></a><span class="w">    </span><span class="c1">// ...</span>
<a id="__codelineno-9-4" name="__codelineno-9-4" href="#__codelineno-9-4"></a><span class="w">    </span><span class="n">IUINT32</span><span class="w"> </span><span class="n">maxack</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">latest_ts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="__codelineno-9-5" name="__codelineno-9-5" href="#__codelineno-9-5"></a><span class="w">    </span><span class="c1">// ...</span>
<a id="__codelineno-9-6" name="__codelineno-9-6" href="#__codelineno-9-6"></a><span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-9-7" name="__codelineno-9-7" href="#__codelineno-9-7"></a><span class="w">        </span><span class="c1">// ...</span>
<a id="__codelineno-9-8" name="__codelineno-9-8" href="#__codelineno-9-8"></a><span class="c1">// ts يشير إلى kcp-&gt; current النقطة النهائية</span>
<a id="__codelineno-9-9" name="__codelineno-9-9" href="#__codelineno-9-9"></a><span class="w">        </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ikcp_decode32u</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">ts</span><span class="p">);</span>
<a id="__codelineno-9-10" name="__codelineno-9-10" href="#__codelineno-9-10"></a><span class="w">        </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ikcp_decode32u</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">sn</span><span class="p">);</span>
<a id="__codelineno-9-11" name="__codelineno-9-11" href="#__codelineno-9-11"></a>
<a id="__codelineno-9-12" name="__codelineno-9-12" href="#__codelineno-9-12"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">cmd</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">IKCP_CMD_ACK</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-9-13" name="__codelineno-9-13" href="#__codelineno-9-13"></a><span class="n">تحديث</span><span class="w"> </span><span class="n">rot</span>
<a id="__codelineno-9-14" name="__codelineno-9-14" href="#__codelineno-9-14"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">_itimediff</span><span class="p">(</span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">current</span><span class="p">,</span><span class="w"> </span><span class="n">ts</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-9-15" name="__codelineno-9-15" href="#__codelineno-9-15"></a><span class="w">                </span><span class="n">ikcp_update_ack</span><span class="p">(</span><span class="n">kcp</span><span class="p">,</span><span class="w"> </span><span class="n">_itimediff</span><span class="p">(</span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">current</span><span class="p">,</span><span class="w"> </span><span class="n">ts</span><span class="p">));</span>
<a id="__codelineno-9-16" name="__codelineno-9-16" href="#__codelineno-9-16"></a><span class="w">            </span><span class="p">}</span>
<a id="__codelineno-9-17" name="__codelineno-9-17" href="#__codelineno-9-17"></a><span class="n">تحديث</span><span class="w"> </span><span class="n">snd_buf</span>
<a id="__codelineno-9-18" name="__codelineno-9-18" href="#__codelineno-9-18"></a><span class="w">            </span><span class="n">ikcp_parse_ack</span><span class="p">(</span><span class="n">kcp</span><span class="p">,</span><span class="w"> </span><span class="n">sn</span><span class="p">);</span>
<a id="__codelineno-9-19" name="__codelineno-9-19" href="#__codelineno-9-19"></a><span class="w">            </span><span class="n">ikcp_shrink_buf</span><span class="p">(</span><span class="n">kcp</span><span class="p">);</span>
<a id="__codelineno-9-20" name="__codelineno-9-20" href="#__codelineno-9-20"></a>
<a id="__codelineno-9-21" name="__codelineno-9-21" href="#__codelineno-9-21"></a><span class="n">maxack</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">أكبر</span><span class="w"> </span><span class="n">رقم</span><span class="w"> </span><span class="n">متسلسل</span><span class="w"> </span><span class="n">في</span><span class="w"> </span><span class="n">جميع</span><span class="w"> </span><span class="n">حزم</span><span class="w"> </span><span class="n">ACK</span><span class="w"> </span><span class="n">لهذا</span><span class="w"> </span><span class="n">المدخل</span>
<a id="__codelineno-9-22" name="__codelineno-9-22" href="#__codelineno-9-22"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">flag</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-9-23" name="__codelineno-9-23" href="#__codelineno-9-23"></a><span class="w">                </span><span class="n">flag</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<a id="__codelineno-9-24" name="__codelineno-9-24" href="#__codelineno-9-24"></a><span class="w">                </span><span class="n">maxack</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sn</span><span class="p">;</span>
<a id="__codelineno-9-25" name="__codelineno-9-25" href="#__codelineno-9-25"></a><span class="w">                </span><span class="n">latest_ts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ts</span><span class="p">;</span>
<a id="__codelineno-9-26" name="__codelineno-9-26" href="#__codelineno-9-26"></a><span class="w">            </span><span class="p">}</span><span class="w">    </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-9-27" name="__codelineno-9-27" href="#__codelineno-9-27"></a><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">_itimediff</span><span class="p">(</span><span class="n">sn</span><span class="p">,</span><span class="w"> </span><span class="n">maxack</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-9-28" name="__codelineno-9-28" href="#__codelineno-9-28"></a><span class="w">                </span><span class="cp">#ifndef IKCP_FASTACK_CONSERVE</span>
<a id="__codelineno-9-29" name="__codelineno-9-29" href="#__codelineno-9-29"></a><span class="w">                    </span><span class="n">maxack</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sn</span><span class="p">;</span>
<a id="__codelineno-9-30" name="__codelineno-9-30" href="#__codelineno-9-30"></a><span class="w">                    </span><span class="n">latest_ts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ts</span><span class="p">;</span>
<a id="__codelineno-9-31" name="__codelineno-9-31" href="#__codelineno-9-31"></a><span class="w">                </span><span class="cp">#else</span>
<a id="__codelineno-9-32" name="__codelineno-9-32" href="#__codelineno-9-32"></a><span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">_itimediff</span><span class="p">(</span><span class="n">ts</span><span class="p">,</span><span class="w"> </span><span class="n">latest_ts</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-9-33" name="__codelineno-9-33" href="#__codelineno-9-33"></a><span class="w">                        </span><span class="n">maxack</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sn</span><span class="p">;</span>
<a id="__codelineno-9-34" name="__codelineno-9-34" href="#__codelineno-9-34"></a><span class="w">                        </span><span class="n">latest_ts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ts</span><span class="p">;</span>
<a id="__codelineno-9-35" name="__codelineno-9-35" href="#__codelineno-9-35"></a><span class="w">                    </span><span class="p">}</span>
<a id="__codelineno-9-36" name="__codelineno-9-36" href="#__codelineno-9-36"></a><span class="w">                </span><span class="cp">#endif</span>
<a id="__codelineno-9-37" name="__codelineno-9-37" href="#__codelineno-9-37"></a><span class="w">                </span><span class="p">}</span>
<a id="__codelineno-9-38" name="__codelineno-9-38" href="#__codelineno-9-38"></a><span class="w">            </span><span class="p">}</span>
<a id="__codelineno-9-39" name="__codelineno-9-39" href="#__codelineno-9-39"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-9-40" name="__codelineno-9-40" href="#__codelineno-9-40"></a><span class="w">        </span><span class="c1">// ...</span>
<a id="__codelineno-9-41" name="__codelineno-9-41" href="#__codelineno-9-41"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-9-42" name="__codelineno-9-42" href="#__codelineno-9-42"></a>
<a id="__codelineno-9-43" name="__codelineno-9-43" href="#__codelineno-9-43"></a><span class="n">إذا</span><span class="w"> </span><span class="n">تم</span><span class="w"> </span><span class="n">استلام</span><span class="w"> </span><span class="n">حزمة</span><span class="w"> </span><span class="n">ACK</span><span class="err">،</span><span class="w"> </span><span class="n">سجلها</span><span class="w"> </span><span class="n">لاستخدامها</span><span class="w"> </span><span class="n">في</span><span class="w"> </span><span class="n">إعادة</span><span class="w"> </span><span class="n">الإرسال</span><span class="w"> </span><span class="n">السريع</span><span class="p">.</span>
<a id="__codelineno-9-44" name="__codelineno-9-44" href="#__codelineno-9-44"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">flag</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-9-45" name="__codelineno-9-45" href="#__codelineno-9-45"></a><span class="w">        </span><span class="n">ikcp_parse_fastack</span><span class="p">(</span><span class="n">kcp</span><span class="p">,</span><span class="w"> </span><span class="n">maxack</span><span class="p">,</span><span class="w"> </span><span class="n">latest_ts</span><span class="p">);</span>
<a id="__codelineno-9-46" name="__codelineno-9-46" href="#__codelineno-9-46"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-9-47" name="__codelineno-9-47" href="#__codelineno-9-47"></a><span class="p">}</span>
</code></pre></div>
</details>

<p>يمكن رؤية أنه بعد استلام حزمة ACK ، ستحتاج أيضًا إلى استخدام <code>ikcp_parse_ack</code> و <code>ikcp_shrink_buf</code> لتحديث <code>snd_buf</code> ، بالإضافة إلى استدعاء <code>ikcp_update_ack</code> لحساب تحديث rto (وقت تكرار الإرسال، مهلة إعادة الإرسال). <code>ikcp_input</code> يحسب أكبر رقم تسلسل في حزمة ACK المستلمة ، لتسجيله للاستخدام في الإرسال السريع للبيانات. وبهذه الطريقة ، عندما يستلم الطرف الإرسالي حزمة ACK ، يتمتع بإزالة البيانات المُرسلة من <code>snd_buf</code> ، حيث تصل البيانات بشكل موثوق إلى الطرف العامل ، وتنتهي عملية التأكيد الكاملة للاستقبال الآلي (ARQ).</p>
<h3 id="_3">إعادة الإرسال بعد تجاوز المهلة</h3>
<p>سيكون النص المترجم باللغة العربية كالتالي:</p>
<p>تم التعريف في السابق بآلية تأكيد الاستلام في ARQ التي تم تحقيقها بواسطة KCP، تتطلب ARQ أيضًا إعادة الإرسال بعد فترة محددة لضمان الموثوقية، والآن سنلقي نظرة على كيفية تنفيذ إعادة الإرسال بواسطة KCP.</p>
<p>دعونا نعود إلى دالة <code>ikcp_flush</code>.</p>
<details>
الملخص: إعادة الإرسال في حالة انتهاء المهلة (انقر لعرض الشيفرة)
<div class="language-cpp highlight"><pre><span></span><code><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a><span class="kt">void</span><span class="w"> </span><span class="nf">ikcp_flush</span><span class="p">(</span><span class="n">ikcpcb</span><span class="w"> </span><span class="o">*</span><span class="n">kcp</span><span class="p">)</span>
<a id="__codelineno-10-2" name="__codelineno-10-2" href="#__codelineno-10-2"></a><span class="p">{</span>
<a id="__codelineno-10-3" name="__codelineno-10-3" href="#__codelineno-10-3"></a><span class="w">    </span><span class="c1">// ...</span>
<a id="__codelineno-10-4" name="__codelineno-10-4" href="#__codelineno-10-4"></a><span class="c1">// إرسال snd_buf</span>
<a id="__codelineno-10-5" name="__codelineno-10-5" href="#__codelineno-10-5"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">snd_buf</span><span class="p">.</span><span class="n">next</span><span class="p">;</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">snd_buf</span><span class="p">;</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">p</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-10-6" name="__codelineno-10-6" href="#__codelineno-10-6"></a><span class="w">        </span><span class="n">IKCPSEG</span><span class="w"> </span><span class="o">*</span><span class="n">segment</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iqueue_entry</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="n">IKCPSEG</span><span class="p">,</span><span class="w"> </span><span class="n">node</span><span class="p">);</span>
<a id="__codelineno-10-7" name="__codelineno-10-7" href="#__codelineno-10-7"></a><span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">needsend</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="__codelineno-10-8" name="__codelineno-10-8" href="#__codelineno-10-8"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">segment</span><span class="o">-&gt;</span><span class="n">xmit</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-10-9" name="__codelineno-10-9" href="#__codelineno-10-9"></a><span class="c1">// الإرسال الأول</span>
<a id="__codelineno-10-10" name="__codelineno-10-10" href="#__codelineno-10-10"></a><span class="w">            </span><span class="n">needsend</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<a id="__codelineno-10-11" name="__codelineno-10-11" href="#__codelineno-10-11"></a><span class="w">            </span><span class="n">segment</span><span class="o">-&gt;</span><span class="n">xmit</span><span class="o">++</span><span class="p">;</span>
<a id="__codelineno-10-12" name="__codelineno-10-12" href="#__codelineno-10-12"></a><span class="n">قم</span><span class="w"> </span><span class="n">بتعيين</span><span class="w"> </span><span class="n">segment</span><span class="o">-&gt;</span><span class="n">rto</span>
<a id="__codelineno-10-13" name="__codelineno-10-13" href="#__codelineno-10-13"></a><span class="c1">// استنادًا إلى segment-&gt;rto ، يتم حساب وقت إعادة إرسال segment-&gt;resendts</span>
<a id="__codelineno-10-14" name="__codelineno-10-14" href="#__codelineno-10-14"></a><span class="w">            </span><span class="n">segment</span><span class="o">-&gt;</span><span class="n">rto</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">rx_rto</span><span class="p">;</span>
<a id="__codelineno-10-15" name="__codelineno-10-15" href="#__codelineno-10-15"></a><span class="w">            </span><span class="n">segment</span><span class="o">-&gt;</span><span class="n">resendts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">current</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">segment</span><span class="o">-&gt;</span><span class="n">rto</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">rtomin</span><span class="p">;</span>
<a id="__codelineno-10-16" name="__codelineno-10-16" href="#__codelineno-10-16"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-10-17" name="__codelineno-10-17" href="#__codelineno-10-17"></a><span class="w">        </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">_itimediff</span><span class="p">(</span><span class="n">current</span><span class="p">,</span><span class="w"> </span><span class="n">segment</span><span class="o">-&gt;</span><span class="n">resendts</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-10-18" name="__codelineno-10-18" href="#__codelineno-10-18"></a><span class="c1">// إعادة الإرسال بعد فترة من الانقطاع</span>
<a id="__codelineno-10-19" name="__codelineno-10-19" href="#__codelineno-10-19"></a><span class="w">            </span><span class="n">needsend</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<a id="__codelineno-10-20" name="__codelineno-10-20" href="#__codelineno-10-20"></a><span class="w">            </span><span class="n">segment</span><span class="o">-&gt;</span><span class="n">xmit</span><span class="o">++</span><span class="p">;</span>
<a id="__codelineno-10-21" name="__codelineno-10-21" href="#__codelineno-10-21"></a><span class="w">            </span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">xmit</span><span class="o">++</span><span class="p">;</span>
<a id="__codelineno-10-22" name="__codelineno-10-22" href="#__codelineno-10-22"></a><span class="n">تحكم</span><span class="w"> </span><span class="n">في</span><span class="w"> </span><span class="n">حساب</span><span class="w"> </span><span class="n">وقت</span><span class="w"> </span><span class="n">إعادة</span><span class="w"> </span><span class="n">النقل</span><span class="w"> </span><span class="n">المؤجل</span><span class="w"> </span><span class="n">للمرة</span><span class="w"> </span><span class="n">القادمة</span><span class="p">.</span>
<a id="__codelineno-10-23" name="__codelineno-10-23" href="#__codelineno-10-23"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">nodelay</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-10-24" name="__codelineno-10-24" href="#__codelineno-10-24"></a><span class="w">                </span><span class="n">segment</span><span class="o">-&gt;</span><span class="n">rto</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">rx_rto</span><span class="p">;</span>
<a id="__codelineno-10-25" name="__codelineno-10-25" href="#__codelineno-10-25"></a><span class="w">            </span><span class="p">}</span><span class="w">    </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-10-26" name="__codelineno-10-26" href="#__codelineno-10-26"></a><span class="w">                </span><span class="n">segment</span><span class="o">-&gt;</span><span class="n">rto</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">rx_rto</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span>
<a id="__codelineno-10-27" name="__codelineno-10-27" href="#__codelineno-10-27"></a><span class="w">            </span><span class="p">}</span>
<a id="__codelineno-10-28" name="__codelineno-10-28" href="#__codelineno-10-28"></a><span class="w">            </span><span class="n">segment</span><span class="o">-&gt;</span><span class="n">resendts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">current</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">segment</span><span class="o">-&gt;</span><span class="n">rto</span><span class="p">;</span>
<a id="__codelineno-10-29" name="__codelineno-10-29" href="#__codelineno-10-29"></a><span class="w">            </span><span class="n">lost</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<a id="__codelineno-10-30" name="__codelineno-10-30" href="#__codelineno-10-30"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-10-31" name="__codelineno-10-31" href="#__codelineno-10-31"></a><span class="w">        </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">segment</span><span class="o">-&gt;</span><span class="n">fastack</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">resent</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-10-32" name="__codelineno-10-32" href="#__codelineno-10-32"></a><span class="n">إعادة</span><span class="w"> </span><span class="n">النقل</span><span class="w"> </span><span class="n">السريع</span>
<a id="__codelineno-10-33" name="__codelineno-10-33" href="#__codelineno-10-33"></a><span class="w">            </span><span class="c1">// ...</span>
<a id="__codelineno-10-34" name="__codelineno-10-34" href="#__codelineno-10-34"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-10-35" name="__codelineno-10-35" href="#__codelineno-10-35"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">needsend</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-10-36" name="__codelineno-10-36" href="#__codelineno-10-36"></a><span class="n">إرسال</span><span class="w"> </span><span class="n">البيانات</span>
<a id="__codelineno-10-37" name="__codelineno-10-37" href="#__codelineno-10-37"></a><span class="w">            </span><span class="c1">// ...</span>
<a id="__codelineno-10-38" name="__codelineno-10-38" href="#__codelineno-10-38"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-10-39" name="__codelineno-10-39" href="#__codelineno-10-39"></a><span class="w">    </span><span class="c1">// ...</span>
<a id="__codelineno-10-40" name="__codelineno-10-40" href="#__codelineno-10-40"></a><span class="p">}</span>
</code></pre></div>
</details>

<p>بمجرد أن يكون الوقت الحالي أكبر من وقت الإعادة <code>segment-&gt;resendts</code>، يشير ذلك إلى أنه لم يتم استلام حزم ACK من الطرف الآخر خلال هذه الفترة الزمنية. في هذه الحالة، يتم تنشيط آلية إعادة الإرسال نتيجة لتجاوز الوقت المحدد، حيث تُعيد البيانات ويتم تعيين <code>needsend = 1</code>.</p>
<p>بعد توفير آلية التأكيد على الاستلام وإعادة الإرسال في حالة الانتهاء من الوقت، يمكن لبروتوكول KCP ضمان نقل البيانات الموثوق به بدعم قواعد البيانات الأساسية. ومن أجل الحفاظ على تدفق البيانات بشكل أسرع، قام KCP أيضًا بالعديد من التحسينات. دعنا نلقي نظرة على الطرق التي قام فيها KCP بتحسين الأداء.</p>
<h2 id="kcp_2">إستراتيجية زيادة سرعة التدفق لـ KCP</h2>
<h3 id="_4">إعادة النقل السريع</h3>
<p>يتلقى المرسل حزمتي بيانات بأرقام متسلسلة <code>sn</code> و<code>sn + 1</code>. إذا تم استلام حزمة ACK الخاصة بـ <code>sn + 1</code> فقط، فقد يكون ذلك بسبب عدم وصول حزمة ACK لـ <code>sn</code> إلى الشبكة بعد أو بسبب فقدان حزمة ACK، أو بسبب فقدان حزمة <code>sn</code>. في حال عدم انقضاء فترة إعادة البث بسبب عدم الوصول إلى الحد الأقصى للمهلة، وبسبب عدم اكتظاظ الشبكة بشكل كبير أيضًا، وإنما بسبب ظروف مفاجئة تؤدي إلى الفقد، فيمكن للمرسل أن يقوم بإرسال حزمة البيانات <code>sn</code> مبكرًا بشكل نشط. هذا يمكن أن يساعد في تسريع استلام البيانات من قبل الطرف الآخر وزيادة سرعة التدفق.</p>
<p>تم تنفيذ آلية إعادة الإرسال السريع داخل KCP، وهو ما يظهر أيضًا في <code>ikcp_flush</code>.</p>
<details>
<summary>إعادة النقل السريعة (انقر لعرض الكود)</summary>
<div class="language-cpp highlight"><pre><span></span><code><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a><span class="kt">void</span><span class="w"> </span><span class="nf">ikcp_flush</span><span class="p">(</span><span class="n">ikcpcb</span><span class="w"> </span><span class="o">*</span><span class="n">kcp</span><span class="p">)</span>
<a id="__codelineno-11-2" name="__codelineno-11-2" href="#__codelineno-11-2"></a><span class="p">{</span>
<a id="__codelineno-11-3" name="__codelineno-11-3" href="#__codelineno-11-3"></a><span class="w">    </span><span class="c1">// ...</span>
<a id="__codelineno-11-4" name="__codelineno-11-4" href="#__codelineno-11-4"></a><span class="w">    </span><span class="n">resent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">fastresend</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="o">?</span><span class="w"> </span><span class="p">(</span><span class="n">IUINT32</span><span class="p">)</span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">fastresend</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="mh">0xffffffff</span><span class="p">;</span>
<a id="__codelineno-11-5" name="__codelineno-11-5" href="#__codelineno-11-5"></a>
<a id="__codelineno-11-6" name="__codelineno-11-6" href="#__codelineno-11-6"></a><span class="c1">// إرسال snd_buf</span>
<a id="__codelineno-11-7" name="__codelineno-11-7" href="#__codelineno-11-7"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">snd_buf</span><span class="p">.</span><span class="n">next</span><span class="p">;</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">snd_buf</span><span class="p">;</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">p</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-11-8" name="__codelineno-11-8" href="#__codelineno-11-8"></a><span class="w">        </span><span class="n">IKCPSEG</span><span class="w"> </span><span class="o">*</span><span class="n">segment</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iqueue_entry</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="n">IKCPSEG</span><span class="p">,</span><span class="w"> </span><span class="n">node</span><span class="p">);</span>
<a id="__codelineno-11-9" name="__codelineno-11-9" href="#__codelineno-11-9"></a><span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">needsend</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="__codelineno-11-10" name="__codelineno-11-10" href="#__codelineno-11-10"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">segment</span><span class="o">-&gt;</span><span class="n">xmit</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-11-11" name="__codelineno-11-11" href="#__codelineno-11-11"></a><span class="w">            </span><span class="c1">// ...</span>
<a id="__codelineno-11-12" name="__codelineno-11-12" href="#__codelineno-11-12"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-11-13" name="__codelineno-11-13" href="#__codelineno-11-13"></a><span class="w">        </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">_itimediff</span><span class="p">(</span><span class="n">current</span><span class="p">,</span><span class="w"> </span><span class="n">segment</span><span class="o">-&gt;</span><span class="n">resendts</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-11-14" name="__codelineno-11-14" href="#__codelineno-11-14"></a><span class="w">            </span><span class="c1">// ...</span>
<a id="__codelineno-11-15" name="__codelineno-11-15" href="#__codelineno-11-15"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-11-16" name="__codelineno-11-16" href="#__codelineno-11-16"></a><span class="w">        </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">segment</span><span class="o">-&gt;</span><span class="n">fastack</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">resent</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-11-17" name="__codelineno-11-17" href="#__codelineno-11-17"></a><span class="n">إعادة</span><span class="w"> </span><span class="n">النقل</span><span class="w"> </span><span class="n">السريع</span>
<a id="__codelineno-11-18" name="__codelineno-11-18" href="#__codelineno-11-18"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="kt">int</span><span class="p">)</span><span class="n">segment</span><span class="o">-&gt;</span><span class="n">xmit</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">fastlimit</span><span class="w"> </span><span class="o">||</span>
<a id="__codelineno-11-19" name="__codelineno-11-19" href="#__codelineno-11-19"></a><span class="w">                </span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">fastlimit</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-11-20" name="__codelineno-11-20" href="#__codelineno-11-20"></a><span class="w">                </span><span class="n">needsend</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<a id="__codelineno-11-21" name="__codelineno-11-21" href="#__codelineno-11-21"></a><span class="w">                </span><span class="n">segment</span><span class="o">-&gt;</span><span class="n">xmit</span><span class="o">++</span><span class="p">;</span>
<a id="__codelineno-11-22" name="__codelineno-11-22" href="#__codelineno-11-22"></a><span class="w">                </span><span class="n">segment</span><span class="o">-&gt;</span><span class="n">fastack</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="__codelineno-11-23" name="__codelineno-11-23" href="#__codelineno-11-23"></a><span class="w">                </span><span class="n">segment</span><span class="o">-&gt;</span><span class="n">resendts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">current</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">segment</span><span class="o">-&gt;</span><span class="n">rto</span><span class="p">;</span>
<a id="__codelineno-11-24" name="__codelineno-11-24" href="#__codelineno-11-24"></a><span class="w">                </span><span class="n">change</span><span class="o">++</span><span class="p">;</span>
<a id="__codelineno-11-25" name="__codelineno-11-25" href="#__codelineno-11-25"></a><span class="w">            </span><span class="p">}</span>
<a id="__codelineno-11-26" name="__codelineno-11-26" href="#__codelineno-11-26"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-11-27" name="__codelineno-11-27" href="#__codelineno-11-27"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">needsend</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-11-28" name="__codelineno-11-28" href="#__codelineno-11-28"></a><span class="c1">// إرسال البيانات</span>
<a id="__codelineno-11-29" name="__codelineno-11-29" href="#__codelineno-11-29"></a><span class="w">            </span><span class="c1">// ...</span>
<a id="__codelineno-11-30" name="__codelineno-11-30" href="#__codelineno-11-30"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-11-31" name="__codelineno-11-31" href="#__codelineno-11-31"></a><span class="w">    </span><span class="c1">// ...</span>
<a id="__codelineno-11-32" name="__codelineno-11-32" href="#__codelineno-11-32"></a><span class="p">}</span>
</code></pre></div>
</details>

<p>يجب أن يتم إعادة النقل السريع في حالتين:
* <code>segment-&gt;fastack &gt;= resent</code>، resent هو معلم قابل للتكوين في <code>kcp-&gt;fastresend</code>، وتعيينه على القيمة 0 سيعطل الإعادة السريعة. تُعيَّن قيمة <code>segment-&gt;fastack</code> في دالة <code>ikcp_parse_fastack</code>، وهذه الدالة تُستدعى في <code>ikcp_input</code>، حيث يتم زيادتها بواحد لكافة الـ <code>segment-&gt;fastack</code> التي تقلقيم <code>sn</code> من <code>maxack</code> المحسوب في <code>ikcp_input</code>، وبالتالي، <code>segment-&gt;fastack</code> تمثل عدد المرات التي تم فيها استقبال باقات تحمل قيمة <code>sn</code> أكبر.
الشرط segment-&gt;xmit &lt;= kcp-&gt;fastlimit || kcp-&gt;fastlimit &lt;= 0 ، حيث أن setgment-&gt;xmit هو عدد مرات الإرسال، و kcp-&gt;fastlimit هو عدد مرات إعادة الإرسال السريع الأقصى الذي يمكن تكوينه، وعدد مرات الإرسال يجب أن يكون أقل من أقصى عدد مرات لإعادة الإرسال السريع</p>
<p>بمجرد توافر شروط إعادة النقل السريع، سيبدأ KCP في تنفيذ إعادة النقل السريع. يجب ملاحظة أن إعادة النقل السريع لن تعيد ضبط زمن إعادة النقل الزائد، سيظل الوقت الأصلي لإعادة النقل الزائد ساري المفعول.</p>
<h3 id="_5">تقليل وقت إعادة الإرسال في حالة تجاوز الوقت القصوى</h3>
<p>الإعادة بالتجاوز في حالة تجاوز الوقت هي آلية رائعة، ولكن تأخذ وقتًا طويلاً، وفقًا لاستراتيجية TCP، يتضاعف وقت الإعادة بالتجاوز في كل مرة، مما يؤدي إلى توسع سريع في وقت الانتظار. قد يحدث في غضون فترة الانتظار أن يكون نافذة الاستقبال بالجهة المستقبلة قد استنفذت، مما يجعلها غير قادرة على استقبال البيانات الجديدة، بينما تكون حزمة الإعادة بالتجاوز في أقصى الأمام، ويجب على الجهة المستقبلة تلقي الحزمة المعادة قبل استعادة جميع البيانات للطبقة العليا، وفي مثل هذه الحالة، يكاد تدفق الشبكة بأكمله يكون صفرًا تقريبًا. يقوم KCP بزيادة تكوينات يمكنها تباطؤ نمو وقت الانتظار، ولن يتم المضاعفة، من خلال تكوين 'kcp-&gt;nodelay' لمراقبة زيادة متعددة للمرة الواحدة فقط من RTO أو 0.5RTO، مما يقلل بشكل فعال من زيادة وقت الانتظار، ويساعد الشبكة على استعادة السرعة بسرعة.</p>
<h3 id="_6">تحديث نافذة الإرسال</h3>
<p>يشير نافذة الإرسال إلى عدد حزم البيانات التي تتم نقلها في نفس الوقت، كلما زادت النافذة، زاد عدد البيانات التي يتم نقلها في نفس الوقت وسرعة التدفق، ولكن عندما تكون النافذة كبيرة جدًا، قد تؤدي إلى اكتظاظ الشبكة، وزيادة معدل فقدان الحزم، وزيادة إعادة نقل البيانات، وانخفاض سرعة التدفق. لذلك، من الضروري تحديث نافذة الإرسال بناءً على الوضع الشبكي بشكل مستمر، والتقريب التدريجي إلى الأمثل. الشيفرة حول نافذة الإرسال في KCP:</p>
<details>
&lt;ملخص&gt; إرسال النافذة (انقر لعرض الشيفرة) ملخص&gt;
<div class="language-cpp highlight"><pre><span></span><code><a id="__codelineno-12-1" name="__codelineno-12-1" href="#__codelineno-12-1"></a><span class="n">ikcpcb</span><span class="o">*</span><span class="w"> </span><span class="nf">ikcp_create</span><span class="p">(</span><span class="n">IUINT32</span><span class="w"> </span><span class="n">conv</span><span class="p">,</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">user</span><span class="p">)</span>
<a id="__codelineno-12-2" name="__codelineno-12-2" href="#__codelineno-12-2"></a><span class="p">{</span>
<a id="__codelineno-12-3" name="__codelineno-12-3" href="#__codelineno-12-3"></a><span class="w">    </span><span class="c1">// ...</span>
<a id="__codelineno-12-4" name="__codelineno-12-4" href="#__codelineno-12-4"></a><span class="n">حجم</span><span class="w"> </span><span class="n">نافذة</span><span class="w"> </span><span class="n">الإرسال</span><span class="w"> </span><span class="n">والاستقبال</span><span class="w"> </span><span class="n">لحجم</span><span class="w"> </span><span class="n">البيانات</span><span class="w"> </span><span class="n">المخزنة</span>
<a id="__codelineno-12-5" name="__codelineno-12-5" href="#__codelineno-12-5"></a><span class="w">    </span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">snd_wnd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">IKCP_WND_SND</span><span class="p">;</span><span class="w">    </span><span class="c1">// 32</span>
<a id="__codelineno-12-6" name="__codelineno-12-6" href="#__codelineno-12-6"></a><span class="w">    </span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">rcv_wnd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">IKCP_WND_RCV</span><span class="p">;</span><span class="w">    </span><span class="c1">// 128</span>
<a id="__codelineno-12-7" name="__codelineno-12-7" href="#__codelineno-12-7"></a><span class="c1">// حجم نافذة الاستقبال على الجانب المستقبل           // 128</span>
<a id="__codelineno-12-8" name="__codelineno-12-8" href="#__codelineno-12-8"></a><span class="w">    </span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">rmt_wnd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">IKCP_WND_RCV</span>
<a id="__codelineno-12-9" name="__codelineno-12-9" href="#__codelineno-12-9"></a><span class="c1">// تهيئة نافذة الإرسال cwnd إلى القيمة 0</span>
<a id="__codelineno-12-10" name="__codelineno-12-10" href="#__codelineno-12-10"></a><span class="w">    </span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">cwnd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="__codelineno-12-11" name="__codelineno-12-11" href="#__codelineno-12-11"></a><span class="c1">// إرسال حجم بايت النافذة ، يستخدم في حساب cwnd</span>
<a id="__codelineno-12-12" name="__codelineno-12-12" href="#__codelineno-12-12"></a><span class="w">    </span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">incr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>
<a id="__codelineno-12-13" name="__codelineno-12-13" href="#__codelineno-12-13"></a><span class="c1">// عتبة بدء بطيء، حدّ التباطؤ في البداية</span>
<a id="__codelineno-12-14" name="__codelineno-12-14" href="#__codelineno-12-14"></a><span class="w">    </span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">ssthresh</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">IKCP_THRESH_INIT</span><span class="p">;</span>
<a id="__codelineno-12-15" name="__codelineno-12-15" href="#__codelineno-12-15"></a><span class="c1">// nocwnd هو معلمة قابل للتكوين ، 1 لا ينظر إلى cwnd</span>
<a id="__codelineno-12-16" name="__codelineno-12-16" href="#__codelineno-12-16"></a><span class="w">    </span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">nocwnd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="__codelineno-12-17" name="__codelineno-12-17" href="#__codelineno-12-17"></a><span class="w">    </span><span class="c1">// ...</span>
<a id="__codelineno-12-18" name="__codelineno-12-18" href="#__codelineno-12-18"></a><span class="p">}</span>
<a id="__codelineno-12-19" name="__codelineno-12-19" href="#__codelineno-12-19"></a>
<a id="__codelineno-12-20" name="__codelineno-12-20" href="#__codelineno-12-20"></a><span class="kt">void</span><span class="w"> </span><span class="nf">ikcp_flush</span><span class="p">(</span><span class="n">ikcpcb</span><span class="w"> </span><span class="o">*</span><span class="n">kcp</span><span class="p">)</span>
<a id="__codelineno-12-21" name="__codelineno-12-21" href="#__codelineno-12-21"></a><span class="p">{</span>
<a id="__codelineno-12-22" name="__codelineno-12-22" href="#__codelineno-12-22"></a><span class="w">    </span><span class="c1">// ...</span>
<a id="__codelineno-12-23" name="__codelineno-12-23" href="#__codelineno-12-23"></a><span class="n">عند</span><span class="w"> </span><span class="n">إرسال</span><span class="w"> </span><span class="n">البيانات</span><span class="err">،</span><span class="w"> </span><span class="n">يتم</span><span class="w"> </span><span class="n">حساب</span><span class="w"> </span><span class="n">حجم</span><span class="w"> </span><span class="n">نافذة</span><span class="w"> </span><span class="n">الإرسال</span><span class="w"> </span><span class="n">أولا</span><span class="err">ً،</span><span class="w"> </span><span class="n">وهو</span><span class="w"> </span><span class="n">أصغر</span><span class="w"> </span><span class="n">قيمة</span><span class="w"> </span><span class="n">بين</span><span class="w"> </span><span class="n">حجم</span><span class="w"> </span><span class="n">النافذة</span><span class="w"> </span><span class="n">الخاصة</span><span class="w"> </span><span class="n">بالذاكرة</span><span class="w"> </span><span class="n">المؤقتة</span><span class="w"> </span><span class="n">للإرسال</span><span class="w"> </span><span class="n">وحجم</span><span class="w"> </span><span class="n">نافذة</span><span class="w"> </span><span class="n">الاستقبال</span><span class="w"> </span><span class="n">للشخص</span><span class="w"> </span><span class="n">الآخر</span><span class="p">.</span>
<a id="__codelineno-12-24" name="__codelineno-12-24" href="#__codelineno-12-24"></a><span class="w">    </span><span class="n">cwnd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_imin_</span><span class="p">(</span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">snd_wnd</span><span class="p">,</span><span class="w"> </span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">rmt_wnd</span><span class="p">);</span>
<a id="__codelineno-12-25" name="__codelineno-12-25" href="#__codelineno-12-25"></a><span class="n">يجب</span><span class="w"> </span><span class="n">النظر</span><span class="w"> </span><span class="n">في</span><span class="w"> </span><span class="n">القيمة</span><span class="w"> </span><span class="n">الافتراضية</span><span class="w"> </span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">cwnd</span><span class="err">،</span><span class="w"> </span><span class="n">وهي</span><span class="w"> </span><span class="n">النافذة</span><span class="w"> </span><span class="n">القابلة</span><span class="w"> </span><span class="n">للإرسال</span><span class="w"> </span><span class="n">المحدثة</span><span class="w"> </span><span class="n">بشكل</span><span class="w"> </span><span class="n">مستمر</span><span class="p">.</span>
<a id="__codelineno-12-26" name="__codelineno-12-26" href="#__codelineno-12-26"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">nocwnd</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="n">cwnd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_imin_</span><span class="p">(</span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">cwnd</span><span class="p">,</span><span class="w"> </span><span class="n">cwnd</span><span class="p">);</span>
<a id="__codelineno-12-27" name="__codelineno-12-27" href="#__codelineno-12-27"></a>
<a id="__codelineno-12-28" name="__codelineno-12-28" href="#__codelineno-12-28"></a><span class="n">تحريك</span><span class="w"> </span><span class="n">snd_queue</span><span class="w"> </span><span class="n">إلى</span><span class="w"> </span><span class="n">snd_buf</span><span class="w"> </span><span class="n">وفق</span><span class="err">ً</span><span class="n">ا</span><span class="w"> </span><span class="n">لحجم</span><span class="w"> </span><span class="n">cwnd</span><span class="p">.</span>
<a id="__codelineno-12-29" name="__codelineno-12-29" href="#__codelineno-12-29"></a><span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">_itimediff</span><span class="p">(</span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">snd_nxt</span><span class="p">,</span><span class="w"> </span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">snd_una</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">cwnd</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-12-30" name="__codelineno-12-30" href="#__codelineno-12-30"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-12-31" name="__codelineno-12-31" href="#__codelineno-12-31"></a><span class="n">قم</span><span class="w"> </span><span class="n">بترجمة</span><span class="w"> </span><span class="n">هذه</span><span class="w"> </span><span class="n">النص</span><span class="w"> </span><span class="n">إلى</span><span class="w"> </span><span class="n">اللغة</span><span class="w"> </span><span class="n">العربية</span><span class="o">:</span>
<a id="__codelineno-12-32" name="__codelineno-12-32" href="#__codelineno-12-32"></a>
<a id="__codelineno-12-33" name="__codelineno-12-33" href="#__codelineno-12-33"></a><span class="c1">// 发送数据</span>
<a id="__codelineno-12-34" name="__codelineno-12-34" href="#__codelineno-12-34"></a><span class="w">    </span><span class="n">resent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">fastresend</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="o">?</span><span class="w"> </span><span class="p">(</span><span class="n">IUINT32</span><span class="p">)</span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">fastresend</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="mh">0xffffffff</span><span class="p">;</span>
<a id="__codelineno-12-35" name="__codelineno-12-35" href="#__codelineno-12-35"></a><span class="c1">// يُعيد تشغيل النقل في حالة فقدان الاتصال lost = 1</span>
<a id="__codelineno-12-36" name="__codelineno-12-36" href="#__codelineno-12-36"></a><span class="c1">// تغيير تنشيط إعادة الارسال السريع ++</span>
<a id="__codelineno-12-37" name="__codelineno-12-37" href="#__codelineno-12-37"></a>
<a id="__codelineno-12-38" name="__codelineno-12-38" href="#__codelineno-12-38"></a><span class="c1">// تحديث عتبة البدء البطيء ونافذة الإرسال</span>
<a id="__codelineno-12-39" name="__codelineno-12-39" href="#__codelineno-12-39"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">change</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-12-40" name="__codelineno-12-40" href="#__codelineno-12-40"></a><span class="n">إذا</span><span class="w"> </span><span class="n">كان</span><span class="w"> </span><span class="n">هناك</span><span class="w"> </span><span class="n">إعادة</span><span class="w"> </span><span class="n">نقل</span><span class="w"> </span><span class="n">سريعة</span><span class="err">،</span><span class="w"> </span><span class="n">فإن</span><span class="w"> </span><span class="n">قيمة</span><span class="w"> </span><span class="n">ssthresh</span><span class="w"> </span><span class="n">يتم</span><span class="w"> </span><span class="n">تعيينها</span><span class="w"> </span><span class="n">إلى</span><span class="w"> </span><span class="n">نصف</span><span class="w"> </span><span class="n">عدد</span><span class="w"> </span><span class="n">الحزم</span><span class="w"> </span><span class="n">التي</span><span class="w"> </span><span class="n">ت</span><span class="err">ُ</span><span class="n">نقل</span><span class="w"> </span><span class="n">حالي</span><span class="err">ً</span><span class="n">ا</span><span class="w"> </span><span class="n">عبر</span><span class="w"> </span><span class="n">الشبكة</span>
<a id="__codelineno-12-41" name="__codelineno-12-41" href="#__codelineno-12-41"></a><span class="w">        </span><span class="n">IUINT32</span><span class="w"> </span><span class="n">inflight</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">snd_nxt</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">snd_una</span><span class="p">;</span>
<a id="__codelineno-12-42" name="__codelineno-12-42" href="#__codelineno-12-42"></a><span class="w">        </span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">ssthresh</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inflight</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span>
<a id="__codelineno-12-43" name="__codelineno-12-43" href="#__codelineno-12-43"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">ssthresh</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">IKCP_THRESH_MIN</span><span class="p">)</span>
<a id="__codelineno-12-44" name="__codelineno-12-44" href="#__codelineno-12-44"></a><span class="w">            </span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">ssthresh</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">IKCP_THRESH_MIN</span><span class="p">;</span>
<a id="__codelineno-12-45" name="__codelineno-12-45" href="#__codelineno-12-45"></a>
<a id="__codelineno-12-46" name="__codelineno-12-46" href="#__codelineno-12-46"></a><span class="c1">// ترسل نافذة تتكون من القيمة الحدية بالإضافة إلى إعادة الإرسال المتعلقة بالإعادة السريعة.</span>
<a id="__codelineno-12-47" name="__codelineno-12-47" href="#__codelineno-12-47"></a><span class="w">        </span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">cwnd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">ssthresh</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">resent</span><span class="p">;</span>
<a id="__codelineno-12-48" name="__codelineno-12-48" href="#__codelineno-12-48"></a><span class="w">        </span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">incr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">cwnd</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">mss</span><span class="p">;</span>
<a id="__codelineno-12-49" name="__codelineno-12-49" href="#__codelineno-12-49"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-12-50" name="__codelineno-12-50" href="#__codelineno-12-50"></a>
<a id="__codelineno-12-51" name="__codelineno-12-51" href="#__codelineno-12-51"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">lost</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-12-52" name="__codelineno-12-52" href="#__codelineno-12-52"></a><span class="n">إذا</span><span class="w"> </span><span class="n">تم</span><span class="w"> </span><span class="n">إعادة</span><span class="w"> </span><span class="n">الإرسال</span><span class="w"> </span><span class="n">بعد</span><span class="w"> </span><span class="n">فترة</span><span class="w"> </span><span class="n">زمنية</span><span class="w"> </span><span class="n">معينة</span><span class="err">،</span><span class="w"> </span><span class="n">سيتم</span><span class="w"> </span><span class="n">تنشيط</span><span class="w"> </span><span class="n">البدء</span><span class="w"> </span><span class="n">البطيء</span><span class="err">،</span><span class="w"> </span><span class="n">وقيمة</span><span class="w"> </span><span class="n">ssthresh</span><span class="w"> </span><span class="n">تكون</span><span class="w"> </span><span class="n">نصف</span><span class="w"> </span><span class="n">حجم</span><span class="w"> </span><span class="n">النافذة</span><span class="w"> </span><span class="n">المرسلة</span>
<a id="__codelineno-12-53" name="__codelineno-12-53" href="#__codelineno-12-53"></a><span class="w">        </span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">ssthresh</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cwnd</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span>
<a id="__codelineno-12-54" name="__codelineno-12-54" href="#__codelineno-12-54"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">ssthresh</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">IKCP_THRESH_MIN</span><span class="p">)</span>
<a id="__codelineno-12-55" name="__codelineno-12-55" href="#__codelineno-12-55"></a><span class="w">            </span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">ssthresh</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">IKCP_THRESH_MIN</span><span class="p">;</span>
<a id="__codelineno-12-56" name="__codelineno-12-56" href="#__codelineno-12-56"></a><span class="c1">// إرسال نافذة مرة أخرى إلى 1، وزيادة التشغيل البطيء مرة أخرى</span>
<a id="__codelineno-12-57" name="__codelineno-12-57" href="#__codelineno-12-57"></a><span class="w">        </span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">cwnd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<a id="__codelineno-12-58" name="__codelineno-12-58" href="#__codelineno-12-58"></a><span class="w">        </span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">incr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">mss</span><span class="p">;</span>
<a id="__codelineno-12-59" name="__codelineno-12-59" href="#__codelineno-12-59"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-12-60" name="__codelineno-12-60" href="#__codelineno-12-60"></a>
<a id="__codelineno-12-61" name="__codelineno-12-61" href="#__codelineno-12-61"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">cwnd</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-12-62" name="__codelineno-12-62" href="#__codelineno-12-62"></a><span class="n">بسبب</span><span class="w"> </span><span class="n">أنه</span><span class="w"> </span><span class="n">تم</span><span class="w"> </span><span class="n">تهيئتها</span><span class="w"> </span><span class="n">إلى</span><span class="w"> </span><span class="n">القيمة</span><span class="w"> </span><span class="mi">0</span><span class="err">،</span><span class="w"> </span><span class="n">ست</span><span class="err">ُ</span><span class="n">عاد</span><span class="w"> </span><span class="n">تعيينها</span><span class="w"> </span><span class="n">هنا</span><span class="w"> </span><span class="n">إلى</span><span class="w"> </span><span class="mf">1.</span>
<a id="__codelineno-12-63" name="__codelineno-12-63" href="#__codelineno-12-63"></a><span class="w">        </span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">cwnd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<a id="__codelineno-12-64" name="__codelineno-12-64" href="#__codelineno-12-64"></a><span class="w">        </span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">incr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">mss</span><span class="p">;</span>
<a id="__codelineno-12-65" name="__codelineno-12-65" href="#__codelineno-12-65"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-12-66" name="__codelineno-12-66" href="#__codelineno-12-66"></a><span class="p">}</span>
<a id="__codelineno-12-67" name="__codelineno-12-67" href="#__codelineno-12-67"></a>
<a id="__codelineno-12-68" name="__codelineno-12-68" href="#__codelineno-12-68"></a><span class="kt">int</span><span class="w"> </span><span class="nf">ikcp_input</span><span class="p">(</span><span class="n">ikcpcb</span><span class="w"> </span><span class="o">*</span><span class="n">kcp</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">size</span><span class="p">)</span>
<a id="__codelineno-12-69" name="__codelineno-12-69" href="#__codelineno-12-69"></a><span class="p">{</span>
<a id="__codelineno-12-70" name="__codelineno-12-70" href="#__codelineno-12-70"></a><span class="w">    </span><span class="n">IUINT32</span><span class="w"> </span><span class="n">prev_una</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">snd_una</span><span class="p">;</span>
<a id="__codelineno-12-71" name="__codelineno-12-71" href="#__codelineno-12-71"></a><span class="c1">// معالجة البيانات المستلمة</span>
<a id="__codelineno-12-72" name="__codelineno-12-72" href="#__codelineno-12-72"></a>
<a id="__codelineno-12-73" name="__codelineno-12-73" href="#__codelineno-12-73"></a><span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-12-74" name="__codelineno-12-74" href="#__codelineno-12-74"></a><span class="w">        </span><span class="c1">// ...</span>
<a id="__codelineno-12-75" name="__codelineno-12-75" href="#__codelineno-12-75"></a><span class="w">        </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ikcp_decode16u</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">wnd</span><span class="p">)</span>
<a id="__codelineno-12-76" name="__codelineno-12-76" href="#__codelineno-12-76"></a><span class="c1">// rmt_wnd هو حجم نافذة الاستقبال للطرف الآخر</span>
<a id="__codelineno-12-77" name="__codelineno-12-77" href="#__codelineno-12-77"></a><span class="w">        </span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">rmt_wnd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">wnd</span>
<a id="__codelineno-12-78" name="__codelineno-12-78" href="#__codelineno-12-78"></a><span class="w">        </span><span class="c1">// ...</span>
<a id="__codelineno-12-79" name="__codelineno-12-79" href="#__codelineno-12-79"></a><span class="n">ترجمة</span><span class="w"> </span><span class="n">النص</span><span class="w"> </span><span class="n">إلى</span><span class="w"> </span><span class="n">اللغة</span><span class="w"> </span><span class="n">العربية</span><span class="o">:</span>
<a id="__codelineno-12-80" name="__codelineno-12-80" href="#__codelineno-12-80"></a>
<a id="__codelineno-12-81" name="__codelineno-12-81" href="#__codelineno-12-81"></a><span class="c1">// تناول البيانات</span>
<a id="__codelineno-12-82" name="__codelineno-12-82" href="#__codelineno-12-82"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-12-83" name="__codelineno-12-83" href="#__codelineno-12-83"></a>
<a id="__codelineno-12-84" name="__codelineno-12-84" href="#__codelineno-12-84"></a><span class="c1">// تحديث نافذة الإرسال الأخيرة</span>
<a id="__codelineno-12-85" name="__codelineno-12-85" href="#__codelineno-12-85"></a><span class="n">إذا</span><span class="w"> </span><span class="n">كان</span><span class="w"> </span><span class="s">"kcp-&gt;snd_una - prev_una &gt; 0"</span><span class="err">،</span><span class="w"> </span><span class="n">فهذا</span><span class="w"> </span><span class="n">يعني</span><span class="w"> </span><span class="n">أنه</span><span class="w"> </span><span class="n">تم</span><span class="w"> </span><span class="n">استلام</span><span class="w"> </span><span class="n">ACK</span><span class="w"> </span><span class="n">خلال</span><span class="w"> </span><span class="n">هذا</span><span class="w"> </span><span class="n">الإدخال</span><span class="w"> </span><span class="n">وأن</span><span class="w"> </span><span class="n">حجم</span><span class="w"> </span><span class="n">الذاكرة</span><span class="w"> </span><span class="n">المؤقتة</span><span class="w"> </span><span class="n">للإرسال</span><span class="w"> </span><span class="n">snd_buf</span><span class="w"> </span><span class="n">قد</span><span class="w"> </span><span class="n">تغير</span><span class="p">.</span>
<a id="__codelineno-12-86" name="__codelineno-12-86" href="#__codelineno-12-86"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">_itimediff</span><span class="p">(</span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">snd_una</span><span class="p">,</span><span class="w"> </span><span class="n">prev_una</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-12-87" name="__codelineno-12-87" href="#__codelineno-12-87"></a><span class="c1">// تقييم نافذة الاستقبال الخاصة بالطرف الآخر</span>
<a id="__codelineno-12-88" name="__codelineno-12-88" href="#__codelineno-12-88"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">cwnd</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">rmt_wnd</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-12-89" name="__codelineno-12-89" href="#__codelineno-12-89"></a><span class="w">            </span><span class="n">IUINT32</span><span class="w"> </span><span class="n">mss</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">mss</span><span class="p">;</span>
<a id="__codelineno-12-90" name="__codelineno-12-90" href="#__codelineno-12-90"></a>
<a id="__codelineno-12-91" name="__codelineno-12-91" href="#__codelineno-12-91"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">cwnd</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">ssthresh</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-12-92" name="__codelineno-12-92" href="#__codelineno-12-92"></a><span class="c1">// أقل من عتبة التباطؤ، زيادة مضاعفة</span>
<a id="__codelineno-12-93" name="__codelineno-12-93" href="#__codelineno-12-93"></a><span class="w">                </span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">cwnd</span><span class="o">++</span><span class="p">;</span>
<a id="__codelineno-12-94" name="__codelineno-12-94" href="#__codelineno-12-94"></a><span class="w">                </span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">incr</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">mss</span><span class="p">;</span>
<a id="__codelineno-12-95" name="__codelineno-12-95" href="#__codelineno-12-95"></a>
<a id="__codelineno-12-96" name="__codelineno-12-96" href="#__codelineno-12-96"></a><span class="w">            </span><span class="p">}</span><span class="w">    </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-12-97" name="__codelineno-12-97" href="#__codelineno-12-97"></a><span class="n">بعد</span><span class="w"> </span><span class="n">تجاوز</span><span class="w"> </span><span class="n">قيمة</span><span class="w"> </span><span class="n">عتبة</span><span class="w"> </span><span class="n">بدء</span><span class="w"> </span><span class="n">التشغيل</span><span class="w"> </span><span class="n">البطيء</span><span class="err">،</span><span class="w"> </span><span class="n">من</span><span class="w"> </span><span class="n">خلال</span><span class="w"> </span><span class="n">تحديث</span><span class="w"> </span><span class="n">الزيادة</span><span class="w"> </span><span class="n">بالصيغة</span><span class="err">،</span><span class="w"> </span><span class="n">ثم</span><span class="w"> </span><span class="n">حساب</span><span class="w"> </span><span class="n">حجم</span><span class="w"> </span><span class="n">النافذة</span><span class="w"> </span><span class="n">المتحكمة</span><span class="p">.</span>
<a id="__codelineno-12-98" name="__codelineno-12-98" href="#__codelineno-12-98"></a><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">incr</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">mss</span><span class="p">)</span><span class="w"> </span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">incr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mss</span><span class="p">;</span>
<a id="__codelineno-12-99" name="__codelineno-12-99" href="#__codelineno-12-99"></a><span class="w">                </span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">incr</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="p">(</span><span class="n">mss</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">mss</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">incr</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">mss</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">16</span><span class="p">);</span>
<a id="__codelineno-12-100" name="__codelineno-12-100" href="#__codelineno-12-100"></a><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">cwnd</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">mss</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">incr</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-12-101" name="__codelineno-12-101" href="#__codelineno-12-101"></a><span class="w">                    </span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">cwnd</span><span class="o">++</span><span class="p">;</span>
<a id="__codelineno-12-102" name="__codelineno-12-102" href="#__codelineno-12-102"></a><span class="w">                </span><span class="p">}</span>
<a id="__codelineno-12-103" name="__codelineno-12-103" href="#__codelineno-12-103"></a><span class="w">            </span><span class="p">}</span>
<a id="__codelineno-12-104" name="__codelineno-12-104" href="#__codelineno-12-104"></a><span class="n">يجب</span><span class="w"> </span><span class="n">مقارنة</span><span class="w"> </span><span class="n">القيمة</span><span class="w"> </span><span class="n">المحدثة</span><span class="w"> </span><span class="n">مرة</span><span class="w"> </span><span class="n">أخرى</span><span class="w"> </span><span class="n">مع</span><span class="w"> </span><span class="n">rmt_wnd</span><span class="p">.</span>
<a id="__codelineno-12-105" name="__codelineno-12-105" href="#__codelineno-12-105"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">cwnd</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">rmt_wnd</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-12-106" name="__codelineno-12-106" href="#__codelineno-12-106"></a><span class="w">                </span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">cwnd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">rmt_wnd</span><span class="p">;</span>
<a id="__codelineno-12-107" name="__codelineno-12-107" href="#__codelineno-12-107"></a><span class="w">                </span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">incr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kcp</span><span class="o">-&gt;</span><span class="n">rmt_wnd</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">mss</span><span class="p">;</span>
<a id="__codelineno-12-108" name="__codelineno-12-108" href="#__codelineno-12-108"></a><span class="w">            </span><span class="p">}</span>
<a id="__codelineno-12-109" name="__codelineno-12-109" href="#__codelineno-12-109"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-12-110" name="__codelineno-12-110" href="#__codelineno-12-110"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-12-111" name="__codelineno-12-111" href="#__codelineno-12-111"></a><span class="p">}</span>
</code></pre></div>
</details>

<p>سيكون هناك قدر أكبر من قطع الشيفرة التي تتعلق بحساب حجم نافذة الإرسال <code>kcp-&gt;cwnd</code>، لأنه يتطلب تحديثًا عند إرسال البيانات واستقبالها. يتم تهيئة <code>kcp-&gt;cwnd</code> بقيمة صفر،
سيتم بعد ذلك، عند استدعاء <code>ikcp_flush</code> لأول مرة، فحصها إذا كانت أقل من 1 ، ستُعدل إلى 1. بعد ذلك، سيرسل المرسل عددًا من حزم البيانات المقابل لحجم نافذة الإرسال، ثم ينتظر تأكيد الاستقبال.
الرد ACK يتم معالجته في الحزمة <code>kcp-&gt;input</code>. إذا تم الكشف عن حزمة ACK في <code>kcp-&gt;input</code> وتم مسح بيانات الحزمة المرسلة في الذاكرة المؤقتة للإرسال، فهذا يعني أن الحزمة قد وصلت بنجاح. سيتم زيادة قيمة <code>kcp-&gt;cwnd++</code>. في الواقع، من المحتمل جدًا أن يتم معالجة حزمة ACK واحدة فقط في كل عملية <code>kcp-&gt;input</code>. يمكن تفسير الزيادة <code>kcp-&gt;cwnd++</code> بأنها زيادة بنسبة مئوية، على سبيل المثال، إذا كان <code>kcp-&gt;cwnd = 2</code>، وتم إرسال حزمتين، واستقبال حزمتين ACK، ستحدث زيادة مرتين، مما يؤدي إلى <code>kcp-&gt;cwnd = 4</code>، وهكذا.</p>
<p><code>cwnd</code> can grow exponentially until it exceeds the slow start threshold, or in case of congestion timeout retransmission, or fast retransmission. After a timeout retransmission, slow start is triggered, and the slow start threshold <code>ssthresh = kcp-&gt;cwnd / 2</code>, the sending window <code>kcp-&gt;cwnd = 1</code>, returns to the initial exponential growth. In the event of fast retransmission, KCP first reduces <code>ssthresh</code> in advance, reducing the space for exponential growth in <code>cwnd</code>, slowing down the growth rate, and preemptively alleviating congestion.</p>
<p>KCP قد أضاف إعدادًا جديدًا يسمى <code>nocwnd</code>، حيث عندما يكون <code>nocwnd = 1</code>، يتم إرسال البيانات دون النظر إلى حجم النافذة، بل يتم إرسال عدد البيانات الأقصى الممكن مباشرة، لتلبية متطلبات الوضع السريع.</p>
<h2 id="_7">تلخيص</h2>
<p>تم تحليل كود المصدر لـ KCP بشكل بسيط في هذا المقال، وتم مناقشة تنفيذ ARQ على KCP، بالإضافة إلى بعض استراتيجيات تعزيز سرعة تدفق KCP. لم يتم ذكر العديد من التفاصيل، يمكن للمهتمين الاطلاع على كود مصدر KCP بأنفسهم والتحقق منه، وأعتقد أنهم سيستفيدون كثيرًا من ذلك.</p>
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

<!-- 转载声明 && visit -->
<blockquote>
<p>Original: <a href="https://wiki.disenone.site/ar">https://wiki.disenone.site/ar</a></p>
<p>This post is protected by <a href="https://creativecommons.org/licenses/by/4.0/deed.en">CC BY-NC-SA 4.0</a> agreement, should be reproduced with attribution.</p>
</blockquote>
<!-- 转载 -->
<div class="a2a_kit a2a_kit_size_32 a2a_default_style" data-a2a-icon-color="#4051b5">
    <a class="a2a_dd" href="https://www.addtoany.com/share"></a>
    <a class="a2a_button_copy_link"></a>
    <a class="a2a_button_wechat"></a>
    <a class="a2a_button_reddit"></a>
    <a class="a2a_button_google_gmail"></a>
    <a class="a2a_button_pocket"></a>
</div>
<script async src="https://static.addtoany.com/menu/page.js"></script>

<!-- 评论 -->
<script src="https://giscus.app/client.js" data-repo="disenone/wiki" data-repo-id="R_kgDOKz9PQg" data-category="Announcements" data-category-id="DIC_kwDOKz9PQs4Cbbvv" data-mapping="og:title" data-strict="1" data-reactions-enabled="1" data-emit-metadata="0" data-input-position="top" data-theme="preferred_color_scheme" data-lang="ar" data-loading="lazy" crossorigin="anonymous" async>
</script>

<!-- visit -->
<blockquote>
<p></p><p class="copyright text-muted"><span id="busuanzi_container_site_uv"> <span id="busuanzi_value_site_uv"></span> Visitors. </span> <span id="busuanzi_container_site_pv"> <span id="busuanzi_value_site_pv"></span> Total Visits. </span> <span id="busuanzi_container_page_pv"> <span id="busuanzi_value_page_pv"></span> Page Visits. </span></p>
<p>تم ترجمة هذه المشاركة باستخدام ChatGPT، يرجى تقديم <a href="https://github.com/disenone/wiki_blog/issues/new"><strong>ردود فعل</strong></a>وسمح المكان الذي تم التغاضي عنه. </p>
</blockquote></div>







  
    
  
  
    
  


  <aside class="md-source-file">
    
      
  <span class="md-source-file__fact">
    <span class="md-icon" title="اخر تحديث">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M21 13.1c-.1 0-.3.1-.4.2l-1 1 2.1 2.1 1-1c.2-.2.2-.6 0-.8l-1.3-1.3c-.1-.1-.2-.2-.4-.2m-1.9 1.8-6.1 6V23h2.1l6.1-6.1zM12.5 7v5.2l4 2.4-1 1L11 13V7zM11 21.9c-5.1-.5-9-4.8-9-9.9C2 6.5 6.5 2 12 2c5.3 0 9.6 4.1 10 9.3-.3-.1-.6-.2-1-.2s-.7.1-1 .2C19.6 7.2 16.2 4 12 4c-4.4 0-8 3.6-8 8 0 4.1 3.1 7.5 7.1 7.9l-.1.2z"/></svg>
    </span>
    <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-custom">2025-01-04</span>
  </span>

    
    
      
  <span class="md-source-file__fact">
    <span class="md-icon" title="خلقت">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M14.47 15.08 11 13V7h1.5v5.25l3.08 1.83c-.41.28-.79.62-1.11 1m-1.39 4.84c-.36.05-.71.08-1.08.08-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8c0 .37-.03.72-.08 1.08.69.1 1.33.32 1.92.64.1-.56.16-1.13.16-1.72 0-5.5-4.5-10-10-10S2 6.5 2 12s4.47 10 10 10c.59 0 1.16-.06 1.72-.16-.32-.59-.54-1.23-.64-1.92M18 15v3h-3v2h3v3h2v-3h3v-2h-3v-3z"/></svg>
    </span>
    <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-custom">2025-01-04</span>
  </span>

    
    
    
  </aside>





                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  عد إلى الأعلى
</button>
        
      </main>
      
        <footer class="md-footer">
  
    
      
      <nav class="md-footer__inner md-grid" aria-label="هامش سفلي" >
        
          
          <a href="../cpp-%E7%BC%96%E5%86%99Windows%E4%B8%8B%E7%9A%84MemoryLeakDetector/" class="md-footer__link md-footer__link--prev" aria-label="السابقة: كتابة كاشف تسرب الذاكرة في نظام Windows">
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
            </div>
            <div class="md-footer__title">
              <span class="md-footer__direction">
                السابقة
              </span>
              <div class="md-ellipsis">
                كتابة كاشف تسرب الذاكرة في نظام Windows
              </div>
            </div>
          </a>
        
        
          
          <a href="../py-%E4%BD%BF%E7%94%A8VisualStudio2015%E7%BC%96%E8%AF%91Python2.7.11/" class="md-footer__link md-footer__link--next" aria-label="التالية: استخدام Visual Studio 2015 لتجميع Python 2.7.11">
            <div class="md-footer__title">
              <span class="md-footer__direction">
                التالية
              </span>
              <div class="md-ellipsis">
                استخدام Visual Studio 2015 لتجميع Python 2.7.11
              </div>
            </div>
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11z"/></svg>
            </div>
          </a>
        
      </nav>
    
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright &copy; 2014 - 2024 by <a href="https://github.com/disenone"> Disenone </a>
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "../..", "features": ["content.code.copy", "content.code.annotate", "content.code.select", "content.action.edit", "content.tooltips", "navigation.tracking", "navigation.tabs", "navigation.footer", "navigation.sections", "navigation.indexes", "toc.follow", "navigation.top", "search.suggest"], "search": "../../assets/javascripts/workers/search.f8cc74c7.min.js", "translations": {"clipboard.copied": "\u062a\u0645 \u0627\u0644\u0646\u0633\u062e \u0627\u0644\u0649 \u0627\u0644\u062d\u0627\u0641\u0638\u0629", "clipboard.copy": "\u0646\u0633\u062e \u0625\u0644\u0649 \u0627\u0644\u062d\u0627\u0641\u0638\u0629", "search.result.more.one": "\u0623\u0643\u062b\u0631 \u0645\u0646 1 \u0641\u064a \u0647\u0630\u0647 \u0627\u0644\u0635\u0641\u062d\u0629", "search.result.more.other": "\u0623\u0643\u062b\u0631 \u0645\u0646 # \u0641\u064a \u0647\u0630\u0647 \u0627\u0644\u0635\u0641\u062d\u0629", "search.result.none": "\u0644\u0627 \u062a\u0648\u062c\u062f \u0646\u062a\u0627\u0626\u062c", "search.result.one": "\u0646\u062a\u0627\u0626\u062c \u0627\u0644\u0628\u062d\u062b \u0645\u0633\u062a\u0646\u062f \u0648\u0627\u062d\u062f", "search.result.other": "\u0646\u062a\u0627\u0626\u062c \u0627\u0644\u0628\u062d\u062b # \u0645\u0633\u062a\u0646\u062f\u0627\u062a", "search.result.placeholder": "\u0627\u0643\u062a\u0628 \u0644\u0628\u062f\u0621 \u0627\u0644\u0628\u062d\u062b", "search.result.term.missing": "\u0645\u0641\u0642\u0648\u062f", "select.version": "\u0625\u062e\u062a\u0631 \u0627\u0644\u0625\u0635\u062f\u0627\u0631"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.60a45f97.min.js"></script>
      
    
  <script id="init-glightbox">const lightbox = GLightbox({"touchNavigation": true, "loop": false, "zoomable": true, "draggable": true, "openEffect": "zoom", "closeEffect": "zoom", "slideEffect": "slide"});
document$.subscribe(() => { lightbox.reload() });
</script></body>
</html>